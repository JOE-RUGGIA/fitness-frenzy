<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness Frenzy â€” VS7g (Music + Start gating + Resetâ†’Splash)</title>
  <style>
    :root{
      --bg:#0f1020; --panel:#1a1c35; --panel-2:#23264a; --accent:#ff7a1a; --accent-2:#3aa6ff;
      --text:#f5f7ff; --muted:#aab1d6; --good:#27c93f;
      --female-accent:#ff76b5;
      --start-hero-desktop:url('FF-desktop.png');
      --start-hero-mobile:url('FF-mobile.png');
      --splash-logo:url('GameBros Logo.png');
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:#f5f7ff; font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}

    .topbar{position:sticky; top:0; z-index:20; background:linear-gradient(180deg, #151734, #10122a); border-bottom:1px solid #22254b; padding:10px 12px}
    .wrap{max-width:880px; margin:0 auto; padding:12px}
    .row{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .logo{font-weight:900; letter-spacing:0.8px}
    .bulk{display:inline-flex; background:#20244a; border:1px solid #2a2e5e; border-radius:8px; overflow:hidden}
    .bulk button{background:transparent; color:#fff; border:0; padding:6px 10px; cursor:pointer; min-width:44px}
    .bulk button.active{background:var(--accent-2); color:#061222; font-weight:700}
    .hp-pill{margin-top:8px; background:#182047; border:1px solid #2a2e5e; padding:8px 10px; border-radius:10px; font-variant-numeric: tabular-nums; display:flex; align-items:center; justify-content:space-between}
    .avatar{width:56px; height:56px; border-radius:50%; background:#2b2f63; display:grid; place-items:center; font-weight:900; border:2px solid #3b3f78; position:relative; cursor:pointer}
    .avatar .dot{position:absolute; top:-4px; right:-4px; width:16px; height:16px; background:var(--good); border-radius:50%; border:2px solid #0f1020; display:none}
    body.female .bulk button.active{background:var(--female-accent); color:#2b0020}
    body.female .btn.glow{box-shadow:0 0 0 2px rgba(255,118,181,.25) inset, 0 0 12px rgba(255,118,181,.35)}

    .cards{display:grid; gap:12px}
    .card{display:grid; grid-template-columns:110px 1fr; gap:12px; padding:10px; background:var(--panel); border:1px solid #262a58; border-radius:12px}
    .tile{background:var(--panel-2); border-radius:10px; position:relative; height:110px; display:grid; place-items:center; user-select:none; overflow:hidden}
    .tile.locked{filter: grayscale(100%); opacity:.9}
    .lvl{position:absolute; top:6px; left:6px; background:#171a38; border:1px solid #2b2f63; padding:2px 6px; border-radius:6px; font-size:12px}
    .tap-btn{appearance:none; border:0; background:var(--accent); color:#1b0d00; font-weight:800; padding:8px 10px; border-radius:8px; cursor:pointer}
    body.female .tap-btn{background:var(--female-accent); color:#2b0020}
    .tile.cooling .tap-btn{opacity:.5; cursor:not-allowed}
    .title{font-weight:700; margin-top:2px}
    .cooldown{margin-top:6px; height:20px; background:#141739; border:1px solid #2a2e5e; border-radius:6px; overflow:hidden; position:relative}
    .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #2f6df3, #41b0ff)}
    .t{position:relative; z-index:1; padding-left:8px; font-variant-numeric: tabular-nums; color:#a6b0d8}
    .meta{display:flex; align-items:center; justify-content:space-between; margin-top:8px}
    .muted{color:#aab1d6}
    .btn{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:10px 14px; border-radius:10px; min-width:180px; cursor:pointer; font-variant-numeric: tabular-nums}
    .btn.glow{box-shadow:0 0 0 2px rgba(255, 192, 120, .25) inset, 0 0 12px rgba(255, 122, 26, .35)}
    .repband{position:absolute; left:6px; right:6px; bottom:6px; height:16px; border-radius:8px; background:#0e132e; border:1px solid #2a2e5e; overflow:hidden}
    .repfill{height:100%; width:0%; background:linear-gradient(90deg, #17b34c, #27c93f)}
    .reptext{position:absolute; inset:0; display:grid; place-items:center; font-size:12px; color:#cfead6; text-shadow:0 1px 2px #000}
    .pill{appearance:none; border:1px solid #2a2e5e; background:#1f254f; color:#e9edff; padding:8px 12px; border-radius:999px; cursor:pointer; font-variant-numeric: tabular-nums}
    .pill.orange{background:var(--accent); color:#1b0d00; font-weight:800}
    body.female .pill.orange{background:var(--female-accent); color:#2b0020}
    .pulse{animation:pulse 1.8s ease-in-out infinite}
    @keyframes pulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.03) } }

    /* Menu overlay */
    .menu{position:fixed; inset:0; display:none; z-index:40}
    .menu.show{display:block}
    .menu-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
    .menu-panel{position:absolute; right:0; top:0; bottom:0; width:min(520px, 92vw); background:#14163a; border-left:1px solid #2a2e5e; display:flex; flex-direction:column; transform:translateX(6%); opacity:0; transition:transform .14s ease, opacity .14s ease}
    .menu.show .menu-panel{transform:translateX(0%); opacity:1}
    .menu-top{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #2a2e5e}
    .menu-title{font-weight:900}
    .menu-close{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:6px 10px; border-radius:8px; cursor:pointer}
    .menu-tabs{display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid #2a2e5e; overflow:auto}
    .tab{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:6px 10px; border-radius:8px; cursor:pointer; white-space:nowrap}
    .tab.active{background:#202767; outline:2px solid var(--accent-2)}
    .menu-body{flex:1; overflow:auto; padding:12px}
    .coach-row{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; background:#171a3a; border:1px solid #2a2e5e; padding:10px; border-radius:10px; margin-bottom:8px}
    .coach-ava{width:44px; height:44px; border-radius:50%; background:#2b2f63; display:grid; place-items:center; font-weight:800}
    .coach-title{font-weight:700}
    .coach-sub{font-size:12px; color:#a6adcf}
    .hired{color:var(--good); font-weight:700}

    /* Tutorial + Offline modal */
    .jax,.off{position:fixed; inset:0; display:none; place-items:center; z-index:55}
    .jax.show,.off.show{display:grid}
    .jax::before,.off::before{content:""; position:absolute; inset:0; background:rgba(0,0,0,.55)}
    .jax .panel,.off .panel{position:relative; z-index:1; max-width:min(640px, 92vw); background:#111333; border:1px solid #2a2e5e; border-radius:14px; padding:16px}

    /* Splash (white background + centered logo) */
    .splash{position:fixed; inset:0; z-index:80; display:none; background:#ffffff;}
    .splash.show{display:block}
    .splash .brand{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center}
    .splash .logo-img{width:min(420px, 60vw); height:min(420px,60vw); background-image:var(--splash-logo); background-size:contain; background-repeat:no-repeat; background-position:center; margin:0 auto}
    .splash .tag{margin-top:10px; color:#333}
    .splash .skip{position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:#111; border:1px solid #333; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer}

    /* Start (full-bleed background image with lower-centered panel) */
    .start{position:fixed; inset:0; z-index:70; display:none}
    .start.show{display:block}
    .start .bg{position:absolute; inset:0; background-position:center; background-size:cover; background-repeat:no-repeat; filter: saturate(1.05);}
    .start .scrim{position:absolute; inset:0; background: linear-gradient(180deg, rgba(10,12,33,.10) 0%, rgba(10,12,33,.55) 45%, rgba(10,12,33,.85) 100%);}
    .start .panel{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:6vh; width:min(760px, 94vw);
      background:rgba(18,20,52,.70); border:1px solid rgba(42,46,94,.75); border-radius:16px;
      backdrop-filter: blur(6px);
      padding:16px;
      display:flex; flex-direction:column; align-items:center; gap:14px;
    }
    .start .avatars{display:flex; gap:10px; align-items:center; justify-content:center}
    .start .ava{width:110px; height:110px; border-radius:12px; display:grid; place-items:center; font-weight:900; border:2px solid #2a2e5e; cursor:pointer; background:#121434; user-select:none}
    .start .ava.active{outline:3px solid var(--accent-2)}
    .start .ava.f{border-color:var(--female-accent)}
    .start .buttons{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .start .btn-start{background:var(--accent); color:#1b0d00; font-weight:900}
    body.female .start .btn-start{background:var(--female-accent); color:#2b0020}
    .start .btn-continue{background:#1f254f}
    .start .hint{color:#ccd2ff; opacity:.85; font-size:13px}

    /* Toast + Error bar */
    .toast{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:100; display:none}
    .toast.show{display:block}
    .toast .box{background:#0f1333; border:1px solid #32407a; color:#e9edff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 30px rgba(0,0,0,.35)}
    .err{position:fixed; top:0; left:0; right:0; background:#8b1111; color:#fff; z-index:120; padding:8px 12px; font-weight:700; display:none}
    .err.show{display:block}

    @media (max-width:560px){
      .start .ava{width:96px; height:96px}
      .start .panel{bottom:4vh}
    }
  </style>
</head>
<body>
  <div id="err" class="err"></div>

  <!-- Splash -->
  <div id="splash" class="splash show" aria-hidden="true">
    <div class="brand">
      <div class="logo-img" aria-label="GameBros logo"></div>
      <div class="tag">loading assetsâ€¦</div>
    </div>
    <button id="splash-skip" class="skip">Skip</button>
  </div>

  <!-- Start (full-screen bg) -->
  <div id="start" class="start" role="dialog" aria-modal="true" aria-label="Start menu" data-bg-desktop="FF-desktop.png" data-bg-mobile="FF-mobile.png">
    <div id="start-bg" class="bg"></div>
    <div class="scrim"></div>
    <div class="panel">
      <div class="avatars" id="start-avatars">
        <div class="ava m active" data-sex="male">Male</div>
        <div class="ava f" data-sex="female">Female</div>
      </div>
      <div class="buttons">
        <button id="btn-new" class="btn btn-start">New Game</button>
        <button id="btn-continue" class="btn btn-continue" style="display:none">Continue</button>
      </div>
      <div class="hint">Music starts after you click.</div>
    </div>
  </div>

  <div class="topbar" aria-hidden="true">
    <div class="wrap">
      <div class="row">
        <div class="row" style="gap:12px; align-items:center">
          <button id="avatar" class="avatar" title="Menu"><span>FF</span><span id="avatar-dot" class="dot"></span></button>
          <div class="logo">Fitness Frenzy â€” VS7g</div>
        </div>
        <div class="bulk" id="bulk">
          <button data-q="1" class="active">Ã—1</button>
          <button data-q="10">Ã—10</button>
          <button data-q="100">Ã—100</button>
        </div>
      </div>
      <div class="hp-pill"><span>HP</span><span id="hp-readout">0</span></div>
    </div>
  </div>

  <div class="wrap" aria-hidden="true">
    <div id="cards" class="cards"></div>
  </div>

  <!-- Menu overlay -->
  <div id="menu" class="menu" role="dialog" aria-modal="true" aria-labelledby="menu-title">
    <div class="menu-backdrop" data-close="1"></div>
    <div class="menu-panel">
      <div class="menu-top">
        <div id="menu-title" class="menu-title">Menu</div>
        <button class="menu-close" data-close="1" aria-label="Close">âœ•</button>
      </div>
      <div class="menu-tabs">
        <button class="tab active" data-tab="coaches">Coaches</button>
        <button class="tab" data-tab="upgrades">Upgrades</button>
        <button class="tab" data-tab="quests">Side Quests</button>
        <button class="tab" data-tab="achievements">Achievements</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>
      <div class="menu-body" id="menu-body"></div>
    </div>
  </div>

  <!-- JAX tutorial -->
  <div id="jax" class="jax" role="dialog" aria-modal="true" aria-label="Tutorial">
    <div class="panel">
      <div class="head"><div class="ava">J</div><div style="font-weight:900">JAX</div></div>
      <div id="jax-text" class="body"></div>
      <div class="actions"><button id="jax-skip" class="btn">Skip</button><button id="jax-next" class="btn">Next</button></div>
    </div>
  </div>

  <!-- Offline modal -->
  <div id="off" class="off" role="dialog" aria-modal="true" aria-label="Offline gains">
    <div class="panel">
      <h3>Welcome back! ðŸŽ’</h3>
      <div class="muted" id="off-sub"></div>
      <div id="off-list" class="list"></div>
      <div class="total"><div>Total</div><div id="off-total">0</div></div>
      <div class="actions">
        <button id="off-dismiss" class="btn">Dismiss</button>
        <button id="off-claim" class="btn">Claim</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"><div class="box" id="toast-text"></div></div>

  <script>
    (function(){
      const errEl = document.getElementById('err');
      function showErr(msg){ errEl.textContent = 'Error: ' + msg; errEl.classList.add('show'); }
      window.addEventListener('error', e => { showErr(e.message || 'Script error'); });
      window.addEventListener('unhandledrejection', e => { showErr((e.reason && e.reason.message) || 'Unhandled promise rejection'); });
    })();
  </script>

  <script>
    try{
      if(!window.__FF_VS7G__){
        window.__FF_VS7G__ = true;

        // ---- Helpers
        function deepClone(x){ try{ return structuredClone(x); }catch(_){ try{ return JSON.parse(JSON.stringify(x)); }catch(__){ return x; } } }
        const isMobile = () => /Mobi|Android/i.test(navigator.userAgent) || (window.matchMedia && window.matchMedia('(pointer:coarse)').matches);

        // ---- UI refs
        const hpEl = document.getElementById('hp-readout');
        const bulk = document.getElementById('bulk');
        const cardsRoot = document.getElementById('cards');
        const avatarBtn = document.getElementById('avatar');
        const avatarDot = document.getElementById('avatar-dot');
        const menu = document.getElementById('menu');
        const menuBody = document.getElementById('menu-body');
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toast-text');

        // Splash / Start refs
        const splash = document.getElementById('splash');
        const splashSkip = document.getElementById('splash-skip');
        const start = document.getElementById('start');
        const startBg = document.getElementById('start-bg');
        const btnNew = document.getElementById('btn-new');
        const btnContinue = document.getElementById('btn-continue');
        const startAvatars = document.getElementById('start-avatars');

        // ---- Prefs (music) ----
        const KEY_MAIN = 'ff-v1';
        const KEY_PREFS = 'ff-v1:prefs';
        function loadPrefs(){
          try{
            const raw = localStorage.getItem(KEY_PREFS);
            if(!raw) return {};
            return JSON.parse(raw) || {};
          }catch(_){ return {}; }
        }
        function savePrefs(p){ try{ localStorage.setItem(KEY_PREFS, JSON.stringify(p)); }catch(_){} }
        const prefs = Object.assign({ musicOn:true, musicVol: isMobile()? 0.03 : 0.12 }, loadPrefs());

        // ---- Music
        const Music = (()=>{
          let el = null;
          let started = false;
          function ensure(){
            if(el) return el;
            const url = isMobile() ? 'FF-fighting music (soft).mp3' : 'FF-fighting music.mp3';
            el = new Audio(url);
            el.loop = true;
            el.volume = prefs.musicVol;
            return el;
          }
          function startPlay(){
            if(!prefs.musicOn) return;
            const a = ensure();
            a.volume = prefs.musicVol;
            a.play().then(()=>{ started=true; }).catch(()=>{ /* ignore user-gesture gate until next click */ });
          }
          function stop(){
            if(!el) return;
            el.pause();
            try{ el.currentTime = 0; }catch(_){}
            started=false;
          }
          function setVol(v){
            prefs.musicVol = v;
            savePrefs(prefs);
            if(el) el.volume = v;
          }
          function setOn(b){
            prefs.musicOn = b;
            savePrefs(prefs);
            if(!b) stop(); else startPlay();
          }
          return { startPlay, stop, setVol, setOn, get vol(){return prefs.musicVol;}, get on(){return prefs.musicOn;} };
        })();

        let dirty = false;
        function markDirty(){ dirty = true; }
        function flushUI(){
          if(!dirty){ requestAnimationFrame(flushUI); return; }
          dirty = false;
          hpEl.textContent = fmt(get().hp);
          for(const id of cardRefs.keys()) updateCard(id);
          avatarDot.style.display = anyCoachAffordable() ? 'block' : 'none';
          document.body.classList.toggle('female', get().avatar === 'female');
          requestAnimationFrame(flushUI);
        }

        const OFFLINE_CAP_HOURS = 72;
        const OFFLINE_MIN_MS = 20000;

        const Exercises = [
          { id:'walk',    name:'Walking',            baseCooldownMs: 1000 },
          { id:'jog',     name:'Jogging',            baseCooldownMs: 3000 },
          { id:'sit',     name:'Sit-ups',            baseCooldownMs: 6000 },
          { id:'push',    name:'Push-ups',           baseCooldownMs: 12000 },
          { id:'jacks',   name:'Jumping Jacks',      baseCooldownMs: 24000 },
          { id:'pull',    name:'Pull-ups',           baseCooldownMs: 48000 },
          { id:'rope',    name:'Jump Rope',          baseCooldownMs: 96000 },
          { id:'plank',   name:'Plank',              baseCooldownMs: 192000 },
          { id:'mtclimb', name:'Mountain Climbers',  baseCooldownMs: 384000 },
          { id:'kb',      name:'Kettlebell',         baseCooldownMs: 768000 },
          { id:'burpee',  name:'Burpees',            baseCooldownMs: 1536000 },
          { id:'bench',   name:'Bench Press',        baseCooldownMs: 3072000 },
          { id:'backsq',  name:'Back Squat',         baseCooldownMs: 6144000 },
          { id:'dead',    name:'Deadlift',           baseCooldownMs: 12288000 },
          { id:'hand',    name:'Handstands',         baseCooldownMs: 24576000 },
          { id:'hspu',    name:'Handstand Push-ups', baseCooldownMs: 49152000 },
          { id:'muscle',  name:'Muscle-ups',         baseCooldownMs: 98304000 },
          { id:'lever',   name:'Front Lever',        baseCooldownMs: 196608000 },
          { id:'icross',  name:'Iron Cross',         baseCooldownMs: 393216000 },
          { id:'vcross',  name:'Victorian Cross',    baseCooldownMs: 786432000 },
        ];

        const coachPrice = (idx) => idx === 0 ? 1500 : Math.round(1500 * Math.pow(1.8, idx));
        const log2 = x => Math.log(x)/Math.log(2);
        const baseHP = (idx, ms) => idx===0 ? 1 : Math.round(20 * Math.pow(ms/1000, 1.10));
        const perTapHP = (b, repHP) => b + repHP;
        const repBaseCost = (b) => Math.max(4, Math.round(b * 0.05));
        const repGrowth = lvl => Math.max(1.07, Math.min(1.15, 1.07 + 0.01 * log2(Math.max(1, lvl))));
        const repCostSingle = (rb,g,rep) => rb * Math.pow(g, rep);
        const repCostBulk   = (rb,g,rep,n) => rb * Math.pow(g, rep) * ((Math.pow(g,n)-1)/(g-1));
        const nextCooldown = ms => Math.max(100, Math.floor(ms/2));
        const unlockCost = (b, ms) => Math.round(b * Math.pow(ms/1000, 0.60) * 1.15);
        const fmt = n => { if(!isFinite(n)) return '0'; const a=Math.abs(n); if(a>=1e12) return (n/1e12).toFixed(2)+'T'; if(a>=1e9) return (n/1e9).toFixed(2)+'B'; if(a>=1e6) return (n/1e6).toFixed(2)+'M'; if(a>=1e3) return (n/1e3).toFixed(2)+'K'; return String(Math.floor(n)); };

        const ACH = {
          first_steps:   { title:'First Steps',     desc:'Walking reaches Lvl 2', reward:50 },
          add_routine:   { title:'Add to Routine',  desc:'Unlock Jogging',        reward:100 },
          coach_duty:    { title:'Coach On Duty',   desc:'Hire your first coach', reward:150 },
          speed_demon:   { title:'Speed Demon',     desc:'Any cooldown â‰¤ 0.30s', reward:180 },
        };

        function defaultExercises(){
          return Exercises.map((ex, idx) => ({
            id: ex.id, unlocked: idx===0, repHP:0, repTarget:10, level:1, cooldown:ex.baseCooldownMs, lastTapAt:0
          }));
        }
        function defaults(){ return {
          schema:20,
          started:false,
          hp:0, qty:1, avatar:'male',
          exercises: defaultExercises(),
          coaches:{},
          tutorial:{ doneIntro:false, shown:{ repsHint:false, unlock:{ jog:false } } },
          achievements:{ first_steps:false, add_routine:false, coach_duty:false, speed_demon:false },
          offline:{ lastSeenAt: Date.now() },
          stats:{ manual:0, auto:0, totalEarned:0 }
        };}
        function ensureIntegrity(data){
          const byId = new Map((data.exercises||[]).map(e => [e.id, e]));
          data.exercises = Exercises.map((ex, idx) => {
            const prev = byId.get(ex.id);
            const d = {
              id: ex.id, unlocked: idx===0, repHP:0, repTarget:10, level:1, cooldown:ex.baseCooldownMs, lastTapAt:0
            };
            if(prev){ d.unlocked=!!prev.unlocked; d.repHP=prev.repHP|0; d.repTarget=prev.repTarget?prev.repTarget|0:10; d.level=prev.level?prev.level|0:1; d.cooldown=prev.cooldown?prev.cooldown|0:ex.baseCooldownMs; d.lastTapAt=prev.lastTapAt?prev.lastTapAt|0:0; }
            return d;
          });
          data.coaches = data.coaches || {};
          data.tutorial = data.tutorial || { doneIntro:false, shown:{ repsHint:false, unlock:{ jog:false } } };
          if(!data.tutorial.shown) data.tutorial.shown = { repsHint:false, unlock:{ jog:false } };
          if(!data.tutorial.shown.unlock) data.tutorial.shown.unlock = { jog:false };
          data.achievements = data.achievements || { first_steps:false, add_routine:false, coach_duty:false, speed_demon:false };
          data.offline = data.offline || { lastSeenAt: Date.now() };
          data.stats = data.stats || { manual:0, auto:0, totalEarned:0 };
          data.avatar = data.avatar==='female' ? 'female' : 'male';
          data.started = !!data.started;
          data.schema = 20;
          return data;
        }

        function load(){
          const cur = localStorage.getItem(KEY_MAIN);
          if(cur){ try{ return ensureIntegrity(JSON.parse(cur)); }catch{} }
          return defaults();
        }
        function save(s){
          try{
            const p = ensureIntegrity(deepClone(s));
            p.exercises.forEach(e => e.lastTapAt = 0);
            localStorage.setItem(KEY_MAIN, JSON.stringify(p));
          }catch(e){ /* no-op */ }
        }

        let S = load();
        document.body.classList.toggle('female', S.avatar==='female');
        const get = () => S;
        function patch(mut){ S = ensureIntegrity(mut(deepClone(S))); save(S); markDirty(); }

        function showToast(msg){ toastText.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1800); }

        // Minimal SFX beeps (placeholder for now)
        const SFX = (()=>{
          let ctx = null;
          function ensure(){ if(!ctx){ try{ ctx = new (window.AudioContext||window.webkitAudioContext)(); }catch{} } return ctx; }
          function beep(freq=440, dur=0.05){
            const c = ensure(); if(!c) return;
            const o = c.createOscillator(); const g = c.createGain();
            o.frequency.value=freq; o.type='square';
            g.gain.value=0.02;
            o.connect(g).connect(c.destination);
            o.start(); o.stop(c.currentTime+dur);
          }
          return { click(){beep(660,0.03)}, ok(){beep(520,0.05)}, deny(){beep(180,0.08)} };
        })();

        // Tutorial + Offline (same behavior)
        const jax = document.getElementById('jax'), jaxText=document.getElementById('jax-text'), jaxSkip=document.getElementById('jax-skip'), jaxNext=document.getElementById('jax-next');
        const Tutor = (() => {
          let queue = []; let active=false;
          function show(lines){ queue=lines.slice(); active=true; jax.classList.add('show'); step(); }
          function step(){ if(queue.length===0){ hide(); return; } jaxText.textContent = queue.shift(); }
          function hide(){ active=false; jax.classList.remove('show'); }
          jaxNext.addEventListener('click', step); jaxSkip.addEventListener('click', hide);
          return { show, hide, get active(){ return active; } };
        })();

        const off = document.getElementById('off');
        const offSub = document.getElementById('off-sub');
        const offList = document.getElementById('off-list');
        const offTotal = document.getElementById('off-total');
        const offClaim = document.getElementById('off-claim');
        const offDismiss = document.getElementById('off-dismiss');
        let suppressTutorialThisSession = false;

        const cardRefs = new Map();
        function createCard(idx){
          const exMeta = Exercises[idx];
          const exState = get().exercises[idx];
          if(!exMeta) return;
          if(!exState){
            patch(st => {
              const def = { id: exMeta.id, unlocked: idx===0, repHP:0, repTarget:10, level:1, cooldown:exMeta.baseCooldownMs, lastTapAt:0 };
              if(!Array.isArray(st.exercises)) st.exercises = [];
              st.exercises[idx] = def;
              return st;
            });
          }

          const card = document.createElement('div'); card.className='card';
          const tile = document.createElement('div'); tile.className='tile';
          if(!get().exercises[idx].unlocked) tile.classList.add('locked');
          const lvl  = document.createElement('div'); lvl.className='lvl'; lvl.textContent = 'Lvl ' + (get().exercises[idx].level||1);
          const tap  = document.createElement('button'); tap.className='tap-btn'; tap.textContent = get().exercises[idx].unlocked ? '+ Tap' : 'Locked';
          const repband = document.createElement('div'); repband.className='repband';
          const repfill = document.createElement('div'); repfill.className='repfill';
          const reptext = document.createElement('div'); reptext.className='reptext';
          repband.append(repfill, reptext);
          tile.append(lvl, tap, repband);

          const right = document.createElement('div');
          const title = document.createElement('div'); title.className='title'; title.textContent = exMeta.name;
          const cd = document.createElement('div'); cd.className='cooldown';
          const bar = document.createElement('div'); bar.className='bar';
          const t = document.createElement('div'); t.className='t'; t.textContent='Ready';
          cd.append(bar, t);
          const meta = document.createElement('div'); meta.className='meta';
          const left = document.createElement('div'); left.className='muted';
          const rightBtn = document.createElement('button'); rightBtn.className='btn';
          meta.append(left, rightBtn);
          right.append(title, cd, meta);
          card.append(tile, right);

          tap.addEventListener('click', () => {
            if(blocked()) return;
            const s = get(); const ex = s.exercises[idx]; if(!ex || !ex.unlocked) return;
            const now = performance.now();
            if (ex.lastTapAt>0 && now < ex.lastTapAt + ex.cooldown) { SFX.deny(); return; }
            const gain = perTapHP(baseHP(idx, exMeta.baseCooldownMs), ex.repHP);
            patch(st => { st.hp += gain; st.stats.manual++; st.stats.totalEarned+=gain; st.exercises[idx].lastTapAt = now; return st; });
            SFX.ok();
          });
          rightBtn.addEventListener('click', () => {
            if(blocked()) return;
            SFX.click();
            const s = get(); const ex = s.exercises[idx]; if(!ex) return;
            if(!ex.unlocked){
              const b = baseHP(idx, exMeta.baseCooldownMs);
              const price = unlockCost(b, exMeta.baseCooldownMs);
              if (s.hp < price) return;
              patch(st => { st.hp -= price; st.exercises[idx].unlocked = true; return st; });
              if(idx===1) maybeAchieve('add_routine');
              return;
            }
            const b = baseHP(idx, exMeta.baseCooldownMs);
            const rb = repBaseCost(b); const g = repGrowth(ex.level||1); const qty = s.qty||1;
            const price = Math.ceil(qty===1 ? repCostSingle(rb,g,ex.repHP||0) : repCostBulk(rb,g,ex.repHP||0,qty));
            if (s.hp < price) return;
            patch(st => {
              st.hp -= price;
              st.exercises[idx].repHP = (st.exercises[idx].repHP||0) + qty;
              while(st.exercises[idx].repHP >= (st.exercises[idx].repTarget||10)){
                st.exercises[idx].level = (st.exercises[idx].level||1) + 1;
                st.exercises[idx].cooldown = nextCooldown(st.exercises[idx].cooldown||exMeta.baseCooldownMs);
                st.exercises[idx].repTarget = (st.exercises[idx].repTarget||10) * 2;
              }
              return st;
            });
            if(idx===0 && (get().exercises[0].level||1) >= 2) maybeAchieve('first_steps');
            if(get().exercises.some(e => e && e.unlocked && (e.cooldown||0) <= 300)) maybeAchieve('speed_demon');
          });

          cardsRoot.append(card);
          cardRefs.set(exMeta.id, { idx, card, tile, lvl, tap, repband, repfill, reptext, cd, bar, t, left, rightBtn, title });
          updateCard(exMeta.id);
        }
        function updateCard(id){
          const r = cardRefs.get(id); if(!r) return;
          const exMeta = Exercises[r.idx];
          const ex = get().exercises[r.idx];
          r.title.textContent = exMeta ? exMeta.name : (ex && ex.id) || 'Exercise';
          if(!ex){
            r.tile.classList.add('locked');
            r.tap.textContent = 'Locked';
            r.left.textContent = 'â€”';
            r.rightBtn.textContent = 'â€”';
            r.reptext.textContent = 'â€”';
            r.repfill.style.width = '0%';
            return;
          }
          r.lvl.textContent = 'Lvl ' + (ex.level||1);

          if(!ex.unlocked){
            r.tile.classList.add('locked');
            r.tap.textContent = 'Locked';
            const b = baseHP(r.idx, exMeta.baseCooldownMs);
            const price = unlockCost(b, exMeta.baseCooldownMs);
            r.left.textContent = 'â€”';
            r.rightBtn.textContent = 'Unlock â€¢ ' + fmt(price) + ' HP';
            const afford = get().hp >= price;
            r.rightBtn.classList.toggle('glow', afford);
            r.rightBtn.classList.toggle('pulse', afford);
            r.reptext.textContent = 'â€”';
            r.repfill.style.width = '0%';
          }else{
            r.tile.classList.remove('locked');
            r.tap.textContent = '+ Tap';
            const b = baseHP(r.idx, exMeta.baseCooldownMs);
            const hpTap = perTapHP(b, ex.repHP||0);
            r.left.textContent = hpTap + ' HP / tap';
            const rb = repBaseCost(b); const g = repGrowth(ex.level||1); const qty = get().qty||1;
            const price = Math.ceil(qty===1 ? repCostSingle(rb,g,ex.repHP||0) : repCostBulk(rb,g,ex.repHP||0,qty));
            r.rightBtn.textContent = 'Reps â€¢ ' + fmt(price) + ' HP';
            r.rightBtn.classList.toggle('glow', get().hp >= price);
            r.rightBtn.classList.remove('pulse');
            r.reptext.textContent = (ex.repHP||0) + ' / ' + (ex.repTarget||10);
            const pct = Math.max(0, Math.min(100, 100 * ((ex.repHP||0) / (ex.repTarget||10))));
            r.repfill.style.width = pct + '%';
          }
        }
        function buildCards(){
          cardsRoot.innerHTML=''; cardRefs.clear();
          for(let i=0;i<Exercises.length;i++){ createCard(i); }
        }

        bulk.addEventListener('click', (e) => {
          if(blocked()) return;
          const b = e.target.closest('button'); if(!b) return;
          [...bulk.children].forEach(btn => btn.classList.toggle('active', btn === b));
          const qty = parseInt(b.dataset.q,10);
          patch(s => { s.qty = qty; return s; });
          SFX.click();
        });

        function anyCoachAffordable(){
          const s = get();
          for(let i=0;i<Exercises.length;i++){
            const ex = s.exercises[i];
            if(!ex || !ex.unlocked) continue;
            const cId = 'c'+(i+1);
            if(s.coaches[cId]) continue;
            const price = coachPrice(i);
            if(s.hp >= price) return true;
          }
          return false;
        }
        function openMenu(tab='coaches'){ if(blocked()) return; renderMenu(tab); menu.classList.add('show'); }
        function closeMenu(){ menu.classList.remove('show'); }
        avatarBtn.addEventListener('click', ()=>{ if(!blocked()) openMenu('coaches'); });
        menu.addEventListener('click', (e)=>{
          const close=e.target.closest('[data-close]'); if(close) return closeMenu();
          const tabBtn=e.target.closest('.tab');
          if(tabBtn){ [...menu.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active', b===tabBtn)); renderMenu(tabBtn.dataset.tab); }
        });

        function renderMenu(tab){
          if(tab==='coaches') return renderCoaches();
          if(tab==='settings') return renderSettings();
          if(tab==='achievements') return renderAchievements();
          menuBody.innerHTML = '<div class="muted">Coming soon.</div>';
        }
        function renderCoaches(){
          const s=get();
          const frag=document.createDocumentFragment();
          let any=false;
          for(let i=0;i<Exercises.length;i++){
            const ex = s.exercises[i];
            if(!ex || !ex.unlocked) continue;
            any=true;
            const row=document.createElement('div'); row.className='coach-row';
            const ava=document.createElement('div'); ava.className='coach-ava'; ava.textContent = i%2===0?'F':'M';
            const mid=document.createElement('div');
            const title=document.createElement('div'); title.className='coach-title'; title.textContent='Coach '+(i+1);
            const sub=document.createElement('div'); sub.className='coach-sub'; sub.textContent='Works on: '+Exercises[i].name;
            mid.append(title, sub);
            const action=document.createElement('div');
            const cId = 'c'+(i+1);
            const hired = !!s.coaches[cId];
            const price = coachPrice(i);
            if(hired){
              const span=document.createElement('span'); span.className='hired'; span.textContent='Hired'; action.append(span);
            }else{
              const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Hire â€¢ '+fmt(price)+' HP';
              if(s.hp>=price) btn.classList.add('glow');
              btn.addEventListener('click', ()=>{
                const cur=get(); if(cur.hp<price || cur.coaches[cId]) return;
                patch(st => { st.hp -= price; st.coaches[cId] = true; return st; });
                maybeAchieve('coach_duty');
                renderCoaches();
                SFX.ok();
              });
              action.append(btn);
            }
            row.append(ava, mid, action); frag.append(row);
          }
          menuBody.innerHTML='';
          if(!any){ menuBody.innerHTML='<div class="muted">Unlock an exercise to hire its coach.</div>'; }
          else menuBody.append(frag);
        }
        function renderSettings(){
          const div=document.createElement('div');
          div.innerHTML =
            '<div class="muted">Audio</div>' +
            '<div style="display:flex; align-items:center; gap:10px; margin:8px 0 16px 0">' +
              '<label><input id="music-on" type="checkbox"> Music on</label>' +
              '<label>Volume <input id="music-vol" type="range" min="0" max="1" step="0.01" style="vertical-align:middle"></label>' +
            '</div>' +
            '<div class="muted">Debug / Save</div>' +
            '<div style="height:6px"></div>' +
            '<button id="dbg5" class="btn">Simulate 5m offline</button> ' +
            '<button id="dbgShow" class="btn">Show Offline Modal Now</button> ' +
            '<button id="reset" class="btn">Reset Save</button>';
          menuBody.innerHTML=''; menuBody.append(div);

          const chk = div.querySelector('#music-on');
          const rng = div.querySelector('#music-vol');
          chk.checked = Music.on;
          rng.value = String(Music.vol);
          chk.addEventListener('change', ()=> Music.setOn(chk.checked));
          rng.addEventListener('input', ()=> Music.setVol(parseFloat(rng.value)));

          div.querySelector('#reset').addEventListener('click', ()=>{
            if(confirm('Reset your save and return to splash?')){
              try{ localStorage.removeItem(KEY_MAIN); }catch(_){}
              location.reload(); // hard return to splash
            }
          });
          div.querySelector('#dbg5').addEventListener('click', ()=>{
            patch(st => { st.offline.lastSeenAt = Date.now() - 5*60*1000; return st; });
            const sum = computeOffline();
            showOfflineModal(sum);
          });
          div.querySelector('#dbgShow').addEventListener('click', ()=>{
            const sum = computeOffline();
            showOfflineModal(sum);
          });
        }
        function renderAchievements(){
          const s=get();
          const grid=document.createElement('div');
          const makeRow=(key, data)=>{
            const row=document.createElement('div'); row.className='coach-row';
            const ava=document.createElement('div'); ava.className='coach-ava'; ava.textContent='â˜…';
            const mid=document.createElement('div');
            const title=document.createElement('div'); title.className='coach-title'; title.textContent=data.title;
            const sub=document.createElement('div'); sub.className='coach-sub'; sub.textContent=data.desc + ' â€” Reward: '+data.reward+' HP';
            mid.append(title, sub);
            const action=document.createElement('div');
            if(s.achievements[key]){ const span=document.createElement('span'); span.className='hired'; span.textContent='Completed'; action.append(span); }
            else { const span=document.createElement('span'); span.className='coach-sub'; span.textContent='Locked'; action.append(span); }
            row.append(ava, mid, action);
            return row;
          };
          grid.append(
            makeRow('first_steps', ACH.first_steps),
            makeRow('add_routine', ACH.add_routine),
            makeRow('coach_duty',  ACH.coach_duty),
            makeRow('speed_demon', ACH.speed_demon),
          );
          menuBody.innerHTML=''; menuBody.append(grid);
        }

        function maybeAchieve(key){
          const data = ACH[key]; if(!data) return;
          const s = get(); if(s.achievements[key]) return;
          patch(st => { st.achievements[key] = true; st.hp += data.reward; return st; });
          showToast(`Achievement: ${data.title}  +${data.reward} HP`);
        }

        function stampNow(){ patch(st => { st.offline.lastSeenAt = Date.now(); return st; }); }
        function computeOffline(){
          const s = get();
          const now = Date.now();
          const last = s.offline?.lastSeenAt || now;
          let ms = Math.max(0, now - last);
          const capMs = OFFLINE_CAP_HOURS * 3600 * 1000;
          const clamped = Math.min(ms, capMs);
          const list = [];
          let total = 0, totalTaps = 0;
          for(let i=0;i<Exercises.length;i++){
            const ex = s.exercises[i];
            const cId = 'c'+(i+1);
            if(!ex || !ex.unlocked) continue;
            if(!s.coaches[cId]) continue;
            if((ex.cooldown||0) <= 0) continue;
            const taps = Math.floor(clamped / ex.cooldown);
            if(taps<=0) continue;
            const gainPerTap = perTapHP(baseHP(i, Exercises[i].baseCooldownMs), ex.repHP||0);
            const gain = gainPerTap * taps;
            list.push({ name: Exercises[i].name, taps, gain });
            total += gain;
            totalTaps += taps;
          }
          return { ms, clamped, list, total, totalTaps };
        }
        function showOfflineModal(summary){
          offSub.textContent = `You were away for ${(summary.clamped/3600000).toFixed(2)} hours (capped at ${OFFLINE_CAP_HOURS}h).`;
          offList.innerHTML = '';
          if(summary.list.length===0){
            const row=document.createElement('div'); row.className='row'; row.innerHTML='<div class="muted">No coached exercises tapped while you were away.</div>';
            offList.append(row);
          }else{
            summary.list.forEach(it => {
              const row=document.createElement('div'); row.className='row';
              row.innerHTML = `<div>${it.name} â€” ${it.taps} taps</div><div>+ ${fmt(it.gain)} HP</div>`;
              offList.append(row);
            });
          }
          offTotal.textContent = '+'+fmt(summary.total)+' HP';
          off.classList.add('show');
          suppressTutorialThisSession = true;
        }
        offClaim.addEventListener('click', ()=>{
          const s = computeOffline();
          if(s.total>0){
            patch(st => { st.hp += s.total; st.stats.auto += s.totalTaps; st.stats.totalEarned += s.total; return st; });
            showToast(`Claimed +${fmt(s.total)} HP from offline`);
          }
          stampNow();
          off.classList.remove('show');
        });
        offDismiss.addEventListener('click', ()=>{
          stampNow();
          off.classList.remove('show');
        });

        window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') stampNow(); });
        window.addEventListener('pagehide', stampNow);

        function build(){ buildCards(); markDirty(); }
        build();

        requestAnimationFrame(flushUI);

        setInterval(()=>{ if(!Tutor.active && !off.classList.contains('show')) stampNow(); }, 15000);

        function tick(){
          const now = performance.now();
          const s = get();
          for(let i=0;i<Exercises.length;i++){
            const ex = s.exercises[i];
            const r = cardRefs.get(Exercises[i].id); if(!r) continue;

            if(!ex || !ex.unlocked){
              r.bar.style.width='0%';
              r.t.textContent='â€”';
              r.tile.classList.remove('cooling');
              continue;
            }

            if(!ex.lastTapAt || ex.lastTapAt === 0){
              r.bar.style.width='100%';
              r.t.textContent='Ready';
              r.tile.classList.remove('cooling');
            }else{
              const dt = Math.max(0, now - (ex.lastTapAt||0));
              const remain = Math.max(0, (ex.cooldown||0) - dt);
              if (remain<=0){ r.bar.style.width='100%'; r.t.textContent='Ready'; r.tile.classList.remove('cooling'); }
              else { const pct = 100 * (dt / (ex.cooldown||1)); r.bar.style.width = Math.max(0,Math.min(100,pct))+'%'; r.t.textContent=(remain/1000).toFixed(2)+'s'; r.tile.classList.add('cooling'); }
            }

            const ready = !ex.lastTapAt || now >= (ex.lastTapAt||0) + (ex.cooldown||0);
            const cId = 'c'+(i+1);
            if(!blocked() && s.coaches[cId] && ready){
              const gain = perTapHP(baseHP(i, Exercises[i].baseCooldownMs), ex.repHP||0);
              patch(st => { st.hp += gain; st.stats.auto++; st.stats.totalEarned+=gain; st.exercises[i].lastTapAt = now; return st; });
            }
          }
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);

        // ---------- Splash â†’ Start gating ----------
        function hasRealSave(d){
          if(d.started) return true;
          if(d.hp>0) return true;
          if(Object.keys(d.coaches||{}).length>0) return true;
          if((d.exercises||[]).some((e,i)=> i>0 && e && e.unlocked)) return true;
          if((d.exercises||[]).some(e=> e && (e.repHP||0)>0)) return true;
          return false;
        }
        function applyStartBackground(){
          const ds = start.getAttribute('data-bg-desktop') || 'FF-desktop.png';
          const ms = start.getAttribute('data-bg-mobile') || 'FF-mobile.png';
          const url = (window.innerWidth>=720 ? ds : ms);
          startBg.style.backgroundImage = `var(--start-hero-${window.innerWidth>=720?'desktop':'mobile'}), url('${url}')`;
        }
        window.addEventListener('resize', applyStartBackground);
        applyStartBackground();

        function showStart(){
          splash.classList.remove('show');
          // Always show Start after Splash; reveal Continue if save exists
          btnContinue.style.display = hasRealSave(get()) ? 'inline-block' : 'none';
          start.classList.add('show');
        }
        function hideStart(){
          start.classList.remove('show');
          splash.classList.remove('show');
          document.querySelectorAll('[aria-hidden="true"]').forEach(el=>el.setAttribute('aria-hidden','false'));
        }
        function blocked(){ return start.classList.contains('show') || splash.classList.contains('show') || Tutor.active || off.classList.contains('show'); }

        // Splash timing (â‰¥2s min, 5s auto)
        let splashMinDone = false; setTimeout(()=>{ splashMinDone = true; }, 2000);
        let splashEnded = false;
        function finishSplash(){
          if(splashEnded) return;
          if(!splashMinDone){ setTimeout(finishSplash, 250); return; }
          splashEnded = true; showStart();
        }
        const splashTimer = setTimeout(finishSplash, 5000);
        splashSkip.addEventListener('click', ()=>{ clearTimeout(splashTimer); finishSplash(); SFX.click(); });

        // Avatar select
        startAvatars.addEventListener('click', (e)=>{
          const a = e.target.closest('.ava'); if(!a) return;
          [...startAvatars.children].forEach(x=>x.classList.toggle('active', x===a));
          const sex = a.dataset.sex==='female' ? 'female' : 'male';
          patch(st => { st.avatar = sex; return st; });
          document.body.classList.toggle('female', sex==='female');
          SFX.click();
        });

        // Start buttons
        function begin(isNew){
          try{
            if(isNew){
              S = defaults(); // reset
              S.avatar = get().avatar;
              S.started = true;
              save(S); markDirty();
            }else{
              patch(st => { st.started = true; return st; });
            }
            hideStart();
            Music.startPlay(); // start background music on user gesture
            if(!Tutor.active){
              setTimeout(()=>{
                Tutor.show([ "You look a bit low on energy. Letâ€™s fix that fast ðŸ’ª", "Tap Walking to earn HP. Then weâ€™ll power up." ]);
                patch(st => { st.tutorial.doneIntro = true; return st; });
              }, 150);
            }
            showToast(isNew ? 'New Game started' : 'Continue');
          }catch(e){
            const err = document.getElementById('err'); err.textContent = 'Init Error: '+ (e.message||e); err.classList.add('show');
          }
        }
        btnNew.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); begin(true); });
        btnContinue.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); begin(false); });

        // If user clicks anywhere on Start panel, try to prime music too
        start.addEventListener('click', ()=>{ Music.startPlay(); }, { once:true });

        // Tutorial checks
        function tutorialCheck(){
          if(blocked()) return;
          if(suppressTutorialThisSession) return;
          const s = get();
          if(!s.tutorial.doneIntro){
            Tutor.show([ "You look a bit low on energy. Letâ€™s fix that fast ðŸ’ª", "Tap Walking to earn HP. Then weâ€™ll power up." ]);
            patch(st => { st.tutorial.doneIntro = true; return st; });
            return;
          }
          if(!s.tutorial.shown?.repsHint && (s.exercises[0]?.repHP||0)===0 && s.hp >= 4){
            Tutor.show([ "Great start! Use Reps to hit harder each tap.", "When the green bar fills, your cooldown halves." ]);
            patch(st => { s.tutorial.shown.repsHint = true; return s; });
            return;
          }
          const jIdx = 1; const j = s.exercises[jIdx];
          const b = baseHP(jIdx, Exercises[jIdx].baseCooldownMs);
          const price = unlockCost(b, Exercises[jIdx].baseCooldownMs);
          if(!s.tutorial.shown?.unlock?.jog && (!j || !j.unlocked) && s.hp >= price){
            Tutor.show([ "Add to your routine! Unlock Jogging when the pill turns orange." ]);
            patch(st => { st.tutorial.shown.unlock.jog = true; return st; });
            return;
          }
        }
        setInterval(()=>{ if(!Tutor.active) tutorialCheck(); }, 600);

        // Offline modal on return (only after gameplay actually started)
        (function checkReturn(){
          try{
            if(!get().started) return; // don't show while at Start
            const s = computeOffline();
            if(s.clamped >= OFFLINE_MIN_MS){ showOfflineModal(s); } else { stampNow(); }
          }catch(e){ stampNow(); }
        })();

      }
    }catch(e){
      const el = document.getElementById('err'); el.textContent = 'Init Error: ' + (e.message || e); el.classList.add('show');
    }
  </script>
</body>
</html>
