<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy â€” V1.0.2 (Mobile volume fix)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
/* ===== THEME TOKENS ===== */
:root{
  --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#9fb1c8; --border:#223556;
  --accent:#cc6b2c; --accent-hi:#ffb357; --brandBlue:#2b6cb0; --rep:#22c55e;
  --pillBg:#132647; --pillBr:#2a4a78; --space:clamp(10px,2.2vw,18px); --r:16px;
  --barH:18px; --repband:15%;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
img{max-width:100%;display:block}

/* ===== TOP BAR (STICKY) ===== */
.topbar{position:sticky;top:0;z-index:1000;background:rgba(10,19,32,.97);
  backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:1024px;margin:0 auto;padding:12px var(--space) 8px;
  display:grid;grid-template-columns:auto 1fr auto;grid-template-rows:auto auto;
  gap:10px 14px;align-items:center}
.leftRow{display:flex;align-items:center;gap:12px}
.avatarBtn{position:relative;width:56px;height:56px;border-radius:50%;
  overflow:hidden;border:2px solid #2a446c;background:#0b1626;cursor:pointer}
.avatarBtn img{width:100%;height:100%;object-fit:cover}
.notifDot{position:absolute;right:-4px;top:-4px;width:18px;height:18px;
  border-radius:50%;background:#39d98a;box-shadow:0 0 0 2px rgba(10,19,32,.97);
  display:none}
.notifDot.show{display:block}
.logoImg{height:34px;width:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
.qtyGroup{justify-self:end;display:inline-flex;border:1px solid #2b3d5a;border-radius:14px;overflow:hidden}
.qtyBtn{background:#13233b;color:#cfe0ff;border:0;padding:10px 14px;font-weight:800;cursor:pointer}
.qtyBtn.active{background:var(--accent);color:#fff}
.hpRow{grid-column:1/-1;display:flex;align-items:center;gap:12px}
.hpPill{flex:1;display:flex;align-items:baseline;gap:6px;padding:10px 16px;border-radius:999px;
  background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid var(--pillBr)}
.hpLabel{font-weight:900;color:var(--accent)}
.hpVal{font-weight:900;font-variant-numeric:tabular-nums;min-width:10ch;text-align:left}

/* ===== LAYOUT ===== */
.wrap{max-width:1024px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;
  padding:var(--space);display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;
  transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.card .left{position:relative;width:clamp(86px,18vw,112px);aspect-ratio:1;border-radius:14px;
  background:#102036;border:1px solid #223b60;display:flex;align-items:center;justify-content:center;overflow:hidden}
.card .left img{width:100%;height:100%;object-fit:cover}
.lvlBadge{position:absolute;left:6px;top:6px;background:linear-gradient(135deg,#203a63,#32578e);
  border:1px solid #4776b8;color:#fff;font-weight:900;border-radius:8px;padding:2px 6px;font-size:12px}
.coachBadge{position:absolute;right:6px;top:6px;width:22px;height:22px;border-radius:6px;overflow:hidden;border:1px solid #2b3d5a;background:#13233b;display:none}
.coachBadge img{width:100%;height:100%;object-fit:cover}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#14361f;border-top:1px solid #204e2b;display:flex;align-items:center;justify-content:center;overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repText{position:relative;font-size:12px;color:#cfead6;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.4)}

.right{display:flex;flex-direction:column;gap:6px;min-width:0}
.head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:0}
.title{font-size:clamp(16px,3.2vw,20px);margin:0}
.coolRow{display:flex;align-items:center;gap:10px}
.cool{flex:1;background:#0c1525;border:1px solid #223556;border-radius:12px;overflow:hidden}
.coolBar{height:18px;background:#101a2a;position:relative}
.coolFill{height:100%;width:100%;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-hi) 92%);position:relative}
.coolFill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.2) 0 6px,transparent 6px 12px);opacity:.65;mix-blend-mode:overlay;animation:stripe 1.2s linear infinite}
@keyframes stripe{to{background-position:60px 0}}
.coolTime{min-width:60px;text-align:right;font-variant-numeric:tabular-nums;color:#cfe0ff}
.metaRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
.kv{background:#13223a;border:1px solid #203659;border-radius:10px;padding:6px 10px;color:#cfe0ff;font-size:14px}
.chips{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.repsBtn{padding:8px 12px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
.repsBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
.repsBtn:not(.ready){background:#1a2a40;color:#d7e3f5}

/* Locked */
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.94)}
.unlockRow{display:flex;align-items:center}
.unlockPill{padding:10px 16px;border-radius:999px;background:#142743;border:1px solid #27456d;color:#ffd6a8;font-weight:900;cursor:not-allowed}
.unlockPill.ready{background:linear-gradient(135deg,var(--accent),var(--accent-hi));color:#fff;border-color:#e89d6b;cursor:pointer;box-shadow:0 12px 26px rgba(204,107,44,.35)}
.card.unlockPulse{animation:unlockPulse .9s ease-in-out infinite}
@keyframes unlockPulse{0%{transform:scale(.94)}50%{transform:scale(.955)}100%{transform:scale(.94)}}

/* Float +HP */
.float{position:fixed;left:0;top:0;transform:translate(-50%,-10px);color:#ffe6c7;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.6);animation:rise .9s ease-out forwards;pointer-events:none;z-index:2000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}

/* Banners */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);border-top:1px solid var(--pillBr);color:#fff;padding:12px 16px calc(12px + env(safe-area-inset-bottom));text-align:center;z-index:2500;animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.8s}
@keyframes bannerIn{to{transform:translateY(0)}}
@keyframes bannerOut{to{transform:translateY(10px);opacity:0}}

/* ===== MENU OVERLAY ===== */
.menuOv{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3000}
.menuOv.open{display:flex}
.panel{width:min(1024px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:18px 18px 0 0;overflow:hidden;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column}
.panelHead{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.panelTitle{font-weight:900}
.hpMini{margin-left:auto;background:#132647;border:1px solid var(--pillBr);border-radius:999px;padding:4px 10px}
.menuTabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px var(--space);border-bottom:1px solid var(--border)}
.tabBtn{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.tabBtn.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.panelBody{padding:14px var(--space);overflow:auto}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1)}
.headshot{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid #1a2f4a;background:#12243b;display:flex;align-items:center;justify-content:center}
.headshot img{width:100%;height:100%;object-fit:cover}
.cName{font-weight:900}
.cInfo{color:var(--muted);font-size:14px;margin-top:4px}
.hire{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer;background:#1a2a40;color:#d7e3f5}
.hire.ready{background:var(--accent);color:#fff}
.hire.owned{background:#198754;color:#fff}

/* ===== START / SPLASH / TUTORIAL ===== */
.splash{position:fixed;inset:0;background:#fff;z-index:5000;display:none;align-items:center;justify-content:center}
.splash.open{display:flex}
.splashInner{width:min(90vw,900px);height:min(80vh,600px);display:flex;align-items:center;justify-content:center}
.splashLogo{max-width:100%;max-height:100%;animation:splashPop 1100ms cubic-bezier(.2,1.2,.3,1);filter:drop-shadow(0 12px 34px rgba(0,0,0,.25))}
@keyframes splashPop{0%{transform:scale(.82);opacity:0}45%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}

.start{position:fixed;inset:0;z-index:4500;display:none;align-items:center;justify-content:center;background:#000}
.start.open{display:flex}
.startFrame{position:relative;z-index:1;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(10,19,32,.50);backdrop-filter:blur(6px);box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startArt{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center}
.startArt img{width:100%;height:100%;object-fit:contain}
.startUI{position:absolute;left:50%;bottom:6vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:12px;width:min(92%,680px)}
.rowBtns{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%}
.btn{padding:14px 22px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.orange{background:var(--accent);color:#fff}
.btn.blue{background:var(--brandBlue);color:#fff}
.btn.small{padding:10px 14px;font-size:18px}
.segment{display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:10px 14px;font-weight:900;cursor:pointer;font-size:22px}
.segBtn.active{background:var(--accent);color:#fff}

/* Tutorial bubble larger on mobile */
.tut{position:fixed;inset:0;z-index:4000;display:none}
.tut.show{display:block}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.22)}
.bubble{position:absolute;left:50%;bottom:8vh;transform:translateX(-50%);display:flex;flex-direction:column;gap:12px;align-items:flex-start;background:#0f1b2b;border:2px solid var(--pillBr);border-radius:18px;padding:20px 22px;max-width:min(1024px,96vw);box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tFace{width:108px;height:108px;border-radius:50%;overflow:hidden;border:2px solid #26406c;background:#0b1423;margin:0 auto}
.tFace img{width:100%;height:100%;object-fit:cover}
.tWho{font-weight:900;color:#ffd6a8;margin:6px 0 4px;text-align:center}
.tText{font-size:clamp(18px,4.6vw,22px);line-height:1.35}
.hl{color:var(--accent);font-weight:900}
.tNext{margin-top:10px;font-size:16px;color:#cfe0ff;display:flex;align-items:center;gap:10px;justify-content:center}
.chev{color:var(--accent-hi);font-size:26px}
.spot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 42px rgba(255,179,87,.45);pointer-events:none}

/* Offline modal */
.off{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3500}
.off.open{display:flex}
.offCard{width:min(520px,94vw);background:#0f1b2b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
.offTitle{margin:0 0 6px;font-weight:900}
.offAmt{font-weight:900;font-size:24px}

@media (prefers-reduced-motion: reduce){
  .coolFill::after{animation:none}
  .banner{animation:none}
}
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topwrap">
    <div class="leftRow">
      <button id="avatarBtn" class="avatarBtn" title="Menu">
        <img id="avatarImg" alt="Avatar" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Player%20Male%20GIFF.gif?raw=true">
        <span id="menuDot" class="notifDot"></span>
      </button>
      <img class="logoImg" alt="Fitness Frenzy Logo" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Logo%20(2).png?raw=true" />
    </div>
    <div class="qtyGroup" id="qtyGroup">
      <button class="qtyBtn active" data-q="1">Ã—1</button>
      <button class="qtyBtn" data-q="10">Ã—10</button>
      <button class="qtyBtn" data-q="100">Ã—100</button>
    </div>
    <div></div>
    <div class="hpRow">
      <div class="hpPill"><span class="hpLabel">HP:</span> <span id="hpTop" class="hpVal">0.00</span></div>
    </div>
  </div>
</div>

<!-- ===== CONTENT ===== -->
<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<!-- ===== MENU OVERLAY ===== -->
<div id="menuOv" class="menuOv" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHead">
      <div class="panelTitle">Menu</div>
      <div class="hpMini">HP: <span id="hpMini">0.00</span></div>
      <button id="menuClose" class="btn small" style="margin-left:auto;background:#1a2a40;color:#d7e3f5">Close</button>
    </div>
    <div class="menuTabs">
      <button class="tabBtn active" data-tab="coaches">Coaches</button>
      <button class="tabBtn" data-tab="achievements">Achievements</button>
      <button class="tabBtn" data-tab="upgrades">Upgrades</button>
      <button class="tabBtn" data-tab="quests">Side Quests</button>
      <button class="tabBtn" data-tab="stats">Stats</button>
      <button class="tabBtn" data-tab="settings">Settings</button>
    </div>
    <div class="panelBody">
      <div id="tab-coaches"></div>
      <div id="tab-achievements" style="display:none"></div>
      <div id="tab-upgrades" style="display:none">
        <div class="coachCard"><div class="cInfo">Future boosts like energy drinks, pre-workout, coffee, weighted vestsâ€¦ (placeholder).</div></div>
      </div>
      <div id="tab-quests" style="display:none">
        <div class="coachCard"><div class="cInfo">Side Quests ideas: 5K run, hike, fasting streak, buddy workoutâ€¦ (placeholder)</div></div>
      </div>
      <div id="tab-stats" style="display:none"></div>
      <div id="tab-settings" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ===== TUTORIAL ===== -->
<div id="tut" class="tut" aria-hidden="true">
  <div class="dim"></div>
  <div id="spot" class="spot" style="display:none"></div>
  <div class="bubble" id="bubble">
    <div class="tFace"><img id="tFace" alt="Trainer" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Trainer%20GIF.gif?raw=true"></div>
    <div class="tWho" id="tWho">JAX</div>
    <div class="tText" id="tText">â€¦</div>
    <div class="tNext"><span>Next</span><span class="chev">â€º</span></div>
  </div>
</div>

<!-- ===== OFFLINE MODAL ===== -->
<div id="off" class="off" aria-hidden="true">
  <div class="offCard">
    <h3 class="offTitle">Welcome back! ðŸ‘‹</h3>
    <div>You were away for <strong id="offDur">0s</strong>.</div>
    <div class="offAmt">You earned <strong id="offAmt">0.00</strong> HP while away.</div>
    <button id="offClaim" class="btn orange" style="margin-top:10px">Claim</button>
    <div id="offCapNote" style="color:#9fb1c8;margin-top:8px;display:none">Offline gains were capped for long absences.</div>
  </div>
</div>

<!-- ===== SPLASH / START ===== -->
<div id="splash" class="splash" aria-hidden="false">
  <div class="splashInner">
    <img class="splashLogo" alt="GameBros" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
  </div>
</div>

<div id="start" class="start" aria-hidden="true">
  <div class="startFrame">
    <div class="startArt"><img alt="Cover" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Cover-Art.png?raw=true"></div>
    <div class="startUI">
      <div class="rowBtns">
        <button id="btnStart" class="btn orange">Start</button>
        <button id="btnContinue" class="btn blue">Continue</button>
      </div>
      <div class="segment" id="avatarSeg">
        <button class="segBtn active" data-avatar="male" title="Male">ðŸ‘¨</button>
        <button class="segBtn" data-avatar="female" title="Female">ðŸ‘©</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   CONFIG / UTIL / BUS
   ============================================================ */
const App = {};
App.Config = Object.freeze({
  SAVE_KEY:'ff-v1', SCHEMA:1, DEC:2, MIN_CD_MS:100, NOTIFY_MS:160, UI_MS:80,
  SAVE_MS:15000, OFFLINE_CAP_MS:24*60*60*1000, PULSE_MIN_MS:5000, PULSE_MAX_MS:10000
});
const $=(q,r=document)=>r.querySelector(q), $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const el=(t,a={})=>{const n=document.createElement(t); for(const k in a){ if(k==='text')n.textContent=a[k]; else if(k==='html')n.innerHTML=a[k]; else n.setAttribute(k,a[k]); } return n;};
const Bus=(()=>{const m={}; return{on(e,f){(m[e]||(m[e]=[])).push(f)},emit(e,p){(m[e]||[]).slice().forEach(fn=>{try{fn(p)}catch{}})}}})();

const Util={
  clamp:(v,a,b)=>Math.max(a,Math.min(b,v)),
  fmtHP(n){const a=Math.abs(n),d=App.Config.DEC; if(a>=1e9)return (n/1e9).toFixed(d)+'B'; if(a>=1e6)return (n/1e6).toFixed(d)+'M'; if(a>=1e3)return (n/1e3).toFixed(d)+'K'; return n.toFixed(d);},
  fmtCost(n){const d=App.Config.DEC; if(n<1e3)return n.toFixed(d); if(n<1e6)return (n/1e3).toFixed(d)+'K'; if(n<1e9)return (n/1e6).toFixed(d)+'M'; return (n/1e9).toFixed(d)+'B';},
  now:()=>performance.now(),
  randInt:(a,b)=>Math.floor(a+Math.random()*(b-a+1)),
  inView:el=>{if(!el)return false; const r=el.getBoundingClientRect(); return r.bottom>0&&r.right>0&&r.left<innerWidth&&r.top<innerHeight;},
  isMobile:()=>/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
};

/* ============================================================
   AUDIO (music via Web Audio API GainNode)
   ============================================================ */
const MusicURL="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music.mp3?raw=true";
const AudioSys=(()=>{
  let ctx=null, gain=null, musicEl=null, srcNode=null, started=false;
  let targetGain = Util.isMobile() ? 0.02 : 0.12; // super low on mobile
  const sfxEnabled={on:true};

  function ensureCtx(){
    if(ctx) return;
    const AC = window.AudioContext||window.webkitAudioContext;
    if(!AC) return; // fallback will use element volume
    ctx=new AC();
    gain=ctx.createGain();
    gain.gain.setValueAtTime(targetGain, ctx.currentTime);
    gain.connect(ctx.destination);
  }

  function startMusic(){
    if(started) return;
    started=true;
    musicEl=new Audio(MusicURL);
    musicEl.loop=true;
    // Try routing through WebAudio (GainNode)
    try{
      ensureCtx();
      if(ctx){
        if(ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
        srcNode=ctx.createMediaElementSource(musicEl);
        srcNode.connect(gain);
        musicEl.play().catch(()=>{ started=false; });
      }else{
        // Fallback element volume (desktop reliable, mobile may clamp)
        musicEl.volume=targetGain;
        musicEl.play().catch(()=>{ started=false; });
      }
    }catch(e){
      // Safe fallback
      musicEl.volume=targetGain;
      musicEl.play().catch(()=>{ started=false; });
    }
  }

  function stopMusic(){ try{ musicEl && musicEl.pause(); }catch{} started=false; }

  function setVol(v){
    targetGain=v;
    if(gain&&ctx) gain.gain.setValueAtTime(v, ctx.currentTime);
    if(musicEl && (!ctx||!gain)) musicEl.volume=v;
  }

  // tiny synth SFX (unchanged)
  const synth=(type='sine',f=660,d=0.12,g=0.06)=>{ try{
    const AC = window.AudioContext||window.webkitAudioContext;
    const c=new AC(); const o=c.createOscillator(), q=c.createGain();
    o.type=type; o.frequency.value=f; q.gain.value=g; o.connect(q); q.connect(c.destination);
    o.start(); q.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + d); o.stop(c.currentTime + d + 0.02);
  }catch{} };

  function playSFX(h){ if(!sfxEnabled.on) return;
    if(h==='tap.ok') synth('sine',700,0.07,0.07);
    else if(h==='reps.buy') synth('square',420,0.12,0.08);
    else if(h==='unlock.do') synth('triangle',300,0.2,0.1);
    else if(h==='upgrade.apply'){ synth('square',650,0.09,0.08); setTimeout(()=>synth('square',900,0.09,0.07),90); }
    else if(h==='achievement.unlock'){ synth('square',600,0.10,0.08); setTimeout(()=>synth('square',800,0.10,0.07),110); setTimeout(()=>synth('square',1000,0.12,0.07),220); }
    else if(h.startsWith('ui.')) synth('sine',500,0.06,0.05);
  }

  // Public API
  return { play:playSFX, sfxEnabled,
    music:{ start:startMusic, stop:stopMusic, setVol:setVol },
    _ensure:ensureCtx, _ctx:()=>ctx
  };
})();

/* ============================================================
   STATE / SAVE / CONTENT (unchanged from your good build)
   ============================================================ */
const State={hp:0,qty:1,avatar:'male',stats:{manual:0,auto:0,totalEarned:0},coaches:{},achievements:{},exercises:[],tutorial:{done:false,shown:{unlock:{},coach:{},upgrade:{}}}};
function save(){ try{ localStorage.setItem(App.Config.SAVE_KEY, JSON.stringify({schema:App.Config.SCHEMA, ...State})); }catch{} }
function load(){ try{ const raw=localStorage.getItem(App.Config.SAVE_KEY); if(!raw)return; const j=JSON.parse(raw); if(j.schema===App.Config.SCHEMA) Object.assign(State,j);}catch{} } load();

const Assets={
  avatarMale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Player%20Male%20GIFF.gif?raw=true",
  avatarFemale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-PlayerFemaleGIFF.gif?raw=true",
  trainer:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Trainer%20GIF.gif?raw=true"
};

/* (â€¦snip: the long exercises + coaches arrays & full UI/Game/Engine code stay the sameâ€¦) */
/* To keep this message focused on the audio fix, Iâ€™m preserving your last working logic below, unchanged. */

const EX_URL={
  walking:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-walking.gif?raw=true",
  jogging:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-running.gif?raw=true",
  situps:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-sit-ups.gif?raw=true",
  pushups:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-push-ups.gif?raw=true",
  jacks:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-jacks.png?raw=true",
  pullups:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-pull.gif?raw=true",
  jumprope:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-jump.gif?raw=true",
  plank:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/plank.png?raw=true",
  mountain:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/mountain.png?raw=true",
  kettlebell:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-jacks.png?raw=true",
  burpees:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  bench:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  backsquat:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  deadlift:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  handstands:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  hspu:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  muscleups:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  frontlever:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  ironcross:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif",
  victoriancross:"https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/refs/heads/main/FF-walking.gif"
};

const COACH_URL=[ /* â€¦ same as before â€¦ */ 
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%205.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Clips%20(4).png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach4.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%206.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%208.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach1.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%2010%20(1).png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%207.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/coach%209.png?raw=true"
];
const COACH_NAME=[ "Stride Guide Sam","Pace Setter Jenna","Core Captain Cruz","Rep Sergeant Rex","Cardio Jackie","Bar Boss Piper","Rope Coach Rio","Plank Pro Parker","Summit Mitch","Bell Master Kira","Burpee Bruin","Spotter Ben","Depth Judge Dee","Hinge Hero Hank","Balance Bella","Inverted Ivy","Ring Raptor Max","Lever Leo","Cross Coach Iris","Victorian Victor" ];

/* ===== buildExercises, Game, Engine, UI, Banners, FX, Coaches, Notify, Menu, Achievements, Settings, Offline, Tutorial ===== */
/* (IDENTICAL to your prior working version â€” omitted here for brevity; keep your latest good code) */
/* ---------- BEGIN: same core game logic from your working build ---------- */
function buildExercises(){
  const L=[['walk','Walking',EX_URL.walking,1000],['jog','Jogging',EX_URL.jogging,3000],['sit','Sit-ups',EX_URL.situps,6000],['push','Push-ups',EX_URL.pushups,12000],['jacks','Jumping Jacks',EX_URL.jacks,24000],['pull','Pull-ups',EX_URL.pullups,48000],['rope','Jump Rope',EX_URL.jumprope,96000],['plank','Plank',EX_URL.plank,192000],['mtclimb','Mountain Climbers',EX_URL.mountain,384000],['kb','Kettlebell',EX_URL.kettlebell,768000],['burpee','Burpees',EX_URL.burpees,1536000],['bench','Bench Press',EX_URL.bench,3072000],['backsq','Back Squat',EX_URL.backsquat,6144000],['dead','Deadlift',EX_URL.deadlift,12288000],['hand','Handstands',EX_URL.handstands,24576000],['hspu','Handstand Push-ups',EX_URL.hspu,49152000],['muscle','Muscle-ups',EX_URL.muscleups,98304000],['lever','Front Lever',EX_URL.frontlever,196608000],['icross','Iron Cross',EX_URL.ironcross,393216000],['vcross','Victorian Cross',EX_URL.victoriancross,786432000]];
  const arr=[]; for(let i=0;i<L.length;i++){const [id,name,url,cd]=L[i];const sec=cd/1000;let baseHP; if(i===0) baseHP=1; else baseHP=Math.round(20*Math.pow(sec,1.10)); const repBaseCost=Math.max(4,Math.round(baseHP*0.05)); const unlockCost=(i===0)?0:Math.round(baseHP*Math.pow(sec,0.60)*1.15);
    arr.push({id,name,icon:url,baseHP,baseCooldown:cd,unlockCost,repBaseCost,
      unlocked:(State.exercises.find(e=>e.id===id)?.unlocked)??(i===0),
      repHP:State.exercises.find(e=>e.id===id)?.repHP??0,
      repProgress:State.exercises.find(e=>e.id===id)?.repProgress??0,
      repTarget:State.exercises.find(e=>e.id===id)?.repTarget??10,
      level:State.exercises.find(e=>e.id===id)?.level??1,
      cooldown:State.exercises.find(e=>e.id===id)?.cooldown??cd,
      lastTapAt:State.exercises.find(e=>e.id===id)?.lastTapAt??0,_autoElapsed:0,els:{}});
  } State.exercises=arr;
}
buildExercises();

const Game={ perTap:ex=>ex.baseHP+ex.repHP,
  repGrowth(ex){const g=1.07+0.01*Math.log2(Math.max(1,ex.level)); return Util.clamp(g,1.07,1.15);},
  repCost(ex,n=1){const g=Game.repGrowth(ex); const b=ex.repBaseCost*Math.pow(g,ex.repHP); if(n===1) return +(b.toFixed(App.Config.DEC)); return +((b*(Math.pow(g,n)-1)/(g-1)).toFixed(App.Config.DEC));},
  addHP(v){State.hp+=v; if(v>0) State.stats.totalEarned+=v; Bus.emit('hp',State.hp);},
  tap(ex,now=Util.now()){ if(!ex.unlocked) return 0; const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown); if(ex.lastTapAt>0 && now-ex.lastTapAt<cd-1){ AudioSys.play('tap.blocked'); return 0;} ex.lastTapAt=now; const g=Game.perTap(ex); Game.addHP(g); State.stats.manual++; AudioSys.play('tap.ok'); UI.floatFrom(ex.els.img||ex.els.card,`+${g.toFixed(App.Config.DEC)}`); return g;},
  buyReps(ex,n){const cost=Game.repCost(ex,n); if(State.hp+1e-6<cost) return false; Game.addHP(-cost); ex.repHP+=n; ex.repProgress+=n;
    while(ex.repProgress>=ex.repTarget){ ex.repProgress-=ex.repTarget; ex.repTarget*=2; ex.level+=1; ex.cooldown=Math.max(App.Config.MIN_CD_MS,Math.floor(ex.cooldown/2)); Banners.push(`${ex.name} upgraded to <strong>Lvl ${ex.level}</strong> â€” cooldown halved!`); AudioSys.play('upgrade.apply'); FX.confettiAt(ex.els.card); Bus.emit('upgrade',{id:ex.id,level:ex.level});}
    AudioSys.play('reps.buy'); Bus.emit('reps',{id:ex.id,qty:n}); return true;},
  unlock(ex){ if(ex.unlocked) return false; if(State.hp+1e-6<ex.unlockCost) return false; Game.addHP(-ex.unlockCost); ex.unlocked=true; ex.lastTapAt=0; AudioSys.play('unlock.do'); FX.confettiAt(ex.els.card); Bus.emit('unlock',ex.id); return true;}
};

/* (â€¦ UI / Engine / Menu / Coaches / Tutorial etc â€” identical to your working version â€¦) */
/* For brevity, the rest of the game code matches your last good file. If you need me to paste 100% again, I can, but only the AUDIO block changed. */

/* ====== SPLASH / START ====== */
function showSplashThenStart(){ const s=$('#splash'); s.classList.add('open'); setTimeout(()=>{ s.classList.remove('open'); $('#start').classList.add('open'); }, 5000); } // 5s per your spec

function wireStart(){
  const st=$('#start');
  function begin(playTutorial){
    // Ensure and resume context from user gesture before starting music (mobile requirement)
    AudioSys._ensure();
    const ctx = AudioSys._ctx();
    if(ctx && ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
    // Set device-specific volume and start
    AudioSys.music.setVol(Util.isMobile()?0.02:0.12);
    AudioSys.music.start();
    st.classList.remove('open');
    if(playTutorial && !State.tutorial.done){ Tutorial.startIntro && Tutorial.startIntro(); }
    Offline.check && Offline.check();
  }
  $('#btnStart').addEventListener('click',()=>{ AudioSys.play('ui.click'); begin(true); });
  $('#btnContinue').addEventListener('click',()=>{ AudioSys.play('ui.click'); begin(false); });
  $$('.segBtn',$('#avatarSeg')).forEach(b=>b.addEventListener('click',()=>{
    $$('.segBtn',$('#avatarSeg')).forEach(x=>x.classList.remove('active')); b.classList.add('active');
    State.avatar=b.dataset.avatar; $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale); save();
  }));
}

/* ====== TOPBAR / MENU WIRING, UI BUILD, ENGINE START ====== */
/* (same as your last working build; omitted for brevity) */

function minimalWire(){
  // qty
  const g=$('#qtyGroup'); $$('.qtyBtn',g).forEach(btn=>btn.addEventListener('click',()=>{
    $$('.qtyBtn',g).forEach(x=>x.classList.remove('active')); btn.classList.add('active'); State.qty=parseInt(btn.dataset.q,10)||1; save(); AudioSys.play('ui.click');
  }));
  // menu
  $('#avatarBtn').addEventListener('click',()=>{ $('#menuOv').classList.add('open'); $('#menuOv').setAttribute('aria-hidden','false'); AudioSys.play('ui.menu.open'); });
  $('#menuClose').addEventListener('click',()=>{ $('#menuOv').classList.remove('open'); $('#menuOv').setAttribute('aria-hidden','true'); AudioSys.play('ui.menu.close'); });
  $('#menuOv').addEventListener('click',e=>{ if(e.target.id==='menuOv'){ $('#menuOv').classList.remove('open'); $('#menuOv').setAttribute('aria-hidden','true'); }});
}

/* ====== BOOT ====== */
function boot(){
  $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);
  // (Rebuild full UI & cards using your existing UI.build etc.)
  if(typeof UI!=='undefined' && UI.build){ UI._hpShown=State.hp; UI.build(); UI.refreshThrottled(); }
  minimalWire();
  wireStart();
  showSplashThenStart();
  if(typeof Engine!=='undefined' && Engine.start) Engine.start();
  setInterval(()=>{ const v=State.hp||0; $('#hpTop').textContent=Util.fmtHP(v); $('#hpMini').textContent=Util.fmtHP(v); }, 250);
  setInterval(save, App.Config.SAVE_MS);
}
document.addEventListener('DOMContentLoaded', boot);

/* ====== MOBILE GUARDS ====== */
(function mobileGuards(){
  let lastTouch=0;
  document.addEventListener('touchend',e=>{ const n=Date.now(); if(n-lastTouch<300){ e.preventDefault(); } lastTouch=n; },{passive:false});
  document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});
  document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});
})();
</script>
</body>
</html>