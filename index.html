<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy — Tutorial Pulse Build</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{
  --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#9fb1c8; --border:#223556;
  --accent:#cc6b2c; --accent-hi:#ffb357; --brandBlue:#2b6cb0; --rep:#22c55e;
  --pillBg:#132647; --pillBr:#2a4a78; --space:clamp(10px,2vw,18px); --r:16px; --barH:18px;
}

/* Base */
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
img,video{max-width:100%;display:block}

/* Top bar */
.topbar{position:sticky;top:0;z-index:1000;background:rgba(10,19,32,.96);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:1024px;margin:0 auto;padding:10px var(--space) 6px;display:grid;grid-template-columns:auto 1fr auto;grid-template-rows:auto auto;gap:8px 12px;align-items:center}
.leftRow{display:flex;align-items:center;gap:12px}
.avatarBtn{position:relative;width:52px;height:52px;border-radius:50%;overflow:hidden;border:2px solid #2a446c;background:#0b1626;cursor:pointer}
.avatarBtn img{width:100%;height:100%;object-fit:cover}
.notifDot{position:absolute;right:-3px;top:-3px;width:14px;height:14px;border-radius:50%;background:#39d98a;box-shadow:0 0 0 2px rgba(10,19,32,.96);display:none}
.notifDot.show{display:block}
.logoImg{height:34px;width:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
.qtyGroup{justify-self:end;display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.qtyBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}
.qtyBtn.active{background:var(--accent);color:#fff}
.hpRow{grid-column:1/-1;display:flex;align-items:center;gap:12px}
.hpPill{display:flex;align-items:baseline;gap:6px;padding:10px 16px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid var(--pillBr);flex:1}
.hpLabel{font-weight:900;color:var(--accent)}
.hpVal{font-weight:900;font-variant-numeric:tabular-nums}

/* Layout + cards */
.wrap{max-width:1024px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
.card .left{position:relative;width:96px;aspect-ratio:1;border-radius:14px;background:#102036;border:1px solid #223b60;display:flex;align-items:center;justify-content:center;overflow:hidden}
.card .left img{width:100%;height:100%;object-fit:cover}
.card .left .vid{width:100%;height:100%;object-fit:cover}
.lvlBadge{position:absolute;left:6px;top:6px;background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;color:#fff;font-weight:900;border-radius:8px;padding:2px 6px;font-size:12px}
.coachDot{position:absolute;right:6px;top:6px;width:18px;height:18px;border-radius:6px;overflow:hidden;border:1px solid #2a4a78;background:#11223d;display:none}
.coachDot img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.right{display:flex;flex-direction:column;gap:6px;min-width:0}
.title{font-size:16px;margin:0}
.coolRow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.cool{background:#0c1525;border:1px solid #223556;border-radius:12px;overflow:hidden}
.coolBar{height:var(--barH);background:#101a2a;position:relative}
.coolFill{height:100%;width:100%;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-hi) 92%);position:relative}
.coolFill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.2) 0 6px,transparent 6px 12px);opacity:.65;mix-blend-mode:overlay;animation:stripe 1.2s linear infinite}
@keyframes stripe{to{background-position:60px 0}}
.coolTime{min-width:64px;text-align:right;font-variant-numeric:tabular-nums;color:#cfe0ff;font-size:14px}
.metaRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between}
.kv{background:#13223a;border:1px solid #203659;border-radius:10px;padding:6px 10px;color:#cfe0ff;font-size:13px}
.repsBtn{padding:8px 12px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
.repsBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
.repsBtn:not(.ready){background:#1a2a40;color:#d7e3f5}

/* Locked */
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.lockTitle{font-weight:800;color:#cfd8e6;margin-bottom:6px}
.unlockRow{display:flex;align-items:center;gap:8px}
.unlockPill{padding:8px 14px;border-radius:999px;background:#142743;border:1px solid #27456d;color:#ffd6a8;font-weight:900;cursor:not-allowed}
.unlockPill.ready{background:linear-gradient(135deg,var(--accent),var(--accent-hi));color:#fff;border-color:#e89d6b;cursor:pointer;box-shadow:0 12px 26px rgba(204,107,44,.35)}

/* Float +HP */
.float{position:fixed;left:0;top:0;transform:translate(-50%,-10px);color:#ffe6c7;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.6);animation:rise .9s ease-out forwards;pointer-events:none;z-index:2000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}

/* Banners */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);border-top:1px solid var(--pillBr);color:#fff;padding:12px 16px calc(12px + env(safe-area-inset-bottom));text-align:center;z-index:2500;animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.8s}
@keyframes bannerIn{to{transform:translateY(0)}} @keyframes bannerOut{to{transform:translateY(10px);opacity:0}}

/* Menu */
.menuOv{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3000}
.menuOv.open{display:flex}
.panel{width:min(1024px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:18px 18px 0 0;overflow:hidden;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column}
.panelHead{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.panelTitle{font-weight:900}
.hpMini{margin-left:auto;background:#132647;border:1px solid var(--pillBr);border-radius:999px;padding:4px 10px}
.menuTabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px var(--space);border-bottom:1px solid var(--border)}
.tabBtn{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.tabBtn.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.panelBody{padding:14px var(--space);overflow:auto}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1)}
.headshot{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid #1a2f4a;background:#12243b;display:flex;align-items:center;justify-content:center}
.headshot img{width:100%;height:100%;object-fit:cover}
.cName{font-weight:900}
.cInfo{color:var(--muted);font-size:14px;margin-top:4px}
.hire{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer;background:#1a2a40;color:#d7e3f5}
.hire.ready{background:var(--accent);color:#fff}
.hire.owned{background:#198754;color:#fff}

/* Start / Splash */
.splash{position:fixed;inset:0;background:#fff;z-index:5000;display:flex;align-items:center;justify-content:center}
.splashInner{width:min(90vw,900px);height:min(80vh,600px);display:flex;align-items:center;justify-content:center}
.splashLogo{max-width:92%;max-height:92%;animation:splashPop 1100ms cubic-bezier(.2,1.2,.3,1)}
@keyframes splashPop{0%{transform:scale(.8);opacity:.0}50%{transform:scale(1.05);opacity:1}100%{transform:scale(1)}}

.start{position:fixed;inset:0;z-index:4500;display:flex;align-items:center;justify-content:center;background:#000}
.startFrame{position:relative;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(10,19,32,.60);backdrop-filter:blur(6px);box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startArt img{width:100%;height:100%;object-fit:contain}
.startUI{position:absolute;left:50%;bottom:6vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:12px;width:min(92%,680px)}
.rowBtns{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%}
.btn{padding:14px 22px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.orange{background:var(--accent);color:#fff}
.btn.blue{background:var(--brandBlue);color:#fff}
.segment{display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:10px 14px;font-weight:900;cursor:pointer}
.segBtn.active{background:var(--accent);color:#fff}

/* Tutorial bubble (supports centered + anchored to avatar) */
.tut{position:fixed;inset:0;z-index:4000;display:none}
.tut.show{display:block}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.22)}
.bubble{position:absolute;display:flex;gap:14px;align-items:flex-start;background:#0f1b2b;border:2px solid var(--pillBr);border-radius:18px;padding:18px 20px;max-width:min(1024px,94vw);box-shadow:0 18px 36px rgba(0,0,0,.35)}
.bubble.center{left:50%;bottom:9vh;transform:translateX(-50%)}
.bubble.anchored{left:var(--bx,20px);top:var(--by,20px)}
.bubble.tip-tl{ /* visual arrow pointing from top-left edge */
  position:relative;
}
.bubble.tip-tl::before{
  content:"";position:absolute;left:10px;top:-10px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid var(--pillBr);
}
.bubble.tip-tl::after{
  content:"";position:absolute;left:10px;top:-8px;width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:9px solid #0f1b2b;
}
.tFace{width:92px;height:92px;border-radius:12px;overflow:hidden;border:1px solid #26406c;background:#0b1423;flex:none}
.tFace img{width:100%;height:100%;object-fit:cover}
.tWho{font-weight:900;color:#ffd6a8;margin-bottom:4px}
.tText{font-size:clamp(18px,3.6vw,22px);line-height:1.35}
.hl{color:var(--accent);font-weight:900}
.tNext{margin-top:10px;font-size:14px;color:#cfe0ff;display:flex;align-items:center;gap:10px}
.chev{color:var(--accent-hi);font-size:24px}
.spot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 42px rgba(255,179,87,.45);pointer-events:none}

/* Offline modal */
.off{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3500}
.off.open{display:flex}
.offCard{width:min(520px,94vw);background:#0f1b2b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
.offTitle{margin:0 0 6px;font-weight:900}
.offAmt{font-weight:900;font-size:24px}

/* Mobile adjustments */
@media (max-width: 480px){
  .card .left{width:84px}
  .title{font-size:15px}
  .coolTime{font-size:13px}
}

/* reduce motion */
@media (prefers-reduced-motion: reduce){
  .coolFill::after{animation:none}
  .banner{animation:none}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topwrap">
    <div class="leftRow">
      <button id="avatarBtn" class="avatarBtn" title="Menu">
        <img id="avatarImg" alt="Avatar" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-male.gif?raw=true">
        <span id="menuDot" class="notifDot"></span>
      </button>
      <img class="logoImg" alt="Fitness Frenzy Logo" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Logo%20(2).png?raw=true" />
    </div>
    <div class="qtyGroup" id="qtyGroup">
      <button class="qtyBtn active" data-q="1">×1</button>
      <button class="qtyBtn" data-q="10">×10</button>
      <button class="qtyBtn" data-q="100">×100</button>
    </div>
    <div></div>
    <div class="hpRow">
      <div class="hpPill"><span class="hpLabel">HP:</span> <span id="hpTop" class="hpVal">0.00</span></div>
    </div>
  </div>
</div>

<!-- CONTENT -->
<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<!-- MENU OVERLAY -->
<div id="menuOv" class="menuOv" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHead">
      <div class="panelTitle">Menu</div>
      <div class="hpMini">HP: <span id="hpMini">0.00</span></div>
      <button id="menuClose" class="btn small" style="margin-left:auto;background:#1a2a40;color:#d7e3f5">Close</button>
    </div>
    <div class="menuTabs">
      <button class="tabBtn active" data-tab="coaches">Coaches</button>
      <button class="tabBtn" data-tab="achievements">Achievements</button>
      <button class="tabBtn" data-tab="stats">Stats</button>
      <button class="tabBtn" data-tab="settings">Settings</button>
    </div>
    <div class="panelBody">
      <div id="tab-coaches"></div>
      <div id="tab-achievements" style="display:none"></div>
      <div id="tab-stats" style="display:none"></div>
      <div id="tab-settings" style="display:none"></div>
    </div>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tut" class="tut" aria-hidden="true">
  <div class="dim"></div>
  <div id="spot" class="spot" style="display:none"></div>
  <div class="bubble center tip-tl" id="bubble">
    <div class="tFace"><img id="tFace" alt="Trainer"></div>
    <div>
      <div class="tWho" id="tWho">JAX</div>
      <div class="tText" id="tText">…</div>
      <div class="tNext"><span>Next</span><span class="chev">›</span></div>
    </div>
  </div>
</div>

<!-- OFFLINE -->
<div id="off" class="off" aria-hidden="true">
  <div class="offCard">
    <h3 class="offTitle">Welcome back! 👋</h3>
    <div>You were away for <strong id="offDur">0s</strong>.</div>
    <div class="offAmt">You earned <strong id="offAmt">0.00</strong> HP while away.</div>
    <button id="offClaim" class="btn orange" style="margin-top:10px">Claim</button>
    <div id="offCapNote" style="color:#9fb1c8;margin-top:8px;display:none">Offline gains were capped for long absences.</div>
  </div>
</div>

<!-- SPLASH & START -->
<div id="splash" class="splash" aria-hidden="false">
  <div class="splashInner"><img class="splashLogo" alt="GameBros" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true"></div>
</div>

<div id="start" class="start" aria-hidden="true">
  <div class="startFrame">
    <div class="startArt"><img alt="Cover" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Cover-Art.png?raw=true"></div>
    <div class="startUI">
      <div class="rowBtns">
        <button id="btnStart" class="btn orange">New Game</button>
        <button id="btnContinue" class="btn blue" style="display:none">Continue</button>
      </div>
      <div class="segment" id="avatarSeg">
        <button class="segBtn active" data-avatar="male" title="Male">👨</button>
        <button class="segBtn" data-avatar="female" title="Female">👩</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =================== UTIL / BUS =================== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const Bus=(()=>{const m={};return{on(e,f){(m[e]||(m[e]=[])).push(f)},emit(e,p){(m[e]||[]).slice().forEach(fn=>{try{fn(p)}catch{}})}})();
const Util={now:()=>performance.now(), clamp:(v,a,b)=>Math.max(a,Math.min(b,v)), fmt(n){const d=2,a=Math.abs(n);if(a>=1e9)return(n/1e9).toFixed(d)+'B';if(a>=1e6)return(n/1e6).toFixed(d)+'M';if(a>=1e3)return(n/1e3).toFixed(d)+'K';return n.toFixed(d)}};

/* =================== AUDIO (simple SFX + music) =================== */
const MusicURL="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music%20(soft).mp3?raw=true";
const AudioSys=(()=>{let music,vol=0.15,on=false;const sfxOn={on:true};
  const synth=(t='sine',f=660,d=.12,g=.06)=>{try{const c=new (window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),q=c.createGain();o.type=t;o.frequency.value=f;q.gain.value=g;o.connect(q);q.connect(c.destination);o.start();q.gain.exponentialRampToValueAtTime(.0001,c.currentTime+d);o.stop(c.currentTime+d+.02)}catch{}};
  function sfx(h){if(!sfxOn.on)return;if(h==='tap.ok')synth('sine',700,.07,.07);
    else if(h==='reps.buy')synth('square',420,.12,.08);
    else if(h==='unlock.do')synth('triangle',300,.2,.1);
    else if(h==='upgrade.apply'){synth('square',650,.09,.08);setTimeout(()=>synth('square',900,.09,.07),90);}
    else if(h==='tutorial.show')synth('sine',520,.08,.06);
    else if(h==='tutorial.next')synth('sine',560,.06,.05);
    else if(h==='tutorial.hide')synth('sine',480,.06,.05);
    else if(h.startsWith('ui.'))synth('sine',500,.06,.05);
  }
  function start(){if(on)return;on=true;music=new Audio(MusicURL);music.loop=true;music.volume=vol;music.play().catch(()=>{on=false;});}
  function setVol(v){vol=v;if(music)music.volume=v;}
  return{play:sfx,music:{start,setVol},sfxEnabled:sfxOn};
})();

/* =================== STATE / SAVE =================== */
const App={Config:{SAVE_KEY:'ff-save',SCHEMA:1,MIN_CD_MS:100,UI_MS:80,NOTIFY_MS:160,OFFLINE_CAP_MS:24*60*60*1000}};
const State={hp:0,qty:1,avatar:'male',stats:{manual:0,auto:0,totalEarned:0},coaches:{},achievements:{},tutorial:{done:false, shown:{unlock:{}, coach:{}, upgrade:{}}},exercises:[]};
function save(){try{localStorage.setItem(App.Config.SAVE_KEY,JSON.stringify({schema:App.Config.SCHEMA,...State}))}catch{}}
(function load(){try{const raw=localStorage.getItem(App.Config.SAVE_KEY);if(!raw)return;const j=JSON.parse(raw);if(j.schema===App.Config.SCHEMA)Object.assign(State,j);}catch{}})();

/* =================== ASSETS =================== */
const Assets={
  trainer:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/fitness%20frenzy-%20coaches%20128%20x128%20test.gif?raw=true",
  avatarMale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-male.gif?raw=true",
  avatarFemale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-female.gif?raw=true"
};

/* =================== CONTENT (first 6 for demo) =================== */
const EXERCISES=[
  {id:'walk', name:'Walking', baseHP:1,   cooldown:1000, unlockCost:0, icon:'🚶'},
  {id:'jog',  name:'Jogging', baseHP:60,  cooldown:3000, unlockCost:60, icon:'🏃'},
  {id:'sit',  name:'Sit-ups', baseHP:120, cooldown:6000, unlockCost:240, icon:'🧎'},
  {id:'push', name:'Push-ups',baseHP:220, cooldown:12000,unlockCost:720, icon:'💪'},
  {id:'jacks',name:'Jumping Jacks',baseHP:480, cooldown:24000,unlockCost:2000, icon:'🤸'},
  {id:'pull', name:'Pull-ups', baseHP:900, cooldown:48000,unlockCost:6000, icon:'🏋️'}
];

/* =================== GAME CORE =================== */
const Game={
  perTap(ex){return ex.baseHP + (ex.repHP||0);},
  repGrowth(ex){const g=1.07 + 0.01*Math.log2(Math.max(1,ex.level||1));return Math.min(g,1.15);},
  repCost(ex,n=1){const g=Game.repGrowth(ex), b=(ex.repBaseCost||4)*Math.pow(g,(ex.repHP||0)); if(n===1) return +b.toFixed(2); return +((b*(Math.pow(g,n)-1)/(g-1))).toFixed(2);},
  addHP(v){State.hp+=v;if(v>0)State.stats.totalEarned+=v;Bus.emit('hp',State.hp);},
  tap(ex,now=performance.now()){
    if(!ex.unlocked)return 0; const cd=Math.max(App.Config.MIN_CD_MS, ex.cooldown);
    if(ex.lastTapAt>0 && now-ex.lastTapAt<cd-1){return 0;}
    ex.lastTapAt=now; const g=Game.perTap(ex); Game.addHP(g); State.stats.manual++; AudioSys.play('tap.ok'); UI.floatFrom(ex.els.img||ex.els.card, `+${g.toFixed(2)}`); return g;
  },
  buyReps(ex,n){const cost=Game.repCost(ex,n); if(State.hp+1e-6<cost)return false; Game.addHP(-cost);
    ex.repHP=(ex.repHP||0)+n; ex.repProgress=(ex.repProgress||0)+n;
    while(ex.repProgress>= (ex.repTarget||10)){ ex.repProgress-= (ex.repTarget||10); ex.repTarget=(ex.repTarget||10)*2; ex.level=(ex.level||1)+1; ex.cooldown=Math.max(App.Config.MIN_CD_MS, Math.floor(ex.cooldown/2)); Banners.push(`${ex.name} upgraded to <strong>Lvl ${ex.level}</strong> — cooldown halved!`); AudioSys.play('upgrade.apply'); }
    AudioSys.play('reps.buy'); Bus.emit('reps',{id:ex.id,qty:n}); return true;
  },
  unlock(ex){ if(ex.unlocked)return false; if(State.hp+1e-6<ex.unlockCost)return false; Game.addHP(-ex.unlockCost); ex.unlocked=true; ex.lastTapAt=0; AudioSys.play('unlock.do'); Bus.emit('unlock',ex.id); return true; }
};

/* =================== UI =================== */
const UI={
  _hpShown:0,
  floatFrom(ref,text){ if(!ref)return; const r=ref.getBoundingClientRect(); const sp=document.createElement('div'); sp.className='float'; sp.textContent=text; sp.style.left=(r.left+r.width/2)+'px'; sp.style.top=(r.top+r.height*0.2)+'px'; document.body.appendChild(sp); setTimeout(()=>sp.remove(),900); },
  drawCooldown(ex){ if(!ex.unlocked)return; const cd=Math.max(App.Config.MIN_CD_MS, ex.cooldown);
    if(cd<=App.Config.MIN_CD_MS){ ex.els.fill.style.width='100%'; ex.els.time.textContent=(cd/1000).toFixed(2)+'s'; return; }
    const ready=ex.lastTapAt<=0; const since=ready?cd:(performance.now()-ex.lastTapAt); const elapsed=Math.max(0, Math.min(since,cd)); const pct=elapsed/cd;
    ex.els.fill.style.width=(pct*100).toFixed(1)+'%'; ex.els.time.textContent=(elapsed/1000).toFixed(2)+'s';
  },
  tickTop(dt){ UI._hpShown += (State.hp-UI._hpShown)*Math.min(1,dt*8); $('#hpTop').textContent=Util.fmt(UI._hpShown); $('#hpMini').textContent=Util.fmt(UI._hpShown); },
  refreshExercise(ex){
    ex.els.title.textContent = ex.name;
    ex.els.kv.textContent = `${Game.perTap(ex).toFixed(0)} HP`;
    // reps
    const n=State.qty; const cost=Game.repCost(ex,n); const can=State.hp+1e-6>=cost;
    ex.els.reps.textContent = (n===1?`Reps (${Util.fmt(cost)} HP)`:`×${n} Reps (${Util.fmt(cost)} HP)`);
    ex.els.reps.classList.toggle('ready',can); ex.els.reps.disabled=!can;
    // unlock
    if(!ex.unlocked){ const canU=State.hp+1e-6>=ex.unlockCost; ex.els.pill.textContent=`Unlock for ${Util.fmt(ex.unlockCost)} HP`; ex.els.pill.classList.toggle('ready',canU); }
    // level/rep bar
    ex.els.lvl.textContent = `Lvl ${ex.level||1}`;
    ex.els.repText.textContent = `${ex.repProgress||0}/${ex.repTarget||10}`;
    ex.els.repFill.style.width = Math.min(1, (ex.repProgress||0)/(ex.repTarget||10))*100+'%';
    // coach chip visibility
    ex.els.coachDot.style.display = Coaches.isAuto(ex.id)?'block':'none';
  },
  refreshAll(){ State.exercises.forEach(UI.refreshExercise); },
  build(){
    const host=$('#stack'); host.innerHTML='';
    State.exercises.forEach(ex=>{
      const card=document.createElement('div'); card.className='card'; ex.els={card};
      const left=document.createElement('div'); left.className='left';
      const lvl=document.createElement('div'); lvl.className='lvlBadge'; ex.els.lvl=lvl;
      const coachDot=document.createElement('div'); coachDot.className='coachDot'; coachDot.innerHTML='<img alt="coach">'; ex.els.coachDot=coachDot;
      const img=document.createElement('div'); img.textContent=ex.icon; img.style.fontSize='56px'; img.style.lineHeight='1'; img.style.userSelect='none'; ex.els.img=img;
      left.append(img,lvl,coachDot);

      const right=document.createElement('div'); right.className='right';
      const title=document.createElement('h3'); title.className='title'; ex.els.title=title;
      const coolRow=document.createElement('div'); coolRow.className='coolRow';
      const cool=document.createElement('div'); cool.className='cool';
      const bar=document.createElement('div'); bar.className='coolBar';
      const fill=document.createElement('div'); fill.className='coolFill'; ex.els.fill=fill; bar.append(fill); cool.append(bar);
      const time=document.createElement('div'); time.className='coolTime'; time.textContent=(ex.cooldown/1000).toFixed(2)+'s'; ex.els.time=time;
      coolRow.append(cool,time);
      const meta=document.createElement('div'); meta.className='metaRow';
      const kv=document.createElement('div'); kv.className='kv'; ex.els.kv=kv;
      const reps=document.createElement('button'); reps.className='repsBtn'; reps.textContent='Reps'; ex.els.reps=reps;
      // rep band over icon
      const repBand=document.createElement('div'); repBand.className='repBand'; repBand.style.cssText='position:absolute;left:0;right:0;bottom:0;height:15%;background:#14361f;border-top:1px solid #204e2b;display:flex;align-items:center;justify-content:center;overflow:hidden';
      const repFill=document.createElement('div'); repFill.className='repFill'; repFill.style.cssText='position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,#22c55e)';
      const repText=document.createElement('div'); repText.className='repText'; repText.style.cssText='position:relative;font-size:12px;color:#cfead6;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.4)';
      repBand.append(repFill,repText); ex.els.repFill=repFill; ex.els.repText=repText; left.appendChild(repBand);

      meta.append(kv,reps);
      right.append(title,coolRow,meta);

      const lockTitle=document.createElement('div'); lockTitle.className='lockTitle'; lockTitle.textContent=ex.name;
      const unlockRow=document.createElement('div'); unlockRow.className='unlockRow';
      const pill=document.createElement('button'); pill.className='unlockPill'; pill.textContent='Unlock'; ex.els.pill=pill; unlockRow.append(pill);

      if(ex.unlocked){ card.append(left,right); } else { card.classList.add('locked'); card.append(left,lockTitle,unlockRow); }
      host.appendChild(card);

      left.addEventListener('pointerdown',e=>{ e.preventDefault(); if(!ex.unlocked)return; Game.tap(ex); save(); });
      reps.addEventListener('click',()=>{ if(Game.buyReps(ex,State.qty)) save(); });
      pill.addEventListener('click',()=>{ if(Game.unlock(ex)){ card.classList.remove('locked'); card.innerHTML=''; card.append(left,right); save(); }});
    });
  }
};

/* =================== Banners =================== */
const Banners={push(html){const host=$('#bannerHost');const b=document.createElement('div');b.className='banner';b.innerHTML='🎉 '+html;host.appendChild(b);setTimeout(()=>b.remove(),3200);}};

/* =================== COACHES (simple) =================== */
const Coaches={list:[],build(){Coaches.list=State.exercises.map((ex,i)=>({id:'c'+(i+1),name:['Stride Guide Sam','Pace Setter Jenna','Core Captain Cruz','Rep Sergeant Rex','Jackie Cardio','Pullup Piper'][i%6],icon:`https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c${i+1}.png?raw=true`,target:ex.id,price: i===0?1500:Math.round(1500*Math.pow(1.8,i))}));},
  isAuto(exId){return Coaches.list.some(c=>State.coaches[c.id] && c.target===exId);},
  ownedFor(exId){return Coaches.list.filter(c=>State.coaches[c.id] && c.target===exId);},
  renderTab(){const host=$('#tab-coaches');host.innerHTML='';const intro=document.createElement('div');intro.className='coachCard';intro.append(Object.assign(document.createElement('div'),{className:'cInfo',textContent:'Coaches auto-tap their exercise. No sound; cooldown respected.'}));host.appendChild(intro);
    const grid=document.createElement('div');grid.className='grid';host.appendChild(grid);
    const exBy=Object.fromEntries(State.exercises.map(e=>[e.id,e]));
    for(const c of Coaches.list){const ex=exBy[c.target];const owned=!!State.coaches[c.id];const can=State.hp+1e-6>=c.price;const unlockedTarget=!!(ex&&ex.unlocked);
      const card=document.createElement('div');card.className='coachCard'+(unlockedTarget?'':' locked');
      const head=document.createElement('div');head.className='headshot';head.append(Object.assign(document.createElement('img'),{src:c.icon,alt:c.name}));
      const mid=document.createElement('div');mid.append(Object.assign(document.createElement('div'),{className:'cName',textContent:c.name}),Object.assign(document.createElement('div'),{className:'cInfo',textContent:`Works on: ${ex?.name||c.target}`}));
      const btn=document.createElement('button');btn.className='hire';btn.textContent=owned?'Hired':`Hire • ${Util.fmt(c.price)} HP`;
      if(owned){btn.classList.add('owned');btn.disabled=true;} else if(unlockedTarget){btn.classList.toggle('ready',can);btn.disabled=!can;}
      card.append(head,mid,btn);grid.appendChild(card);
      btn.addEventListener('click',()=>{if(owned||!unlockedTarget)return; if(State.hp+1e-6<c.price)return; Game.addHP(-c.price); State.coaches[c.id]=true; save(); UI.refreshAll(); Coaches.renderTab();});
    }}};
Coaches.build();

/* =================== ENGINE LOOP =================== */
(function loop(){let last=performance.now();function tick(){const now=performance.now();const dt=Math.min(.25,(now-last)/1000);last=now;
  for(const ex of State.exercises){ if(Coaches.isAuto(ex.id)){ const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown); ex._auto = (ex._auto||0) + dt*1000; while(ex._auto>=cd){ex._auto-=cd; ex.lastTapAt=now; Game.addHP(Game.perTap(ex)); State.stats.auto++;}} UI.drawCooldown(ex);}
  UI.tickTop(dt); requestAnimationFrame(tick);} requestAnimationFrame(tick);})();

/* =================== NOTIFY DOT =================== */
const Notify=(()=>{let next=0;function coachAvail(){for(const c of Coaches.list){const ex=State.exercises.find(e=>e.id===c.target);if(!ex||!ex.unlocked)continue;if(State.coaches[c.id])continue;if(State.hp+1e-6>=c.price)return true;}return false;}
  function update(){ $('#menuDot').classList.toggle('show',coachAvail()); }
  function updateThrottled(){const now=performance.now(); if(now>=next){next=now+App.Config.NOTIFY_MS;update();}}
  Bus.on('hp',update);Bus.on('unlock',update);Bus.on('reps',update);Bus.on('upgrade',update);
  return{update,updateThrottled};
})();

/* =================== MENU =================== */
const Menu={open(){ $('#menuOv').classList.add('open'); $('#menuOv').setAttribute('aria-hidden','false'); AudioSys.play('ui.menu.open'); Coaches.renderTab(); },
  close(){ $('#menuOv').classList.remove('open'); $('#menuOv').setAttribute('aria-hidden','true'); AudioSys.play('ui.menu.close'); },
  wire(){
    $('#avatarBtn').addEventListener('click',Menu.open); $('#menuClose').addEventListener('click',Menu.close);
    $('#menuOv').addEventListener('click',e=>{if(e.target.id==='menuOv')Menu.close();});
    $$('.tabBtn',$('.menuTabs')).forEach(btn=>btn.addEventListener('click',()=>{ AudioSys.play('ui.tab.switch'); $$('.tabBtn',$('.menuTabs')).forEach(x=>x.classList.remove('active')); btn.classList.add('active');
      ['coaches','achievements','stats','settings'].forEach(t=>$('#tab-'+t).style.display=(t===btn.dataset.tab?'block':'none'));
      if(btn.dataset.tab==='coaches')Coaches.renderTab(); if(btn.dataset.tab==='stats')Menu.renderStats(); if(btn.dataset.tab==='settings')Menu.renderSettings(); if(btn.dataset.tab==='achievements')Menu.renderAchievements();
    }));
  },
  renderStats(){ $('#tab-stats').innerHTML=`<div class="coachCard"><div>
      <div><strong>Current HP:</strong> ${Util.fmt(State.hp)}</div>
      <div><strong>Total Earned:</strong> ${Util.fmt(State.stats.totalEarned||0)}</div>
      <div><strong>Manual Taps:</strong> ${State.stats.manual||0}</div>
      <div><strong>Auto Taps:</strong> ${State.stats.auto||0}</div>
      <div><strong>Exercises Unlocked:</strong> ${State.exercises.filter(e=>e.unlocked).length} / ${State.exercises.length}</div>
      <div><strong>Coaches Hired:</strong> ${Object.values(State.coaches).filter(Boolean).length} / ${Coaches.list.length}</div>
    </div></div>`;},
  renderSettings(){ const host=$('#tab-settings'); host.innerHTML=''; const card=document.createElement('div'); card.className='coachCard';
    const wrap=document.createElement('div'); wrap.innerHTML=`<div style="display:flex;flex-direction:column;gap:10px">
      <label><input id="set-sfx" type="checkbox" checked/> Sound Effects</label>
      <label>Music Volume <input id="set-music" type="range" min="0" max="1" step="0.01" value="0.15" style="width:160px;vertical-align:middle"></label>
    </div>
    <hr style="border:0;border-top:1px solid #223556;margin:10px 0">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btn-save" class="btn small" style="background:#1a2a40;color:#d7e3f5">Save</button>
      <button id="btn-reset" class="btn small" style="background:#1a2a40;color:#d7e3f5">Reset</button>
    </div>`; card.appendChild(wrap); host.appendChild(card);
    $('#set-sfx').onchange=e=>AudioSys.sfxEnabled.on=!!e.target.checked;
    $('#set-music').oninput=e=>AudioSys.music.setVol(parseFloat(e.target.value||'0.15'));
    $('#btn-save').onclick=()=>{save();AudioSys.play('ui.click');};
    $('#btn-reset').onclick=()=>{ if(confirm('Reset your progress?')){ localStorage.removeItem(App.Config.SAVE_KEY); location.reload(); } };
  },
  renderAchievements(){ $('#tab-achievements').innerHTML = `<div class="coachCard"><div class="cInfo">Achievements placeholder.</div></div>`; }
};

/* =================== OFFLINE =================== */
const Offline=(()=>{const KEY='ff-last'; const off=$('#off');
  function saveNow(){try{localStorage.setItem(KEY,Date.now().toString())}catch{}}
  function fmt(ms){let s=Math.floor(ms/1000),h=Math.floor(s/3600);s%=3600;const m=Math.floor(s/60);s%=60;const L=[];if(h)L.push(h+'h');if(m)L.push(m+'m');if(s||!L.length)L.push(s+'s');return L.join(' ');}
  function summary(ms){let sum=0; for(const ex of State.exercises){ if(!ex.unlocked)continue; if(!Coaches.isAuto(ex.id))continue; const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown); const taps=Math.floor(ms/cd); if(taps>0) sum+=taps*Game.perTap(ex);} return sum;}
  function check(){const last=parseInt(localStorage.getItem(KEY)||'0',10);const now=Date.now(); if(last>0){const delta=now-last; const cap=Math.min(delta,App.Config.OFFLINE_CAP_MS); const gain=summary(cap); if(gain>0){$('#offDur').textContent=fmt(cap); $('#offAmt').textContent=Util.fmt(gain); $('#offCapNote').style.display=(delta>cap)?'block':'none'; off.classList.add('open'); $('#offClaim').onclick=()=>{Game.addHP(gain); off.classList.remove('open'); save();};}} saveNow();}
  window.addEventListener('visibilitychange',()=>{if(document.hidden)saveNow();}); window.addEventListener('pagehide',saveNow); window.addEventListener('beforeunload',saveNow);
  return{check};
})();

/* =================== TUTORIAL (with 10s avatar pulse) =================== */
const Tutorial=(()=> {
  const ov=$('#tut'), bubble=$('#bubble'), tFace=$('#tFace'), tWho=$('#tWho'), tText=$('#tText'), spot=$('#spot');
  let step=null, idx=0, faceTimer=null; const FACE_MS=10000;

  function overlayBusy(){return ov.classList.contains('show');}
  function show(){ ov.classList.add('show'); ov.setAttribute('aria-hidden','false'); AudioSys.play('tutorial.show'); }
  function hide(){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); AudioSys.play('tutorial.hide'); hideSpot(); stopFacePulse(); }

  function restartFaceOnce(){
    if(!tFace) return;
    if(!tFace.dataset.base){
      const base=tFace.src.split('#')[0].split('?')[0];
      tFace.dataset.base = base + (/\?raw=/.test(tFace.src)?'?raw=true':'?raw=true');
    }
    tFace.src = tFace.dataset.base + '&t=' + Date.now();
  }
  function startFacePulse(){ stopFacePulse(); restartFaceOnce(); faceTimer=setInterval(()=>{ if(!overlayBusy()) return; restartFaceOnce(); }, FACE_MS); }
  function stopFacePulse(){ if(faceTimer){ clearInterval(faceTimer); faceTimer=null; } }

  function setCentered(){ bubble.classList.add('center'); bubble.classList.remove('anchored','tip-tl'); bubble.style.left='50%'; bubble.style.bottom='9vh'; bubble.style.top='auto'; bubble.style.transform='translateX(-50%)'; }
  function setAnchored(){ bubble.classList.remove('center'); bubble.classList.add('anchored','tip-tl'); positionToAvatar(); }
  function positionToAvatar(){ const av=$('#avatarBtn'); if(!av) return; const r=av.getBoundingClientRect(); const bw=bubble.offsetWidth||320, bh=bubble.offsetHeight||160; let x=r.right+12, y=r.top+6; const maxX=innerWidth-bw-8; if(x>maxX)x=Math.max(8,r.left-bw-12); if(y+bh>innerHeight-8)y=Math.max(8,innerHeight-bh-8); bubble.style.setProperty('--bx',x+'px'); bubble.style.setProperty('--by',y+'px'); bubble.style.left=x+'px'; bubble.style.top=y+'px'; bubble.style.bottom='auto'; bubble.style.transform='none'; }
  window.addEventListener('resize',()=>{ if(bubble.classList.contains('anchored')) positionToAvatar(); });
  window.addEventListener('scroll',()=>{ if(bubble.classList.contains('anchored')) positionToAvatar(); });

  function setSpeaker(who){
    tWho.textContent=who;
    stopFacePulse();
    tFace.src = (who==='JAX') ? Assets.trainer : (State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);
    if(who==='JAX') setCentered(); else setAnchored();
    startFacePulse();
  }

  function setLines(lines){ idx=0; setSpeaker(lines[0].who); tText.innerHTML=lines[0].html; show(); }
  function nextLine(lines,onDone){ if(idx<lines.length-1){ idx++; setSpeaker(lines[idx].who); tText.innerHTML=lines[idx].html; AudioSys.play('tutorial.next'); if(bubble.classList.contains('anchored')) positionToAvatar(); } else { if(onDone) onDone(); } }
  bubble.addEventListener('click',()=>{ if(step) nextLine(step.lines,step.onDone); });

  function showSpot(sel){ const node=document.querySelector(sel); if(!node){hideSpot();return;} const r=node.getBoundingClientRect(); const pad=6; spot.style.display='block'; spot.style.left=(r.left-pad)+'px'; spot.style.top=(r.top-pad)+'px'; spot.style.width=(r.width+pad*2)+'px'; spot.style.height=(r.height+pad*2)+'px';}
  function hideSpot(){ spot.style.display='none'; }

  function startIntro(){
    if(State.tutorial.doneIntro) return;
    const lines=[
      {who:'JAX',html:`You look a bit low on energy. Let's fix that <span class="hl">fast</span> 💪`},
      {who:'You',html:`Where do I start?`},
      {who:'JAX',html:`Tap <span class="hl">Walking</span> to earn <span class="hl">1 HP</span>. Then we'll power up.`}
    ];
    setLines(lines);
    step={lines,onDone(){ hide(); State.tutorial.doneIntro=true; save(); showSpot('.card[data-id="walk"] .left'); setTimeout(hideSpot,1200); }};
  }

  function maybeRepsHint(){
    if(State.tutorial.shown && State.tutorial.shown.repsHint) return false;
    const walk=State.exercises.find(e=>e.id==='walk'); if(!walk || !walk.unlocked) return false;
    if(walk.repHP>0) return false;
    if(State.hp+1e-6<4) return false;
    if(!State.tutorial.shown) State.tutorial.shown={};
    State.tutorial.shown.repsHint=true; save();
    const lines=[
      {who:'JAX',html:`Great start! Use <span class="hl">Reps</span> to hit harder each tap.`},
      {who:'You',html:`And the <span class="hl">green bar</span>?`},
      {who:'JAX',html:`When it fills, your <span class="hl">cooldown halves</span>. Big gains.`}
    ];
    setLines(lines); step={lines,onDone(){ hide(); }}; showSpot('.card[data-id="walk"] .repsBtn'); return true;
  }

  function onUpgrade(ex){
    if(State.tutorial.shown && State.tutorial.shown.upgrade && State.tutorial.shown.upgrade[ex.id]) return false;
    if(!State.tutorial.shown) State.tutorial.shown={};
    if(!State.tutorial.shown.upgrade) State.tutorial.shown.upgrade={};
    State.tutorial.shown.upgrade[ex.id]=true; save();
    const L=[{who:'JAX',html:`<span class="hl">${ex.name}</span> upgraded! Cooldown halved.`}];
    setLines(L); step={lines:L,onDone(){hide();}}; showSpot(`.card[data-id="${ex.id}"] .cool`); setTimeout(hideSpot,1500);
    return true;
  }

  function onUnlockAffordableJog(){
    const ex=State.exercises.find(e=>e.id==='jog'); if(!ex || ex.unlocked) return false;
    if(State.tutorial.shown && State.tutorial.shown.unlock && State.tutorial.shown.unlock[ex.id]) return false;
    if(State.hp+1e-6<ex.unlockCost) return false;
    if(!State.tutorial.shown) State.tutorial.shown={};
    if(!State.tutorial.shown.unlock) State.tutorial.shown.unlock={};
    State.tutorial.shown.unlock[ex.id]=true; save();
    const L=[{who:'JAX',html:`Add to your routine! Unlock <span class="hl">${ex.name}</span> when the pill turns orange.`}];
    setLines(L); step={lines:L,onDone(){hide();}}; showSpot(`.card[data-id="${ex.id}"] .unlockPill`); return true;
  }

  function onCoachAffordableFirst(){
    if(State.tutorial.shown && State.tutorial.shown.coachFirst) return false;
    const c0=Coaches.list[0]; if(!c0)return false;
    if(State.coaches[c0.id]) return false;
    const ex=State.exercises.find(e=>e.id===c0.target); if(!ex||!ex.unlocked) return false;
    if(State.hp+1e-6<c0.price) return false;
    if(!State.tutorial.shown) State.tutorial.shown={};
    State.tutorial.shown.coachFirst=true; save();
    const L=[{who:'JAX',html:`Ready to scale? Open the <span class="hl">Menu</span> (your avatar) and <span class="hl">Hire</span> a coach.`}];
    setLines(L); step={lines:L,onDone(){hide();}}; showSpot('#avatarBtn'); return true;
  }

  function scanAll(){ if(overlayBusy()) return; if(maybeRepsHint()) return; if(onUnlockAffordableJog()) return; if(onCoachAffordableFirst()) return; }

  Bus.on('upgrade',({id})=>{const ex=State.exercises.find(e=>e.id===id); if(ex) onUpgrade(ex);});
  Bus.on('hp',()=>{ if(!overlayBusy()) scanAll(); });

  return {startIntro,scanAll};
})();

/* =================== BOOT / START =================== */
function wireTopbar(){
  const g=$('#qtyGroup'); $$('.qtyBtn',g).forEach(btn=>btn.addEventListener('click',()=>{ $$('.qtyBtn',g).forEach(x=>x.classList.remove('active')); btn.classList.add('active'); State.qty=parseInt(btn.dataset.q,10)||1; save(); AudioSys.play('ui.click'); UI.refreshAll(); }));
}
function wireMenu(){ Menu.wire(); }
function showSplashThenStart(){ const s=$('#splash'); setTimeout(()=>{ s.style.display='none'; const hasSave=!!localStorage.getItem(App.Config.SAVE_KEY); if(hasSave) $('#btnContinue').style.display='block'; $('#start').style.display='flex'; }, 5000); }
function wireStart(){
  $('#btnStart').addEventListener('click',()=>{ localStorage.removeItem(App.Config.SAVE_KEY); location.reload(); });
  $('#btnContinue').addEventListener('click',()=>{ $('#start').style.display='none'; AudioSys.music.setVol(0.15); AudioSys.music.start(); Offline.check(); });
  $$('.segBtn',$('#avatarSeg')).forEach(b=>b.addEventListener('click',()=>{ $$('.segBtn',$('#avatarSeg')).forEach(x=>x.classList.remove('active')); b.classList.add('active'); State.avatar=b.dataset.avatar; $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale); save(); }));
}

function initExercises(){
  // create exercise state from EXERCISES
  State.exercises = EXERCISES.map((e,i)=>({
    id:e.id,name:e.name,icon:e.icon, baseHP:e.baseHP, cooldown:e.cooldown, unlockCost:e.unlockCost,
    repBaseCost: Math.max(4, Math.round(e.baseHP*0.05)),
    unlocked: i===0, repHP:0, repProgress:0, repTarget:10, level:1, lastTapAt:0, els:{}
  }));
}

function boot(){
  $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);
  initExercises();
  UI._hpShown=State.hp; UI.build(); UI.refreshAll(); wireTopbar(); wireMenu(); wireStart(); showSplashThenStart(); Coaches.build();
  // draw loop UI
  (function uiLoop(){ const step=()=>{ State.exercises.forEach(UI.drawCooldown); Notify.updateThrottled(); requestAnimationFrame(step)}; requestAnimationFrame(step); })();
  // start tutorial only for brand-new runs
  if(!State.tutorial.done) { setTimeout(()=>{ Tutorial.startIntro(); }, 600); }
  // keep mini HP fresh in menu
  setInterval(()=>{ $('#hpMini').textContent=Util.fmt(State.hp); }, 400);
  // Music will start when Continue pressed (and when New Game restarts)
}

document.addEventListener('DOMContentLoaded', boot);

/* Mobile dbl-tap guard */
document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});
document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});
</script>
</body>
</html>
