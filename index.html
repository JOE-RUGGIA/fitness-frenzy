<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Fitness Frenzy</title>
<style>
:root{
  --bg:#0f1421; --bg2:#0b1220;
  --ink:#eaf1fb; --muted:#9fb0c6;
  --card:#152136; --edge:rgba(255,255,255,.06);
  --accent:#ff7a1a; --accent2:#ffc38f;
  --good:#2dd36f; --warn:#ffd166;
}
*{box-sizing:border-box} html,body{height:100%}
html{-webkit-text-size-adjust:100%}
body{
  margin:0;color:var(--ink);
  font:16px/1.45 system-ui, Segoe UI, Arial;
  background:
    radial-gradient(900px 600px at -10% -20%,rgba(58,160,255,.15),transparent),
    radial-gradient(1000px 700px at 110% 10%,rgba(255,122,26,.10),transparent),
    linear-gradient(180deg,var(--bg),var(--bg2));
  -webkit-tap-highlight-color: transparent;
  padding-bottom: env(safe-area-inset-bottom);
}
button, input, select{font:inherit}
input[type=range]{accent-color:var(--accent)}
.wrap{max-width:1140px;margin:16px auto 110px;padding:0 14px}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;flex-wrap:wrap}
.hp{
  flex:0 1 auto;
  font:900 clamp(24px,4.2vw,36px)/1 system-ui;
  min-width: clamp(180px,30vw,260px);
  text-overflow:ellipsis;white-space:nowrap;overflow:hidden;
  text-shadow:0 6px 22px rgba(0,0,0,.35)
}
.hp small{font-weight:800;opacity:.9;background:rgba(255,255,255,.08);padding:.16em .45em;border-radius:.35em;margin-left:.45rem}
.row{flex:1 1 auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.btn{
  border:1px solid var(--edge);border-radius:12px;padding:8px 12px;font-weight:800;background:#0f1926;color:#fff;cursor:pointer;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:80px
}
.btn.active{background:var(--accent);color:#1b0e03;border-color:transparent}
.iconbtn{display:inline-flex;align-items:center;gap:6px}
.pill{display:flex;align-items:center;gap:8px;background:#0f1926;border-radius:12px;padding:6px 8px;border:1px solid var(--edge)}
.pill label{font-weight:800;color:#d7e3f6;font-size:12px}
.toggle{background:#0e1724;border-radius:10px;padding:6px 10px;font-weight:800}

/* Missions / Week */
.mission{
  display:flex;align-items:center;gap:10px;margin:6px 0 10px;
  background:#111a2b;border:1px solid var(--edge);border-radius:12px;padding:10px;
}
.mission h2{margin:0;font:900 16px/1.1 system-ui}
.msub{color:#cfe0ff;font-size:12px}
.mbar{flex:1;height:12px;background:#0b1219;border-radius:8px;overflow:hidden;position:relative}
.mbar i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--good),#9cffbd)}
.mgoal{font-weight:900;color:#bfe0ff}

/* Ribbon + Confetti */
.ribbon{position:fixed;top:-60px;left:50%;transform:translateX(-50%);
  background:#152136;border:1px solid var(--edge);color:#eaf1fb;
  padding:10px 16px;border-radius:999px;font-weight:900;z-index:120;
  box-shadow:0 14px 32px rgba(0,0,0,.4)}
.ribbon.show{animation:slideDown .28s ease forwards, slideUp .36s ease 2.7s forwards}
@keyframes slideDown{to{top:14px}} @keyframes slideUp{to{top:-60px}}
#confetti{pointer-events:none;position:fixed;inset:0;z-index:110}

/* Cards */
.card{
  position:relative;background:var(--card);border-radius:14px;padding:10px;margin:10px 0;
  box-shadow:0 10px 22px rgba(0,0,0,.36), inset 0 0 0 1px var(--edge);
  display:grid;grid-template-columns:160px 1fr 360px;gap:10px;align-items:center;min-height:140px;
}
@media (max-width:900px){
  .card{grid-template-columns:140px 1fr;min-height:150px}
  .actions{grid-column:1/-1}
}
@media (max-width:680px){
  .card{grid-template-columns:1fr;gap:8px;padding:12px}
}

/* Avatar */
.avatarbtn{
  position:relative;display:grid;place-items:center;width:100%;height: clamp(92px,22vw,110px);
  border-radius:14px;border:2px dashed #7ff2b0;background:linear-gradient(180deg,#0c1e16,#0f271a);color:#cffff1;
  cursor:pointer;user-select:none;overflow:hidden;z-index:5;transition:box-shadow .15s ease, transform .06s ease;
  touch-action: manipulation;
}
.avatarbtn:active{transform:translateY(1px)}
.avatarbtn.ready{box-shadow:0 0 0 3px rgba(39,210,103,.25) inset}
.avatarbtn.needGlow{animation:needBlink 1.1s ease-in-out infinite}
@keyframes needBlink{
  0%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
  50%{box-shadow:0 0 14px 2px rgba(58,160,255,.35),0 0 0 4px rgba(255,122,26,.18) inset}
  100%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
}
.unlockPulse{animation:unlockPulse 1.05s ease-in-out infinite}
@keyframes unlockPulse{0%{box-shadow:0 0 0 0 rgba(255,122,26,.0)}50%{box-shadow:0 0 16px 2px rgba(255,122,26,.6)}100%{box-shadow:0 0 0 0 rgba(255,122,26,.0)}}
.emoji{font-size: clamp(48px,10vw,64px);display:block;filter:drop-shadow(0 4px 7px rgba(0,0,0,.35))}
.avatarbtn.animate .emoji{animation:bop .22s ease} /* NOTE: sprites do NOT bop */
@keyframes bop{0%{transform:scale(.94) rotate(-2deg)}50%{transform:scale(1.12) rotate(2deg)}100%{transform:scale(1)}}
.avatarbtn img{width: clamp(64px,14vw,86px);height: clamp(64px,14vw,86px);image-rendering:pixelated;max-width:100%}

/* Badges / Locks */
.badge{position:absolute;top:8px;left:8px;background:#20314f;color:#bfe0ff;border:1px solid var(--edge);font-weight:900;padding:.2em .5em;border-radius:999px}
.locked .emoji,.locked img{filter:blur(8px) grayscale(.25) drop-shadow(0 4px 7px rgba(0,0,0,.35))}
.lockOverlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.22);font-weight:900;color:#ffddb5;letter-spacing:.4px}
.lockOverlay span{background:rgba(0,0,0,.22);padding:.2em .6em;border-radius:999px;border:1px solid var(--edge)}

/* Meta + Cooldown (striped orange) */
.meta h3{margin:0 0 2px;font:800 clamp(16px,3.8vw,18px)/1.1 system-ui;max-height:22px;overflow:hidden}
.meta .sub{color:var(--muted);font-size: clamp(11px,3.2vw,12px);max-height:18px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.bar{height: clamp(12px,3.4vw,14px);background:#0b1219;border-radius:8px;overflow:hidden;margin-top:8px;position:relative}
.bar i{
  display:block;height:100%;width:0;
  background:
    repeating-linear-gradient(45deg, rgba(0,0,0,.06) 0 10px, rgba(0,0,0,.14) 10px 20px),
    linear-gradient(90deg,var(--accent),var(--accent2));
  background-size:24px 100%, auto; animation:stripe 1.2s linear infinite;
}
@keyframes stripe{from{background-position:0 0,0 0}to{background-position:24px 0,0 0}}
.bar.ready{box-shadow:0 0 0 2px rgba(45,211,111,.3) inset}

/* Actions */
.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-self:stretch}
@media (max-width:680px){ .actions{grid-template-columns:1fr} }
.actions .btn{height:44px;display:flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.action{background:linear-gradient(180deg,#ff8b3a,#ff7a1a);color:#1b0e03;border-color:transparent;position:relative}
.secondary{background:#0e1724;color:#fff;border:1px solid var(--edge);position:relative}
.action[disabled],.secondary[disabled]{opacity:.5;cursor:not-allowed}

/* Glitter sheen on affordable (applies only when enabled & affordable) */
.glitter.available::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.18) 25%, rgba(255,255,255,.35) 33%, transparent 45%);
  transform:translateX(-120%); filter:blur(.6px);
  animation:shine 1.15s ease-in-out infinite;
}
@keyframes shine{0%{transform:translateX(-120%)}60%{transform:translateX(0%)}100%{transform:translateX(120%)}}

/* Coach */
.coachBtn{display:flex;align-items:center;justify-content:center;gap:10px}
.coachFace{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;background:#1c2a44;border:1px solid var(--edge);font-size:26px;flex:0 0 52px}
.coachActive{background:#172b1f;border-color:#2dd36f;color:#b8ffd1}
.dot{width:10px;height:10px;border-radius:50%;background:#2dd36f;box-shadow:0 0 10px #2dd36f}
.dot.pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(39,210,103,.35)}70%{box-shadow:0 0 0 10px rgba(39,210,103,0)}100%{box-shadow:0 0 0 0 rgba(39,210,103,0)}}

/* Intro modal */
body.intro-open{overflow:hidden}
#intro{
  position:fixed;inset:0;z-index:999;display:grid;place-items:center;background:rgba(8,12,20,.65);backdrop-filter:blur(10px);
  opacity:1;visibility:visible;transition:opacity .25s ease,visibility .25s ease
}
#intro.off{opacity:0;visibility:hidden;pointer-events:none}
.introCard{width:min(720px,92vw);background:#141f34;border:1px solid var(--edge);border-radius:16px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.introCard h1{margin:0 0 6px;font:900 clamp(22px,6vw,28px)/1.1 system-ui}
.introRow{display:flex;gap:12px;flex-wrap:wrap}
.introStep{background:#0f1928;border:1px solid var(--edge);border-radius:12px;padding:10px;flex:1;min-width:200px}
.startBtn{margin-top:12px;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#ff8b3a,#ff7a1a);border:0;border-radius:12px;color:#1b0e03;font-weight:900;padding:10px 14px;cursor:pointer}

/* Sticky mobile footer */
.footer{
  position:fixed;left:0;right:0;bottom:0;z-index:1000;
  display:none;gap:10px;align-items:center;justify-content:space-between;
  padding:10px max(10px, env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
  background:rgba(15,21,33,.85); backdrop-filter: blur(10px);
  border-top:1px solid var(--edge);
}
.footer .group{display:flex;gap:8px;align-items:center}
.footer .btn{min-width:64px}
.footer input[type=range]{width:min(42vw,220px)}
@media (max-width:820px){ .footer{display:flex} .wrap{margin-bottom:160px} }

/* Tutorial highlights */
.tutor{
  position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:1500;
}
.tutor.on{display:grid}
.tcard{background:#13203a;border:1px solid var(--edge);border-radius:12px;padding:14px;max-width:92vw;box-shadow:0 16px 44px rgba(0,0,0,.6)}
.tcard b{color:#fff}
.tfinger{position:absolute;width:64px;height:64px;transform:translate(-50%,-50%);pointer-events:none;filter:drop-shadow(0 8px 20px rgba(0,0,0,.5))}
</style>
</head>
<body class="intro-open">
<canvas id="confetti"></canvas>

<!-- INTRO -->
<div id="intro">
  <div class="introCard">
    <h1>Fitness Frenzy</h1>
    <p class="hint">Earn <b>HP (Health Points)</b> by tapping exercises. Upgrade them, hire coaches (auto-tap), and unlock stronger moves. The orange striped bar shows cooldown.</p>
    <div class="introRow">
      <div class="introStep">üëü <b>Tap</b> when a card glows.</div>
      <div class="introStep">üßë‚Äçüè´ <b>Coaches</b> auto-tap (and earn while you‚Äôre away!).</div>
      <div class="introStep">üìÜ <b>Weeks</b> (levels): finish Week goals to progress.</div>
    </div>
    <button class="startBtn" id="startGame" onclick="startGame()">Start Workout ‚ñ∂</button>
  </div>
</div>

<div class="wrap" aria-live="polite">
  <header>
    <div class="hp" id="hp">0.00 <small>HP</small></div>

    <div class="row" id="topControls">
      <div class="btn active" data-m="1">x1</div>
      <div class="btn" data-m="10">x10</div>
      <div class="btn" data-m="100">x100</div>
      <div class="btn" data-m="max">xMAX</div>

      <div class="pill">
        <label>‚ô™ Music</label>
        <button class="btn toggle" id="muteBtn">Mute</button>
        <label for="vol" class="hint">Vol</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.25" style="width:120px">
      </div>

      <button class="btn" id="share">Share</button>
      <button class="btn" id="new">New Game</button>
    </div>
  </header>

  <!-- Mission / Week tracker -->
  <div class="mission" id="mission">
    <div>
      <h2 id="mTitle">Week 1: Foundation</h2>
      <div class="msub" id="mSub">Goal: Unlock <b>Weight Lifting</b> & any Coach to <b>Lv.2</b></div>
    </div>
    <div class="mbar"><i id="mProg"></i></div>
    <div class="mgoal" id="mGoal">0/2</div>
  </div>

  <div id="list"></div>
</div>

<!-- Sticky mobile footer controls -->
<div class="footer" id="footer">
  <div class="group">
    <div class="btn" data-m="1">x1</div>
    <div class="btn" data-m="10">x10</div>
    <div class="btn" data-m="100">x100</div>
    <div class="btn" data-m="max">xMAX</div>
  </div>
  <div class="group">
    <button class="btn toggle" id="muteBtn2">Mute</button>
    <input id="vol2" type="range" min="0" max="1" step="0.01" value="0.25">
  </div>
</div>

<!-- Tutorial overlay -->
<div class="tutor" id="tutor">
  <img class="tfinger" id="tfinger" alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text x='8' y='48' font-size='40'>üëâ</text></svg>">
  <div class="tcard" id="tcard">Tip</div>
</div>

<div class="ribbon" id="ribbon">üéâ Unlocked!</div>
<audio id="bgm" preload="auto" loop crossorigin="anonymous"></audio>

<script>
/* ========= STATIC PATHS ========= */
const RAW_BASE = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/";
const MUSIC_URL = RAW_BASE + "Velvet%20Haze%20-%20Take%20a%20Seat%20-%20Instrumental%20version.mp3";

/* ========= EXERCISES (Week 1 set) ========= */
const EX=[ // id,name,emoji,set,gain,interval,baseCost,mult,coachCost,unlock,week
  ["walk","Walking","üëü","0.25 miles",1,0.5,6,1.18,  300,    0, 1],
  ["jog","Jogging","üèÉ‚Äç‚ôÇÔ∏è","0.5 miles",7,2.0,40,1.19, 1200,   40, 1],
  ["yoga","Yoga","üßò‚Äç‚ôÇÔ∏è","2 min flow",30,3.0,220,1.20, 6000,  120,1],
  ["cycle","Cycling","üö¥‚Äç‚ôÇÔ∏è","1.2 miles",120,6.5,1200,1.21,20000, 600,1],
  ["lift","Weight Lifting","üèãÔ∏è‚Äç‚ôÇÔ∏è","20 reps",520,9.0,6800,1.22,80000,  2200,1], // Week 1 "final"
];

/* Teaser big goal (later) */
const BIG_GOAL = { id:"ult", name:"Ultimate Trainer", emoji:"üèÜ", tease:"All exercises x10 ‚Ä¢ Global auto-click", unlockHp: 5_000_000 };

/* SPRITES: walking demo uses your bike frames for now */
const SPRITES = { walk: ["bike1.png","bike2.png","bike3.png"].map(f=>RAW_BASE+f) };

/* ========= STATE ========= */
const STORAGE="ff_core_levels_v1";
let state={
  hp:0, multi:1, items:{}, level:1,
  firstSteps:{taps:0, done:false},
  lastSeen: Date.now(),
  streak:{lastDay:null, count:0},
  tut:{tap:false, up:false, coach:false}
};
const tmp={}; // timers, frames, anim

/* ========= QS ========= */
const $=s=>document.querySelector(s), id=s=>document.getElementById(s);
const now=()=>performance.now()/1000;

/* ========= FORMATTERS ========= */
function fmtHP(n){
  const a=Math.abs(n);
  const d=v=>v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  if(a>=1e9) return d(n/1e9)+"B";
  if(a>=1e6) return d(n/1e6)+"M";
  if(a>=1e3) return d(n/1e3)+"K";
  return d(n);
}
function fmtCost(n){
  n=Math.floor(n); const a=Math.abs(n);
  const f=v=>Number.isInteger(v)?v.toString():v.toFixed(1).replace(/\.0$/,'');
  if(a>=1e9) return f(n/1e9)+"B";
  if(a>=1e6) return f(n/1e6)+"M";
  if(a>=1e3) return f(n/1e3)+"K";
  return String(n);
}

/* ========= CONFETTI + RIBBON ========= */
const cf=id("confetti"); const cfx=cf.getContext("2d"); let confetti=[],confTimer=null;
function fireConfetti(n=140){cancelAnimationFrame(confTimer);const W=cf.width=innerWidth,H=cf.height=innerHeight;confetti=Array.from({length:n},()=>({x:Math.random()*W,y:-10,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,s:2+Math.random()*4,c:`hsl(${Math.random()*360},90%,60%)`,r:Math.random()*Math.PI}));(function loop(){cfx.clearRect(0,0,W,H);confetti.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.r+=.1;cfx.save();cfx.translate(p.x,p.y);cfx.rotate(p.r);cfx.fillStyle=p.c;cfx.fillRect(-p.s/2,-p.s/2,p.s,p.s);cfx.restore();});confTimer=requestAnimationFrame(loop); if(confetti.every(p=>p.y>H+20)) cancelAnimationFrame(confTimer);})();}

function showRibbon(text){const rb=$("#ribbon");rb.textContent=text;rb.classList.remove("show");void rb.offsetWidth;rb.classList.add("show");fireConfetti(180); s_cheer();}

/* ========= AUDIO ========= */
const bgm=id("bgm"); bgm.src=MUSIC_URL; bgm.volume=Number($("#vol").value); let isPlaying=false;
function syncVolumeUIs(v){ id("vol").value=v; id("vol2").value=v; }
id("vol").addEventListener("input",e=>{ bgm.volume=Number(e.target.value); id("vol2").value=e.target.value; });
id("vol2").addEventListener("input",e=>{ bgm.volume=Number(e.target.value); id("vol").value=e.target.value; });
function syncMuteUIs(){ const t=bgm.muted?"Unmute":"Mute"; id("muteBtn").textContent=t; id("muteBtn2").textContent=t; }
id("muteBtn").addEventListener("click",()=>{ bgm.muted=!bgm.muted; syncMuteUIs(); });
id("muteBtn2").addEventListener("click",()=>{ bgm.muted=!bgm.muted; syncMuteUIs(); });

let AC=null, master=null, noiseBuf=null;
function ensureAC(){ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; AC=new C(); master=AC.createGain(); master.gain.value=.95; master.connect(AC.destination); noiseBuf=mkNoise(.18); }
function mkNoise(sec){const n=AC.sampleRate*sec,b=AC.createBuffer(1,n,AC.sampleRate),a=b.getChannelData(0);for(let i=0;i<n;i++)a[i]=Math.random()*2-1;return b;}
function s_step(){ ensureAC(); const t=AC.currentTime; const src=AC.createBufferSource(); src.buffer=noiseBuf; const bp=AC.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=220; bp.Q.value=0.6; const g=AC.createGain(); g.gain.value=.20; src.connect(bp); bp.connect(g); g.connect(master); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(.20,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.12); src.start(t); src.stop(t+.14);}
function coin(){ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="square";o.frequency.value=920;o.connect(g);g.connect(master);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.22,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.22);o.start(t);o.stop(t+.24);}
function sparkle(){ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="triangle";o.frequency.value=1500;o.connect(g);g.connect(master);g.gain.setValueAtTime(.16,t);g.gain.exponentialRampToValueAtTime(.0001,t+.22);o.start(t);o.stop(t+.24);}
function s_cheer(){ // louder cheer so it's clearly audible
  ensureAC(); const t=AC.currentTime;
  const ns=AC.createBufferSource(); ns.buffer=noiseBuf;
  const hp=AC.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=420;
  const g1=AC.createGain(); g1.gain.value=.35; ns.connect(hp); hp.connect(g1); g1.connect(master);
  g1.gain.setValueAtTime(0,t); g1.gain.linearRampToValueAtTime(.35,t+.02); g1.gain.exponentialRampToValueAtTime(.0001,t+.6);
  ns.start(t); ns.stop(t+.62);
  const blip=(f,dt,amp=.22)=>{const o=AC.createOscillator(),g=AC.createGain();o.type="triangle";o.frequency.value=f;o.connect(g);g.connect(master);g.gain.setValueAtTime(amp,t+dt);g.gain.exponentialRampToValueAtTime(.0001,t+dt+.3);o.start(t+dt);o.stop(t+dt+.32);};
  blip(660,0.02); blip(990,0.02,.20); blip(1320,0.03,.18); setTimeout(sparkle,160);
}

/* ========= SAVE/LOAD ========= */
function load(){
  try{const raw=localStorage.getItem(STORAGE); if(raw){ const parsed=JSON.parse(raw); state=Object.assign(state,parsed);} }catch{}
  EX.forEach(([eid],i)=>{
    if(!state.items[eid]) state.items[eid]={lvl:i?0:1,unlocked:!i,coach:false,coachLevel:0,taps:0};
    tmp[eid]={next:0,frame:0,timer:null,frames:[],useEmoji:true,animTimer:null,animLoop:false};
  });
}
function save(){ state.lastSeen = Date.now(); localStorage.setItem(STORAGE,JSON.stringify(state)); }
function newGame(){ localStorage.removeItem(STORAGE); state={hp:0,multi:1,items:{},level:1,firstSteps:{taps:0,done:false},lastSeen:Date.now(),streak:{lastDay:null,count:0},tut:{tap:false,up:false,coach:false}}; load(); build(); renderAll(); }

/* ========= OFFLINE GAINS ========= */
function grantOffline(){
  const then = state.lastSeen || Date.now();
  const ms = Math.max(0, Date.now()-then);
  const sec = Math.floor(ms/1000);
  if(sec<5) return;
  let perSec = 0;
  EX.forEach(([eid,, , , gain, interval])=>{
    const it=state.items[eid]; if(it?.coach){
      const perTap = Math.floor(gain*Math.max(1,it.lvl));
      const speed = coachSpeed(interval,it.coachLevel||1);
      perSec += (perTap/speed);
    }
  });
  const gain = Math.floor(perSec * sec);
  if(gain>0){ state.hp += gain; showRibbon(`üí§ Offline gains: +${fmtCost(gain)} HP`); }
}

/* ========= DAILY STREAK ========= */
function dailyStreak(){
  const today = new Date(); today.setHours(0,0,0,0);
  const todayKey = today.getTime();
  if(state.streak.lastDay===todayKey) return;
  const last = state.streak.lastDay;
  if(last && todayKey - last === 86400000){ state.streak.count = Math.min(state.streak.count+1,7); }
  else { state.streak.count = 1; }
  state.streak.lastDay = todayKey;
  const reward = 100 * state.streak.count;
  state.hp += reward;
  showRibbon(`üìÜ Daily streak ${state.streak.count}/7: +${fmtCost(reward)} HP`);
}

/* ========= SPRITES ========= */
function preloadSprites(eid, urls=[]){
  if(!urls.length){ tmp[eid].useEmoji=true; return; }
  let loaded=0, ok=true;
  tmp[eid].frames = urls.map(u=>{ const im=new Image(); im.src=u; im.onload=()=>loaded++; im.onerror=()=>{ok=false}; return im; });
  setTimeout(()=>{
    tmp[eid].useEmoji = !(ok && loaded>0);
    const img=id("spr-"+eid), emo=id("emo-"+eid);
    if(img&&emo&&tmp[eid].useEmoji===false){ img.style.display="block"; emo.style.display="none"; img.src=tmp[eid].frames[0].src; }
  }, 600);
}

/* ========= ANIMATION CONTROL (bike) ========= */
function startAnim(eid, mode, durationSec){
  // mode: 'cooldown' (run through frames until cooldown ends), 'loop' (continuous for coach), 'stop'
  stopAnim(eid);
  const info = tmp[eid]; if(info.useEmoji) return; // emojis don't animate now
  const img = id("spr-"+eid); if(!img) return;

  if(mode==="loop"){ info.animLoop=true; info.animTimer=setInterval(()=>{ info.frame=(info.frame+1)%info.frames.length; img.src=info.frames[info.frame].src; }, 120); return; }

  if(mode==="cooldown"){
    const end = performance.now() + durationSec*1000;
    let interval = 90; // fast at start
    const tick=()=>{
      const left = end - performance.now();
      if(left<=0){ stopAnim(eid); return; }
      info.frame=(info.frame+1)%info.frames.length; img.src=info.frames[info.frame].src;
      // simple ease out: slow down toward the end
      const p = 1 - (left/(durationSec*1000));
      interval = 90 + Math.floor(p*180); // 90ms -> 270ms
      info.animTimer = setTimeout(tick, interval);
    };
    info.animTimer = setTimeout(tick, interval);
  }
}
function stopAnim(eid){
  const info=tmp[eid]; if(!info) return;
  if(info.animTimer){ clearTimeout(info.animTimer); info.animTimer=null; }
  info.animLoop=false;
}

/* ========= MISSIONS ========= */
function updateMissionUI(){
  const goals = [
    // Week 1: unlock last card + any coach lv2
    () => state.items["lift"]?.unlocked ? 1 : 0,
    () => Object.values(state.items).some(v=>v.coach && (v.coachLevel||1)>=2) ? 1 : 0
  ];
  const done = goals.reduce((a,f)=>a+f(),0);
  id("mGoal").textContent = `${done}/2`;
  id("mProg").style.width = `${(done/2)*100}%`;
  id("mTitle").textContent = state.level===1 ? "Week 1: Foundation" : `Week ${state.level}`;
  id("mSub").innerHTML = state.level===1
    ? `Goal: Unlock <b>Weight Lifting</b> & any Coach to <b>Lv.2</b>`
    : `New week unlocked! More intense training ahead.`;
  if(done===2 && state.level===1){
    state.level=2; save();
    showRibbon("‚úÖ Week 1 complete ‚Äî Week 2 unlocked!");
  }
}

/* ========= BUILD ========= */
function build(){
  const host=$("#list"); host.innerHTML="";

  EX.filter(r=>r[10] <= state.level).forEach(([eid,name,emoji,setLabel,gain,interval,base,mult,coachCost,unlock])=>{
    const it=state.items[eid], unlocked=it.unlocked, ready=now()>=tmp[eid].next;
    const affordable = state.hp>=unlock;

    const card=document.createElement("div"); card.className="card"; card.dataset.id=eid;
    card.innerHTML=`
      ${!unlocked && affordable? `<div class="badge">UNLOCK AVAILABLE</div>` : ``}
      <button type="button" class="avatarbtn ${unlocked?'':'locked'} ${ready?'ready':''}" 
              id="tap-${eid}" ${unlocked?``:`disabled`} aria-label="${unlocked?'Perform '+name:'Locked'}">
        <img id="spr-${eid}" alt="" style="display:none"/><div class="emoji" id="emo-${eid}" aria-hidden="true">${emoji}</div>
        ${unlocked?'':'<div class="lockOverlay"><span>üîí COMING SOON</span></div>'}
      </button>
      <div class="meta">
        <h3>${name} <span class="sub">‚Ä¢ ${setLabel}</span></h3>
        <div class="sub">HP Gain: <b id="gain-${eid}">${fmtCost(Math.max(1,gain*Math.max(1,it.lvl)))}</b> ‚Ä¢ Unlock: ${fmtCost(unlock)} HP</div>
        <div class="bar ${ready?'ready':''}"><i id="bar-${eid}"></i></div>
      </div>
      <div class="actions">
        ${unlocked
          ? `<button class="btn action" id="up-${eid}">Upgrade</button>
             <button class="btn secondary coachBtn" id="coach-${eid}">
                <span class="coachFace" id="coachFace-${eid}">${it.coach?'üßë‚Äçüè´':'üßë‚Äçüè´'}</span>
                <span id="coachTxt-${eid}">${it.coach?('Coach Lv.'+(it.coachLevel||1)):'Hire Coach ‚Ä¢ '+fmtCost(coachCost)+' HP'}</span>
                <span class="dot ${it.coach?'pulse':'hide'}" id="coachDot-${eid}" style="margin-left:4px"></span>
              </button>`
          : `<button class="btn action" id="unlock-${eid}">Unlock | ${fmtCost(unlock)} HP</button>
             <button class="btn secondary" disabled>Coach</button>`}
      </div>`;
    host.appendChild(card);

    // load demo sprite for Walking (bike frames) and NEVER bop the sprite
    if(eid==="walk" && SPRITES.walk){ preloadSprites("walk", SPRITES.walk); }

    // Tap
    const tap=id("tap-"+eid);
    if(unlocked){
      const handler=e=>{
        e.preventDefault(); firstUserInteract();
        perform(eid);
        s_step();
        // start cooldown animation for sprites (not emoji)
        if(tmp[eid].useEmoji===false){
          startAnim(eid, "cooldown", intervalForCoach(eid)); // animate through cooldown
        }
      };
      tap.addEventListener("pointerdown",handler,{passive:false});
      tap.addEventListener("click",handler);
      tap.addEventListener("touchstart",handler,{passive:false});

      // Upgrade
      const upBtn=id("up-"+eid);
      upBtn.addEventListener("click",()=>{
        const qty=(state.multi==="max")?maxLevels(base,mult,it.lvl,state.hp):Number(state.multi);
        const cnt=Math.max(1,qty||0), cost=pack(base,mult,it.lvl,cnt);
        if(state.hp>=cost){
          state.hp-=cost; it.lvl+=cnt; coin(); renderAll(); save();
          // remove gleam right after purchase
          upBtn.classList.remove("glitter","available");
          // tutorial: if first time, show coach tip
          if(!state.tut.coach){ setTimeout(()=>maybeTutorCoach(eid),200); }
        }
      });

      // Coach / Coach upgrades
      const coachBtn=id("coach-"+eid), txt=id("coachTxt-"+eid), face=id("coachFace-"+eid);
      const refreshCoachLabel=()=>{ txt.textContent = it.coach ? ("Coach Lv."+(it.coachLevel||1)) : `Hire Coach ‚Ä¢ ${fmtCost(coachCost)} HP`; };
      refreshCoachLabel();
      coachBtn.addEventListener("click",()=>{
        // Hire
        if(!it.coach){
          if(state.hp<coachCost) return;
          state.hp-=coachCost; it.coach=true; it.coachLevel=1; coin(); renderAll(); startCoach(eid); save();
          face.classList.add("coachActive"); id("coachDot-"+eid)?.classList.remove("hide"); id("coachDot-"+eid)?.classList.add("pulse");
          showRibbon(`üßë‚Äçüè´ Coach hired for ${name}!`);
          refreshCoachLabel();
          // Walking sprite loops under coach
          if(eid==="walk" && tmp[eid].useEmoji===false) startAnim(eid,"loop");
        }else{
          // Upgrade coach: cost scales like base*1.7^level
          const nextLevel=(it.coachLevel||1)+1;
          const cost=Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
          if(state.hp<cost) return;
          state.hp-=cost; it.coachLevel=nextLevel; coin(); renderAll(); save();
          showRibbon(`‚¨ÜÔ∏è Coach Lv.${nextLevel} for ${name}`);
          refreshCoachLabel();
          if(eid==="walk" && tmp[eid].useEmoji===false) { stopAnim(eid); startAnim(eid,"loop"); } // keep looping
        }
      });

    }else{
      id("unlock-"+eid).addEventListener("click",()=>{
        if(state.hp<unlock) return;
        state.hp-=unlock; it.unlocked=true; it.lvl=Math.max(1,it.lvl);
        sparkle(); renderAll(); build(); showRibbon(`‚ú® Unlocked ${name}!`);
      });
      if(affordable){ card.querySelector(".avatarbtn").classList.add("unlockPulse"); }
    }
  });

  /* Big Goal teaser */
  const goal = document.createElement("div"); goal.className="card";
  goal.innerHTML = `
    <button type="button" class="avatarbtn locked" disabled>
      <div class="emoji">üèÜ</div>
      <div class="lockOverlay"><span>üîí ULTIMATE TRAINER</span></div>
    </button>
    <div class="meta">
      <h3>${BIG_GOAL.name} <span class="sub">‚Ä¢ ${BIG_GOAL.tease}</span></h3>
      <div class="sub">Unlock: <b>${fmtCost(BIG_GOAL.unlockHp)} HP</b></div>
      <div class="bar"><i style="width:${Math.min(100, Math.floor((state.hp/BIG_GOAL.unlockHp)*100))}%"></i></div>
    </div>
    <div class="actions">
      <button class="btn secondary" disabled>Coming Soon</button>
      <button class="btn secondary" id="share2">Tell a friend</button>
    </div>`;
  $("#list").appendChild(goal);
  goal.querySelector("#share2").addEventListener("click",shareProgress);

  // Multiplier buttons sync (top + footer)
  document.querySelectorAll("[data-m]").forEach(b=>{
    b.classList.toggle("active", b.dataset.m==state.multi);
    b.onclick=()=>{ document.querySelectorAll("[data-m]").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(`[data-m="${b.dataset.m}"]`).forEach(x=>x.classList.add("active"));
      state.multi=(b.dataset.m==="max")?"max":Number(b.dataset.m); save(); renderAll(); };
  });

  updateMissionUI();
}

/* ========= COOLDOWNS / GLEAM ========= */
function coachSpeed(baseInterval, level){ // lower is faster
  if(!level || level<1) level=1;
  return baseInterval / (1 + (level-1)*0.25); // each level +25% faster
}
function intervalForCoach(eid){
  const row=EX.find(r=>r[0]===eid); const base=row[5];
  const it=state.items[eid]; if(!it?.coach) return base;
  return coachSpeed(base, it.coachLevel||1);
}

/* ========= CORE LOOP ========= */
function firstUserInteract(){ if(!isPlaying){ bgm.play().catch(()=>{}); isPlaying=true; ensureAC(); syncMuteUIs(); } }

function perform(eid,auto=false){
  const row=EX.find(r=>r[0]===eid), it=state.items[eid]; if(!row) return;
  const [, , , , gain, ] = row;
  const t=now(); if(t<tmp[eid].next) return;

  // next based on current coach speed (even for manual we align to same duration for animation feel)
  const dur = intervalForCoach(eid);
  tmp[eid].next = t + dur;

  // Base gain
  let amt = Math.floor(gain * Math.max(1,it.lvl));

  // Surprise drop (5%)
  if(Math.random()<0.05){ const bonus = Math.ceil(amt*0.5); amt += bonus; floatText(id("tap-"+eid), `‚ú® +${fmtCost(bonus)} bonus!`); sparkle(); }

  state.hp += amt; it.taps++;

  // First Steps early reward
  if(!state.firstSteps.done && eid==="walk"){
    state.firstSteps.taps++;
    if(state.firstSteps.taps===10){
      const gift = 120; state.hp += gift; state.firstSteps.done=true;
      showRibbon(`üëü First Steps bonus: +${fmtCost(gift)} HP`);
    }
  }

  // EMOJI BOP ONLY if not sprite
  const tap = id("tap-"+eid);
  if(tmp[eid].useEmoji!==false){ tap.classList.remove("animate"); void tap.offsetWidth; tap.classList.add("animate"); }

  renderAll(); save();
}

/* Coaches schedule exactly on their (faster) interval */
function startCoach(eid){
  const it=state.items[eid]; if(!it.coach) return;
  stopCoach(eid);
  // Start/keep sprite loop for walking
  if(eid==="walk" && tmp[eid].useEmoji===false) { stopAnim(eid); startAnim(eid,"loop"); }
  const tick=()=>{
    const interval = intervalForCoach(eid);
    perform(eid,true);
    tmp[eid].timer = setTimeout(tick, interval*1000);
  };
  tmp[eid].timer = setTimeout(tick, 0);
}
function stopCoach(eid){ if(tmp[eid].timer){ clearTimeout(tmp[eid].timer); tmp[eid].timer=null; }}

/* ========= MATH & RENDER ========= */
function pack(base,mult,start,count){const a=base*Math.pow(mult,start);return count===1?a:a*(Math.pow(mult,count)-1)/(mult-1)}
function maxLevels(base,mult,current,hp){const a=base*Math.pow(mult,current); if(hp<a) return 0; return Math.floor(Math.log((hp*(mult-1))/a+1)/Math.log(mult));}

function floatText(anchor,text){const n=document.createElement("div");n.className="float";n.textContent=text;const r=anchor.getBoundingClientRect();n.style.left=(r.left+r.width/2)+"px";n.style.top=(r.top-6+window.scrollY)+"px";document.body.appendChild(n);n.animate([{transform:"translate(-50%,0)",opacity:1},{transform:"translate(-50%,-46px)",opacity:0}],{duration:820,easing:"ease-out"});setTimeout(()=>n.remove(),840)}
function renderHP(){ id("hp").innerHTML=`${fmtHP(state.hp)} <small>HP</small>`; }
function renderBars(){
  const t=now();
  EX.forEach(([eid,, , , , interval, base, mult, coachCost, unlock])=>{
    const it=state.items[eid];
    const left=Math.max(0,tmp[eid].next - t);
    const dur = intervalForCoach(eid);
    const pct = 1 - Math.min(1, left / dur);
    const bar=id("bar-"+eid), tap=id("tap-"+eid);
    if(bar){ bar.style.width = Math.round(pct*100)+"%"; bar.parentElement.classList.toggle('ready', left<=0); }
    if(tap){
      tap.classList.toggle("ready", left<=0);
      tap.classList.toggle("needGlow", left<=0 && !it.coach);
      // gleam only when enabled & affordable
      const card = tap.closest(".card");
      if(card){
        const upBtn=card.querySelector("#up-"+eid);
        const unlockBtn=card.querySelector("#unlock-"+eid);
        const coachBtn=card.querySelector("#coach-"+eid);
        if(unlockBtn){
          const allow = (state.hp>=unlock && !it.unlocked);
          unlockBtn.classList.toggle("glitter", allow);
          unlockBtn.classList.toggle("available", allow);
        }
        if(upBtn){
          const c1 = pack(base, mult, it.lvl, 1);
          const allow = state.hp>=c1;
          upBtn.classList.toggle("glitter", allow);
          upBtn.classList.toggle("available", allow);
        }
        if(coachBtn && !it.coach){
          const allow = state.hp>=coachCost;
          coachBtn.classList.toggle("glitter", allow);
          coachBtn.classList.toggle("available", allow);
        } else if (coachBtn && it.coach){
          // show gleam when you can afford next coach level
          const nextLevel=(it.coachLevel||1)+1;
          const c = Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
          const allow = state.hp>=c;
          coachBtn.classList.toggle("glitter", allow);
          coachBtn.classList.toggle("available", allow);
          id("coachTxt-"+eid).textContent = `Coach Lv.${it.coachLevel||1}`;
        }
      }
    }
  });
  updateMissionUI();
}
function renderButtons(){
  EX.forEach(([eid,, , , gain, , base, mult, coachCost, unlock])=>{
    const it=state.items[eid]; if(!it) return;
    const gEl=id("gain-"+eid); if(gEl) gEl.textContent = fmtCost(gain*Math.max(1,it.lvl));
    const upBtn=id("up-"+eid);
    if(upBtn){
      const qty=(state.multi==="max")?maxLevels(base,mult,it.lvl,state.hp):Number(state.multi);
      const cnt=Math.max(1,qty||0), cost=pack(base,mult,it.lvl,cnt);
      upBtn.textContent = `Upgrade x${cnt} | ${fmtCost(cost)} HP`;
      upBtn.disabled = (cnt===0)||(state.hp<cost);
    }
    const coachBtn=id("coach-"+eid), face=id("coachFace-"+eid), dot=id("coachDot-"+eid), txt=id("coachTxt-"+eid);
    if(coachBtn){
      if(!it.coach){
        txt.textContent = `Hire Coach ‚Ä¢ ${fmtCost(coachCost)} HP`;
        coachBtn.disabled = state.hp<coachCost;
      }else{
        const nextLevel=(it.coachLevel||1)+1;
        const c = Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
        txt.textContent = `Coach Lv.${it.coachLevel||1} ‚Ä¢ Upgrade ${fmtCost(c)} HP`;
        coachBtn.disabled = state.hp<c;
        face.classList.add("coachActive"); dot?.classList.remove("hide"); dot?.classList.add("pulse");
      }
    }
    const unlockBtn=id("unlock-"+eid);
    if(unlockBtn){
      unlockBtn.textContent = `Unlock | ${fmtCost(unlock)} HP`;
      unlockBtn.disabled = state.hp<unlock;
    }
  });
}
function renderAll(){ renderHP(); renderBars(); renderButtons(); }

/* ========= SHARE ========= */
function shareProgress(){
  const text=`I just hit ${fmtHP(state.hp)} HP in Fitness Frenzy! üí™`;
  const url=location.href;
  if(navigator.share){ navigator.share({title:"Fitness Frenzy", text, url}).catch(()=>{}); }
  else { navigator.clipboard?.writeText(`${text} ${url}`); showRibbon("üîó Link copied ‚Äî go flex!"); }
}
id("share").addEventListener("click",shareProgress);

/* ========= TUTORIAL ========= */
function showTutor(msg, targetEl){
  const t = id("tutor"), c=id("tcard"), f=id("tfinger");
  c.innerHTML = msg;
  if(targetEl){
    const r=targetEl.getBoundingClientRect();
    f.style.left = (r.left + r.width/2) + "px";
    f.style.top  = (r.top  + window.scrollY + r.height + 26) + "px";
  }
  t.classList.add("on");
  t.onclick = ()=> t.classList.remove("on");
}
function maybeTutorTap(){
  if(state.tut.tap) return;
  const el = id("tap-walk");
  if(el){ state.tut.tap=true; save(); showTutor("<b>Tap here</b> to walk and earn HP!", el); }
}
function maybeTutorUpgrade(eid){
  if(state.tut.up) return;
  const up = id("up-"+eid);
  if(up && !up.disabled){ state.tut.up=true; save(); showTutor("You can <b>upgrade</b> this exercise to earn more HP per tap.", up); }
}
function maybeTutorCoach(eid){
  if(state.tut.coach) return;
  const c = id("coach-"+eid);
  if(c){ state.tut.coach=true; save(); showTutor("Hire a <b>Coach</b> to auto-tap. Upgrade coach levels to go faster.", c); }
}

/* ========= START ========= */
function startGame(){
  const intro = document.getElementById('intro');
  if (intro) intro.classList.add('off');
  document.body.classList.remove('intro-open');
  try { bgm.play().catch(()=>{}); } catch(e){}
  isPlaying = true; try { ensureAC(); } catch(e){}
  syncMuteUIs();
  setTimeout(maybeTutorTap, 300);
}

/* ========= LOOP & BOOT ========= */
function loop(){ renderBars(); requestAnimationFrame(loop); }
function loadAll(){
  load();
  grantOffline();
  dailyStreak();
  build();
  renderAll();
  loop();
}
document.getElementById("new").onclick=()=>{ if(confirm("Start a new game? This wipes progress.")) { newGame(); } };

// init
window.addEventListener("pointerdown",()=>{ ensureAC(); }, {once:true});
const bgmVol = Number(id("vol").value); bgm.volume = bgmVol; syncVolumeUIs(bgmVol); syncMuteUIs();
loadAll();
</script>
</body>
</html>
