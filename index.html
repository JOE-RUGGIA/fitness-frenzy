<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy â€“ Core Loop V1</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
  :root{
    --bg:#0f1114; --card:#161a20; --ink:#e9eef3; --muted:#9aa7b3; --accent:#2e7d32; --border:#232a33;
    --space:clamp(10px,2.2vw,18px); --r:14px; --fs-1:clamp(16px,2.4vw,18px); --fs-2:clamp(18px,3.2vw,22px); --fs-3:clamp(22px,5vw,28px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);
    padding:env(safe-area-inset-top) var(--space) env(safe-area-inset-bottom) var(--space)}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin:var(--space) 0}
  h1{margin:0;font-size:var(--fs-3)}
  .row{display:flex;gap:var(--space);flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:var(--space);flex:1 1 300px;min-width:280px}
  .muted{color:var(--muted)}
  .btn{width:100%;padding:12px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{background:#3a434f;color:#a7b1be;cursor:not-allowed}
  .btn.secondary{background:#2b3c4f}
  .icon{font-size:clamp(22px,5.5vw,34px)}
  .kpi{display:flex;align-items:center;gap:10px}
  .stat{font-variant-numeric:tabular-nums}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--space)}
  @media (max-width:560px){.grid-2{grid-template-columns:1fr}}
  .coolwrap{background:#0d0f12;border:1px solid #28303a;border-radius:10px;overflow:hidden}
  .coolbar{height:16px;background:#1e2a36;position:relative}
  .coolfill{height:100%;width:0%;background:linear-gradient(90deg,#2e7d32,#4caf50)}
  .cooltxt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cde8d1}
  .exercise{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--border);background:#11161c}
  .exercise.locked{opacity:.5;filter:grayscale(1)}
  .exercise .left{display:flex;align-items:center;gap:10px}
  .pill{padding:4px 8px;border-radius:999px;background:#213042;color:#cfe7ff;font-size:12px}
  .repbar{height:10px;border-radius:8px;background:#1b2530;overflow:hidden}
  .repfill{height:100%;width:0%;background:#3e7bd9}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#1b232d;color:#eaf3ff;border:1px solid #2b3a4b;border-radius:12px;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.35);opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <span class="icon">ðŸ’ª</span>
    <h1>Fitness Frenzy</h1>
  </header>

  <div class="row">
    <div class="card">
      <h3>Bank</h3>
      <div class="kpi"><span class="icon">ðŸª™</span> <div>HP: <span id="hp" class="stat">0</span></div></div>
      <div class="muted">Per Tap: <span id="perTap" class="stat">1</span></div>
      <div class="muted">Cooldown: <span id="coolInfo" class="stat">0.6s</span></div>
      <div class="muted">Exercise: <span id="exName" class="stat">Walking</span></div>
      <div style="height:12px"></div>
      <div class="coolwrap">
        <div class="coolbar">
          <div id="coolfill" class="coolfill"></div>
          <div id="cooltxt" class="cooltxt"></div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="grid-2">
        <button id="tapBtn" class="btn">Tap to Exercise</button>
        <button id="saveBtn" class="btn secondary">Save</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
        <label class="muted" style="display:flex;align-items:center;gap:8px">
          <input id="mute" type="checkbox"> Mute
        </label>
      </div>
      <div class="muted" id="status"></div>
    </div>

    <div class="card">
      <h3>Reps & Upgrade</h3>
      <div class="exercise" id="repInfo">
        <div style="flex:1">
          <div><strong>Reps</strong> â€“ each rep **doubles** your HP per tap.</div>
          <div class="muted">Progress: <span id="repCount" class="stat">0</span>/<span id="repTarget" class="stat">10</span></div>
          <div class="repbar"><div id="repfill" class="repfill"></div></div>
        </div>
        <button id="buyRepBtn" class="btn" style="max-width:160px">Buy Rep (Cost <span id="repCost">4</span> HP)</button>
      </div>
      <div style="height:10px"></div>
      <button id="upgradeBtn" class="btn" disabled>Upgrade: Halve Cooldown</button>
      <div class="muted" style="margin-top:8px">Upgrade triggers when Reps reach the target. After upgrade: reps reset to 0, target doubles (10â†’20â†’40â€¦), cooldown canâ€™t go below 0.1s.</div>
    </div>
  </div>

  <div style="height:var(--space)"></div>

  <div class="card">
    <h3>Exercises</h3>
    <div id="exercisesList" class="col" style="display:flex;flex-direction:column;gap:10px"></div>
  </div>
</div>

<div id="toast" class="toast">Upgraded! Cooldown halved.</div>

<script>
/* ========= Core Data ========= */
const VERSION='ff-core-1';
const SAVE_KEY='fitness_frenzy_'+VERSION;

const exercises = [
  {
    id:'walk', name:'Walking', icon:'ðŸš¶', baseHP:1, baseCooldown:600, // ms
    reps:0, repTarget:10, repBaseCost:4, repGrowth:2, unlocked:true, unlockCost:0,
    cooldown:600, lastTapAt: -Infinity
  },
  {
    id:'jog', name:'Jogging', icon:'ðŸƒ', baseHP:60, baseCooldown:3000,
    reps:0, repTarget:10, repBaseCost:30, repGrowth:2, unlocked:false, unlockCost:60,
    cooldown:3000, lastTapAt: -Infinity
  }
  // future: cycling, swimming, etc.
];

let current = 0; // index of selected exercise
const state = { hp:0, muted:false, lastTS: performance.now() };

/* ========= Helpers ========= */
const fmt = (n)=> n>=1e9?(n/1e9).toFixed(2)+'B': n>=1e6?(n/1e6).toFixed(2)+'M': n>=1e3?(n/1e3).toFixed(2)+'K': Math.floor(n).toString();
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const perTap = (ex)=> ex.baseHP * Math.pow(2, ex.reps);
const cooldownMs = (ex)=> ex.cooldown;
const canTap = (ex, now)=> (now - ex.lastTapAt) >= cooldownMs(ex) - 1; // allow 1ms drift

/* ========= Sound (WebAudio tiny bleeps) ========= */
let audioCtx=null;
function sfx(type){
  if(state.muted) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type='sine';
    const t=audioCtx.currentTime;
    if(type==='tap'){ o.frequency.setValueAtTime(660,t); g.gain.setValueAtTime(.06,t); g.gain.exponentialRampToValueAtTime(.0001,t+.08); }
    if(type==='buy'){ o.frequency.setValueAtTime(440,t); g.gain.setValueAtTime(.08,t); g.gain.exponentialRampToValueAtTime(.0001,t+.12); }
    if(type==='upgrade'){ o.frequency.setValueAtTime(520,t); g.gain.setValueAtTime(.08,t); o.frequency.exponentialRampToValueAtTime(880,t+.18); g.gain.exponentialRampToValueAtTime(.0001,t+.22); }
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+.25);
  }catch{}
}

/* ========= Persistence ========= */
function save(){
  const payload = { hp:state.hp, muted:state.muted, exercises:exercises.map(e=>({
    id:e.id, reps:e.reps, repTarget:e.repTarget, unlocked:e.unlocked, cooldown:e.cooldown
  })) };
  localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  ui.status.textContent='Saved.'; setTimeout(()=>ui.status.textContent='',800);
}
function load(){
  const raw=localStorage.getItem(SAVE_KEY); if(!raw) return;
  try{
    const s=JSON.parse(raw);
    state.hp = s.hp ?? 0;
    state.muted = !!s.muted;
    if(Array.isArray(s.exercises)){
      for(const eSaved of s.exercises){
        const e = exercises.find(x=>x.id===eSaved.id);
        if(!e) continue;
        e.reps = eSaved.reps ?? e.reps;
        e.repTarget = eSaved.repTarget ?? e.repTarget;
        e.unlocked = eSaved.unlocked ?? e.unlocked;
        e.cooldown = eSaved.cooldown ?? e.baseCooldown;
      }
    }
  }catch{}
}

/* ========= UI refs ========= */
const ui = {
  hp: document.getElementById('hp'),
  perTap: document.getElementById('perTap'),
  coolInfo: document.getElementById('coolInfo'),
  exName: document.getElementById('exName'),
  tapBtn: document.getElementById('tapBtn'),
  saveBtn: document.getElementById('saveBtn'),
  resetBtn: document.getElementById('resetBtn'),
  mute: document.getElementById('mute'),
  status: document.getElementById('status'),
  coolfill: document.getElementById('coolfill'),
  cooltxt: document.getElementById('cooltxt'),
  repCount: document.getElementById('repCount'),
  repTarget: document.getElementById('repTarget'),
  repfill: document.getElementById('repfill'),
  buyRepBtn: document.getElementById('buyRepBtn'),
  repCost: document.getElementById('repCost'),
  upgradeBtn: document.getElementById('upgradeBtn'),
  exercisesList: document.getElementById('exercisesList'),
  toast: document.getElementById('toast')
};

/* ========= Exercise List UI ========= */
function renderExercisesList(){
  ui.exercisesList.innerHTML='';
  exercises.forEach((e, idx)=>{
    const row=document.createElement('div');
    row.className='exercise'+(e.unlocked?'':' locked');
    row.innerHTML=`
      <div class="left"><span class="icon">${e.icon}</span>
        <div>
          <div><strong>${e.name}</strong> ${idx===current?'<span class="pill">Selected</span>':''}</div>
          <div class="muted">Tap = ${fmt(e.baseHP)} Ã— 2^${e.reps} = <strong>${fmt(perTap(e))}</strong> HP</div>
          <div class="muted">Cooldown: ${(cooldownMs(e)/1000).toFixed(2)}s</div>
        </div>
      </div>
      <div>
        ${e.unlocked
          ? `<button class="btn secondary" data-act="select">Use</button>`
          : `<button class="btn" data-act="unlock">Unlock (${fmt(e.unlockCost)} HP)</button>`
        }
      </div>`;
    row.querySelector('button').addEventListener('pointerdown',(ev)=>{
      ev.preventDefault();
      if(row.classList.contains('locked')){
        if(state.hp>=e.unlockCost){
          state.hp -= e.unlockCost; e.unlocked=true; current = idx; sfx('buy'); renderAll();
        }
      }else{
        current=idx; renderAll();
      }
    },{passive:false});
    ui.exercisesList.appendChild(row);
  });
}

/* ========= Reps & Upgrade ========= */
function repCostFor(e){ // geometric cost: base * growth^reps
  return Math.floor(e.repBaseCost * Math.pow(e.repGrowth, e.reps));
}

function buyRep(){
  const e = exercises[current];
  const cost = repCostFor(e);
  if(state.hp < cost) return;
  state.hp -= cost;
  e.reps += 1;             // doubles tap power each time
  sfx('buy');
  checkUpgrade(e);
  renderAll();
}

function checkUpgrade(e){
  if(e.reps >= e.repTarget){
    // Upgrade: halve cooldown (floor at 100ms), reset reps, double target
    e.reps = 0;
    e.repTarget = e.repTarget * 2;
    e.cooldown = Math.max(100, Math.floor(e.cooldown / 2));
    toast('Upgraded! Cooldown halved.');
    sfx('upgrade');
  }
}

/* ========= Tap & Cooldown ========= */
function tap(){
  const e = exercises[current];
  const now = performance.now();
  if(!canTap(e, now)) return;
  e.lastTapAt = now;
  state.hp += perTap(e);
  sfx('tap');
}

function updateCooldownUI(){
  const e = exercises[current];
  const cd = cooldownMs(e);
  const now = performance.now();
  const since = now - e.lastTapAt;
  const pct = clamp(since / cd, 0, 1);

  // If cooldown very short (<=100ms), keep bar full and show HP/sec text
  if(cd <= 100){
    ui.coolfill.style.width = '100%';
    const hps = perTap(e) / (cd/1000);
    ui.cooltxt.textContent = `HP/sec: ${hps.toFixed(1)}`;
    return;
  }

  ui.coolfill.style.width = (pct*100).toFixed(1)+'%';
  ui.cooltxt.textContent = pct<1 ? '' : 'Ready';
}

/* ========= Render ========= */
function renderTop(){
  const e = exercises[current];
  ui.hp.textContent = fmt(state.hp);
  ui.perTap.textContent = fmt(perTap(e));
  ui.coolInfo.textContent = (cooldownMs(e)/1000).toFixed(2)+'s';
  ui.exName.textContent = e.name;
  ui.mute.checked = state.muted;
}
function renderReps(){
  const e = exercises[current];
  ui.repCount.textContent = e.reps;
  ui.repTarget.textContent = e.repTarget;
  ui.repfill.style.width = (Math.min(e.reps / e.repTarget, 1)*100).toFixed(1)+'%';
  const cost = repCostFor(e);
  ui.repCost.textContent = fmt(cost);
  ui.buyRepBtn.disabled = state.hp < cost;
  ui.upgradeBtn.disabled = true; // upgrade happens automatically on reaching target
}
function renderAll(){
  renderTop(); renderReps(); renderExercisesList(); updateCooldownUI();
}

/* ========= Loop ========= */
function tick(ts){
  state.lastTS = ts;
  updateCooldownUI();
  requestAnimationFrame(tick);
}

/* ========= Toast ========= */
let toastTimer=null;
function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>ui.toast.classList.remove('show'), 1200);
}

/* ========= Wire Up ========= */
function bindPress(el, fn){
  el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
  el.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); fn(e);} });
}

bindPress(ui.tapBtn, ()=>{ tap(); renderAll(); });
bindPress(ui.buyRepBtn, ()=>{ buyRep(); });
bindPress(ui.saveBtn, save);
bindPress(ui.resetBtn, ()=>{
  if(!confirm('Reset your progress?')) return;
  localStorage.removeItem(SAVE_KEY); location.reload();
});
ui.mute.addEventListener('change', ()=>{ state.muted = ui.mute.checked; });

/* ========= Boot ========= */
function boot(){
  load();
  renderAll();
  requestAnimationFrame(tick);
  // Autosave every 20s
  setInterval(save, 20000);
}
boot();
</script>
</body>
</html>
