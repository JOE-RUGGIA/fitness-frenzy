<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fitness Frenzy â€” Safe Boot</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{
  --bg:#0a1320;--card:#0f1b2b;--ink:#e9eef3;--muted:#a7b7cc;--border:#213149;
  --accent:#cc6b2c;--accent-hi:#ffb357;--rep:#22c55e;--warn:#39d98a;
  --space:clamp(10px,2.2vw,18px);--r:16px;--fs-2:clamp(18px,3.2vw,22px);--repband:16%;
}
/* ====== Safe Boot Error ====== */
#bootError{position:fixed;inset:12px 12px auto 12px;background:#290b0b;border:1px solid #7e2b2b;color:#ffd7d7;padding:12px 14px;border-radius:10px;z-index:99999;display:none;box-shadow:0 10px 24px rgba(0,0,0,.4)}
#bootError strong{color:#fff}
#bootError pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;margin:6px 0 0}
/* ====== Base ====== */
*{box-sizing:border-box}
html,body{height:100%;touch-action:manipulation;overflow-x:hidden}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0}
button,.tapPad{-webkit-user-select:none;user-select:none;touch-action:manipulation}

/* Splash */
.splashOv{position:fixed;inset:0;background:#fff;z-index:9500;display:none;align-items:center;justify-content:center}
.splashOv.open{display:flex}
.splashInner{display:flex;align-items:center;justify-content:center;width:min(90vw,900px);height:min(80vh,600px);position:relative;border-radius:12px}
.splashLogo{max-width:100%;max-height:100%;filter:drop-shadow(0 10px 24px rgba(0,0,0,.22));animation:splashPop 1200ms cubic-bezier(.2,1.2,.3,1) forwards}
@keyframes splashPop{0%{transform:scale(.82);opacity:0}45%{transform:scale(1.06);opacity:1}70%{transform:scale(.98)}100%{transform:scale(1)}}
.splashShine{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:12px}
.splashShine::before{content:"";position:absolute;top:-40%;left:-30%;width:60%;height:200%;background:linear-gradient(70deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.55) 50%,rgba(255,255,255,0) 100%);transform:rotate(18deg) translateX(-120%);animation:shineSweep 1800ms 300ms ease-in-out 2 both}
@keyframes shineSweep{to{transform:rotate(18deg) translateX(220%)}}

/* Top bar */
.topbar{position:sticky;position:-webkit-sticky;top:0;z-index:1000;background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap}

/* Avatar + logo + dot */
.topPlayer{--avatar-size:88px;position:relative;display:flex;align-items:center;gap:8px;margin-left:6px}
#topPlayerAvatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;overflow:hidden;background:#0b1423;border:1px solid #27456d;box-shadow:0 4px 12px rgba(0,0,0,.25);cursor:pointer}
#topPlayerAvatar img{width:100%;height:100%;object-fit:cover}
.topPlayer .topLogo{height:var(--avatar-size);width:auto;display:block;user-select:none;pointer-events:none;object-fit:contain;max-width:min(40vw,480px)}
#menuDotAvatar{position:absolute;top:-6px;left:calc(var(--avatar-size) - 8px);width:16px;height:16px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 2px rgba(10,19,32,.95);display:none}
#menuDotAvatar.show{display:block}

/* HP pill & qty */
.hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;box-shadow:0 6px 18px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.04)}
.hpPill .label{font-weight:900;color:var(--accent)}
.hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);width:11ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}
.spacer{flex:1}
.seg{display:inline-flex;border:1px solid #2b3d5a;border-radius:10px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}
.segBtn.active{background:var(--accent);color:#fff}
.btn{position:relative;overflow:hidden;padding:12px 18px;border:none;border-radius:14px;font-weight:800;cursor:pointer;transform:translateZ(0)}
.btn.primary{background:var(--accent);color:#fff}
.btn.secondary{background:#1a2a40;color:#d7e3f5}
.btn.ghost{background:#13233b;color:#cfe0ff;border:1px solid #2b3d5a}
#menuBtn{display:none} /* legacy hook, hidden */

/* Layout / cards */
.wrap{max-width:980px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:var(--space);display:flex;gap:14px;align-items:stretch;transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.90)}
.card.unlock-ready{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 14px 30px rgba(204,107,44,.28),0 0 24px rgba(204,107,44,.25)}
.tapPad{position:relative;width:clamp(72px,16vw,120px);aspect-ratio:1;border-radius:var(--r);background:#12243b;border:1px solid #1a2f4a;display:flex;align-items:center;justify-content:center;font-size:clamp(44px,12vw,72px);cursor:pointer;overflow:visible}
.lvl{position:absolute;left:6px;top:6px;font-size:12px;font-weight:900;color:#fff;background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;border-radius:8px;padding:2px 6px}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#15341f;border-top:1px solid #204e2b;border-bottom-left-radius:var(--r);border-bottom-right-radius:var(--r);overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repLabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cfead6}
.right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
.ex-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ex-title{font-size:var(--fs-2);margin:0}
.muted{color:#a7b7cc}
.coachSlotTop{display:flex;align-items:center;gap:8px;margin-left:auto;flex-wrap:wrap}

/* Cooldown */
.coolwrap{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolbar{height:16px;background:#101a2a;position:relative}
.coolfill{height:100%;width:0%;position:relative;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-hi) 92%)}
.coolfill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.16) 0 6px,transparent 6px 12px);mix-blend-mode:overlay;opacity:.65;animation:stripeMove 1.2s linear infinite}
@keyframes stripeMove{from{background-position:0 0}to{background-position:60px 0}}
.metaRow{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.kv{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:6px 10px;border-radius:10px;font-size:14px}
.costLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.costPill{display:inline-flex;align-items:center;gap:8px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#ffd6a8;background:#142743;border:1px solid #27456d;padding:8px 14px;border-radius:999px;cursor:not-allowed}
.costPill.ready{color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-hi));border-color:#e89d6b;box-shadow:0 12px 26px rgba(204,107,44,.35)}

/* Menu */
.menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:5000;display:none;align-items:flex-end;justify-content:center}
.menuOverlay.open{display:flex}
.menuPanel{width:min(980px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden}
.menuHeader{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.menuTitle{font-weight:900;font-size:20px}
.menuTabs{display:flex;gap:8px;padding:8px var(--space);border-bottom:1px solid var(--border);flex-wrap:wrap}
.menuTab{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.menuTab.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.menuBody{padding:14px var(--space);overflow:auto}
.coachIntro{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:14px}
.coachList{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:700px){.coachList{grid-template-columns:1fr 1fr}}
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.headshot{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:40px;border-radius:12px;background:#12243b;border:1px solid #1a2f4a}
.coachMid{flex:1;min-width:0}
.coachName{font-weight:900}
.coachInfo{color:#a7b7cc;font-size:14px;margin-top:2px}
.coachRight{display:flex;align-items:center}
.hireBtn{padding:12px 18px;font-size:16px;border-radius:12px}
.hireBtn.secondary{background:#1a2a40;color:#d7e3f5}
.hireBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}

/* Start overlay */
.startOv{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;pointer-events:auto}
.startOv.open{display:flex}
.startPlate{position:absolute;inset:0;background:url('https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png') center/cover no-repeat;filter:blur(14px) brightness(.75);opacity:.9}
.startBackdrop{position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(0,0,0,.25),rgba(0,0,0,.55) 70%)}
.startFrame{position:relative;z-index:1;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(10,19,32,.50);backdrop-filter:blur(6px);box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startImgWrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
.startImgWrap img{width:100%;height:100%;object-fit:contain;pointer-events:none}
.startUI{position:absolute;left:50%;bottom:5.5vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:12px;width:min(92%,680px)}
.startBtns{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;width:100%}
.btn.lg{font-size:clamp(18px,4.5vw,22px);padding:14px 24px;border-radius:16px;width:100%}
.startAvatar{display:flex;gap:10px;align-items:center;justify-content:center}
.startAvatar .segBtn{font-size:24px;padding:10px 14px}

/* Tutorial */
.tutOv{position:fixed;inset:0;z-index:8000;display:none;pointer-events:none}
.tutOv.show{display:block}
.tutBubble{position:absolute;left:50%;bottom:12vh;transform:translateX(-50%);max-width:min(980px,96vw);background:#0f1b2b;border:2px solid #2a4a78;border-radius:18px;padding:22px 24px;color:#fff;display:flex;gap:16px;align-items:flex-start;pointer-events:auto;box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tutText{flex:1;font-size:clamp(18px,3.8vw,24px);line-height:1.35}
.tutWho{font-weight:900;color:#ffd6a8;margin-bottom:4px}
.tutMore{font-size:14px;color:#a7b7cc;margin-top:10px;display:flex;align-items:center;gap:10px}
.tutAvatar{width:92px;height:92px;border-radius:12px;overflow:hidden;flex:0 0 auto;background:#0b1423;border:1px solid #26406c}
.tutAvatar img{width:100%;height:100%;object-fit:cover}
.tutSpot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 42px rgba(255,179,87,.45);animation:spotPulse 1.2s ease-in-out infinite;pointer-events:none}
@keyframes spotPulse{0%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 16px rgba(255,179,87,.35)}50%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 32px rgba(255,179,87,.55)}100%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 16px rgba(255,179,87,.35)}}

/* Banners */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);color:#fff;border-top:1px solid #2a4a78;padding:12px 16px calc(12px + env(safe-area-inset-bottom));opacity:0;z-index:3000;display:flex;gap:8px;align-items:center;justify-content:center;text-align:center;animation:bannerIn .25s ease-out forwards,bannerOut .9s ease-in forwards 2.6s}
@keyframes bannerIn{to{opacity:1;transform:translateY(0)}}
@keyframes bannerOut{to{opacity:0;transform:translateY(8px)}}

/* Misc */
.float{position:fixed;color:#ffe6c7;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.6);transform:translate(-50%,-10px);animation:rise .9s ease-out forwards;pointer-events:none;z-index:1000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}
@media (max-width:420px){.topPlayer{--avatar-size:72px}.hpPill .val{width:9ch}}
</style>
</head>
<body>
<!-- Safe Boot Error -->
<div id="bootError"><strong>Boot error</strong><pre id="bootErrorMsg"></pre></div>

<!-- Top bar -->
<div class="topbar">
  <div class="topwrap">
    <div class="topPlayer" id="topPlayer">
      <div class="pAvatar" id="topPlayerAvatar" role="button" tabindex="0" aria-label="Open menu">
        <img id="topPlayerImg" alt="Player Avatar"
             src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Player%20Male%20GIFF.gif">
      </div>
      <img id="topLogoImg" class="topLogo"
           src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-logo%20real.png"
           alt="Fitness Frenzy Logo">
      <span id="menuDotAvatar"></span>
    </div>

    <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0.00</span></div>
    <div class="spacer"></div>

    <button id="menuBtn" class="btn ghost">Menu</button>
    <div class="seg" id="qtyTop">
      <button class="segBtn active" data-q="1">Ã—1</button>
      <button class="segBtn" data-q="10">Ã—10</button>
    </div>
    <button id="saveBtn" class="btn secondary">Save</button>
    <button id="resetBtn" class="btn secondary">Reset</button>
  </div>
</div>

<!-- Splash -->
<div id="splashOv" class="splashOv" aria-hidden="false">
  <div class="splashInner">
    <div class="splashShine"></div>
    <img class="splashLogo" alt="GameBros Logo"
      src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
  </div>
</div>

<!-- Start Screen -->
<div id="startOv" class="startOv" aria-hidden="true">
  <div class="startPlate"></div><div class="startBackdrop"></div>
  <div class="startFrame">
    <div class="startImgWrap">
      <img alt="Fitness Frenzy Cover" src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png">
    </div>
    <div id="startUI" class="startUI">
      <div class="startBtns">
        <button id="btnStart" class="btn primary lg">Start</button>
        <button id="btnContinue" class="btn secondary lg">Continue</button>
      </div>
      <div class="startAvatar">
        <div class="seg" id="segAvatar" aria-label="Choose avatar">
          <button class="segBtn" data-avatar="male" title="Male"><span class="sym">â™‚</span></button>
          <button class="segBtn" data-avatar="female" title="Female"><span class="sym">â™€</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Game stack -->
<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<!-- Offline Gains -->
<div id="offOv" class="menuOverlay" aria-hidden="true" style="z-index:7000">
  <div class="menuPanel" role="dialog" aria-modal="true" style="border-radius:16px;max-width:520px">
    <div class="menuHeader"><div class="menuTitle">Welcome back!</div><div class="spacer"></div><button id="offClose" class="btn secondary">Close</button></div>
    <div class="menuBody">
      <div class="coachIntro">Your coaches trained while you were away for <strong id="offDur">0s</strong>.</div>
      <div style="font-size:26px;font-weight:900;margin:8px 0">+<span id="offAmt">0.00</span> HP</div>
      <button id="offClaim" class="btn primary">Claim</button>
      <div id="offCapNote" class="coachIntro" style="display:none;margin-top:12px">Note: Offline gains capped for long absences.</div>
    </div>
  </div>
</div>

<!-- Menu -->
<div id="menuOverlay" class="menuOverlay" aria-hidden="true">
  <div class="menuPanel" role="dialog" aria-modal="true">
    <div class="menuHeader">
      <div class="menuTitle">Menu</div>
      <div class="spacer"></div>
      <div class="hpPill small"><span class="label">HP:</span><span id="hpMenu" class="val">0.00</span></div>
      <button id="menuClose" class="btn secondary">Close</button>
    </div>
    <div class="menuTabs">
      <button class="menuTab active" data-tab="coaches">Coaches</button>
      <button class="menuTab" data-tab="upgrades">Upgrades</button>
      <button class="menuTab" data-tab="achievements">Achievements</button>
      <button class="menuTab" data-tab="stats">Stats</button>
      <button class="menuTab" data-tab="settings">Settings</button>
    </div>
    <div class="menuBody">
      <div id="tab-coaches"></div>
      <div id="tab-upgrades" style="display:none"><p>Upgrades coming soon.</p></div>
      <div id="tab-achievements" style="display:none"></div>
      <div id="tab-stats" style="display:none"></div>
      <div id="tab-settings" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Tutorial -->
<div id="tutOv" class="tutOv" aria-hidden="true">
  <div id="tutSpot" class="tutSpot" style="display:none"></div>
  <div id="tutBubble" class="tutBubble" role="dialog" aria-live="polite" aria-modal="true">
    <div id="tutAvatar" class="tutAvatar">
      <img alt="Trainer" decoding="async" loading="eager"
           src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Trainer%20GIF.gif">
    </div>
    <div class="tutText">
      <div id="tutWho" class="tutWho">JAX</div>
      <div id="tutLine">â€¦</div>
      <div class="tutMore"><span>Next</span> <span style="color:#ffb357;font-weight:900">â€º</span></div>
    </div>
  </div>
</div>

<script>
/* ========= Safe Boot Diagnostics ========= */
(function(){
  const box=document.getElementById('bootError');
  const msg=document.getElementById('bootErrorMsg');
  function show(err){box.style.display='block';msg.textContent=String(err && (err.stack||err.message||err));}
  window.addEventListener('error',e=>show(e.error||e.message));
  window.addEventListener('unhandledrejection',e=>show(e.reason||'Unhandled promise rejection'));
  window.FF_SAFE_ERROR=show;
})();

/* ========= Assets ========= */
const TRAINER_GIF="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Trainer%20GIF.gif";
const PLAYER_GIF_MALE="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Player%20Male%20GIFF.gif";
const PLAYER_GIF_FEMALE="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-PlayerFemaleGIFF.gif";

/* ========= App Core ========= */
const App={};
App.Flags={tutorial:true,coaches:true,achievements:true,settings:true};
App.Config=Object.freeze({SAVE_KEY:'ff-v420-safe',SCHEMA_VERSION:1,DEC:2,EPS:1e-6,SOLID_CD_MS:100,REP_GROWTH:1.12,SAVE_MS:20000,UI_REFRESH_MS:120,OFFLINE_MAX_MS:12*60*60*1000});

/* Utils */
App.Util=(()=>{const DEC=()=>App.Config.DEC;
  const fmtTop=n=>{const a=Math.abs(n);if(a>=1e9)return(n/1e9).toFixed(DEC())+'B';if(a>=1e6)return(n/1e6).toFixed(DEC())+'M';if(a>=1e3)return(n/1e3).toFixed(DEC())+'K';return n.toFixed(DEC());};
  const fmtCost=n=> n<1e3? n.toFixed(DEC()):(n<1e6?(n/1e3).toFixed(DEC())+'K':(n<1e9?(n/1e6).toFixed(DEC())+'M':(n/1e9).toFixed(DEC())+'B'));
  return{fmtTop,fmtCost};
})();

/* Settings (SFX on by default) */
App.Settings=(()=>{const KEY=App.Config.SAVE_KEY+':prefs',d={sfx:true,floats:true};let p={...d};try{const r=localStorage.getItem(KEY);if(r)p={...d,...JSON.parse(r)}}catch{} function save(){try{localStorage.setItem(KEY,JSON.stringify(p))}catch{}}
return{get:k=>p[k],set:(k,v)=>{p[k]=v;save();},all:()=>({...p})};})();

/* Audio (simple) */
App.Audio=(()=>{let ctx;function ensure(){if(!ctx){try{ctx=new (window.AudioContext||window.webkitAudioContext)();}catch{}} if(ctx&&ctx.state!=='running'){ctx.resume().catch(()=>{});} }
function sfx(type){if(!App.Settings.get('sfx'))return;ensure();try{const t=ctx.currentTime;const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type=type==='buy'?'triangle':(type==='popup'?'square':'sine');o.frequency.value=(type==='buy')?440:(type==='popup'?560:660);g.gain.value=0.06;g.gain.exponentialRampToValueAtTime(.0001,t+0.18);o.start();o.stop(t+0.18);}catch{}}
['pointerdown','touchstart','keydown'].forEach(ev=>window.addEventListener(ev,ensure,{once:true,passive:true}));
return{sfx};})();

/* Event bus */
App.Bus=(()=>{const m={};return{on(ev,fn){(m[ev]||(m[ev]=[])).push(fn);return()=>this.off(ev,fn)},off(ev,fn){const a=m[ev];if(!a)return;const i=a.indexOf(fn);if(i>=0)a.splice(i,1)},emit(ev,p){const a=m[ev];if(!a)return;for(const f of a.slice())try{f(p)}catch(e){console.warn(e)}}};})();

/* Content (20 exercises) */
App.Content=(()=>{const ex=[
  {id:'walk',name:'Walking',icon:'ðŸš¶',baseHP:1,baseCooldown:600,repBaseCost:4,unlockCost:0,unlocked:true},
  {id:'jog',name:'Jogging',icon:'ðŸƒ',baseHP:60,baseCooldown:3000,repBaseCost:30,unlockCost:60,unlocked:false},
  {id:'sit',name:'Sit-ups',icon:'ðŸ§˜',baseHP:180,baseCooldown:6000,repBaseCost:90,unlockCost:300,unlocked:false},
  {id:'push',name:'Push-ups',icon:'ðŸ’ª',baseHP:400,baseCooldown:12000,repBaseCost:200,unlockCost:1200,unlocked:false},
  {id:'jacks',name:'Jumping Jacks',icon:'ðŸ¤¸',baseHP:900,baseCooldown:24000,repBaseCost:450,unlockCost:1800,unlocked:false},
  {id:'squat',name:'Bodyweight Squats',icon:'ðŸ¦µ',baseHP:1800,baseCooldown:48000,repBaseCost:900,unlockCost:3600,unlocked:false},
  {id:'lunge',name:'Lunges',icon:'ðŸ¦µ',baseHP:3200,baseCooldown:96000,repBaseCost:1600,unlockCost:6400,unlocked:false},
  {id:'plank',name:'Plank',icon:'ðŸ§˜â€â™‚ï¸',baseHP:5000,baseCooldown:192000,repBaseCost:2500,unlockCost:10000,unlocked:false},
  {id:'climb',name:'Mountain Climbers',icon:'ðŸ§—',baseHP:8000,baseCooldown:384000,repBaseCost:4000,unlockCost:16000,unlocked:false},
  {id:'burpee',name:'Burpees',icon:'ðŸ¤¾',baseHP:12000,baseCooldown:768000,repBaseCost:6000,unlockCost:24000,unlocked:false},
  {id:'pullup',name:'Pull-ups',icon:'ðŸ§—â€â™‚ï¸',baseHP:18000,baseCooldown:1536000,repBaseCost:9000,unlockCost:36000,unlocked:false},
  {id:'kb',name:'Kettlebell Swings',icon:'ðŸ‹ï¸',baseHP:26000,baseCooldown:3072000,repBaseCost:13000,unlockCost:52000,unlocked:false},
  {id:'bench',name:'Bench Press',icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:36000,baseCooldown:6144000,repBaseCost:18000,unlockCost:72000,unlocked:false},
  {id:'backsq',name:'Back Squat',icon:'ðŸ‹ï¸â€â™€ï¸',baseHP:48000,baseCooldown:12288000,repBaseCost:24000,unlockCost:96000,unlocked:false},
  {id:'dead',name:'Deadlift',icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:65000,baseCooldown:24576000,repBaseCost:32500,unlockCost:130000,unlocked:false},
  {id:'clean',name:'Clean & Jerk',icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:85000,baseCooldown:49152000,repBaseCost:42500,unlockCost:170000,unlocked:false},
  {id:'snatch',name:'Snatch',icon:'ðŸ‹ï¸â€â™€ï¸',baseHP:110000,baseCooldown:98304000,repBaseCost:55000,unlockCost:220000,unlocked:false},
  {id:'halfmar',name:'Half Marathon',icon:'ðŸŽ½',baseHP:150000,baseCooldown:196608000,repBaseCost:75000,unlockCost:300000,unlocked:false},
  {id:'marathon',name:'Marathon',icon:'ðŸ',baseHP:200000,baseCooldown:393216000,repBaseCost:100000,unlockCost:400000,unlocked:false},
  {id:'ironcross',name:'Iron Cross',icon:'ðŸ¤¸â€â™‚ï¸',baseHP:260000,baseCooldown:786432000,repBaseCost:130000,unlockCost:520000,unlocked:false}
]; return{exercises:ex};})();

/* State */
App.State=(()=>{const KEY=App.Config.SAVE_KEY;const s={schemaVersion:App.Config.SCHEMA_VERSION,hp:0,buyQty:1,exercises:[],coachesOwned:{},stats:{manualTaps:0,autoTaps:0,totalEarned:0},
  tutorial:{done:false,avatar:'male',shown:{unlock:{},coach:{},upgrade:{}}},achievements:{}};
  function setExercises(list){const base=(Array.isArray(list)&&list.length)?list:(App.Content?.exercises||[]);
    s.exercises=base.map(e=>({...e,repHP:0,repProgress:0,repTarget:10,level:1,cooldown:e.baseCooldown,lastTapAt:e.unlocked?0:-1,_autoElapsed:0,els:{}}));}
  function load(){try{const raw=localStorage.getItem(KEY);if(!raw)return;const j=JSON.parse(raw);
    s.schemaVersion=j.schemaVersion||s.schemaVersion;s.hp=j.hp??0;s.buyQty=j.buyQty??1;s.coachesOwned=j.coachesOwned||{};s.stats=j.stats||s.stats;
    s.tutorial={...s.tutorial,...(j.tutorial||{}),shown:{unlock:{},coach:{},upgrade:{},...(j.tutorial?.shown||{})}};
    s.achievements=j.achievements||{};s.__loaded=j.exercises||[];}catch(e){console.warn('Load failed',e);}}
  function merge(){if(!s.__loaded)return;const idx=Object.fromEntries(s.exercises.map(e=>[e.id,e]));for(const se of s.__loaded){const e=idx[se.id];if(!e)continue;
      e.repHP=se.repHP??0;e.repProgress=se.repProgress??0;e.repTarget=se.repTarget??10;e.unlocked=se.unlocked??e.unlocked;e.cooldown=se.cooldown??e.baseCooldown;e.level=se.level??1;e.lastTapAt=(se.lastTapAt??0);}
    delete s.__loaded;}
  function save(){try{localStorage.setItem(KEY,JSON.stringify({schemaVersion:s.schemaVersion,hp:s.hp,buyQty:s.buyQty,coachesOwned:s.coachesOwned,stats:s.stats,tutorial:s.tutorial,achievements:s.achievements,
      exercises:s.exercises.map(e=>({id:e.id,repHP:e.repHP,repProgress:e.repProgress,repTarget:e.repTarget,unlocked:e.unlocked,cooldown:e.cooldown,level:e.level,lastTapAt:e.lastTapAt}))}))}catch{}}
  return{s,setExercises,load,merge,save};
})();

/* Game math */
App.Game=(()=>{const {EPS,REP_GROWTH}=App.Config;const S=App.State.s;const perTap=e=>e.baseHP+e.repHP;
  const bulkRepCost=(e,q)=>{const base=e.repBaseCost*Math.pow(REP_GROWTH,e.repHP);return +(base*(Math.pow(REP_GROWTH,q)-1)/(REP_GROWTH-1)).toFixed(App.Config.DEC);};
  function addHP(d){S.hp+=d;if(d>0){S.stats.totalEarned=(S.stats.totalEarned||0)+d}App.Bus.emit('hp:change',S.hp);}
  function addReps(e,q){const cost=bulkRepCost(e,q);if(S.hp+EPS<cost)return false;addHP(-cost);e.repHP+=q;e.repProgress+=q;App.Bus.emit('reps:buy',{exId:e.id,qty:q});
    while(e.repProgress>=e.repTarget){e.repProgress-=e.repTarget;e.repTarget*=2;e.cooldown=Math.max(100,Math.floor(e.cooldown/2));e.level+=1;App.Bus.emit('exercise:levelup',{exId:e.id,level:e.level});App.UI.Banners.upgrade(`${e.name} upgraded to Lvl ${e.level}! Speed Ã—2`);} return true;}
  function tap(e,now=performance.now()){if(!e.unlocked)return 0;const cd=e.cooldown;if(e.lastTapAt>0 && now-e.lastTapAt<cd-1)return 0;e.lastTapAt=now;const g=perTap(e);addHP(g);S.stats.manualTaps++;App.Bus.emit('tap:manual',{exId:e.id,gain:g});return g;}
  return{perTap,bulkRepCost,addReps,tap,addHP};
})();

/* Coaches */
App.Coaches=(()=>{const list=[
  {id:'c1',name:'Rookie Coach',icon:'ðŸ§‘â€ðŸ«',price:1500,target:'walk'},
  {id:'c2',name:'Track Buddy',icon:'ðŸ‘Ÿ',price:6000,target:'jog'},
  {id:'c3',name:'Core Captain',icon:'ðŸ§˜â€â™‚ï¸',price:25000,target:'sit'},
  {id:'c4',name:'Push-up Pro',icon:'ðŸ’ª',price:100000,target:'push'}
];
  function isAuto(exId){const owned=App.State.s.coachesOwned;return list.some(c=>owned[c.id]&&c.target===exId);}
  function forExercise(exId){const owned=App.State.s.coachesOwned;return list.filter(c=>owned[c.id]&&c.target===exId);}
  function renderList(){const host=document.getElementById('tab-coaches');host.innerHTML=`<div class="coachIntro">Coaches auto-tap a specific exercise (no sounds). They respect cooldown.</div>`;const wrap=document.createElement('div');wrap.className='coachList';host.appendChild(wrap);
    const exById=Object.fromEntries(App.State.s.exercises.map(e=>[e.id,e]));for(const c of list){const owned=!!App.State.s.coachesOwned[c.id];const targ=exById[c.target];const locked=!(targ&&targ.unlocked);
      const card=document.createElement('div');card.className='coachCard'+(locked?' locked':'');
      card.innerHTML=`<div class="headshot">${c.icon}</div><div class="coachMid"><div class="coachName">${c.name}</div><div class="coachInfo">Works on: ${targ?targ.name:c.target}</div></div><div class="coachRight"><button class="hireBtn secondary" data-id="${c.id}">${owned?'Owned':`Hire â€¢ ${App.Util.fmtCost(c.price)} HP`}</button></div>`;
      wrap.appendChild(card);
      const btn=card.querySelector('.hireBtn');if(owned||locked){btn.disabled=true}else{const can=App.State.s.hp+App.Config.EPS>=c.price;btn.disabled=!can;btn.classList.toggle('ready',can);btn.classList.toggle('secondary',!can);}
      btn.addEventListener('click',()=>{if(btn.disabled)return;App.Game.addHP(-c.price);App.State.s.coachesOwned[c.id]=true;App.Audio.sfx('buy');App.Bus.emit('coach:owned',c.id);renderList();});
    }}
  return{isAuto,forExercise,renderList,list:()=>list.slice()};
})();

/* Achievements (basic) */
App.Achievements=(()=>{const defs=[
  {id:'first_steps',icon:'ðŸ‘£',title:'First Steps',desc:'Upgrade Walking to Lvl 2 (10/10).',reward:50,done:()=>lvl('walk')>=2},
  {id:'jog_unlocked',icon:'ðŸƒ',title:'Add to Routine',desc:'Unlock Jogging.',reward:100,done:()=>unlocked('jog')}
];
  function unlocked(id){const e=App.State.s.exercises.find(x=>x.id===id);return e&&e.unlocked;}
  function lvl(id){const e=App.State.s.exercises.find(x=>x.id===id);return e?e.level:0;}
  function grant(a){if(App.State.s.achievements[a.id])return;App.State.s.achievements[a.id]=true;App.Game.addHP(a.reward);App.UI.Banners.upgrade(`Achievement: ${a.title} â€¢ +${App.Util.fmtTop(a.reward)} HP`);App.Audio.sfx('popup');}
  function check(){for(const a of defs){if(!App.State.s.achievements[a.id]&&a.done())grant(a);}}
  function render(){const host=document.getElementById('tab-achievements');const grid=document.createElement('div');grid.className='coachList';for(const a of defs){const done=!!App.State.s.achievements[a.id];
      const div=document.createElement('div');div.className='coachCard';div.innerHTML=`<div class="headshot">${a.icon}</div><div class="coachMid"><div class="coachName">${a.title}</div><div class="coachInfo">${a.desc}</div></div><div class="coachRight"><div class="hireBtn ${done?'ready':''}">${done?('+'+App.Util.fmtTop(a.reward)+' HP'):('Reward '+App.Util.fmtTop(a.reward))}</div></div>`;grid.appendChild(div);}host.innerHTML='';host.appendChild(grid);}
  App.Bus.on('hp:change',check);App.Bus.on('exercise:unlock',check);App.Bus.on('exercise:levelup',check);App.Bus.on('reps:buy',check);
  return{render};
})();

/* UI helpers */
App.UI={};
App.UI.Banners=(()=>{function upgrade(text){const host=document.getElementById('bannerHost');const el=document.createElement('div');el.className='banner';el.innerHTML=`ðŸŽ‰ <strong>${text}</strong>`;host.appendChild(el);setTimeout(()=>el.remove(),3600);}return{upgrade};})();

App.UI.Overlay=(()=>{const floatFrom=(fromEl,text)=>{if(!App.Settings.get('floats'))return;const r=fromEl.getBoundingClientRect();const span=document.createElement('div');span.className='float';span.textContent=text;span.style.left=(r.left+r.width/2)+'px';span.style.top=(r.top+r.height*0.1)+'px';document.body.appendChild(span);setTimeout(()=>span.remove(),950);};return{floatFrom,suppress:false};})();

/* Renderer */
App.UI.Renderer=(()=>{const refs={stack:document.getElementById('stack'),hp:document.getElementById('hp'),hpMenu:document.getElementById('hpMenu'),
  qtyTop:document.getElementById('qtyTop'),saveBtn:document.getElementById('saveBtn'),resetBtn:document.getElementById('resetBtn'),
  menuBtn:document.getElementById('menuBtn')};const {fmtTop,fmtCost}=App.Util;const {perTap,bulkRepCost}=App.Game;const s=App.State.s;let shownHP=0;
  function card(e){const c=document.createElement('div');c.className='card'+(e.unlocked?'':' locked');c.dataset.id=e.id;
    const pad=document.createElement('div');pad.className='tapPad';pad.textContent=e.icon;const lvl=document.createElement('div');lvl.className='lvl';lvl.textContent=`Lvl ${e.level}`;pad.appendChild(lvl);
    const repBand=document.createElement('div');repBand.className='repBand';repBand.innerHTML=`<div class="repFill"></div><div class="repLabel">0/10</div>`;pad.appendChild(repBand);
    const right=document.createElement('div');right.className='right';
    const head=document.createElement('div');head.className='ex-head';head.innerHTML=`<div class="ex-title">${e.name}</div><div class="muted headRight"></div><div class="coachs coachSlotTop"></div>`;
    const cool=document.createElement('div');cool.className='coolwrap';cool.innerHTML=`<div class="coolbar"><div class="coolfill"></div></div>`;
    const meta=document.createElement('div');meta.className='metaRow';meta.innerHTML=`<span class="kv"><strong class="kvTap">${perTap(e).toFixed(App.Config.DEC)}</strong> HP</span><button class="btn secondary" data-role="reps">Reps</button>`;
    const costLine=document.createElement('div');costLine.className='costLine';costLine.innerHTML=`<button class="costPill" type="button">Unlock for <span class="costAmt"></span> HP</button>`;
    right.appendChild(head);right.appendChild(cool);right.appendChild(meta);right.appendChild(costLine);c.appendChild(pad);c.appendChild(right);
    e.els={card:c,tapPad:pad,lvl,repFill:repBand.querySelector('.repFill'),repLabel:repBand.querySelector('.repLabel'),headRight:head.querySelector('.headRight'),
      coolFill:cool.querySelector('.coolfill'),kvTap:meta.querySelector('.kvTap'),buyBtn:meta.querySelector('button'),coachSlotTop:head.querySelector('.coachSlotTop'),costPill:costLine.querySelector('.costPill'),costAmt:costLine.querySelector('.costAmt')};
    if(!e.unlocked){cool.style.display='none';meta.style.display='none';head.querySelector('.coachSlotTop').style.display='none';}
    App.Engine.bindPress(pad,()=>{const g=App.Game.tap(e);if(g>0){App.Audio.sfx('tap');App.UI.Overlay.floatFrom(pad,`+${g.toFixed(App.Config.DEC)}`);}});
    App.Engine.bindPress(e.els.buyBtn,()=>{if(App.Game.addReps(e,App.State.s.buyQty||1)){App.Audio.sfx('buy');refreshExercise(e);}});
    e.els.costPill.addEventListener('click',()=>{if(e.unlocked)return;const can=s.hp+App.Config.EPS>=e.unlockCost;if(!can)return;App.Game.addHP(-e.unlockCost);e.unlocked=true;e.lastTapAt=0;App.Audio.sfx('buy');App.Bus.emit('exercise:unlock',e.id);refreshExercise(e,true);});
    return c;}
  function renderStack(){refs.stack.innerHTML='';for(const e of s.exercises){refs.stack.appendChild(card(e));refreshExercise(e,true);}}
  function refreshExercise(e,full){const cd=Math.max(100,e.cooldown);
    if(e.unlocked){if(e.els.kvTap)e.els.kvTap.textContent=perTap(e).toFixed(App.Config.DEC);
      if(cd<=App.Config.SOLID_CD_MS){if(e.els.coolFill)e.els.coolFill.style.width='100%';if(e.els.headRight)e.els.headRight.textContent=(cd/1000).toFixed(App.Config.DEC)+'s';}
      else{const ready=(e.lastTapAt<=0);const since=ready?cd:(performance.now()-e.lastTapAt);const pct=Math.max(0,Math.min(1,since/cd));if(e.els.coolFill)e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';
        if(e.els.headRight)e.els.headRight.textContent=(Math.max(0,Math.min(since,cd))/1000).toFixed(App.Config.DEC)+'s';}}
    if(e.els.repLabel)e.els.repLabel.textContent=`${e.repProgress}/${e.repTarget}`;if(e.els.repFill)e.els.repFill.style.width=(Math.min(e.repProgress/e.repTarget,1)*100).toFixed(1)+'%';
    if(e.els.lvl)e.els.lvl.textContent=`Lvl ${e.level}`;
    if(e.els.buyBtn){const qty=s.buyQty||1,cost=App.Game.bulkRepCost(e,qty),can=s.hp+App.Config.EPS>=cost;e.els.buyBtn.textContent=(qty===1?`Reps (${App.Util.fmtCost(cost)} HP)`: `Ã—${qty} Reps (${App.Util.fmtCost(cost)} HP)`);e.els.buyBtn.disabled=!can;e.els.buyBtn.classList.toggle('primary',can);e.els.buyBtn.classList.toggle('secondary',!can);}
    if(!e.unlocked&&e.els.costPill){const canUn=s.hp+App.Config.EPS>=e.unlockCost;e.els.costAmt.textContent=App.Util.fmtCost(e.unlockCost);e.els.card.classList.toggle('unlock-ready',canUn);}
    if(full&&e.els.coachSlotTop){const cs=App.Coaches.forExercise(e.id);e.els.coachSlotTop.innerHTML='';if(cs.length){for(const c of cs){const chip=document.createElement('div');chip.textContent=`${c.icon} ${c.name}`;chip.className='kv';e.els.coachSlotTop.appendChild(chip);}}}
  }
  function refreshAll(){for(const e of s.exercises)refreshExercise(e)}
  function tickTop(dt){shownHP+=(s.hp-shownHP)*Math.min(1,dt*8);refs.hp.textContent=fmtTop(shownHP);const hpMenu=document.getElementById('hpMenu');if(hpMenu)hpMenu.textContent=fmtTop(shownHP);}
  function buildStats(){const host=document.getElementById('tab-stats');const owned=Object.keys(s.coachesOwned).length;const unlocked=s.exercises.filter(e=>e.unlocked).length;
    host.innerHTML=`<div class="coachIntro"><strong>Lifetime Stats</strong><div>Total HP: ${fmtTop(s.hp)}</div><div>Earned: ${fmtTop(s.stats.totalEarned||0)}</div><div>Manual taps: ${s.stats.manualTaps}</div><div>Auto taps: ${s.stats.autoTaps}</div><div>Exercises unlocked: ${unlocked}/${s.exercises.length}</div><div>Coaches hired: ${owned}/${App.Coaches.list().length}</div></div>`;}
  function buildSettings(){const host=document.getElementById('tab-settings');const prefs=App.Settings.all();
    host.innerHTML=`<div class="coachIntro"><strong>Preferences</strong></div><label><input id="set-sfx" type="checkbox" ${prefs.sfx?'checked':''}/> Sound effects</label><br><label><input id="set-floats" type="checkbox" ${prefs.floats?'checked':''}/> Show +HP float</label>`;
    document.getElementById('set-sfx').onchange=e=>App.Settings.set('sfx',!!e.target.checked);
    document.getElementById('set-floats').onchange=e=>App.Settings.set('floats',!!e.target.checked);}
  function wireMenu(){const overlay=document.getElementById('menuOverlay');const close=document.getElementById('menuClose');
    document.getElementById('topPlayerAvatar').addEventListener('click',()=>{App.Audio.sfx('popup');overlay.classList.add('open');overlay.setAttribute('aria-hidden','false');});
    close.addEventListener('click',()=>{App.Audio.sfx('popup');overlay.classList.remove('open');overlay.setAttribute('aria-hidden','true');});
    overlay.addEventListener('click',e=>{if(e.target===overlay)close.click();});
    document.querySelectorAll('.menuTab').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.menuTab').forEach(b=>b.classList.toggle('active',b===btn));
      const id=btn.dataset.tab;['coaches','upgrades','achievements','stats','settings'].forEach(t=>{document.getElementById('tab-'+t).style.display=(t===id?'block':'none');});
      if(id==='coaches')App.Coaches.renderList();if(id==='achievements')App.Achievements.render();if(id==='stats')buildStats();if(id==='settings')buildSettings();}));
  }
  return{refs,renderStack,refreshAll,refreshExercise,tickTop,wireMenu};
})();

/* Engine */
App.Engine=(()=>{let last=performance.now();function start(){function tick(){const now=performance.now(),dt=Math.min(0.25,(now-last)/1000);last=now;autoTap(now,dt);App.UI.Renderer.tickTop(dt);for(const e of App.State.s.exercises)updateCooldown(e);App.UI.Renderer.refreshAll();requestAnimationFrame(tick);}requestAnimationFrame(tick);}
  function autoTap(now,dt){const s=App.State.s;for(const e of s.exercises){if(!App.Coaches.isAuto(e.id))continue;e._autoElapsed=(e._autoElapsed||0)+dt*1000;const cd=Math.max(100,e.cooldown);while(e._autoElapsed>=cd){e._autoElapsed-=cd;e.lastTapAt=now;const g=e.baseHP+e.repHP;App.Game.addHP(g);s.stats.autoTaps++;}}}
  function updateCooldown(e){if(!e.unlocked)return;const cd=Math.max(100,e.cooldown);if(cd<=App.Config.SOLID_CD_MS){if(e.els.coolFill)e.els.coolFill.style.width='100%';if(e.els.headRight)e.els.headRight.textContent=(cd/1000).toFixed(App.Config.DEC)+'s';return;}
    const ready=(e.lastTapAt<=0);const since=ready?cd:(performance.now()-e.lastTapAt);const pct=Math.max(0,Math.min(1,since/cd));if(e.els.coolFill)e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';if(e.els.headRight)e.els.headRight.textContent=(Math.max(0,Math.min(since,cd))/1000).toFixed(App.Config.DEC)+'s';}
  function bindPress(el,fn){el.addEventListener('pointerdown',e=>{e.preventDefault();fn(e);},{passive:false});el.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();fn(e);}});}
  return{start,bindPress};
})();

/* Notify dot */
App.Notify=(()=>{const dot=document.getElementById('menuDotAvatar');function coachAvail(){const s=App.State.s;const ex=Object.fromEntries(s.exercises.map(e=>[e.id,e]));for(const c of App.Coaches.list()){if(s.coachesOwned[c.id])continue;const t=ex[c.target];if(!t||!t.unlocked)continue;if(s.hp+App.Config.EPS>=c.price)return true;}return false;}
  function update(){const show=coachAvail();dot.classList.toggle('show',show);}App.Bus.on('hp:change',update);App.Bus.on('coach:owned',update);App.Bus.on('exercise:unlock',update);return{update};})();

/* Start */
App.UI.Start=(()=>{const ov=document.getElementById('startOv');const btnStart=document.getElementById('btnStart');const btnCont=document.getElementById('btnContinue');const seg=document.getElementById('segAvatar');const topImg=document.getElementById('topPlayerImg');
  function setAvatar(av){App.State.s.tutorial.avatar=av;[...seg.querySelectorAll('.segBtn')].forEach(b=>b.classList.toggle('active',b.dataset.avatar===av));topImg.src=(av==='female')?PLAYER_GIF_FEMALE:PLAYER_GIF_MALE;App.State.save();}
  function init(){const cur=App.State.s.tutorial.avatar||'male';setAvatar(cur);seg.querySelectorAll('.segBtn').forEach(b=>b.addEventListener('click',()=>{App.Audio.sfx('tap');setAvatar(b.dataset.avatar);}));btnStart.addEventListener('click',()=>{App.Audio.sfx('popup');hide();if(!App.State.s.tutorial.done){App.Tutorial.start();}setTimeout(()=>App.Offline.checkAndShow(),50);});btnCont.addEventListener('click',()=>{App.Audio.sfx('popup');hide();setTimeout(()=>App.Offline.checkAndShow(),50);});}
  function show(){ov.classList.add('open');ov.setAttribute('aria-hidden','false');}
  function hide(){ov.classList.remove('open');ov.setAttribute('aria-hidden','true');}
  return{init,show,hide};
})();

/* Tutorial (intro + dynamic triggers) */
App.Tutorial=(()=>{if(!App.Flags.tutorial){return{start(){},reposition(){}};}const ov=document.getElementById('tutOv');const bubble=document.getElementById('tutBubble');const who=document.getElementById('tutWho');const line=document.getElementById('tutLine');const spot=document.getElementById('tutSpot');
  let step=null,idx=0;
  function setSpeaker(name){who.textContent=name;}
  function setText(html){line.innerHTML=html;}
  function show(){ov.classList.add('show');ov.setAttribute('aria-hidden','false');}
  function hide(){ov.classList.remove('show');ov.setAttribute('aria-hidden','true');hideSpot();}
  function showSpot(sel){const el=document.querySelector(sel);if(!el){hideSpot();return;}const r=el.getBoundingClientRect(),pad=6;spot.style.display='block';spot.style.left=(r.left-pad)+'px';spot.style.top=(r.top-pad)+'px';spot.style.width=(r.width+pad*2)+'px';spot.style.height=(r.height+pad*2)+'px';}
  function hideSpot(){spot.style.display='none';}
  bubble.addEventListener('click',()=>{if(!step)return;if(idx<step.lines.length-1){idx++;const L=step.lines[idx];setSpeaker(L.who);setText(L.html);}else{hide();step.onDone&&step.onDone();}});
  function intro(){step={lines:[{who:'JAX',html:'Heyâ€”energy looks low. Letâ€™s fix that <strong style="color:#ffb357">fast</strong>.'},{who:'You',html:'Okayâ€”where do I start?'},{who:'JAX',html:'Tap <strong style="color:#ffb357">Walking</strong> to earn <strong style="color:#ffb357">1 HP</strong> each time.'}],onDone(){showSpot('.card[data-id="walk"] .tapPad');setTimeout(hide,50);}};idx=0;setSpeaker(step.lines[0].who);setText(step.lines[0].html);show();}
  function maybeUnlockPrompt(){const s=App.State.s;const jog=s.exercises.find(e=>e.id==='jog');if(jog && !jog.unlocked && !s.tutorial.shown.unlock?.jog && s.hp+App.Config.EPS>=jog.unlockCost){s.tutorial.shown.unlock=s.tutorial.shown.unlock||{};s.tutorial.shown.unlock.jog=true;App.State.save();step={lines:[{who:'JAX',html:`Add to your routine: unlock <strong style="color:#ffb357">${jog.name}</strong> for <strong style="color:#ffb357">${App.Util.fmtTop(jog.unlockCost)}</strong> HP.`}],onDone(){hide();}};idx=0;setSpeaker(step.lines[0].who);setText(step.lines[0].html);show();showSpot('.card[data-id="jog"] .costPill');}}
  App.Bus.on('hp:change',maybeUnlockPrompt);App.Bus.on('exercise:unlock',maybeUnlockPrompt);App.Bus.on('exercise:levelup',({exId})=>{const ex=App.State.s.exercises.find(x=>x.id===exId);if(!ex)return;const key=ex.id;const s=App.State.s;if(s.tutorial.shown.upgrade?.[key])return;s.tutorial.shown.upgrade=s.tutorial.shown.upgrade||{};s.tutorial.shown.upgrade[key]=true;App.State.save();step={lines:[{who:'JAX',html:`<strong style="color:#ffb357">${ex.name} upgraded!</strong> Cooldown halved.`}],onDone(){hide();}};idx=0;setSpeaker(step.lines[0].who);setText(step.lines[0].html);show();});
  return{start:intro};
})();

/* Offline */
App.Offline=(()=>{const KEY='ff-last-active';
  function saveNow(){try{localStorage.setItem(KEY,Date.now().toString());}catch{}}
  function summarize(ms){let earned=0;const s=App.State.s;for(const e of s.exercises){if(!e.unlocked)continue;if(!App.Coaches.isAuto(e.id))continue;const cd=Math.max(100,e.cooldown);const taps=Math.floor(ms/cd);if(taps<=0)continue;earned+=taps*(e.baseHP+e.repHP);}return earned;}
  function fmt(ms){let sec=Math.floor(ms/1000);const h=Math.floor(sec/3600);sec%=3600;const m=Math.floor(sec/60);sec%=60;const parts=[];if(h)parts.push(h+'h');if(m)parts.push(m+'m');if(sec||!parts.length)parts.push(sec+'s');return parts.join(' ');}
  function checkAndShow(){const last=parseInt(localStorage.getItem(KEY)||'0',10);const now=Date.now();if(last>0){const delta=now-last;const capped=Math.min(delta,App.Config.OFFLINE_MAX_MS);const gained=summarize(capped);
      if(gained>0){document.getElementById('offAmt').textContent=App.Util.fmtTop(gained);document.getElementById('offDur').textContent=fmt(capped);document.getElementById('offCapNote').style.display=(delta>capped)?'block':'none';
        const ov=document.getElementById('offOv');ov.classList.add('open');ov.setAttribute('aria-hidden','false');document.getElementById('offClose').onclick=()=>{ov.classList.remove('open');ov.setAttribute('aria-hidden','true');};
        document.getElementById('offClaim').onclick=()=>{App.Game.addHP(gained);ov.classList.remove('open');ov.setAttribute('aria-hidden','true');};}} saveNow();}
  window.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden')saveNow();});
  window.addEventListener('pagehide',saveNow);window.addEventListener('beforeunload',saveNow);
  return{checkAndShow};
})();

/* Boot */
(function boot(){
  try{
    /* prevent double-tap zoom */
    let lastTouchEnd=0;document.addEventListener('touchend',e=>{const n=Date.now();if(n-lastTouchEnd<=300){e.preventDefault();}lastTouchEnd=n;},{passive:false});
    document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});

    /* Seed before anything */
    App.State.setExercises(App.Content.exercises);
    App.State.load();
    App.State.merge();

    /* Render minimal game immediately */
    App.UI.Renderer.renderStack();
    App.UI.Renderer.wireMenu();
    App.Notify.update();

    /* Wire top controls */
    const r=App.UI.Renderer.refs;
    r.saveBtn.addEventListener('click',App.State.save);
    r.resetBtn.addEventListener('click',()=>{if(confirm('Reset your progress?')){localStorage.removeItem(App.Config.SAVE_KEY);location.reload();}});
    [...r.qtyTop.querySelectorAll('.segBtn')].forEach(b=>b.addEventListener('pointerdown',ev=>{ev.preventDefault();[...r.qtyTop.querySelectorAll('.segBtn')].forEach(x=>x.classList.remove('active'));b.classList.add('active');App.State.s.buyQty=parseInt(b.dataset.q,10);App.UI.Renderer.refreshAll();App.Audio.sfx('tap');},{passive:false}));

    /* Start engine */
    App.Engine.start();

    /* Start overlay init */
    App.UI.Start.init();

    /* Splash -> Start (forced) */
    const splash=document.getElementById('splashOv');
    splash.classList.add('open');splash.setAttribute('aria-hidden','false');
    setTimeout(()=>{splash.classList.remove('open');splash.setAttribute('aria-hidden','true');App.UI.Start.show();}, 2500);
    /* Failsafe: force start after 5s if not open */
    setTimeout(()=>{const startEl=document.getElementById('startOv');if(startEl && !startEl.classList.contains('open')){App.UI.Start.show();}},5000);

  }catch(err){window.FF_SAFE_ERROR(err);}
})();
</script>
</body>
</html>