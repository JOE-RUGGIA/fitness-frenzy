<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Fitness Frenzy</title>
<style>
:root{
  --bg:#0f1421; --bg2:#0b1220;
  --ink:#eaf1fb; --muted:#9fb0c6;
  --card:#152136; --edge:rgba(255,255,255,.06);
  --accent:#ff7a1a; --accent2:#ffc38f;
  --good:#2dd36f; --lock:#8ea0bd; --danger:#ff4d4d;
}
*{box-sizing:border-box}
html,body{height:100%}
html{-webkit-text-size-adjust:100%}
body{
  margin:0;color:var(--ink);
  font:16px/1.45 system-ui, Segoe UI, Arial;
  background:
    radial-gradient(900px 600px at -10% -20%,rgba(58,160,255,.15),transparent),
    radial-gradient(1000px 700px at 110% 10%,rgba(255,122,26,.10),transparent),
    linear-gradient(180deg,var(--bg),var(--bg2));
  -webkit-tap-highlight-color: transparent;
  padding-bottom: env(safe-area-inset-bottom);
}

/* Sticky header */
header{
  position:sticky; top:0; z-index:1000;
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;
  background:rgba(15,21,33,.85); border-bottom:1px solid var(--edge);
  backdrop-filter:saturate(1.1) blur(8px);
}
.hp-wrap{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.hp-icon{font-size:26px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
.hp{
  flex:1 1 auto;
  font:900 clamp(22px,4.2vw,36px)/1 system-ui;
  min-width: 0;
  text-overflow:ellipsis;white-space:nowrap;overflow:hidden;
  text-shadow:0 6px 22px rgba(0,0,0,.35)
}
.hp small{font-weight:800;opacity:.9;background:rgba(255,255,255,.08);padding:.16em .45em;border-radius:.35em;margin-left:.45rem}
.head-actions{display:flex;gap:8px;align-items:center}

/* Icon-only mute */
.iconbtn{
  position:relative; width:44px; height:44px; border-radius:12px; border:1px solid var(--edge);
  background:#0f1926; color:#fff; display:grid; place-items:center; cursor:pointer;
}
.iconbtn svg{width:22px;height:22px}
.iconbtn.muted::after{
  content:""; position:absolute; width:28px; height:2.5px; background:var(--danger);
  transform:rotate(-30deg); border-radius:2px;
}

/* Content wrapper */
.wrap{max-width:1080px;margin:10px auto 110px;padding:0 14px}

/* Cards */
.card{
  position:relative;background:var(--card);border-radius:14px;padding:12px;margin:12px 0;
  box-shadow:0 10px 22px rgba(0,0,0,.36), inset 0 0 0 1px var(--edge);
  display:grid;grid-template-columns:160px 1fr 320px;gap:12px;align-items:center;min-height:140px;
}
@media (max-width:900px){
  .card{grid-template-columns:140px 1fr}
  .actions{grid-column:1/-1}
}
@media (max-width:680px){
  .card{grid-template-columns:1fr;gap:8px;padding:12px}
}

/* Avatar (tap area) */
.avatarbtn{
  position:relative;display:grid;place-items:center;width:100%;height: clamp(100px,24vw,120px);
  border-radius:14px;border:2px dashed #7ff2b0;background:linear-gradient(180deg,#0c1e16,#0f271a);color:#cffff1;
  cursor:pointer;user-select:none;overflow:hidden;z-index:5;transition:box-shadow .15s ease, transform .06s ease;
  touch-action: manipulation;
}
.avatarbtn.ready{box-shadow:0 0 0 3px rgba(39,210,103,.25) inset}
.avatarbtn.needGlow{animation:needBlink 1.1s ease-in-out infinite}
@keyframes needBlink{
  0%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
  50%{box-shadow:0 0 14px 2px rgba(58,160,255,.35),0 0 0 4px rgba(255,122,26,.18) inset}
  100%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
}
.emoji{font-size: clamp(52px,12vw,68px);display:block;filter:drop-shadow(0 4px 7px rgba(0,0,0,.35))}
.avatarbtn.animate .emoji{animation:bop .22s ease}
@keyframes bop{0%{transform:scale(.94) rotate(-2deg)}50%{transform:scale(1.12) rotate(2deg)}100%{transform:scale(1)}}

/* Mini progress-to-next-Rep bar inside avatar (GREEN) */
.avatar-mini{
  position:absolute;left:8px;right:8px;bottom:8px;height:10px;border-radius:8px;
  background:#0b1219;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)
}
.avatar-mini i{
  display:block;height:100%;width:0%;
  background:linear-gradient(90deg,#9cffbd,#2dd36f);
}

/* Lock */
.lockedTone{filter:grayscale(.75) brightness(.85); opacity:.9}

/* Meta + cooldown bar */
.meta h3{margin:0 0 4px;font:800 clamp(16px,3.8vw,18px)/1.15 system-ui;max-height:44px;overflow:hidden}
.meta .sub{color:var(--muted);font-size: clamp(11.5px,3.2vw,12.5px);white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
.meta .sub.lock{color:var(--lock)}
.statGrid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
.stat{color:#c7d8f7;font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.bar{height: clamp(12px,3.4vw,14px);background:#0b1219;border-radius:8px;overflow:hidden;margin-top:10px;position:relative}
.bar i{
  display:block;height:100%;width:0;
  background:
    repeating-linear-gradient(45deg, rgba(0,0,0,.06) 0 10px, rgba(0,0,0,.14) 10px 20px),
    linear-gradient(90deg,var(--accent),var(--accent2));
  background-size:24px 100%, auto; animation:stripe 1.2s linear infinite;
}
.bar.pulse i{width:100% !important; animation:none}
@keyframes stripe{from{background-position:0 0,0 0}to{background-position:24px 0,0 0}}
.bar.ready{box-shadow:0 0 0 2px rgba(45,211,111,.3) inset}

/* Actions */
.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-self:stretch}
@media (max-width:680px){ .actions{grid-template-columns:1fr} }
.btn{
  height:46px;display:flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;
  border:1px solid var(--edge);border-radius:12px;padding:10px 12px;font-weight:800;background:#0e1724;color:#fff;cursor:pointer;
}
.action{background:linear-gradient(180deg,#ff8b3a,#ff7a1a);color:#1b0e03;border-color:transparent}
.secondary{background:#0e1724;color:#fff;border:1px solid var(--edge)}
.btn[disabled]{opacity:.5;cursor:not-allowed}

/* Glitter only when affordable */
.glitter.available::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.18) 25%, rgba(255,255,255,.35) 33%, transparent 45%);
  transform:translateX(-120%); filter:blur(.6px);
  animation:shine 1.15s ease-in-out infinite;
}
@keyframes shine{0%{transform:translateX(-120%)}60%{transform:translateX(0%)}100%{transform:translateX(120%)}}

/* Mobile footer (mute only) */
.footer{
  position:fixed;left:0;right:0;bottom:0;z-index:1000;
  display:flex;gap:10px;align-items:center;justify-content:flex-end;
  padding:10px max(10px, env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
  background:rgba(15,21,33,.85); backdrop-filter: blur(10px);
  border-top:1px solid var(--edge);
}
.footer .iconbtn{min-width:44px}

/* Intro */
body.intro-open{overflow:hidden}
#intro{
  position:fixed;inset:0;z-index:5000;display:grid;place-items:center;background:rgba(8,12,20,.65);
  opacity:1;visibility:visible;transition:opacity .25s ease,visibility .25s ease
}
#intro.off{opacity:0;visibility:hidden;pointer-events:none}
.introCard{width:min(720px,92vw);background:#141f34;border:1px solid var(--edge);border-radius:16px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.introCard h1{margin:0 0 6px;font:900 clamp(22px,6vw,28px)/1.1 system-ui}
.startBtn{margin-top:12px;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#ff8b3a,#ff7a1a);border:0;border-radius:12px;color:#1b0e03;font-weight:900;padding:10px 14px;cursor:pointer}

/* Confetti/Ribbon + burst */
.ribbon{position:fixed;top:-60px;left:50%;transform:translateX(-50%);
  background:#152136;border:1px solid var(--edge);color:#eaf1fb;
  padding:10px 16px;border-radius:999px;font-weight:900;z-index:120;
  box-shadow:0 14px 32px rgba(0,0,0,.4)}
.ribbon.show{animation:slideDown .28s ease forwards, slideUp .36s ease 2.7s forwards}
@keyframes slideDown{to{top:14px}} @keyframes slideUp{to{top:-60px}}
#confetti{pointer-events:none;position:fixed;inset:0;z-index:110}
.burst{position:absolute;left:0;top:0;pointer-events:none;z-index:1300;font-size:20px}
</style>
</head>
<body class="intro-open">
<canvas id="confetti"></canvas>

<!-- INTRO -->
<div id="intro">
  <div class="introCard">
    <h1>Fitness Frenzy</h1>
    <p>Tap to earn <b>HP (Health Points)</b>. Increase <b>Reps</b> to raise HP/tap and reduce cooldown (never below <b>0.10s</b>). Hire a <b>Coach</b> later for x2 speed.</p>
    <button class="startBtn" id="startBtn">Start Workout ‚ñ∂</button>
  </div>
</div>

<header>
  <div class="hp-wrap">
    <div class="hp-icon" aria-hidden="true">üí™</div>
    <div class="hp" id="hp">0.00 <small>HP</small></div>
  </div>
  <div class="head-actions">
    <button class="iconbtn" id="muteTop" aria-label="Toggle sound">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 10v4h4l5 4V6L7 10H3zM16 7.82v8.36c1.76-.97 3-2.85 3-4.82s-1.24-3.85-3-4.82z"/></svg>
    </button>
    <button class="iconbtn" id="new" title="New Game" aria-label="New Game">üóò</button>
  </div>
</header>

<div class="wrap" aria-live="polite">
  <div id="list"></div>
</div>

<!-- Mobile footer (mute only) -->
<div class="footer">
  <button class="iconbtn" id="muteBottom" aria-label="Toggle sound">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 10v4h4l5 4V6L7 10H3zM16 7.82v8.36c1.76-.97 3-2.85 3-4.82s-1.24-3.85-3-4.82z"/></svg>
  </button>
</div>

<div class="ribbon" id="ribbon">üéâ</div>
<audio id="bgm" preload="auto" loop crossorigin="anonymous"></audio>

<script>
/* ========= CORE ========= */
const RAW_BASE = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/";
const MUSIC_URL = RAW_BASE + "Velvet%20Haze%20-%20Take%20a%20Seat%20-%20Instrumental%20version.mp3";
const STORAGE="ff_balanced_v3";

/* Exercises: id,name,emoji,baseGain,baseInterval,baseRepCost,repCostMult,gainMult,unlockCost, burstEmoji */
const EX=[
  ["walk","Walking","üëü",  1, 1.00,  10, 1.35, 1.12,   0,  "üëü"],
  ["jog","Jogging","üèÉ‚Äç‚ôÇÔ∏è", 6, 3.00,  60, 1.38, 1.13,  60,  "üèÅ"],
  ["yoga","Yoga","üßò‚Äç‚ôÇÔ∏è",  22, 5.00, 260, 1.42, 1.14, 180, "üßò"],
  ["cycle","Cycling","üö¥‚Äç‚ôÇÔ∏è", 80, 8.00, 1200,1.45, 1.15, 720,"üö¥"],
  ["lift","Weight Lifting","üèãÔ∏è‚Äç‚ôÇÔ∏è", 300,12.0, 6800,1.48,1.16, 2500,"üèãÔ∏è"],
];

const COACH_BASE = 800;       // base
const COACH_SCALE = 3.0;      // index factor
const MIN_INTERVAL = 0.10;    // cap

/* State */
let state={ hp:0, items:{}, lastSeen:Date.now() };
const tmp={}; // per-ex timers
let isPlaying=false;

/* Helpers */
const $=s=>document.querySelector(s), id=s=>document.getElementById(s);
const now=()=>performance.now()/1000;
function fmtHP(n){ const a=Math.abs(n); const d=v=>v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  if(a>=1e9) return d(n/1e9)+"B"; if(a>=1e6) return d(n/1e6)+"M"; if(a>=1e3) return d(n/1e3)+"K"; return d(n); }
function fmtCost(n){ n=Math.floor(n); const a=Math.abs(n); const f=v=>Number.isInteger(v)?v.toString():v.toFixed(1).replace(/\.0$/,'');
  if(a>=1e9) return f(n/1e9)+"B"; if(a>=1e6) return f(n/1e6)+"M"; if(a>=1e3) return f(n/1e3)+"K"; return String(n); }
function repCost(ex, lvl){ return Math.floor(ex[5] * Math.pow(ex[6], Math.max(0,lvl-1))); } // steeper cost
function gainPerTap(ex, lvl){ return Math.floor(ex[3] * Math.pow(ex[7], Math.max(0,lvl-1))); } // gentler growth
function intervalFor(ex, lvl, hasCoach){
  const base = ex[4] * Math.pow(0.92, Math.max(0,lvl-1)); // reps reduce 8%-> now 8% (0.92 factor)
  const sped = hasCoach ? base/2 : base;
  return Math.max(MIN_INTERVAL, sped);
}

/* Audio */
const bgm=id("bgm"); bgm.src=MUSIC_URL; bgm.volume=0.22;
function setMuteUI(){
  const muted = bgm.muted;
  id("muteTop").classList.toggle("muted", muted);
  id("muteBottom").classList.toggle("muted", muted);
}
id("muteTop").onclick=()=>{ bgm.muted=!bgm.muted; setMuteUI(); };
id("muteBottom").onclick=()=>{ bgm.muted=!bgm.muted; setMuteUI(); };

let AC=null, master=null, noiseBuf=null;
function ensureAC(){ try{ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; AC=new C(); master=AC.createGain(); master.gain.value=.95; master.connect(AC.destination); noiseBuf=mkNoise(.18);}catch{} }
function mkNoise(sec){ const sr=(AC?.sampleRate)||48000, n=sr*sec; const b=AC.createBuffer(1,n,sr), a=b.getChannelData(0); for(let i=0;i<n;i++) a[i]=Math.random()*2-1; return b; }
function s_click(){ try{ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="triangle";o.frequency.value=420;o.connect(g);g.connect(master);g.gain.setValueAtTime(.18,t);g.gain.exponentialRampToValueAtTime(.0001,t+.14);o.start(t);o.stop(t+.16);}catch{} }
function s_upgrade(){ try{ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="square";o.frequency.value=980;o.connect(g);g.connect(master);g.gain.setValueAtTime(.24,t);g.gain.exponentialRampToValueAtTime(.0001,t+.22);o.start(t);o.stop(t+.24);}catch{} }
function s_coin(){ try{ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="square";o.frequency.value=760;o.connect(g);g.connect(master);g.gain.setValueAtTime(.22,t);g.gain.exponentialRampToValueAtTime(.0001,t+.18);o.start(t);o.stop(t+.2);}catch{} }
function s_cheer(){ try{ ensureAC(); const t=AC.currentTime; const ns=AC.createBufferSource(); ns.buffer=noiseBuf; const hp=AC.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=420; const g1=AC.createGain(); g1.gain.value=.35; ns.connect(hp); hp.connect(g1); g1.connect(master); g1.gain.setValueAtTime(0,t); g1.gain.linearRampToValueAtTime(.35,t+.02); g1.gain.exponentialRampToValueAtTime(.0001,t+.6); ns.start(t); ns.stop(t+.62);}catch{} }

/* Save/Load */
function load(){
  try{const raw=localStorage.getItem(STORAGE); if(raw){ const parsed=JSON.parse(raw); state=Object.assign(state,parsed);} }catch{}
  EX.forEach((ex,i)=>{
    const eid=ex[0];
    if(!state.items[eid]) state.items[eid]={ unlocked: i===0, reps: Math.max(1, i===0?1:0), coach:false, next:0, taps:0 };
    tmp[eid]={timer:null};
  });
}
function save(){ state.lastSeen=Date.now(); try{localStorage.setItem(STORAGE,JSON.stringify(state));}catch{} }
function newGame(){ try{localStorage.removeItem(STORAGE);}catch{}; state={hp:0,items:{},lastSeen:Date.now()}; load(); build(); renderAll(); }

/* Build UI */
function build(){
  const host=$("#list"); host.innerHTML="";
  EX.forEach((ex,i)=>{
    const [eid,name,emoji,, , , , ,unlockCost] = ex;
    const it=state.items[eid]; const unlocked=it.unlocked;

    const card=document.createElement("div"); card.className="card"; card.dataset.id=eid;

    const coachCost = Math.floor((COACH_BASE + unlockCost*2) * (1 + i/COACH_SCALE));

    const metaUnlocked = `
      <h3>${name}</h3>
      <div class="sub">Reps Lv.<b id="replv-${eid}">${it.reps||1}</b> ‚Ä¢ Gain/tap: <b id="gain-${eid}"></b> ‚Ä¢ Cooldown: <b id="cd-${eid}"></b>s</div>
      <div class="bar" id="coolbar-${eid}"><i id="bar-${eid}"></i></div>
      <div class="statGrid">
        <div class="stat" id="repstat-${eid}"></div>
        <div class="stat" id="coachstat-${eid}"></div>
      </div>`;

    const metaLocked = `
      <h3>${name}</h3>
      <div class="sub lock">Unlock: <b>${fmtCost(unlockCost)} HP</b></div>`;

    card.innerHTML = `
      <button type="button" class="avatarbtn ${unlocked?'':'lockedTone'}" id="tap-${eid}" ${unlocked?``:`disabled`} aria-label="${unlocked?'Perform '+name:'Locked'}">
        <div class="emoji">${emoji}</div>
        <div class="avatar-mini"><i id="mini-${eid}"></i></div>
      </button>
      <div class="meta">${unlocked?metaUnlocked:metaLocked}</div>
      <div class="actions" id="actions-${eid}">
        ${unlocked
          ? `<button class="btn action" id="rep-${eid}">Reps</button>
             <button class="btn secondary" id="coach-${eid}" ${ (it.reps>=3 && !it.coach) ? "" : "disabled" }>
               <span>üßë‚Äçüíº Coach</span>
             </button>`
          : `<button class="btn action" id="unlock-${eid}">Unlock | ${fmtCost(unlockCost)} HP</button>`}
      </div>
    `;
    host.appendChild(card);

    if(unlocked){
      // Tap ‚Äì play SFX only if activation actually happens
      const tap = id("tap-"+eid);
      const handler = (e)=>{ e.preventDefault(); firstInteract();
        if (perform(eid)) { s_click(); } // play only on true perform
      };
      tap.addEventListener("pointerdown",handler,{passive:false});
      tap.addEventListener("click",handler);
      tap.addEventListener("touchstart",handler,{passive:false});

      // Reps
      id("rep-"+eid).addEventListener("click",()=>{
        const nextLvl = (it.reps||1)+1;
        const cost = repCost(ex, nextLvl);
        if(state.hp>=cost){
          state.hp -= cost; it.reps = nextLvl; s_upgrade();
          const coachBtn = id("coach-"+eid);
          if(it.reps>=3 && !it.coach) coachBtn.disabled=false;
          renderAll(); save();
        }
      });

      // Coach (x2 speed)
      const coachBtn = id("coach-"+eid);
      coachBtn?.addEventListener("click",()=>{
        if(it.coach) return;
        const price = coachCost;
        if(state.hp<price) return;
        state.hp -= price; it.coach = true; s_coin(); startCoach(eid);
        showRibbon(`üßë‚Äçüíº Coach hired for ${name} (x2 speed)`);
        coachBtn.disabled = true; renderAll(); save();
      });
    }else{
      id("unlock-"+eid).addEventListener("click",()=>{
        const cost = unlockCost;
        if(state.hp<cost) return;
        state.hp -= cost; it.unlocked=true; it.reps=1; s_coin(); showRibbon(`‚ú® Unlocked ${name}!`);
        build(); renderAll(); save();
      });
    }
  });

  // Teaser card
  const teaser=document.createElement("div"); teaser.className="card";
  const pct = Math.min(100, Math.floor((state.hp/5_000_000)*100));
  teaser.innerHTML=`
    <button type="button" class="avatarbtn lockedTone" disabled>
      <div class="emoji">üèÜ</div>
      <div class="avatar-mini"><i style="width:${pct}%;"></i></div>
    </button>
    <div class="meta">
      <h3>Ultimate Trainer</h3>
      <div class="sub">All exercises x10 ‚Ä¢ Global auto-click</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
    </div>
    <div class="actions">
      <button class="btn secondary" disabled>Coming Soon</button>
      <button class="btn secondary" id="share2">Tell a friend</button>
    </div>`;
  $("#list").appendChild(teaser);
  $("#share2").addEventListener("click",shareProgress);
}

/* Interactions */
function firstInteract(){
  if(!isPlaying){
    try{ bgm.play().catch(()=>{}); }catch(e){}
    isPlaying=true; ensureAC(); setMuteUI();
  }
  const intro=$("#intro"); if(intro && !intro.classList.contains("off")) { intro.classList.add("off"); document.body.classList.remove("intro-open"); }
}

/* Perform returns true if activation happened (for sound gating) */
function perform(eid){
  const ex = EX.find(x=>x[0]===eid), it=state.items[eid];
  const t=now();
  const interval = intervalFor(ex, it.reps||1, it.coach);
  if(t < (it.next||0)) return false; // no activation -> no SFX

  it.next = t + interval;

  let gain = gainPerTap(ex, it.reps||1);
  state.hp += gain; it.taps++;

  const tapEl=id("tap-"+eid);
  tapEl.classList.remove("animate"); void tapEl.offsetWidth; tapEl.classList.add("animate");
  floatHP(tapEl, gain);
  emojiBurst(tapEl, ex[9]); // single-theme emoji

  renderAll(); save();
  return true;
}

function startCoach(eid){
  const it=state.items[eid]; if(!it.coach) return;
  stopCoach(eid);
  const tick=()=>{
    perform(eid);
    const ex=EX.find(x=>x[0]===eid);
    const interval = intervalFor(ex, it.reps||1, true);
    tmp[eid].timer = setTimeout(tick, Math.max(80, interval*1000));
  };
  tmp[eid].timer = setTimeout(tick, 0);
}
function stopCoach(eid){ if(tmp[eid].timer){ clearTimeout(tmp[eid].timer); tmp[eid].timer=null; }}

/* Rendering */
function renderAll(){
  id("hp").innerHTML = `${fmtHP(state.hp)} <small>HP</small>`;

  EX.forEach((ex,i)=>{
    const [eid,name,emoji,, , , , ,unlockCost,burst] = ex; const it=state.items[eid];
    const unlocked=it.unlocked;

    if(unlocked){
      const t=now();
      const interval = intervalFor(ex, it.reps||1, it.coach);
      const left = Math.max(0,(it.next||0)-t);
      const pct = 1 - Math.min(1, left/interval);

      const barWrap=id("coolbar-"+eid);
      const bar=id("bar-"+eid);
      if(bar){
        if(interval<=0.18){
          barWrap?.classList.add("pulse");
          bar.style.width = "100%";
        }else{
          barWrap?.classList.remove("pulse");
          bar.style.width = Math.round(pct*100)+"%";
        }
      }
      const tap=id("tap-"+eid); if(tap){
        tap.classList.toggle("ready", left<=0);
        tap.classList.toggle("needGlow", left<=0 && !it.coach);
      }

      // Stats
      const repLv = it.reps||1;
      const gain = gainPerTap(ex, repLv);
      const cd = interval.toFixed(2).replace(/\.00$/,'');
      const nextRepCost = repCost(ex, repLv+1);

      const replv=id("replv-"+eid); if(replv) replv.textContent=repLv;
      const ge=id("gain-"+eid); if(ge) ge.textContent=fmtCost(gain);
      const ce=id("cd-"+eid); if(ce) ce.textContent=cd;

      const repstat=id("repstat-"+eid);
      if(repstat){ repstat.innerHTML = `Next Rep: <b>${fmtCost(nextRepCost)} HP</b>`; }

      const coachBtn = id("coach-"+eid);
      const coachstat=id("coachstat-"+eid);
      const cPrice = Math.floor((COACH_BASE + unlockCost*2) * (1 + i/COACH_SCALE));
      if(coachBtn && coachstat){
        if(repLv>=3 && !it.coach){
          coachBtn.disabled = state.hp<cPrice;
          coachstat.innerHTML = `Coach: <b>${fmtCost(cPrice)} HP</b><br/><small style="color:#9fb0c6">üßë‚Äçüíº x2 speed</small>`;
          coachBtn.classList.toggle("glitter", state.hp>=cPrice);
          coachBtn.classList.toggle("available", state.hp>=cPrice);
        }else if(it.coach){
          coachBtn.disabled = true;
          coachstat.innerHTML = `Coach: <b>Active</b><br/><small style="color:#9fb0c6">üßë‚Äçüíº x2 speed</small>`;
          coachBtn.classList.remove("glitter","available");
        }else{
          coachBtn.disabled = true;
          coachstat.innerHTML = `Coach: <span style="color:#9fb0c6">Unlock after Rep Lv.3</span>`;
          coachBtn.classList.remove("glitter","available");
        }
      }

      // Mini green bar toward next Rep
      const mini=id("mini-"+eid);
      if(mini){
        const pctAff = Math.max(0, Math.min(1, state.hp / Math.max(1,nextRepCost))) * 100;
        mini.style.width = pctAff.toFixed(0)+"%";
      }

      // Buttons
      const repBtn=id("rep-"+eid);
      if(repBtn){
        repBtn.textContent = `Reps | ${fmtCost(nextRepCost)} HP`;
        repBtn.disabled = state.hp<nextRepCost;
        repBtn.classList.toggle("glitter", state.hp>=nextRepCost);
        repBtn.classList.toggle("available", state.hp>=nextRepCost);
      }
    }else{
      // Locked: show only unlock in actions and meta text has cost
      const actions=id("actions-"+eid);
      if(actions){ actions.querySelectorAll(".btn").forEach(b=>{ if(!b.id.startsWith("unlock-")) b.style.display="none"; }); }
      const mini=id("mini-"+eid);
      if(mini){
        const pct = Math.max(0, Math.min(1, state.hp / Math.max(1,unlockCost))) * 100;
        mini.style.width = pct.toFixed(0)+"%";
      }
    }
  });
}

/* Floaters & burst */
function floatHP(anchor, amt){
  const n=document.createElement("div"); n.textContent="+"+fmtCost(amt)+" HP";
  n.style.position="absolute"; n.style.left="0"; n.style.top="0"; n.style.pointerEvents="none"; n.style.zIndex=1300; n.style.fontWeight="900";
  document.body.appendChild(n);
  const r=anchor.getBoundingClientRect();
  n.style.left=(r.left+r.width/2)+"px"; n.style.top=(r.top-6+window.scrollY)+"px"; n.style.transform="translate(-50%,0)";
  n.animate([{transform:"translate(-50%,0)",opacity:1,color:"#fff"},
             {transform:"translate(-50%,-46px)",opacity:0,color:"#ffdea8"}],
            {duration:820,easing:"ease-out"});
  setTimeout(()=>n.remove(),840)
}
function emojiBurst(anchor, emoji){
  const r=anchor.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2+window.scrollY;
  for(let i=0;i<10;i++){
    const e=document.createElement("div"); e.className="burst"; e.textContent=emoji;
    e.style.left=cx+"px"; e.style.top=cy+"px";
    document.body.appendChild(e);
    const dx=(Math.random()-0.5)*120, dy=-60 - Math.random()*60, rot=(Math.random()*60-30);
    e.animate([{transform:`translate(-50%,-50%) translate(0,0) rotate(0deg)`,opacity:1},
               {transform:`translate(-50%,-50%) translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
               {duration:700+Math.random()*300,easing:"cubic-bezier(.2,.8,.2,1)"});
    setTimeout(()=>e.remove(),1100);
  }
}

/* Confetti + ribbon */
const cf=id("confetti"); const cfx=cf.getContext("2d"); let confetti=[],confTimer=null;
function fireConfetti(n=140){cancelAnimationFrame(confTimer);const W=cf.width=innerWidth,H=cf.height=innerHeight;confetti=Array.from({length:n},()=>({x:Math.random()*W,y:-10,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,s:2+Math.random()*4,c:`hsl(${Math.random()*360},90%,60%)`,r:Math.random()*Math.PI}));(function loopC(){cfx.clearRect(0,0,W,H);confetti.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.r+=.1;cfx.save();cfx.translate(p.x,p.y);cfx.rotate(p.r);cfx.fillStyle=p.c;cfx.fillRect(-p.s/2,-p.s/2,p.s,p.s);cfx.restore();});confTimer=requestAnimationFrame(loopC); if(confetti.every(p=>p.y>H+20)) cancelAnimationFrame(confTimer);})(); }
function showRibbon(text){const rb=$("#ribbon");rb.textContent=text;rb.classList.remove("show");void rb.offsetWidth;rb.classList.add("show");fireConfetti(160); s_cheer();}

/* Share (teaser button uses this) */
function shareProgress(){
  const text=`I just hit ${fmtHP(state.hp)} HP in Fitness Frenzy! üí™`;
  const url=location.href;
  if(navigator.share){ navigator.share({title:"Fitness Frenzy", text, url}).catch(()=>{}); }
  else { navigator.clipboard?.writeText(`${text} ${url}`); showRibbon("üîó Link copied ‚Äî go flex!"); }
}

/* Start / New / Loop */
id("startBtn").addEventListener("click",()=>{ firstInteract(); $("#intro").classList.add("off"); document.body.classList.remove("intro-open"); });
id("new").onclick=()=>{ if(confirm("Start a new game? This wipes progress.")) newGame(); };

/* Loop: drive cooldown bars */
function loop(){ renderAll(); requestAnimationFrame(loop); }

/* Music policy (mobile) */
window.addEventListener("pointerdown",()=>{ ensureAC(); if(!isPlaying){ try{bgm.play().catch(()=>{})}catch{}; isPlaying=true; setMuteUI(); } }, {once:true});

/* Canvas size */
function fitCanvas(){ cf.width=innerWidth; cf.height=innerHeight; }
window.addEventListener("resize",fitCanvas); fitCanvas();

/* Boot */
function loadAll(){ load(); build(); renderAll(); loop(); }
loadAll();
</script>
</body>
</html>
