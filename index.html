<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy — V1.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<style>
:root{
  --bg:#08111c;
  --card:#0e1a2a;
  --ink:#ecf2f8;
  --muted:#a8bfd8;
  --border:#1f3554;
  --accent:#cc6b2c;   /* burnt orange */
  --accent-hi:#ffb357;
  --brandBlue:#2b6cb0;
  --rep:#22c55e;      /* green */
  --pillBg:#132647;
  --pillBr:#2a4a78;
  --space:clamp(10px,2.4vw,18px);
  --barH:16px;
  --repband:15%;
}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
img,video{max-width:100%;display:block}

/* ===== Sticky Top Bar (bigger) ===== */
.topbar{position:sticky;top:0;z-index:1000;background:rgba(8,17,28,.96);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:1100px;margin:0 auto;padding:8px var(--space);display:grid;grid-template-columns:auto 1fr auto;grid-template-rows:auto auto;gap:8px 14px;align-items:center}
.leftRow{display:flex;align-items:center;gap:12px}
.avatarBtn{position:relative;width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid #27456f;background:#0b1626;cursor:pointer}
.avatarBtn img{width:100%;height:100%;object-fit:cover}
.notifDot{position:absolute;right:-6px;top:-6px;width:18px;height:18px;border-radius:50%;background:#39d98a;box-shadow:0 0 0 2px rgba(8,17,28,.96);display:none;z-index:2}
.notifDot.show{display:block}
.logoImg{height:42px;width:auto;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
.qtyGroup{justify-self:end;display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.qtyBtn{background:#13233b;color:#cfe0ff;border:0;padding:7px 10px;font-weight:800;cursor:pointer;font-size:13px}
.qtyBtn.active{background:var(--accent);color:#fff}
.hpRow{grid-column:1/-1;display:flex;align-items:center}
.hpPill{display:flex;align-items:baseline;gap:8px;padding:10px 14px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid var(--pillBr);width:100%}
.hpLabel{font-weight:900;color:var(--accent)}
.hpVal{font-weight:900;font-variant-numeric:tabular-nums;text-align:left;letter-spacing:.2px}

/* ===== Layout ===== */
.wrap{max-width:1100px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}

/* ===== Exercise Card (compact) ===== */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.left{position:relative;width:88px;aspect-ratio:1;border-radius:12px;background:#102036;border:1px solid #223b60;display:flex;align-items:center;justify-content:center;overflow:hidden}
.left video,.left img{width:100%;height:100%;object-fit:cover;object-position:center}
.poster{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#0b1626}
.poster img{max-width:100%;max-height:100%;object-fit:contain}
.lvlBadge{position:absolute;left:6px;top:6px;background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;color:#fff;font-weight:900;border-radius:8px;padding:2px 6px;font-size:12px}
.coachDot{position:absolute;right:6px;top:6px;width:22px;height:22px;border-radius:6px;border:1px solid #2b3d5a;overflow:hidden;background:#0b1626;display:none}
.coachDot img{width:100%;height:100%;object-fit:cover}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#14361f;border-top:1px solid #204e2b;display:flex;align-items:center;justify-content:center;overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repText{position:relative;font-size:12px;color:#cfead6;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.4)}

.right{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:center;min-width:0}
.title{grid-column:1/-1;margin:0;font-size:16px;line-height:1}
.cool{grid-column:1/-1;background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolBar{height:var(--barH);background:#101a2a;position:relative}
.coolFill{height:100%;width:100%;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-hi) 92%);position:relative}
.coolFill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.22) 0 6px,transparent 6px 12px);opacity:.65;mix-blend-mode:overlay;animation:stripe 1.2s linear infinite}
@keyframes stripe{to{background-position:60px 0}}
.coolTime{justify-self:end;font-variant-numeric:tabular-nums;color:#cfe0ff;font-size:13px}
.kv{justify-self:start;background:#13223a;border:1px solid #203659;border-radius:8px;padding:4px 8px;color:#cfe0ff;font-size:13px;line-height:1}
.chips{justify-self:start;display:flex;gap:8px;align-items:center}
.repsBtn{justify-self:end;padding:8px 12px;border:0;border-radius:10px;font-weight:800;cursor:pointer;font-size:14px;white-space:nowrap}
.repsBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
.repsBtn:not(.ready){background:#1a2a40;color:#d7e3f5}
@media(max-width:480px){
  .left{width:78px}
  .title{font-size:15px}
  .coolTime{font-size:12px}
  .kv{font-size:12px}
  .repsBtn{font-size:13px;padding:7px 10px}
}

/* Locked */
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.lockMeta{display:flex;flex-direction:column;gap:6px}
.unlockPill{padding:8px 14px;border-radius:999px;background:#142743;border:1px solid #27456d;color:#ffd6a8;font-weight:900;cursor:not-allowed;white-space:nowrap}
.unlockPill.ready{background:linear-gradient(135deg,var(--accent),var(--accent-hi));color:#fff;border-color:#e89d6b;cursor:pointer;box-shadow:0 12px 26px rgba(204,107,44,.35)}
.card.unlockPulse{animation:unlockPulse .9s ease-in-out infinite}
@keyframes unlockPulse{0%{transform:scale(.96)}50%{transform:scale(.975)}100%{transform:scale(.96)}}

/* Tap FX */
.float{position:fixed;left:0;top:0;transform:translate(-50%,-10px);color:#ffe6c7;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.6);animation:rise .9s ease-out forwards;pointer-events:none;z-index:2000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}
.burst{position:absolute;inset:0;pointer-events:none}
.star{position:absolute;width:6px;height:6px;background:#ffd166;border-radius:50%;opacity:0;animation:popStar .5s ease-out forwards}
@keyframes popStar{0%{transform:scale(.2);opacity:0}30%{opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(1);opacity:0}}

/* Banners */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);border-top:1px solid var(--pillBr);color:#fff;padding:12px 16px calc(12px + env(safe-area-inset-bottom));text-align:center;z-index:2500;animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.8s}
@keyframes bannerIn{to{transform:translateY(0)}}
@keyframes bannerOut{to{transform:translateY(10px);opacity:0}}

/* ===== Menu Overlay ===== */
.menuOv{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3000}
.menuOv.open{display:flex}
.panel{width:min(1100px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:18px 18px 0 0;overflow:hidden;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column}
.panelHead{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.panelTitle{font-weight:900}
.hpMini{margin-left:auto;background:#132647;border:1px solid var(--pillBr);border-radius:999px;padding:4px 10px}
.menuTabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px var(--space);border-bottom:1px solid var(--border)}
.tabBtn{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.tabBtn.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.panelBody{padding:14px var(--space);overflow:auto}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1)}
.headshot{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid #1a2f4a;background:#12243b;display:flex;align-items:center;justify-content:center}
.headshot img{width:100%;height:100%;object-fit:cover}
.cName{font-weight:900}
.cInfo{color:var(--muted);font-size:14px;margin-top:4px}
.hire{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer;background:#1a2a40;color:#d7e3f5;white-space:nowrap}
.hire.ready{background:var(--accent);color:#fff}
.hire.owned{background:#198754;color:#fff}

/* ===== Splash / Start ===== */
.splash{position:fixed;inset:0;background:#fff;z-index:5000;display:none;align-items:center;justify-content:center}
.splash.open{display:flex}
.splashInner{width:min(92vw,900px);height:min(80vh,600px);display:flex;align-items:center;justify-content:center;position:relative}
.splashLogo{max-width:100%;max-height:100%;animation:splashPop 900ms cubic-bezier(.2,1.2,.3,1);filter:drop-shadow(0 18px 40px rgba(0,0,0,.35))}
@keyframes splashPop{0%{transform:scale(.8);opacity:0}50%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}

.start{position:fixed;inset:0;z-index:4500;display:none;align-items:center;justify-content:center;background:#000}
.start.open{display:flex}
.startFrame{position:relative;z-index:1;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:#000;box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startArt{position:absolute;inset:0;background:#000}
.startArt img{width:100%;height:100%;object-fit:contain}
.startUI{position:absolute;left:50%;bottom:6vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:14px;width:min(92%,680px)}
.rowBtns{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%}
.btn{padding:14px 22px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.orange{background:var(--accent);color:#fff}
.btn.blue{background:var(--brandBlue);color:#fff}
.segment{display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:10px 14px;font-weight:900;cursor:pointer;font-size:22px}
.segBtn.active{background:var(--accent);color:#fff}

/* ===== Tutorial (bigger, avatar above text) ===== */
.tut{position:fixed;inset:0;z-index:4000;display:none}
.tut.show{display:block}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.18)}
.bubble{position:absolute;left:50%;bottom:10vh;transform:translateX(-50%);display:flex;flex-direction:column;gap:12px;align-items:flex-start;background:#0f1b2b;border:2px solid var(--pillBr);border-radius:18px;padding:18px 20px;max-width:min(1080px,96vw);box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tFace{align-self:flex-start;width:110px;height:110px;border-radius:12px;overflow:hidden;border:1px solid #26406c;background:#0b1423}
.tFace img{width:100%;height:100%;object-fit:cover}
.tWho{font-weight:900;color:#ffd6a8;margin:2px 0 4px 0;font-size:18px}
.tText{font-size:clamp(18px,3.6vw,24px);line-height:1.35}
.hl{color:var(--accent);font-weight:900}
.tNext{margin-top:10px;font-size:16px;color:#cfe0ff;display:flex;align-items:center;gap:10px}
.chev{color:var(--accent-hi);font-size:26px}
.spot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 12px rgba(255,179,87,.18),0 0 42px rgba(255,179,87,.45);pointer-events:none}
.bubble.fromTop{bottom:auto;top:70px;transform:translateX(-50%)}
.bubble.fromTop::before{content:"";position:absolute;left:16px;top:-10px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid var(--pillBr)}

/* ===== Offline ===== */
.off{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3500}
.off.open{display:flex}
.offCard{width:min(520px,94vw);background:#0f1b2b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
.offTitle{margin:0 0 6px;font-weight:900}
.offAmt{font-weight:900;font-size:24px}

@media (prefers-reduced-motion: reduce){
  .coolFill::after{animation:none}
  .banner{animation:none}
}
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topwrap">
    <div class="leftRow">
      <button id="avatarBtn" class="avatarBtn" title="Menu">
        <img id="avatarImg" alt="Avatar" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-male.gif?raw=true">
        <span id="menuDot" class="notifDot"></span>
      </button>
      <img class="logoImg" alt="Fitness Frenzy Logo" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Logo%20(2).png?raw=true" />
    </div>
    <div class="qtyGroup" id="qtyGroup">
      <button class="qtyBtn active" data-q="1">×1</button>
      <button class="qtyBtn" data-q="10">×10</button>
      <button class="qtyBtn" data-q="100">×100</button>
    </div>
    <div></div>
    <div class="hpRow">
      <div class="hpPill"><span class="hpLabel">HP:</span> <span id="hpTop" class="hpVal">0.00</span></div>
    </div>
  </div>
</div>

<!-- ===== CONTENT ===== -->
<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<!-- ===== MENU ===== -->
<div id="menuOv" class="menuOv" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHead">
      <div class="panelTitle">Menu</div>
      <div class="hpMini">HP: <span id="hpMini">0.00</span></div>
      <button id="menuClose" class="btn small" style="margin-left:auto;background:#1a2a40;color:#d7e3f5">Close</button>
    </div>
    <div class="menuTabs">
      <button class="tabBtn active" data-tab="coaches">Coaches</button>
      <button class="tabBtn" data-tab="achievements">Achievements</button>
      <button class="tabBtn" data-tab="upgrades">Upgrades</button>
      <button class="tabBtn" data-tab="quests">Side Quests</button>
      <button class="tabBtn" data-tab="stats">Stats</button>
      <button class="tabBtn" data-tab="settings">Settings</button>
    </div>
    <div class="panelBody">
      <div id="tab-coaches"></div>
      <div id="tab-achievements" style="display:none"></div>
      <div id="tab-upgrades" style="display:none">
        <div class="coachCard"><div class="cInfo">Future boosts like energy drinks, pre-workout, coffee, weighted vests… temporary & permanent bonuses will live here.</div></div>
      </div>
      <div id="tab-quests" style="display:none">
        <div class="coachCard"><div class="cInfo">Side Quests ideas: 5K run, sunrise hike, fasting streak, buddy workout multipliers. (Placeholder)</div></div>
      </div>
      <div id="tab-stats" style="display:none"></div>
      <div id="tab-settings" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ===== TUTORIAL ===== -->
<div id="tut" class="tut" aria-hidden="true">
  <div class="dim"></div>
  <div id="spot" class="spot" style="display:none"></div>
  <div class="bubble" id="bubble">
    <div class="tFace"><img id="tFace" alt="Trainer"></div>
    <div>
      <div class="tWho" id="tWho">JAX</div>
      <div class="tText" id="tText">…</div>
      <div class="tNext"><span>Next</span><span class="chev">›</span></div>
    </div>
  </div>
</div>

<!-- ===== OFFLINE ===== -->
<div id="off" class="off" aria-hidden="true">
  <div class="offCard">
    <h3 class="offTitle">Welcome back! 👋</h3>
    <div>You were away for <strong id="offDur">0s</strong>.</div>
    <div class="offAmt">You earned <strong id="offAmt">0.00</strong> HP while away.</div>
    <button id="offClaim" class="btn orange" style="margin-top:10px">Claim</button>
    <div id="offCapNote" style="color:#9fb1c8;margin-top:8px;display:none">Offline gains were capped for long absences.</div>
  </div>
</div>

<!-- ===== SPLASH / START ===== -->
<div id="splash" class="splash" aria-hidden="false">
  <div class="splashInner">
    <img class="splashLogo" alt="GameBros" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
  </div>
</div>

<div id="start" class="start" aria-hidden="true">
  <div class="startFrame">
    <div class="startArt"><img alt="Cover" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Cover-Art.png?raw=true"></div>
    <div class="startUI">
      <div class="rowBtns">
        <button id="btnStart" class="btn orange">New Game</button>
        <button id="btnContinue" class="btn blue" style="display:none">Continue</button>
      </div>
      <div class="segment" id="avatarSeg">
        <button class="segBtn active" data-avatar="male" title="Male">👨</button>
        <button class="segBtn" data-avatar="female" title="Female">👩</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== Core Helpers ========== */
const App={};
App.Config=Object.freeze({SAVE_KEY:'ff-v13',SCHEMA:1,DEC:2,MIN_CD_MS:100,NOTIFY_MS:160,UI_MS:80,SAVE_MS:15000,OFFLINE_CAP_MS:86400000,PULSE_MIN_MS:9000,PULSE_MAX_MS:13000});
const IS_MOBILE=/Mobi|Android/i.test(navigator.userAgent);
const $=(q,r=document)=>r.querySelector(q);
const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const el=(t,a={})=>{const n=document.createElement(t);for(const k in a){if(k==='text')n.textContent=a[k];else if(k==='html')n.innerHTML=a[k];else n.setAttribute(k,a[k]);}return n;};
const Bus=(()=>{const m={};return{on:(e,f)=>((m[e]||(m[e]=[])).push(f)),emit:(e,p)=>(m[e]||[]).slice().forEach(fn=>{try{fn(p)}catch(err){console.error(err)}})}})();
const Util={clamp:(v,a,b)=>Math.max(a,Math.min(b,v)),fmtHP(n){const a=Math.abs(n),d=App.Config.DEC;if(a>=1e9)return(n/1e9).toFixed(d)+'B';if(a>=1e6)return(n/1e6).toFixed(d)+'M';if(a>=1e3)return(n/1e3).toFixed(d)+'K';return n.toFixed(d);},fmtCost(n){const d=App.Config.DEC;if(n<1e3)return n.toFixed(d);if(n<1e6)return(n/1e3).toFixed(d)+'K';if(n<1e9)return(n/1e6).toFixed(d)+'M';return(n/1e9).toFixed(d)+'B';},now:()=>performance.now(),randInt:(a,b)=>Math.floor(a+Math.random()*(b-a+1)),inView:(E)=>{if(!E)return false;const r=E.getBoundingClientRect();return r.bottom>0&&r.right>0&&r.left<innerWidth&&r.top<innerHeight;}};

/* ========== Audio (music + SFX) ========== */
const MusicURL_DESKTOP="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music.mp3?raw=true";
const MusicURL_MOBILE ="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music%20(soft).mp3?raw=true";
const AudioSys=(()=>{let music,musicVol=IS_MOBILE?0.07:0.12,musicOn=false;const sfxEnabled={on:true};
const synth=(type='sine',f=660,d=0.12,g=0.06)=>{try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),q=ctx.createGain();o.type=type;o.frequency.value=f;q.gain.value=g;o.connect(q);q.connect(ctx.destination);o.start();q.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);o.stop(ctx.currentTime+d+0.02);}catch{}};
function playSFX(h){if(!sfxEnabled.on)return;if(h==='tap.ok')synth('sine',700,0.07,0.07);else if(h==='reps.buy')synth('square',420,0.12,0.08);else if(h==='unlock.do')synth('triangle',300,0.2,0.1);else if(h==='upgrade.apply'){synth('square',650,0.09,0.08);setTimeout(()=>synth('square',900,0.09,0.07),90);}else if(h==='achievement.unlock'){synth('square',600,0.10,0.08);setTimeout(()=>synth('square',800,0.10,0.07),110);setTimeout(()=>synth('square',1000,0.12,0.07),220);}else if(h==='tutorial.show'){synth('triangle',520,0.12,0.06);}else if(h==='tutorial.next'){synth('triangle',620,0.09,0.06);}else if(h.startsWith('ui.'))synth('sine',500,0.06,0.05);else if(h==='offline.show'){synth('sine',450,0.12,0.06);}else if(h==='offline.claim'){synth('square',700,0.12,0.08);}}
function startMusic(){if(musicOn)return;musicOn=true;music=new Audio(IS_MOBILE?MusicURL_MOBILE:MusicURL_DESKTOP);music.loop=true;music.volume=musicVol;music.play().catch(()=>{musicOn=false;});}
return{play:playSFX,music:{start:startMusic,setVol:v=>{musicVol=v;if(music)music.volume=v;}},sfxEnabled};})();

/* ========== State / Save ========== */
const State={hp:0,qty:1,avatar:'male',stats:{manual:0,manualWalk:0,auto:0,totalEarned:0},coaches:{},achievements:{},tutorial:{done:false,flags:{repExplained:false,jogTip:false,coachTip:false},shown:{unlock:{},coach:{},upgrade:{}}},exercises:[]};
function save(){try{localStorage.setItem(App.Config.SAVE_KEY,JSON.stringify({schema:App.Config.SCHEMA,...State}));}catch{}}
function load(){try{const raw=localStorage.getItem(App.Config.SAVE_KEY);if(!raw)return;const j=JSON.parse(raw);if(j.schema===App.Config.SCHEMA){Object.assign(State,j);}State.tutorial=State.tutorial||{done:false,flags:{},shown:{unlock:{},coach:{},upgrade:{}}};State.tutorial.flags=State.tutorial.flags||{repExplained:false,jogTip:false,coachTip:false};State.tutorial.shown=State.tutorial.shown||{unlock:{},coach:{},upgrade:{}};}catch{}}
load();

/* ========== Assets / Media ========== */
const Assets={avatarMale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-male.gif?raw=true",avatarFemale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/ff-player-avatar-female.gif?raw=true",trainerGif:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/fitness%20frenzy-%20coaches%20128%20x128%20test.gif?raw=true",logo:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Logo%20(2).png?raw=true",splash:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true",cover:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Cover-Art.png?raw=true"};
const EX_MEDIA={male:{walking:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20walking.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20walking.jpg?raw=true"},jogging:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20running.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20running.jpg?raw=true"},situps:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20situps.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20situp%20still.jpg?raw=true"},pushups:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20pushups.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20pushup%20still.jpg?raw=true"}},female:{walking:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20walking.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20walking.jpg?raw=true"},jogging:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20running.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20running.jpg?raw=true"},situps:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20situps.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20situp.jpg?raw=true"},pushups:{mp4:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercixe%20female%20pushups.mp4?raw=true",poster:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20pushup.jpg?raw=true"}}};

/* Coach images c1..c20 (alternate F/M) */
const COACH_IMG = Array.from({length:20},(_,i)=>`https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c${i+1}.png?raw=true`);
const COACH_NAME = ["Coach Aster","Coach Blaze","Coach Comet","Coach Dash","Coach Ember","Coach Flux","Coach Grit","Coach Halo","Coach Ion","Coach Jolt","Coach Kraken","Coach Lyra","Coach Moxie","Coach Nova","Coach Onyx","Coach Pulse","Coach Quake","Coach Raze","Coach Surge","Coach Titan"];

/* ========== Build exercises list ========== */
function buildExercises(){
  const L=[['walk','Walking','walking',1000],['jog','Jogging','jogging',3000],['sit','Sit-ups','situps',6000],['push','Push-ups','pushups',12000],
           ['jacks','Jumping Jacks','',24000],['pull','Pull-ups','',48000],['rope','Jump Rope','',96000],['plank','Plank','',192000],
           ['mtclimb','Mountain Climbers','',384000],['kb','Kettlebell','',768000],['burpee','Burpees','',1536000],['bench','Bench Press','',3072000],
           ['backsq','Back Squat','',6144000],['dead','Deadlift','',12288000],['hand','Handstands','',24576000],['hspu','Handstand Push-ups','',49152000],
           ['muscle','Muscle-ups','',98304000],['lever','Front Lever','',196608000],['icross','Iron Cross','',393216000],['vcross','Victorian Cross','',786432000]];
  const prior=Object.fromEntries((State.exercises||[]).map(e=>[e.id,e]));
  State.exercises=L.map(([id,name,key,cd],i)=>{
    const sec=cd/1000;
    let baseHP = (i===0)?1:Math.round(20*Math.pow(sec,1.10));
    const repBaseCost=Math.max(4,Math.round(baseHP*0.05));
    const unlockCost=(i===0)?0:Math.round(baseHP*Math.pow(sec,0.60)*1.15);
    const p=prior[id]||{};
    return {id,name,mediaKey:key,baseHP,baseCooldown:cd,unlockCost,repBaseCost,unlocked:(p.unlocked??(i===0)),repHP:p.repHP??0,repProgress:p.repProgress??0,repTarget:p.repTarget??10,level:p.level??1,cooldown:p.cooldown??cd,lastTapAt:p.lastTapAt??0,_autoElapsed:0,els:{},coachIcon:null};
  });
}
buildExercises();

/* ========== Game Logic ========== */
const Game={
  perTap:(ex)=>ex.baseHP+ex.repHP,
  repGrowth:(ex)=>Util.clamp(1.07+0.01*Math.log2(Math.max(1,ex.level)),1.07,1.15),
  repCost(ex,n=1){const g=Game.repGrowth(ex);const b=ex.repBaseCost*Math.pow(g,ex.repHP);if(n===1)return +(b.toFixed(App.Config.DEC));return +((b*(Math.pow(g,n)-1)/(g-1)).toFixed(App.Config.DEC));},
  addHP(v){State.hp+=v;if(v>0)State.stats.totalEarned+=v;Bus.emit('hp',State.hp);},
  tap(ex,now=Util.now()){if(!ex.unlocked)return 0;const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);if(ex.lastTapAt>0&&now-ex.lastTapAt<cd-1){AudioSys.play('tap.blocked');return 0;}
    ex.lastTapAt=now;const g=Game.perTap(ex);Game.addHP(g);State.stats.manual++;if(ex.id==='walk')State.stats.manualWalk++;AudioSys.play('tap.ok');UI.floatFrom(ex.els.img||ex.els.card,'+'+g.toFixed(App.Config.DEC));FX.burst(ex.els.left);return g;},
  buyReps(ex,n){const cost=Game.repCost(ex,n);if(State.hp+1e-6<cost)return false;Game.addHP(-cost);ex.repHP+=n;ex.repProgress+=n;
    while(ex.repProgress>=ex.repTarget){ex.repProgress-=ex.repTarget;ex.repTarget*=2;ex.level+=1;ex.cooldown=Math.max(App.Config.MIN_CD_MS,Math.floor(ex.cooldown/2));Banners.push(`${ex.name} upgraded to <strong>Lvl ${ex.level}</strong> — cooldown halved!`);AudioSys.play('upgrade.apply');FX.confettiAt(ex.els.card);Bus.emit('upgrade',{id:ex.id,level:ex.level});}
    AudioSys.play('reps.buy');Bus.emit('reps',{id:ex.id,qty:n});return true;},
  unlock(ex){if(ex.unlocked)return false;if(State.hp+1e-6<ex.unlockCost)return false;Game.addHP(-ex.unlockCost);ex.unlocked=true;ex.lastTapAt=0;AudioSys.play('unlock.do');FX.confettiAt(ex.els.card);Bus.emit('unlock',ex.id);return true;}
};

/* ========== Auto / Engine Loop ========== */
const Engine=(()=>{let last=Util.now();function loop(){const now=Util.now();const dt=Math.min(0.25,(now-last)/1000);last=now;
  for(const ex of State.exercises){if(!Coaches.isAuto(ex.id))continue;const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);ex._autoElapsed+=dt*1000;while(ex._autoElapsed>=cd){ex._autoElapsed-=cd;ex.lastTapAt=now;const g=Game.perTap(ex);Game.addHP(g);State.stats.auto++;if(Settings.get('floats'))UI.floatFrom(ex.els.img||ex.els.card,'+'+g.toFixed(App.Config.DEC));}}
  for(const ex of State.exercises)UI.drawCooldown(ex);UI.tickTop(dt);UI.refreshThrottled();Notify.updateThrottled();requestAnimationFrame(loop);}return{start:()=>requestAnimationFrame(loop)}})();

/* ========== UI / FX ========== */
const UI={
  _hpShown:0,
  floatFrom(ref,text){if(!ref||!Settings.get('floats'))return;const r=ref.getBoundingClientRect();const sp=el('div',{class:'float',text});sp.style.left=(r.left+r.width/2)+'px';sp.style.top=(r.top+r.height*0.15)+'px';document.body.appendChild(sp);setTimeout(()=>sp.remove(),900);},
  drawCooldown(ex){if(!ex.unlocked)return;const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);if(cd<=App.Config.MIN_CD_MS){ex.els.fill.style.width='100%';ex.els.time.textContent=(cd/1000).toFixed(App.Config.DEC)+'s';return;}const ready=ex.lastTapAt<=0;const since=ready?cd:(Util.now()-ex.lastTapAt);const elapsed=Math.max(0,Math.min(since,cd));const pct=elapsed/cd;ex.els.fill.style.width=(pct*100).toFixed(1)+'%';ex.els.time.textContent=(elapsed/1000).toFixed(App.Config.DEC)+'s';},
  tickTop(dt){UI._hpShown+=(State.hp-UI._hpShown)*Math.min(1,dt*8);$('#hpTop').textContent=Util.fmtHP(UI._hpShown);$('#hpMini').textContent=Util.fmtHP(UI._hpShown);},
  refreshThrottled(){const now=performance.now();if(!UI._next||now>=UI._next){UI._next=now+App.Config.UI_MS;for(const ex of State.exercises)UI.refreshExercise(ex);}},
  refreshExercise(ex){
    ex.els.repText.textContent=`${ex.repProgress}/${ex.repTarget}`;ex.els.repFill.style.width=Math.min(1,ex.repProgress/ex.repTarget)*100+'%';
    ex.els.lvl.textContent=`Lvl ${ex.level}`;ex.els.kv.textContent=`${Math.round(Game.perTap(ex))} HP`;
    const n=State.qty;const cost=Game.repCost(ex,n);const can=State.hp+1e-6>=cost;ex.els.reps.textContent=(n===1?`Reps (${Util.fmtCost(cost)} HP)`:`×${n} Reps (${Util.fmtCost(cost)} HP)`);ex.els.reps.classList.toggle('ready',can);ex.els.reps.disabled=!can;
    if(!ex.unlocked){const canU=State.hp+1e-6>=ex.unlockCost;ex.els.pill.textContent=`Unlock for ${Util.fmtCost(ex.unlockCost)} HP`;ex.els.pill.classList.toggle('ready',canU);ex.els.card.classList.toggle('unlockPulse',canU);if(canU && !State.tutorial.shown.unlock[ex.id]){AudioSys.play('unlock.ready');State.tutorial.shown.unlock[ex.id]=true;save();}}
    ex.els.coachDot.style.display = Coaches.ownedFor(ex.id).length ? 'block' : 'none';
  },
  build(){
    const host=$('#stack');host.innerHTML='';
    State.exercises.forEach(ex=>{
      const card=el('div',{class:'card'});ex.els.card=card;if(!ex.unlocked)card.classList.add('locked');
      /* left media */
      const left=el('div',{class:'left'});ex.els.left=left;
      let media=null,posterDiv=null,posterImg=null;
      if(['walk','jog','sit','push'].includes(ex.id)){
        const keyMap={walk:'walking',jog:'jogging',sit:'situps',push:'pushups'};
        const key=keyMap[ex.id];
        posterDiv=el('div',{class:'poster'});posterImg=el('img',{alt:ex.name});
        posterDiv.appendChild(posterImg);
        media=document.createElement('video');media.muted=true;media.playsInline=true;media.preload='metadata';media.style.display='none';
        ex.els.media=media;ex.els.poster=posterDiv;ex.els.posterImg=posterImg;
        left.append(posterDiv,media);
        MediaPulse.load(ex); // set sources & schedule pulse
      }else{
        const img=el('img',{alt:ex.name,src: UI.emojiFor(ex.id)});ex.els.img=img;left.append(img);
      }
      const lvl=el('div',{class:'lvlBadge',text:`Lvl ${ex.level}`});ex.els.lvl=lvl;left.append(lvl);
      const coachDot=el('div',{class:'coachDot'});coachDot.append(el('img',{alt:'Coach'}));ex.els.coachDot=coachDot;left.append(coachDot);
      const repBand=el('div',{class:'repBand'});const repFill=el('div',{class:'repFill'});const repText=el('div',{class:'repText',text:`${ex.repProgress}/${ex.repTarget}`});ex.els.repFill=repFill;ex.els.repText=repText;repBand.append(repFill,repText);left.append(repBand);

      /* right column */
      const right=el('div',{class:'right'});
      const title=el('h3',{class:'title',text:ex.name}); // directly above cooldown
      const cool=el('div',{class:'cool'});const bar=el('div',{class:'coolBar'});const fill=el('div',{class:'coolFill'});ex.els.fill=fill;bar.append(fill);cool.append(bar);
      const time=el('div',{class:'coolTime',text:(Math.max(App.Config.MIN_CD_MS,ex.cooldown)/1000).toFixed(App.Config.DEC)+'s'});ex.els.time=time;
      const kv=el('div',{class:'kv',text:`${Math.round(Game.perTap(ex))} HP`});ex.els.kv=kv;
      const chips=el('div',{class:'chips'});ex.els.chips=chips;
      const reps=el('button',{class:'repsBtn',text:'Reps'});ex.els.reps=reps;

      right.append(title,cool,time,kv,chips,reps);

      // locked view extras
      const lockMeta=el('div',{class:'lockMeta'});const pill=el('button',{class:'unlockPill',text:`Unlock for ${Util.fmtCost(ex.unlockCost)} HP`});ex.els.pill=pill;lockMeta.append(pill);

      if(ex.unlocked){card.append(left,right);}else{card.append(left,lockMeta);}

      $('#stack').appendChild(card);

      // interactions
      left.addEventListener('pointerdown',e=>{e.preventDefault();if(!ex.unlocked)return;Game.tap(ex);save();});
      reps.addEventListener('click',()=>{if(Game.buyReps(ex,State.qty)){save();}});
      pill.addEventListener('click',()=>{if(Game.unlock(ex)){card.classList.remove('locked','unlockPulse');lockMeta.remove();card.append(left,right);save();}});

      // tag for tutorial spot
      card.setAttribute('data-id',ex.id);
    });
  },
  emojiFor(id){
    const map={jacks:'🕺',pull:'🧗',rope:'🪢',plank:'🧘',mtclimb:'⛰️',kb:'🏋️',burpee:'🤸',bench:'🏋️‍♂️',backsq:'🏋️‍♀️',dead:'⚓',hand:'🤸‍♂️',hspu:'🙃',muscle:'💪',lever:'🦾',icross:'➕',vcross:'✚'};
    return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><text x="50%" y="55%" font-size="140" text-anchor="middle">'+(map[id]||'🏃')+'</text></svg>';
  }
};

/* Tap starburst */
const FX={burst(node){if(!node)return;const b=el('div',{class:'burst'});for(let i=0;i<12;i++){const s=el('div',{class:'star'});const dx=(Math.random()*60-30)+'px',dy=(Math.random()*60-30)+'px';s.style.setProperty('--dx',dx);s.style.setProperty('--dy',dy);s.style.left='50%';s.style.top='50%';b.appendChild(s);}node.appendChild(b);setTimeout(()=>b.remove(),520);},
  confettiAt(node){if(!node)return;const r=node.getBoundingClientRect();const x=r.left+r.width/2,y=r.top+r.height/2;const host=el('div');host.style.cssText='position:fixed;left:0;top:0;pointer-events:none;z-index:2200';document.body.appendChild(host);const colors=['#ffb357','#ffd166','#7bd88f','#6bd3ff','#d4bfff','#ff8fab'];for(let i=0;i<26;i++){const d=el('div');const size=6+Math.random()*6;d.style.cssText=`position:absolute;width:${size}px;height:${size}px;background:${colors[i%colors.length]};opacity:.95;border-radius:${Math.random()<.4?'50%':'2px'};left:${x+(Math.random()*120-60)}px;top:${y+(Math.random()*40-20)}px`;const dx=(Math.random()*2-1)*(innerWidth*0.12),dy=(innerHeight*0.25+Math.random()*innerHeight*0.15);d.animate([{transform:'translate(0,0) rotate(0)',opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${180+Math.random()*180}deg)`,opacity:0}],{duration:1200+Math.random()*600,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'});host.appendChild(d);}setTimeout(()=>host.remove(),2000);}
};
const Banners={push(html){const host=$('#bannerHost');const b=el('div',{class:'banner',html:`🎉 ${html}`});host.appendChild(b);setTimeout(()=>b.remove(),3200);}};

/* ========== Coaches / Notify / Menu ========== */
const Coaches={
  list:[],
  build(){this.list=State.exercises.map((ex,idx)=>({id:'c'+(idx+1),name:COACH_NAME[idx],icon:COACH_IMG[idx],target:ex.id,price:Coaches.priceFor(idx)}));},
  priceFor(idx){if(idx===0)return 1500;return Math.round(1500*Math.pow(1.8,idx));},
  isAuto:(exId)=>Coaches.list.some(c=>State.coaches[c.id]&&c.target===exId),
  ownedFor:(exId)=>Coaches.list.filter(c=>State.coaches[c.id]&&c.target===exId),
  renderTab(){
    const host=$('#tab-coaches');host.innerHTML='';
    const intro=el('div',{class:'coachCard'});intro.append(el('div',{class:'cInfo',text:'Coaches auto-tap a specific exercise for you (no sound). They follow cooldowns.'}));host.appendChild(intro);
    const grid=el('div',{class:'grid'});host.appendChild(grid);
    const exBy=Object.fromEntries(State.exercises.map(e=>[e.id,e]));
    for(const c of Coaches.list){const ex=exBy[c.target];const owned=!!State.coaches[c.id];const canAfford=State.hp+1e-6>=c.price;const unlockedTarget=!!(ex&&ex.unlocked);
      const card=el('div',{class:'coachCard'+(unlockedTarget?'':' locked')});const head=el('div',{class:'headshot'});head.append(el('img',{src:c.icon,alt:c.name}));const mid=el('div');mid.append(el('div',{class:'cName',text:c.name}),el('div',{class:'cInfo',text:`Works on: ${ex?.name||c.target}`}));const btn=el('button',{class:'hire',text:owned?'Hired':`Hire • ${Util.fmtCost(c.price)} HP`});
      if(owned){btn.classList.add('owned');btn.disabled=true;}else if(unlockedTarget){btn.classList.toggle('ready',canAfford);btn.disabled=!canAfford;}
      card.append(head,mid,btn);grid.appendChild(card);
      btn.addEventListener('click',()=>{if(owned||!unlockedTarget)return;if(State.hp+1e-6<c.price)return;Game.addHP(-c.price);State.coaches[c.id]=true;save();AudioSys.play('coach.hire');UI.refreshThrottled();Coaches.renderTab();});}}
};
Coaches.build();

const Notify=(()=>{let next=0;function coachAvailable(){for(const c of Coaches.list){const ex=State.exercises.find(e=>e.id===c.target);if(!ex||!ex.unlocked)continue;if(State.coaches[c.id])continue;if(State.hp+1e-6>=c.price)return true;}return false;}
function update(){$('#menuDot').classList.toggle('show',coachAvailable());}
function updateThrottled(){const now=performance.now();if(now>=next){next=now+App.Config.NOTIFY_MS;update();}}
Bus.on('hp',update);Bus.on('unlock',update);Bus.on('reps',update);Bus.on('upgrade',update);Bus.on('coach',update);
return{update,updateThrottled};})();

/* ========== Menu (tabs) ========== */
const Menu={
  open(){ $('#menuOv').classList.add('open');$('#menuOv').setAttribute('aria-hidden','false');AudioSys.play('ui.menu.open');Coaches.renderTab(); },
  close(){ $('#menuOv').classList.remove('open');$('#menuOv').setAttribute('aria-hidden','true');AudioSys.play('ui.menu.close'); },
  wire(){
    $('#avatarBtn').addEventListener('click',()=>Menu.open());
    $('#menuClose').addEventListener('click',()=>Menu.close());
    $('#menuOv').addEventListener('click',e=>{ if(e.target.id==='menuOv') Menu.close(); });
    $$('.tabBtn',$('.menuTabs')).forEach(btn=>btn.addEventListener('click',()=>{AudioSys.play('ui.tab.switch');$$('.tabBtn',$('.menuTabs')).forEach(x=>x.classList.remove('active'));btn.classList.add('active');const tab=btn.dataset.tab;['coaches','achievements','upgrades','quests','stats','settings'].forEach(t=>{$('#tab-'+t).style.display=(t===tab?'block':'none');});if(tab==='coaches')Coaches.renderTab();if(tab==='stats')Menu.renderStats();if(tab==='settings')Menu.renderSettings();if(tab==='achievements')Menu.renderAchievements();}));
  },
  renderStats(){const host=$('#tab-stats');host.innerHTML=`<div class="coachCard"><div>
    <div><strong>Current HP:</strong> ${Util.fmtHP(State.hp)}</div>
    <div><strong>Total Earned:</strong> ${Util.fmtHP(State.stats.totalEarned||0)}</div>
    <div><strong>Manual Taps:</strong> ${State.stats.manual||0}</div>
    <div><strong>Auto Taps:</strong> ${State.stats.auto||0}</div>
    <div><strong>Exercises Unlocked:</strong> ${State.exercises.filter(e=>e.unlocked).length} / ${State.exercises.length}</div>
    <div><strong>Coaches Hired:</strong> ${Object.values(State.coaches).filter(Boolean).length} / ${Coaches.list.length}</div>
  </div></div>`;},
  renderSettings(){const host=$('#tab-settings');host.innerHTML='';const card=el('div',{class:'coachCard'});const wrap=el('div');wrap.innerHTML=`<div style="display:flex;flex-direction:column;gap:10px">
      <label><input id="set-sfx" type="checkbox" ${AudioSys.sfxEnabled.on?'checked':''}/> Sound Effects</label>
      <label><input id="set-floats" type="checkbox" checked/> Show +HP floaters</label>
    </div>
    <hr style="border:0;border-top:1px solid #223556;margin:10px 0">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btn-save" class="btn small" style="background:#1a2a40;color:#d7e3f5">Save</button>
      <button id="btn-reset" class="btn small" style="background:#1a2a40;color:#d7e3f5">Reset</button>
      <button id="btn-export" class="btn small" style="background:#1a2a40;color:#d7e3f5">Export</button>
      <button id="btn-import" class="btn small" style="background:#1a2a40;color:#d7e3f5">Import</button>
    </div>`;card.appendChild(wrap);host.appendChild(card);
    $('#set-sfx').onchange=e=>AudioSys.sfxEnabled.on=!!e.target.checked;$('#set-floats').onchange=e=>Settings.set('floats',!!e.target.checked);
    $('#btn-save').onclick=()=>{save();AudioSys.play('save.ok');};
    $('#btn-reset').onclick=()=>{if(confirm('Reset your progress?')){localStorage.removeItem(App.Config.SAVE_KEY);location.reload();}};
    $('#btn-export').onclick=()=>{const blob=new Blob([localStorage.getItem(App.Config.SAVE_KEY)||'{}'],{type:'application/json'});const a=el('a');a.href=URL.createObjectURL(blob);a.download='fitness-frenzy-save.json';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),500);};
    $('#btn-import').onclick=()=>{const inp=el('input',{type:'file',accept:'application/json'});inp.addEventListener('change',()=>{const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{JSON.parse(r.result);localStorage.setItem(App.Config.SAVE_KEY,r.result);alert('Imported. Reloading…');location.reload();}catch(e){alert('Import failed.');}};r.readAsText(f);});inp.click();};
  },
  renderAchievements(){const host=$('#tab-achievements');host.innerHTML='';const grid=el('div',{class:'grid'});host.appendChild(grid);for(const a of Achievements.defs){const owned=!!State.achievements[a.id];const card=el('div',{class:'coachCard'});const head=el('div',{class:'headshot'});head.append(el('div',{text:a.icon,style:'font-size:36px;display:flex;align-items:center;justify-content:center;width:100%;height:100%'}));const mid=el('div');mid.append(el('div',{class:'cName',text:a.title}),el('div',{class:'cInfo',text:a.desc}));const right=el('div',{class:'cInfo',text:owned?'Completed':`Reward: +${Util.fmtCost(a.reward)} HP`});card.append(head,mid,right);grid.appendChild(card);}}
};

/* ========== Achievements (light) ========== */
const Achievements={defs:[
  {id:'first_steps',icon:'👣',title:'First Steps',desc:'Upgrade Walking to Lvl 2 (10/10).',reward:50,test:()=>State.exercises.find(e=>e.id==='walk')?.level>=2},
  {id:'add_routine',icon:'🏃',title:'Add to Routine',desc:'Unlock Jogging.',reward:100,test:()=>State.exercises.find(e=>e.id==='jog')?.unlocked},
  {id:'first_coach',icon:'🧑‍🏫',title:'Coach On Duty',desc:'Hire your first coach.',reward:150,test:()=>Object.values(State.coaches).some(Boolean)},
  {id:'speed_demon',icon:'⚡',title:'Speed Demon',desc:'Any exercise reaches ≤0.30s cooldown.',reward:180,test:()=>State.exercises.some(e=>e.unlocked&&Math.max(App.Config.MIN_CD_MS,e.cooldown)<=300)}
],checkAll(){for(const a of Achievements.defs){if(!State.achievements[a.id]&&a.test()){State.achievements[a.id]=true;Game.addHP(a.reward);AudioSys.play('achievement.unlock');Banners.push(`Achievement: <strong>${a.title}</strong> • +${Util.fmtCost(a.reward)} HP`);save();}}}};
Bus.on('hp',()=>Achievements.checkAll());
Bus.on('upgrade',()=>Achievements.checkAll());
Bus.on('unlock',()=>Achievements.checkAll());
Bus.on('reps',()=>Achievements.checkAll());

/* ========== Settings (prefs) ========== */
const Settings=(()=>{const d={floats:true};try{const raw=localStorage.getItem(App.Config.SAVE_KEY+':prefs');if(raw)Object.assign(d,JSON.parse(raw));}catch{}function saveS(){try{localStorage.setItem(App.Config.SAVE_KEY+':prefs',JSON.stringify(d));}catch{}}
return{get:k=>d[k],set:(k,v)=>{d[k]=v;saveS();}}})();

/* ========== Offline Gains ========== */
const Offline=(()=>{const KEY='ff-last',off=$('#off');function saveNow(){try{localStorage.setItem(KEY,Date.now().toString());}catch{}}
function fmt(ms){let s=Math.floor(ms/1000),h=Math.floor(s/3600);s%=3600;const m=Math.floor(s/60);s%=60;const L=[];if(h)L.push(h+'h');if(m)L.push(m+'m');if(s||!L.length)L.push(s+'s');return L.join(' ');}
function summary(ms){let sum=0;for(const ex of State.exercises){if(!ex.unlocked)continue;if(!Coaches.isAuto(ex.id))continue;const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);const taps=Math.floor(ms/cd);if(taps>0)sum+=taps*Game.perTap(ex);}return sum;}
function check(){const last=parseInt(localStorage.getItem(KEY)||'0',10);const now=Date.now();if(last>0){const delta=now-last;const cap=Math.min(delta,App.Config.OFFLINE_CAP_MS);const gain=summary(cap);if(gain>0){$('#offDur').textContent=fmt(cap);$('#offAmt').textContent=Util.fmtHP(gain);$('#offCapNote').style.display=(delta>cap)?'block':'none';off.classList.add('open');AudioSys.play('offline.show');$('#offClaim').onclick=()=>{Game.addHP(gain);off.classList.remove('open');AudioSys.play('offline.claim');save();};}}
saveNow();}
window.addEventListener('visibilitychange',()=>{if(document.hidden)saveNow();});
window.addEventListener('pagehide',saveNow);
window.addEventListener('beforeunload',saveNow);
return{check};})();

/* ========== Tutorial (event-driven) ========== */
const Tutorial=(()=>{const ov=$('#tut'),bubble=$('#bubble'),tFace=$('#tFace'),tWho=$('#tWho'),tText=$('#tText'),spot=$('#spot');let step=null,idx=0;
function show(){ov.classList.add('show');ov.setAttribute('aria-hidden','false');AudioSys.play('tutorial.show');}
function hide(){ov.classList.remove('show');ov.setAttribute('aria-hidden','true');hideSpot();}
function setSpeaker(who){tWho.textContent=who;if(who==='JAX')tFace.src=Assets.trainerGif;else tFace.src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);}
function setLines(lines){idx=0;setSpeaker(lines[0].who);tText.innerHTML=lines[0].html;show();}
function nextLine(lines,onDone){if(idx<lines.length-1){idx++;setSpeaker(lines[idx].who);tText.innerHTML=lines[idx].html;AudioSys.play('tutorial.next');}else{onDone&&onDone();}}
bubble.addEventListener('click',()=>{if(step)nextLine(step.lines,step.onDone);});
function showSpot(sel){const node=document.querySelector(sel);if(!node){hideSpot();return;}const r=node.getBoundingClientRect();const pad=6;spot.style.display='block';spot.style.left=(r.left-pad)+'px';spot.style.top=(r.top-pad)+'px';spot.style.width=(r.width+pad*2)+'px';spot.style.height=(r.height+pad*2)+'px';}
function hideSpot(){spot.style.display='none';}
function startIntro(){if(State.tutorial.done)return;const lines=[{who:'JAX',html:`You look a bit low on energy. Let's fix that <span class="hl">fast</span> 💪`},{who:'You',html:`Where do I start?`},{who:'JAX',html:`Tap <span class="hl">Walking</span> to earn <span class="hl">HP</span>. Then we'll power up.`},];setLines(lines);step={lines,onDone(){hide();showSpot('.card[data-id="walk"] .left');}};}
function maybeRepTip(){if(State.tutorial.flags.repExplained)return;if(State.stats.manualWalk>=4){State.tutorial.flags.repExplained=true;save();const L=[{who:'JAX',html:`Nice pace! Hit <span class="hl">Reps</span> to make each tap hit harder. Watch the <span class="hl">green</span> bar fill.`}];setLines(L);step={lines:L,onDone(){hide();}};showSpot('.card[data-id="walk"] .repsBtn');}}
function onUpgrade(ex){if(State.tutorial.shown.upgrade[ex.id])return;State.tutorial.shown.upgrade[ex.id]=true;save();const L=[{who:'JAX',html:`<span class="hl">${ex.name}</span> upgraded! Cooldown halved.`}];setLines(L);step={lines:L,onDone(){hide();}};showSpot(`.card[data-id="${ex.id}"] .cool`);setTimeout(hideSpot,1500);}
function onUnlockAffordable(ex){if(ex.id!=='jog')return;if(State.tutorial.flags.jogTip)return;const L=[{who:'JAX',html:`Add to your routine! Unlock <span class="hl">${ex.name}</span> when this turns <span class="hl">orange</span>.`}];setLines(L);step={lines:L,onDone(){hide();State.tutorial.flags.jogTip=true;save();}};showSpot(`.card[data-id="${ex.id}"] .unlockPill`);}
function onCoachAffordable(){if(State.tutorial.flags.coachTip)return;const c=Coaches.list[0];if(!c)return;const ex=State.exercises.find(e=>e.id===c.target);if(!ex||!ex.unlocked)return;if(State.coaches[c.id])return;if(State.hp+1e-6>=c.price){const L=[{who:'JAX',html:`Ready for autopilot? Tap your <span class="hl">avatar</span> to open the <span class="hl">menu</span> and <span class="hl">Hire</span> a coach.`}];setLines(L);step={lines:L,onDone(){hide();State.tutorial.flags.coachTip=true;save();}};const bub=$('#bubble');bub.classList.add('fromTop');showSpot('#avatarBtn');setTimeout(()=>bub.classList.remove('fromTop'),10);}}
Bus.on('reps',({id})=>{if(id==='walk')maybeRepTip();});
Bus.on('tap',({id})=>{if(id==='walk')maybeRepTip();});
Bus.on('upgrade',({id})=>{const ex=State.exercises.find(e=>e.id===id);if(ex)onUpgrade(ex);});
Bus.on('hp',()=>{const jog=State.exercises.find(e=>e.id==='jog');if(jog && !jog.unlocked && State.hp+1e-6>=jog.unlockCost)onUnlockAffordable(jog);onCoachAffordable();});
return{startIntro,hide};})();

/* ========== Avatar GIF pulse (CORS-safe) ========== */
const AvatarPulse=(()=>{const GIFS={male:Assets.avatarMale,female:Assets.avatarFemale};let current='male',timer=null,imgEl=null,restarting=false;
function ensure(){if(!imgEl)imgEl=$('#avatarImg');return !!imgEl;}
function apply(){if(!ensure())return;imgEl.src=GIFS[current];}
function burst(){if(!ensure()||restarting)return;restarting=true;const base=GIFS[current];imgEl.src=base+(base.includes('?')?'&':'?')+'t='+Date.now();setTimeout(()=>{restarting=false;schedule();},1500);}
function schedule(){if(timer)clearTimeout(timer);timer=setTimeout(burst,App.Config.PULSE_MIN_MS+Math.random()*(App.Config.PULSE_MAX_MS-App.Config.PULSE_MIN_MS));}
function start(){imgEl=$('#avatarImg');apply();schedule();}
function set(g){current=(g==='female')?'female':'male';apply();schedule();}
return{start,set,apply};})();

/* ========== MediaPulse for exercise videos ========== */
const MediaPulse=(()=>{function load(ex){const g=State.avatar==='female'?'female':'male';const key=ex.mediaKey;if(!key){ex.els.img = ex.els.img || ex.els.left.querySelector('img');return;}
  const srcs=EX_MEDIA[g][key];if(!srcs)return;
  ex.els.posterImg.src=srcs.poster; // poster centered
  ex.els.media.src=srcs.mp4;
  ex.els.media.load();
  ex._pulseTimer && clearTimeout(ex._pulseTimer);
  schedule(ex);
}
function schedule(ex){if(!ex.els.media)return;const delay=9000+Math.random()*4000;ex._pulseTimer=setTimeout(()=>playBurst(ex),delay);}
function playBurst(ex){const v=ex.els.media;if(!v)return; if(!Util.inView(ex.els.card)){schedule(ex);return;}
  v.currentTime=0; v.muted=true; v.play().catch(()=>{}); v.style.display='block'; ex.els.poster.style.display='none';
  setTimeout(()=>{v.pause();v.style.display='none';ex.els.poster.style.display='flex';schedule(ex);}, 1200);
}
return{load,refreshAll(){State.exercises.forEach(ex=>{if(ex.mediaKey)load(ex);});}})();

/* ========== Start / Splash ========== */
function showSplashThenStart(){const s=$('#splash');s.classList.add('open');setTimeout(()=>{s.classList.remove('open');const hasSave=!!localStorage.getItem(App.Config.SAVE_KEY);$('#btnContinue').style.display=hasSave?'inline-block':'none';$('#start').classList.add('open');},5000);}
function wireStart(){
  const st=$('#start');
  $('#btnStart').addEventListener('click',()=>{AudioSys.play('ui.click');localStorage.removeItem(App.Config.SAVE_KEY);location.reload();});
  $('#btnContinue').addEventListener('click',()=>{AudioSys.play('ui.click');st.classList.remove('open');AudioSys.music.start();Offline.check();if(!State.tutorial.done){State.tutorial.done=true;save();} });
  $$('.segBtn',$('#avatarSeg')).forEach(b=>b.addEventListener('click',()=>{$$('.segBtn',$('#avatarSeg')).forEach(x=>x.classList.remove('active'));b.classList.add('active');State.avatar=b.dataset.avatar;$('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);save();MediaPulse.refreshAll();}));
}

/* ========== Input guards (mobile zoom) ========== */
(function(){let lastTouch=0;document.addEventListener('touchend',e=>{const n=Date.now();if(n-lastTouch<300){e.preventDefault();}lastTouch=n;},{passive:false});document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});})();

/* ========== Topbar Qty wiring ========== */
function wireTopbar(){const g=$('#qtyGroup');$$('.qtyBtn',g).forEach(btn=>btn.addEventListener('click',()=>{$$('.qtyBtn',g).forEach(x=>x.classList.remove('active'));btn.classList.add('active');State.qty=parseInt(btn.dataset.q,10)||1;save();AudioSys.play('ui.click');UI.refreshThrottled();}));}

/* ========== Boot ========== */
function boot(){
  $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);
  UI._hpShown=State.hp;
  UI.build(); UI.refreshThrottled();
  Menu.wire(); wireTopbar(); wireStart(); showSplashThenStart();
  State.exercises.forEach(ex=>{ex.els.card.addEventListener('click',e=>{if(e.target.closest('.left'))Bus.emit('tap',{id:ex.id});});});
  setInterval(()=>{$('#hpMini').textContent=Util.fmtHP(State.hp);},400);
  State.qty=State.qty||1;
  Engine.start();
  setInterval(save,App.Config.SAVE_MS);

  // Start music only when continuing or after New Game reload; intro music begins after continue; for New Game user clicks again.
  AvatarPulse.start(); AvatarPulse.set(State.avatar);

  // First-time start: after "New Game" reload, show intro once in gameplay
  if(!localStorage.getItem(App.Config.SAVE_KEY)){ /* fresh state on first real entry */ }
}
document.addEventListener('DOMContentLoaded',boot);

/* ========== Hooks to start tutorial after New Game ======== */
document.addEventListener('visibilitychange',()=>{}); // placeholder

/* After start screen closes, begin tutorial on first session */
(function observeStartClose(){
  const obs=new MutationObserver(()=>{ if(!$('#start').classList.contains('open')){ // Start closed
      // Begin music + tutorial only if not done
      AudioSys.music.start();
      if(!State.tutorial.done){ Tutorial.startIntro(); State.tutorial.done=true; save(); }
      obs.disconnect();
      // Prepare media posters after avatar known
      MediaPulse.refreshAll();
    }});
  obs.observe(document.body,{subtree:true,attributes:true,attributeFilter:['class']});
})();

/* Re-render coaches tab when hired to put coach icon on card top-right */
Bus.on('hp',()=>{UI.refreshThrottled();});
Bus.on('unlock',()=>{UI.refreshThrottled();});
Bus.on('reps',()=>{UI.refreshThrottled();});
Bus.on('upgrade',()=>{UI.refreshThrottled();});

/* Expose tap event for rep tutorial */
Bus.on('tap',({id})=>{ if(id==='walk') { /* counted in Game.tap */ } });

</script>
</body>
</html>
