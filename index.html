<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Fitness Frenzy — Core (Steps 1–3)</title>
<style>
  :root{
    --bg:#0f1020; --panel:#1a1c35; --panel-2:#23264a; --text:#f5f7ff; --muted:#aab1d6;
    --accent:#3aa6ff; --good:#27c93f; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text);
       font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px; margin:0 auto; padding:14px}
  .topbar{position:sticky; top:0; z-index:10; background:#16183a; border-bottom:1px solid #242756}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .logo{font-weight:900; letter-spacing:.3px}
  .bulk{display:inline-flex; background:#20244a; border:1px solid #2a2e5e; border-radius:10px; overflow:hidden}
  .bulk button{background:transparent; color:#fff; border:0; padding:8px 12px; cursor:pointer; min-width:52px}
  .bulk button.active{background:var(--accent); color:#061222; font-weight:800}
  .pill{margin-top:10px; background:#182047; border:1px solid #2a2e5e;
        padding:10px 12px; border-radius:12px; font-variant-numeric:tabular-nums; display:flex; justify-content:space-between}
  .devbar{margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .devbar .tag{color:#aab1d6; font-size:12px; opacity:.9}
  .cards{display:grid; gap:12px; margin-top:14px}
  .card{display:grid; grid-template-columns:120px 1fr; gap:14px; padding:12px;
        background:var(--panel); border:1px solid #262a58; border-radius:14px}
  .tile{background:var(--panel-2); border-radius:12px; height:120px; user-select:none; cursor:pointer; position:relative}
  .tile.locked{filter:grayscale(100%); opacity:.9; cursor:default}
  .lvl{position:absolute; top:6px; left:6px; background:#171a38; border:1px solid #2b2f63; padding:2px 7px; border-radius:8px; font-size:13px}
  .repband{position:absolute; left:6px; right:6px; bottom:6px; height:18px; border-radius:9px; background:#0e132e; border:1px solid #2a2e5e; overflow:hidden}
  .repfill{height:100%; width:0%; background:linear-gradient(90deg,#17b34c,#27c93f)}
  .reptext{position:absolute; inset:0; display:grid; place-items:center; font-size:13px; color:#cfead6}
  .title{font-weight:800; margin-top:2px; font-size:16px}
  .cooldown{margin-top:8px; height:22px; background:#141739; border:1px solid #2a2e5e; border-radius:8px; overflow:hidden; position:relative}
  .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,#2f6df3,#41b0ff)}
  .t{position:relative; z-index:1; padding-left:8px; font-variant-numeric:tabular-nums; color:#a6b0d8; font-size:14px}
  .meta{display:flex; align-items:center; justify-content:space-between; margin-top:10px; gap:10px; flex-wrap:wrap}
  .muted{color:var(--muted); font-size:15px}
  .btn{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:10px 12px; border-radius:12px; min-width:160px; cursor:pointer}
  .btn.glow{box-shadow:0 0 0 2px rgba(58,166,255,.25) inset, 0 0 12px rgba(58,166,255,.35)}
  @media (max-width:480px){
    .card{grid-template-columns:96px 1fr; padding:10px}
    .tile{height:96px}
    .btn{min-width:140px}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="logo">Fitness Frenzy — Core</div>
        <div id="bulk" class="bulk" role="group" aria-label="Bulk selector">
          <button data-q="1" class="active">×1</button>
          <button data-q="10">×10</button>
          <button data-q="100">×100</button>
        </div>
      </div>
      <div class="pill"><span>HP</span><span id="hp">0</span></div>
      <!-- Dev toolbar: leave visible for QA; remove when shipping -->
      <div class="devbar">
        <button id="dev-reset" class="btn" style="min-width:auto">Reset Save</button>
        <button id="dev-fresh" class="btn" style="min-width:auto">Fresh: Walk only</button>
        <button id="dev-seed"  class="btn" style="min-width:auto">Seed L4/L3/L2/L1</button>
        <span class="tag">DEV</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="cards" class="cards" aria-live="polite"></div>
  </div>

<script>
/* ==========================================================
   Fitness Frenzy — CORE (Steps 1–3)
   Bars correct on first frame; reset + seed for QA
   ========================================================== */
(function(){
  "use strict";

  /* ---------- Step 1: Data model + math ---------- */
  const Exercises = [
    { id:'walk',   name:'Walking',           baseCooldownMs:1000 },
    { id:'jog',    name:'Jogging',           baseCooldownMs:3000 },
    { id:'sit',    name:'Sit-ups',           baseCooldownMs:6000 },
    { id:'push',   name:'Push-ups',          baseCooldownMs:12000 },
    { id:'jacks',  name:'Jumping Jacks',     baseCooldownMs:24000 },
    { id:'pull',   name:'Pull-ups',          baseCooldownMs:48000 },
    { id:'rope',   name:'Jump Rope',         baseCooldownMs:96000 },
    { id:'plank',  name:'Plank',             baseCooldownMs:192000 },
    { id:'mtclimb',name:'Mountain Climbers', baseCooldownMs:384000 },
    { id:'kb',     name:'Kettlebell',        baseCooldownMs:768000 },
    { id:'burpee', name:'Burpees',           baseCooldownMs:1536000 },
    { id:'bench',  name:'Bench Press',       baseCooldownMs:3072000 },
    { id:'backsq', name:'Back Squat',        baseCooldownMs:6144000 },
    { id:'dead',   name:'Deadlift',          baseCooldownMs:12288000 },
    { id:'hand',   name:'Handstands',        baseCooldownMs:24576000 },
    { id:'hspu',   name:'Handstand Push-ups',baseCooldownMs:49152000 },
    { id:'muscle', name:'Muscle-ups',        baseCooldownMs:98304000 },
    { id:'lever',  name:'Front Lever',       baseCooldownMs:196608000 },
    { id:'icross', name:'Iron Cross',        baseCooldownMs:393216000 },
    { id:'vcross', name:'Victorian Cross',   baseCooldownMs:786432000 },
  ];

  const fmt = (n)=>{
    if(!Number.isFinite(n)) return '0';
    const a=Math.abs(n);
    if(a>=1e12) return (n/1e12).toFixed(2)+'T';
    if(a>=1e9)  return (n/1e9).toFixed(2)+'B';
    if(a>=1e6)  return (n/1e6).toFixed(2)+'M';
    if(a>=1e3)  return (n/1e3).toFixed(2)+'K';
    return String(Math.floor(n));
  };

  const baseHP    = (idx,ms)=> (idx===0? 1 : Math.round(20*Math.pow(ms/1000,1.10)));
  const perTapHP  = (base, reps)=> base + reps;
  const unlockCost= (base,ms)=> Math.round(base * Math.pow(ms/1000,0.60) * 1.15);
  const repBaseCost = (base)=> Math.max(4, Math.round(base * 0.05));
  const repGrowth = (level)=> Math.max(1.07, Math.min(1.15, 1.07 + 0.01 * Math.log2(Math.max(1,level))));
  const repCostSingle = (rb,g,rep)=> rb * Math.pow(g, rep);
  const repCostBulk   = (rb,g,rep,n)=> rb * Math.pow(g, rep) * ((Math.pow(g,n)-1)/(g-1));
  const nextCooldown  = (ms)=> Math.max(100, Math.floor(ms/2));

  /* ---------- Step 3: State + save ---------- */
  const SAVE_KEY = 'ff-core-v2';

  function defaultExercises(){
    return Exercises.map((ex,idx)=>({
      id:ex.id, unlocked:(idx===0), rep:0, repTarget:10, level:1,
      cooldown:ex.baseCooldownMs, lastTapAt:0
    }));
  }

  function defaults(){
    // Start with your requested baseline: first 4 unlocked & leveled 4/3/2/1
    const s = { schema:2, hp:0, qty:1, exercises: defaultExercises() };
    // unlock first 4
    for (let i=0;i<4;i++) s.exercises[i].unlocked = true;
    // bump levels with cooldown-halving
    levelTo(s.exercises[0], 4);
    levelTo(s.exercises[1], 3);
    levelTo(s.exercises[2], 2);
    levelTo(s.exercises[3], 1);
    // ensure ready on first frame
    s.exercises.forEach(e=> e.lastTapAt = 0);
    return s;
  }

  function levelTo(ex, target){
    ex.level = Math.max(1, ex.level|0);
    while (ex.level < target) {
      ex.level += 1;
      ex.cooldown = nextCooldown(ex.cooldown);
      ex.repTarget *= 2;
    }
  }

  function ensureIntegrity(d){
    const byId = new Map((d.exercises||[]).map(e=>[e.id,e]));
    d.exercises = Exercises.map((ex,idx)=>{
      const prev = byId.get(ex.id)||{};
      return {
        id:ex.id,
        unlocked: !!(prev.unlocked || idx===0 || idx<4), // keep first 4 unlocked by default
        rep: (prev.rep|0)||0,
        repTarget: (prev.repTarget|0)||10,
        level: (prev.level|0)||1,
        cooldown: (prev.cooldown|0)||ex.baseCooldownMs,
        lastTapAt: (prev.lastTapAt|0)||0
      };
    });
    d.hp = Number(d.hp)||0;
    d.qty = [1,10,100].includes(d.qty)? d.qty : 1;
    d.schema = 2;

    // Normalize timebase: kill any epoch/future lastTapAt that would break bars
    const nowPerf = performance.now();
    for (const ex of d.exercises) {
      const t = Number(ex.lastTapAt)||0;
      if (t > 1e9 || t < 0 || (t > 0 && t > nowPerf + (ex.cooldown||0)*4)) ex.lastTapAt = 0;
    }
    return d;
  }

  function load(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      return raw ? ensureIntegrity(JSON.parse(raw)) : defaults();
    }catch{ return defaults(); }
  }

  function save(state){
    try{
      const copy = JSON.parse(JSON.stringify(state));
      copy.exercises.forEach(e=> e.lastTapAt = 0); // volatile
      localStorage.setItem(SAVE_KEY, JSON.stringify(copy));
    }catch{}
  }

  let S = ensureIntegrity(load());

  /* ---------- Step 2: UI ---------- */
  const hpEl   = document.getElementById('hp');
  const cards  = document.getElementById('cards');
  const bulk   = document.getElementById('bulk');

  const refs = new Map(); // id -> {els}

  function createCard(idx){
    const meta = Exercises[idx];
    const ex   = S.exercises[idx];

    const card   = document.createElement('div'); card.className='card';
    const tile   = document.createElement('div'); tile.className='tile';
    const lvl    = document.createElement('div'); lvl.className='lvl';
    const repband= document.createElement('div'); repband.className='repband';
    const repfill= document.createElement('div'); repfill.className='repfill';
    const reptext= document.createElement('div'); reptext.className='reptext';
    repband.append(repfill, reptext);
    tile.append(lvl, repband);

    const right  = document.createElement('div');
    const title  = document.createElement('div'); title.className='title';
    const cdWrap = document.createElement('div'); cdWrap.className='cooldown';
    const bar    = document.createElement('div'); bar.className='bar';
    const t      = document.createElement('div'); t.className='t';
    cdWrap.append(bar,t);
    const metaRow= document.createElement('div'); metaRow.className='meta';
    const left   = document.createElement('div'); left.className='muted';
    const btn    = document.createElement('button'); btn.className='btn';

    metaRow.append(left, btn);
    right.append(title, cdWrap, metaRow);
    card.append(tile, right);
    cards.append(card);

    // Immediate first-frame bar state to prevent flicker
    if (ex.unlocked && (!ex.lastTapAt || ex.lastTapAt===0)) {
      bar.style.width = '100%';
      t.textContent = 'Ready';
    } else if (!ex.unlocked) {
      bar.style.width = '0%';
      t.textContent = '—';
    }

    // interactions
    tile.addEventListener('click', ()=> {
      const ex = S.exercises[idx];
      if(!ex || !ex.unlocked) return;
      const now = performance.now();
      if(ex.lastTapAt>0 && now < ex.lastTapAt + ex.cooldown) return;
      const gain = perTapHP(baseHP(idx, meta.baseCooldownMs), ex.rep);
      S.hp += gain;
      ex.lastTapAt = now;
      renderExercise(idx);
      renderTop();
      save(S);
    });

    btn.addEventListener('click', ()=>{
      const ex = S.exercises[idx];
      const base = baseHP(idx, meta.baseCooldownMs);
      if(!ex.unlocked){
        const price = unlockCost(base, meta.baseCooldownMs);
        if(S.hp < price) return;
        S.hp -= price; ex.unlocked = true;
        ex.lastTapAt = 0; // show Ready immediately
      } else {
        const rb = repBaseCost(base);
        const g  = repGrowth(ex.level);
        const q  = S.qty;
        const price = Math.ceil(q===1 ? repCostSingle(rb,g,ex.rep) : repCostBulk(rb,g,ex.rep,q));
        if(S.hp < price) return;
        S.hp -= price;
        ex.rep += q;
        // Level-ups & cooldown shrink
        while(ex.rep >= ex.repTarget){
          ex.level += 1;
          ex.repTarget *= 2;
          ex.cooldown = nextCooldown(ex.cooldown);
        }
      }
      renderExercise(idx);
      renderTop();
      save(S);
    });

    refs.set(meta.id, {idx, card, tile, lvl, repfill, reptext, bar, t, left, btn, title});
    renderExercise(idx);
  }

  function renderTop(){
    hpEl.textContent = fmt(S.hp);
  }

  function renderExercise(idx){
    const meta = Exercises[idx];
    const ex   = S.exercises[idx];
    const r    = refs.get(meta.id);
    if(!r) return;

    r.title.textContent = meta.name;
    r.lvl.textContent   = 'Lvl ' + (ex.level||1);

    if(!ex.unlocked){
      r.tile.classList.add('locked');
      r.left.textContent = '—';
      const base = baseHP(idx, meta.baseCooldownMs);
      const price= unlockCost(base, meta.baseCooldownMs);
      r.btn.textContent  = 'Unlock • ' + fmt(price) + ' HP';
      r.btn.classList.toggle('glow', S.hp>=price);
      r.reptext.textContent = '—';
      r.repfill.style.width = '0%';
      r.bar.style.width     = '0%';
      r.t.textContent       = '—';
      return;
    }

    r.tile.classList.remove('locked');
    const base = baseHP(idx, meta.baseCooldownMs);
    const tap  = perTapHP(base, ex.rep);
    r.left.textContent = tap + ' HP / tap';

    const rb = repBaseCost(base);
    const g  = repGrowth(ex.level||1);
    const q  = S.qty;
    const price = Math.ceil(q===1 ? repCostSingle(rb,g,ex.rep||0) : repCostBulk(rb,g,ex.rep||0,q));
    r.btn.textContent = 'Reps ×' + q + ' • ' + fmt(price) + ' HP';
    r.btn.classList.toggle('glow', S.hp>=price);

    const pct = Math.max(0, Math.min(100, 100*((ex.rep||0)/(ex.repTarget||10))));
    r.reptext.textContent = (ex.rep||0) + ' / ' + (ex.repTarget||10);
    r.repfill.style.width = pct + '%';
    // If no active cooldown, bar should read Ready & full immediately
    if (!ex.lastTapAt || ex.lastTapAt===0){
      r.bar.style.width = '100%';
      r.t.textContent = 'Ready';
    }
  }

  function build(){
    cards.innerHTML = '';
    refs.clear();
    for(let i=0;i<Exercises.length;i++) createCard(i);
    renderTop();
  }

  /* ---------- Engine loop (bars) ---------- */
  function tick(){
    const now = performance.now();
    for(let i=0;i<Exercises.length;i++){
      const ex = S.exercises[i];
      const r  = refs.get(Exercises[i].id);
      if(!r) continue;

      if(!ex || !ex.unlocked){
        r.bar.style.width = '0%';
        r.t.textContent   = '—';
        continue;
      }

      // Ready → full bar
      if(!ex.lastTapAt || ex.lastTapAt===0){
        r.bar.style.width = '100%';
        r.t.textContent   = 'Ready';
        continue;
      }

      const dt = Math.max(0, now - ex.lastTapAt);
      const remain = Math.max(0, ex.cooldown - dt);
      if (remain <= 0){
        r.bar.style.width = '100%';
        r.t.textContent   = 'Ready';
      } else {
        const pct = 100 * (dt / Math.max(1, ex.cooldown));
        r.bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
        r.t.textContent   = (remain/1000).toFixed(2) + 's';
      }
    }
    requestAnimationFrame(tick);
  }

  /* ---------- Bulk selector ---------- */
  bulk.addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const q = parseInt(b.dataset.q, 10);
    if(![1,10,100].includes(q)) return;
    S.qty = q;
    [...bulk.children].forEach(x=> x.classList.toggle('active', x===b));
    save(S);
    for(let i=0;i<Exercises.length;i++) renderExercise(i);
  });

  /* ---------- Dev: Reset / Fresh / Seed ---------- */
  document.getElementById('dev-reset').addEventListener('click', ()=>{
    try{ localStorage.removeItem(SAVE_KEY); }catch(_){}
    location.reload();
  });

  document.getElementById('dev-fresh').addEventListener('click', ()=>{
    // Walk-only clean start
    const s = { schema:2, hp:0, qty:1, exercises: defaultExercises() };
    s.exercises[0].unlocked = true;
    s.exercises.forEach(e=> e.lastTapAt=0);
    S = ensureIntegrity(s);
    save(S);
    build();
  });

  document.getElementById('dev-seed').addEventListener('click', ()=>{
    S = ensureIntegrity(defaults()); // same L4/L3/L2/L1 seed as first-run
    save(S);
    build();
  });

  /* ---------- Boot ---------- */
  build();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
