<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Fitness Frenzy â€” AdCap Core + Save + Offline + Debug</title>
<style>
  :root{
    --bg:#0f1421; --bg2:#0b1220; --ink:#eaf1fb; --muted:#9fb0c6;
    --card:#152136; --edge:rgba(255,255,255,.08);
    --accent:#ff7a1a; --accent2:#ffc38f; --good:#2dd36f;
  }
  *{box-sizing:border-box}
  html,body{height:100%} html{-webkit-text-size-adjust:100%}
  body{
    margin:0;color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Arial;
    background:
      radial-gradient(900px 600px at -10% -20%,rgba(58,160,255,.15),transparent),
      radial-gradient(1000px 700px at 110% 10%,rgba(255,122,26,.10),transparent),
      linear-gradient(180deg,var(--bg),var(--bg2));
    -webkit-tap-highlight-color: transparent;
  }
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;
    padding:10px 14px;background:rgba(15,21,33,.85);border-bottom:1px solid var(--edge);backdrop-filter:blur(8px)}
  .hp-wrap{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
  .hp-icon{font-size:26px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .hp{flex:1;font:900 clamp(22px,4.2vw,36px)/1 system-ui;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hp small{font-weight:800;opacity:.9;background:rgba(255,255,255,.08);padding:.16em .45em;border-radius:.35em;margin-left:.45rem}

  .wrap{max-width:900px;margin:14px auto 120px;padding:0 14px}
  .grid{display:grid;gap:12px}
  @media (min-width:740px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border-radius:14px;padding:12px;
    box-shadow:0 10px 22px rgba(0,0,0,.36), inset 0 0 0 1px var(--edge);
    display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:center;min-height:140px}
  @media (max-width:520px){.card{grid-template-columns:1fr}}
  .tap{position:relative;display:grid;place-items:center;height:100px;border-radius:14px;border:2px dashed #7ff2b0;
    background:linear-gradient(180deg,#0c1e16,#0f271a);color:#cffff1;cursor:pointer;user-select:none;overflow:hidden}
  .tap.ready{box-shadow:0 0 0 3px rgba(39,210,103,.28) inset}
  .emoji{font-size:56px}
  .tap.bop .emoji{animation:bop .18s ease} @keyframes bop{50%{transform:scale(1.12)}}

  .meta h3{margin:0 0 6px;font:800 18px/1.15 system-ui;display:flex;align-items:center;gap:8px}
  .meta h3 small{font-weight:800;color:#fff;background:#2c3a57;border:1px solid rgba(255,255,255,.15);
    padding:.1em .5em;border-radius:.4em}
  .sub{color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap}

  .bar{height:14px;background:#0b1219;border-radius:8px;overflow:hidden;margin-top:6px}
  .bar i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .mini{position:relative;height:14px;background:#0b1219;border-radius:8px;overflow:hidden;margin-top:8px}
  .mini i{display:block;height:100%;width:0;background:linear-gradient(90deg,#9cffbd,#2dd36f)}
  .mini .lbl{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font:900 11px/1 system-ui;color:#cfead7;text-shadow:0 1px 2px rgba(0,0,0,.5);pointer-events:none}

  .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .btn{height:44px;display:flex;align-items:center;justify-content:center;border:1px solid var(--edge);
    border-radius:12px;padding:0 10px;font-weight:900;background:#0e1724;color:#fff;cursor:pointer;position:relative}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .primary{background:linear-gradient(180deg,#ff8b3a,#ff7a1a);color:#1b0e03;border-color:transparent}
  .glitter.available::after{content:"";position:absolute;inset:0;pointer-events:none;border-radius:12px;
    background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.18) 25%,rgba(255,255,255,.35) 33%,transparent 45%);
    transform:translateX(-120%);animation:shine 1.15s ease-in-out infinite;filter:blur(.6px)}
  @keyframes shine{0%{transform:translateX(-120%)}60%{transform:translateX(0)}100%{transform:translateX(120%)}}

  .float{position:absolute;left:50%;transform:translateX(-50%);pointer-events:none;font-weight:900;text-shadow:0 1px 2px rgba(0,0,0,.35)}

  /* Debug box */
  #ffDebug{position:fixed;inset:auto 8px 8px 8px;background:#0b0f18;color:#ffb4b4;
    border:1px solid #311; border-radius:10px; padding:10px; font:12px/1.35 ui-monospace,monospace; z-index:999999}
  #ffDebug b{color:#fff}
</style>
</head>
<body>
<header>
  <div class="hp-wrap">
    <div class="hp-icon">ðŸ’ª</div>
    <div class="hp" id="hp">0.00 <small>HP</small></div>
  </div>
</header>

<div class="wrap">
  <div class="grid" id="cards"></div>
</div>

<!-- DEBUG PANEL -->
<div id="ffDebug">
  <div><b>Fitness Frenzy Debug</b></div>
  <div id="ffErr">No errors yet.</div>
  <div id="ffClick">No clicks yet.</div>
  <div id="ffTop">Top element: (waiting)</div>
</div>

<script>
/* ================= Core Utilities ================= */
const $ = s => document.getElementById(s);
function fmt(n){
  // compact formatter to Qd range
  const a=Math.abs(n);
  const f=(v)=>v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  if(a>=1e18) return f(n/1e18)+'E'; // exa-ish
  if(a>=1e15) return f(n/1e15)+'Q';
  if(a>=1e12) return f(n/1e12)+'T';
  if(a>=1e9)  return f(n/1e9)+'B';
  if(a>=1e6)  return f(n/1e6)+'M';
  if(a>=1e3)  return f(n/1e3)+'K';
  return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}

function now(){ return Date.now(); }

/* ================= Audio (minimal, inline) ================= */
let AC=null, master=null;
function ensureAC(){ try{ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; AC=new C(); master=AC.createGain(); master.gain.value=.9; master.connect(AC.destination);}catch(e){} }
function s_click(){ try{ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain(); o.type="triangle"; o.frequency.value=420; o.connect(g); g.connect(master); g.gain.setValueAtTime(.16,t); g.gain.exponentialRampToValueAtTime(.0001,t+.12); o.start(t); o.stop(t+.14);}catch(e){} }
function s_buy(){ try{ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain(); o.type="square"; o.frequency.value=980; o.connect(g); g.connect(master); g.gain.setValueAtTime(.2,t); g.gain.exponentialRampToValueAtTime(.0001,t+.2); o.start(t); o.stop(t+.22);}catch(e){} }

/* ================= Data & Balance ================= */
// AdCap-style config (Beginner Zone sample)
const EXERCISES = [
  {
    key:'walk', name:'Walking', icon:'ðŸ‘Ÿ',
    baseCost:5, baseHP:1, cooldown:4000, coeff:1.07,  // 4s cycle
    trainerCost:100, unlocked:true
  },
  {
    key:'sit', name:'Sit-Ups', icon:'ðŸ¤¸â€â™‚ï¸',
    baseCost:60, baseHP:60, cooldown:3000, coeff:1.15, // 3s cycle
    trainerCost:600, unlocked:false
  },
  // Add more later per your tableâ€¦
];

const OFFLINE_RATE = 0.5;           // 50% rate offline
const OFFLINE_CAP_MS = 24*3600e3;   // cap offline calc to 24h

/* ================= State ================= */
let state = {
  hp: 0,
  lastSave: now(),
  lastTick: now(),
  exercises: EXERCISES.map(e=>({
    key:e.key, reps:0, trainer:false, nextReady:0, unlocked:!!e.unlocked
  }))
};

/* ================= Save / Load / Offline ================= */
const SAVE_KEY='ff-save-v1';
function save(){
  state.lastSave = now();
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(s && typeof s.hp === 'number' && Array.isArray(s.exercises)){
      state = {...state, ...s};
      // Ensure future compatibility
      EXERCISES.forEach((cfg,i)=>{
        if(!state.exercises[i] || state.exercises[i].key!==cfg.key){
          state.exercises[i] = {key:cfg.key, reps:0, trainer:false, nextReady:0, unlocked:!!cfg.unlocked};
        }
      });
      // Offline gains for trainers
      const elapsed = Math.min(OFFLINE_CAP_MS, now() - (s.lastTick||now()));
      if(elapsed>1000){
        let hpGain = 0;
        EXERCISES.forEach((cfg,i)=>{
          const ex = state.exercises[i];
          if(ex.trainer && ex.reps>0){
            const perCycle = calcCycleHP(cfg, ex);
            const cycles = Math.floor(elapsed / cfg.cooldown);
            hpGain += perCycle * cycles * OFFLINE_RATE;
          }
        });
        state.hp += hpGain;
      }
    }
  }catch(e){ console.warn('Load failed', e); }
}
window.addEventListener('beforeunload', save);
setInterval(save, 15000);

/* ================= Math ================= */
// cost to buy next rep (quantity)
function costNext(cfg, ex){
  // classic AdCap: baseCost * 1.07^reps
  return Math.ceil(cfg.baseCost * Math.pow(1.07, ex.reps));
}
// HP per cycle (AdCap-esque, with your coeff exponent)
function calcCycleHP(cfg, ex){
  if(ex.reps<=0) return 0;
  const mult = Math.pow(ex.reps, cfg.coeff); // gentle exponential
  return cfg.baseHP * mult;                  // room for global multipliers later
}

/* ================= UI ================= */
function buildUI(){
  const cards = $('cards');
  cards.innerHTML='';
  EXERCISES.forEach((cfg,i)=>{
    const ex = state.exercises[i];

    const card = document.createElement('div');
    card.className='card';
    card.id = `card-${cfg.key}`;

    const tap = document.createElement('button');
    tap.className='tap';
    tap.id = `tap-${cfg.key}`;
    tap.innerHTML = `<div class="emoji">${cfg.icon}</div>`;
    tap.addEventListener('click', ()=>{ ensureAC(); tapExercise(i); });

    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `
      <h3>${cfg.name} ${ex.trainer?'<small>Coach</small>':''}</h3>
      <div class="sub">
        <span>Reps: <b id="reps-${cfg.key}">${ex.reps}</b></span>
        <span>HP/cycle: <b id="hpc-${cfg.key}">0</b></span>
        <span>Cooldown: <b id="cd-${cfg.key}">${(cfg.cooldown/1000).toFixed(2)}s</b></span>
      </div>
      <div class="bar"><i id="cool-${cfg.key}"></i></div>
      <div class="mini"><i id="mini-${cfg.key}"></i><div class="lbl" id="miniLbl-${cfg.key}">â€”</div></div>
      <div class="actions">
        <button class="btn primary glitter" id="buy-${cfg.key}">Buy Rep | â€” HP</button>
        <button class="btn" id="mgr-${cfg.key}">Hire Coach | â€” HP</button>
      </div>
    `;
    card.appendChild(tap);
    card.appendChild(meta);
    cards.appendChild(card);
  });
}

function updateUI(){
  $('hp').innerHTML = `${fmt(state.hp)} <small>HP</small>`;
  EXERCISES.forEach((cfg,i)=>{
    const ex = state.exercises[i];
    const ready = now() >= ex.nextReady;

    const tapEl = $(`tap-${cfg.key}`);
    const repsEl = $(`reps-${cfg.key}`);
    const hpcEl = $(`hpc-${cfg.key}`);
    const cdEl  = $(`cd-${cfg.key}`);
    const coolI = $(`cool-${cfg.key}`);
    const miniI = $(`mini-${cfg.key}`);
    const miniL = $(`miniLbl-${cfg.key}`);
    const buyBt = $(`buy-${cfg.key}`);
    const mgrBt = $(`mgr-${cfg.key}`);

    if(tapEl) tapEl.classList.toggle('ready', ready);

    const perCycle = calcCycleHP(cfg, ex);
    if(repsEl) repsEl.textContent = ex.reps;
    if(hpcEl)  hpcEl.textContent  = fmt(perCycle);
    if(cdEl)   cdEl.textContent   = (cfg.cooldown/1000).toFixed(2)+'s';

    // cooldown bar
    const left = Math.max(0, ex.nextReady - now());
    const pct = 1 - Math.min(1, left / cfg.cooldown);
    if(coolI) coolI.style.width = Math.round(pct*100)+'%';

    // Buy Rep
    const cost = costNext(cfg, ex);
    if(buyBt){
      buyBt.textContent = `Buy Rep | ${fmt(cost)} HP`;
      const can = state.hp >= cost && state.exercises[i].unlocked !== false;
      buyBt.disabled = !can;
      buyBt.classList.toggle('available', can);
      buyBt.onclick = ()=>{ ensureAC(); buyRep(i); };
    }

    // Trainer
    const mCost = cfg.trainerCost;
    if(mgrBt){
      mgrBt.textContent = ex.trainer ? 'Coach Hired' : `Hire Coach | ${fmt(mCost)} HP`;
      const can = !ex.trainer && state.hp >= mCost && ex.reps>0;
      mgrBt.disabled = !can;
      mgrBt.classList.toggle('available', can);
      mgrBt.onclick = ()=>{ ensureAC(); hireCoach(i); };
    }

    // Unlock rule: unlock next exercise when this has >=1 rep
    if(i+1<EXERCISES.length){
      const next = state.exercises[i+1];
      if(!next.unlocked && ex.reps>=1){
        next.unlocked = true;
        const nextCard = $(`card-${EXERCISES[i+1].key}`);
        if(nextCard) nextCard.style.filter='none';
      }
    }

    // Lock visual for locked exercises
    const card = $(`card-${cfg.key}`);
    if(card){
      if(!ex.unlocked){
        card.style.filter='grayscale(1) blur(1px) opacity(.85)';
        if(buyBt) buyBt.style.visibility='hidden';
        if(mgrBt) mgrBt.style.visibility='hidden';
        if(miniI) miniI.style.width='0%';
        if(miniL) miniL.textContent='Locked';
      }else{
        card.style.filter='none';
        if(buyBt) buyBt.style.visibility='';
        if(mgrBt) mgrBt.style.visibility='';
        if(miniL) miniL.textContent='â€”'; // (reserved for future per-exercise milestones)
      }
    }
  });
}

/* ================= Gameplay ================= */
function floatHP(anchor, text){
  const r = anchor.getBoundingClientRect();
  const n = document.createElement('div');
  n.className='float'; n.textContent=text;
  n.style.left = (r.left + r.width/2) + 'px';
  n.style.top  = (r.top + 10 + window.scrollY) + 'px';
  document.body.appendChild(n);
  n.animate([{transform:'translate(-50%,0) scale(1)', opacity:1, color:'#fff'},
             {transform:'translate(-50%,-40px) scale(1.05)', opacity:0, color:'#ffdea8'}],
            {duration:800, easing:'ease-out'});
  setTimeout(()=>n.remove(),820);
}

function tapExercise(i){
  const cfg = EXERCISES[i], ex = state.exercises[i];
  if(!ex.unlocked){ return; }
  if(now() < ex.nextReady){ return; }
  if(ex.reps<=0){ return; }          // need at least 1 rep to produce
  // start a cycle; pay out immediately (AdCap pays on completion; here we pay on start for snappier feel)
  const gain = calcCycleHP(cfg, ex);
  state.hp += gain;
  s_click();
  const tapEl = $(`tap-${cfg.key}`);
  if(tapEl){ tapEl.classList.remove('bop'); void tapEl.offsetWidth; tapEl.classList.add('bop'); floatHP(tapEl, `+${fmt(gain)} HP`);}
  ex.nextReady = now() + cfg.cooldown;
}

function buyRep(i){
  const cfg = EXERCISES[i], ex = state.exercises[i];
  if(!ex.unlocked){ return; }
  const cost = costNext(cfg, ex);
  if(state.hp < cost) return;
  state.hp -= cost;
  ex.reps += 1;
  s_buy();
  // gentle nudge: first time you buy any reps, set ready so a tap pays instantly
  if(ex.nextReady === 0) ex.nextReady = now();
}

function hireCoach(i){
  const cfg = EXERCISES[i], ex = state.exercises[i];
  if(ex.trainer || ex.reps<=0) return;
  const mCost = cfg.trainerCost;
  if(state.hp < mCost) return;
  state.hp -= mCost;
  ex.trainer = true;
  s_buy();
}

/* ================= Main Loop ================= */
function tick(){
  const t = now();
  const dt = t - state.lastTick;
  state.lastTick = t;

  // trainers automation: run on cycle boundaries
  EXERCISES.forEach((cfg,i)=>{
    const ex = state.exercises[i];
    if(!ex.trainer || ex.reps<=0 || !ex.unlocked) return;
    if(t >= ex.nextReady){
      const gain = calcCycleHP(cfg, ex);
      state.hp += gain;
      ex.nextReady = t + cfg.cooldown;
      // minimal glow on auto complete
      const tapEl = $(`tap-${cfg.key}`);
      if(tapEl){ tapEl.classList.add('ready'); setTimeout(()=>tapEl.classList.remove('ready'), 60); }
    }
  });

  updateUI();
}
setInterval(tick, 60);

/* ================= Boot ================= */
function boot(){
  buildUI();
  load();
  updateUI();
  // Debug clicks
  document.addEventListener('click', e=>{
    $('ffClick').textContent = 'Last click on: ' + (e.target.id || e.target.tagName);
  }, true);
  // Probe top element over first cardâ€™s tap
  setInterval(()=>{
    const first = EXERCISES[0];
    const tap = $(`tap-${first.key}`);
    const info = $('ffTop');
    if(!tap){ info.textContent='Top element over tap: (no element)'; return; }
    const r = tap.getBoundingClientRect();
    const x = Math.round(r.left + r.width/2), y = Math.round(r.top + r.height/2);
    const el = document.elementFromPoint(x, y);
    info.textContent = 'Top element over tap: ' + (el ? (el.id || el.tagName) : 'none');
  }, 500);
  window.addEventListener('error', (e)=>{
    const where=(e.filename||'')+(e.lineno?(':'+e.lineno):'');
    $('ffErr').textContent = 'JS error: ' + e.message + ' @ ' + where;
  });
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
</script>
</body>
</html>
