<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Fitness Frenzy — VS6g (ES5 Mobile-Safe Minimal)</title>
  <style>
    :root{
      --bg:#0f1020; --panel:#1a1c35; --panel-2:#23264a; --accent:#ff7a1a; --text:#f5f7ff; --muted:#aab1d6;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .topbar{position:sticky; top:0; z-index:10; background:#111432; border-bottom:1px solid #23285b; padding:10px 12px}
    .wrap{max-width:880px; margin:0 auto; padding:12px}
    .row{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .logo{font-weight:900}
    .hp-pill{margin-top:8px; background:#182047; border:1px solid #2a2e5e; padding:8px 10px; border-radius:10px; font-variant-numeric: tabular-nums; display:flex; align-items:center; justify-content:space-between}
    .cards{display:grid; gap:12px}
    .card{display:grid; grid-template-columns:110px 1fr; gap:12px; padding:10px; background:var(--panel); border:1px solid #262a58; border-radius:12px}
    .tile{background:var(--panel-2); border-radius:10px; position:relative; height:110px; display:grid; place-items:center; user-select:none; overflow:hidden; cursor:pointer}
    .tile.locked{filter: grayscale(100%); opacity:.9}
    .lvl{position:absolute; top:6px; left:6px; background:#171a38; border:1px solid #2b2f63; padding:2px 6px; border-radius:6px; font-size:12px}
    .tap-btn{appearance:none; border:0; background:var(--accent); color:#1b0d00; font-weight:800; padding:8px 10px; border-radius:8px; cursor:pointer}
    .tile.cooling .tap-btn{opacity:.5; cursor:not-allowed}
    .title{font-weight:700; margin-top:2px}
    .cooldown{margin-top:6px; height:20px; background:#141739; border:1px solid #2a2e5e; border-radius:6px; overflow:hidden; position:relative}
    .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #2f6df3, #41b0ff)}
    .t{position:relative; z-index:1; padding-left:8px; font-variant-numeric: tabular-nums; color:#aab1d6}
    .meta{display:flex; align-items:center; justify-content:space-between; margin-top:8px}
    .muted{color:#aab1d6}
    .btn{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:8px 10px; border-radius:10px; min-width:160px; cursor:pointer; font-variant-numeric: tabular-nums}
    .repband{position:absolute; left:6px; right:6px; bottom:6px; height:16px; border-radius:8px; background:#0e132e; border:1px solid #2a2e5e; overflow:hidden}
    .repfill{height:100%; width:0%; background:linear-gradient(90deg, #17b34c, #27c93f)}
    .reptext{position:absolute; inset:0; display:grid; place-items:center; font-size:12px; color:#cfead6; text-shadow:0 1px 2px #000}
    .err{position:fixed; top:0; left:0; right:0; background:#8b1111; color:#fff; z-index:100; padding:8px 12px; font-weight:700; display:none}
    .err.show{display:block}
    .hud{position:fixed; bottom:8px; right:8px; background:#0e1433; color:#9ec4ff; border:1px solid #2a3e7a; padding:6px 8px; border-radius:8px; font-size:12px; font-variant-numeric: tabular-nums; opacity:.9}
    .testbar{display:flex; gap:8px; align-items:center}
  </style>
</head>
<body>
  <div id="err" class="err"></div>

  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="logo">Fitness Frenzy — VS6g (ES5 Mobile-Safe Minimal)</div>
        <div class="testbar">
          <button id="taptest" class="btn">Tap Test</button>
          <span id="tapcount" class="muted">0</span>
        </div>
      </div>
      <div class="hp-pill"><span>HP</span><span id="hp-readout">0</span></div>
    </div>
  </div>

  <div class="wrap">
    <div id="cards" class="cards"></div>
  </div>

  <div id="hud" class="hud">tick: —<br>now: —<br>lastTap: —</div>

  <script>
  (function(){
    var errEl = document.getElementById('err');
    function showErr(msg){ errEl.textContent = 'Error: ' + msg; errEl.classList.add('show'); }
    window.addEventListener('error', function(e){ showErr(e.message || 'Script error'); });
    window.addEventListener('unhandledrejection', function(e){ var r = e.reason; showErr((r && r.message) || 'Unhandled promise rejection'); });

    // --- ES5 helpers ---
    function fmt(n){ if(!isFinite(n)) return '0'; var a=Math.abs(n); if(a>=1e12) return (n/1e12).toFixed(2)+'T'; if(a>=1e9) return (n/1e9).toFixed(2)+'B'; if(a>=1e6) return (n/1e6).toFixed(2)+'M'; if(a>=1e3) return (n/1e3).toFixed(2)+'K'; return String(Math.floor(n)); }
    function pow(a,b){ return Math.pow(a,b); }
    function log2(x){ return Math.log(x)/Math.log(2); }

    // Content (minimal two exercises)
    var Exercises = [
      { id:'walk', name:'Walking', baseCooldownMs:1000 },
      { id:'jog',  name:'Jogging', baseCooldownMs:3000 }
    ];

    // Math
    function baseHP(idx, ms){ return idx===0 ? 1 : Math.round(20 * pow(ms/1000, 1.10)); }
    function perTapHP(b, repHP){ return b + repHP; }
    function repBaseCost(b){ return Math.max(4, Math.round(b * 0.05)); }
    function repGrowth(lvl){ return Math.max(1.07, Math.min(1.15, 1.07 + 0.01 * log2(Math.max(1, lvl)))); }
    function repCostSingle(rb,g,rep){ return rb * pow(g, rep); }
    function nextCooldown(ms){ return Math.max(100, Math.floor(ms/2)); }
    function unlockCost(b, ms){ return Math.round(b * pow(ms/1000, 0.60) * 1.15); }

    // State (in-memory only)
    var S = {
      hp:0, qty:1,
      exercises:[
        { id:'walk', unlocked:true,  repHP:0, repTarget:10, level:1, cooldown:1000, lastTapAt:0 },
        { id:'jog',  unlocked:false, repHP:0, repTarget:10, level:1, cooldown:3000, lastTapAt:0 }
      ]
    };

    // DOM refs
    var hpReadout = document.getElementById('hp-readout');
    var cardsRoot = document.getElementById('cards');
    var hud = document.getElementById('hud');
    var tapTest = document.getElementById('taptest');
    var tapCountEl = document.getElementById('tapcount');
    var tapCount = 0;
    tapTest.addEventListener('click', function(){ tapCount++; tapCountEl.textContent = tapCount; });

    // Cards
    var cardRefs = {}; // id -> ref
    function createCard(idx){
      var meta = Exercises[idx];
      var ex = S.exercises[idx];

      var card = document.createElement('div'); card.className='card';
      var tile = document.createElement('div'); tile.className='tile';
      if(!ex.unlocked) tile.classList.add('locked');
      var lvl  = document.createElement('div'); lvl.className='lvl'; lvl.textContent = 'Lvl ' + ex.level;
      var tap  = document.createElement('button'); tap.className='tap-btn'; tap.textContent = ex.unlocked ? '+ Tap' : 'Locked';
      var repband = document.createElement('div'); repband.className='repband';
      var repfill = document.createElement('div'); repfill.className='repfill';
      var reptext = document.createElement('div'); reptext.className='reptext';
      repband.appendChild(repfill); repband.appendChild(reptext);
      tile.appendChild(lvl); tile.appendChild(tap); tile.appendChild(repband);

      var right = document.createElement('div');
      var title = document.createElement('div'); title.className='title'; title.textContent = meta.name;
      var cd = document.createElement('div'); cd.className='cooldown';
      var bar = document.createElement('div'); bar.className='bar';
      var t = document.createElement('div'); t.className='t'; t.textContent='Ready';
      cd.appendChild(bar); cd.appendChild(t);
      var metaRow = document.createElement('div'); metaRow.className='meta';
      var left = document.createElement('div'); left.className='muted';
      var rightBtn = document.createElement('button'); rightBtn.className='btn';
      metaRow.appendChild(left); metaRow.appendChild(rightBtn);
      right.appendChild(title); right.appendChild(cd); right.appendChild(metaRow);
      card.appendChild(tile); card.appendChild(right);
      cardsRoot.appendChild(card);

      function doTap(){
        var now = Date.now();
        var e = S.exercises[idx];
        if(!e.unlocked) return;
        if(now < e.lastTapAt + e.cooldown) return;
        var gain = perTapHP(baseHP(idx, meta.baseCooldownMs), e.repHP);
        S.hp += gain;
        e.lastTapAt = now;
        hpReadout.textContent = fmt(S.hp);
      }
      tap.addEventListener('click', doTap);
      tile.addEventListener('click', doTap);

      rightBtn.addEventListener('click', function(){
        var e = S.exercises[idx];
        if(!e.unlocked){
          var b0 = baseHP(idx, meta.baseCooldownMs);
          var price0 = unlockCost(b0, meta.baseCooldownMs);
          if(S.hp < price0) return;
          S.hp -= price0; e.unlocked = true; tap.textContent = '+ Tap'; tile.classList.remove('locked');
          hpReadout.textContent = fmt(S.hp);
          return;
        }
        var b = baseHP(idx, meta.baseCooldownMs);
        var rb = repBaseCost(b); var g = repGrowth(e.level);
        var price = Math.ceil(repCostSingle(rb,g,e.repHP));
        if(S.hp < price) return;
        S.hp -= price; e.repHP += 1;
        if(e.repHP >= e.repTarget){ e.level += 1; e.cooldown = nextCooldown(e.cooldown); e.repTarget *= 2; }
        hpReadout.textContent = fmt(S.hp);
      });

      cardRefs[meta.id] = { idx:idx, tile:tile, lvl:lvl, tap:tap, repfill:repfill, reptext:reptext, bar:bar, t:t, left:left, rightBtn:rightBtn, title:title };
      updateCard(meta.id);
    }

    function updateCard(id){
      var r = cardRefs[id]; if(!r) return;
      var i = r.idx;
      var meta = Exercises[i];
      var e = S.exercises[i];
      r.lvl.textContent = 'Lvl ' + e.level;
      r.title.textContent = meta.name;

      if(!e.unlocked){
        r.tile.classList.add('locked');
        r.tap.textContent = 'Locked';
        var b0 = baseHP(i, meta.baseCooldownMs);
        var price0 = unlockCost(b0, meta.baseCooldownMs);
        r.left.textContent = '—';
        r.rightBtn.textContent = 'Unlock • ' + fmt(price0) + ' HP';
        r.reptext.textContent = '—'; r.repfill.style.width = '0%';
      }else{
        r.tile.classList.remove('locked');
        r.tap.textContent = '+ Tap';
        var b = baseHP(i, meta.baseCooldownMs);
        var hpTap = perTapHP(b, e.repHP);
        r.left.textContent = hpTap + ' HP / tap';
        var rb = repBaseCost(b); var g = repGrowth(e.level);
        var price = Math.ceil(repCostSingle(rb,g,e.repHP));
        r.rightBtn.textContent = 'Reps • ' + fmt(price) + ' HP';
        r.reptext.textContent = e.repHP + ' / ' + e.repTarget;
        var pct = Math.max(0, Math.min(100, 100 * (e.repHP / e.repTarget)));
        r.repfill.style.width = pct + '%';
      }
    }

    function build(){
      cardsRoot.innerHTML='';
      cardRefs = {};
      for(var i=0;i<Exercises.length;i++){ createCard(i); }
    }
    build();

    // Timer loop (setInterval for Safari robustness)
    var tickCount = 0;
    setInterval(function(){
      try{
        tickCount++;
        var now = Date.now();
        hud.innerHTML = 'tick: ' + tickCount + '<br>now: ' + now + '<br>lastTap: ' + S.exercises[0].lastTapAt;
        for(var i=0;i<Exercises.length;i++){
          var e = S.exercises[i]; var r = cardRefs[Exercises[i].id];
          if(!r) continue;
          var dt = Math.max(0, now - e.lastTapAt);
          var remain = Math.max(0, e.cooldown - dt);
          var pct = e.cooldown>0 ? Math.max(0, Math.min(100, 100 * (dt / e.cooldown))) : 100;
          if(remain<=0){ r.bar.style.width='100%'; r.t.textContent='Ready'; r.tile.classList.remove('cooling'); }
          else { r.bar.style.width = pct + '%'; r.t.textContent = (remain/1000).toFixed(2)+'s'; r.tile.classList.add('cooling'); }
        }
        // Periodically refresh static text
        if(tickCount % 10 === 0){
          updateCard('walk'); updateCard('jog');
        }
      }catch(e){ showErr(e.message || e); }
    }, 50);

  })();
  </script>
</body>
</html>
