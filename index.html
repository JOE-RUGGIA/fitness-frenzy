<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Fitness Frenzy — core + menu + fitcoins + rep bars (quiet)</title>
<style>
  :root{
    --bg:#0f1020; --panel:#151836; --panel2:#1d2148; --border:#2a2e5e;
    --text:#eef1ff; --muted:#aab1d6; --good:#27c93f; --accent:#3aa6ff;
    --f-accent:#ff76b5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  /* Top bar */
  .topbar{position:sticky; top:0; z-index:20; background:linear-gradient(180deg,#151734,#10122a); border-bottom:1px solid #22254b}
  .wrap{max-width:920px; margin:0 auto; padding:12px 14px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{font-weight:900; letter-spacing:.3px}
  .avatar{width:64px; height:64px; border-radius:50%; border:2px solid #3b3f78; background:#23265a; display:grid; place-items:center; font-weight:900; cursor:pointer; position:relative}
  .avatar .dot{position:absolute; right:-6px; top:-6px; width:18px; height:18px; border-radius:50%; background:var(--good); border:3px solid var(--bg); display:none}
  .bulk{display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#1a1e45}
  .bulk button{border:0; background:transparent; color:#fff; padding:8px 12px; min-width:52px; cursor:pointer}
  .bulk button.active{background:var(--accent); color:#061222; font-weight:800}
  /* Two-pill row */
  .top-pills{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
  .hp-pill,.fit-pill{
    background:#182047; border:1px solid var(--border); padding:10px 12px; border-radius:12px;
    display:flex; justify-content:space-between; font-variant-numeric:tabular-nums
  }

  /* Cards */
  .cards{display:grid; gap:12px}
  .card{display:grid; grid-template-columns:120px 1fr; gap:12px; padding:12px; background:var(--panel); border:1px solid var(--border); border-radius:14px}
  .tile{height:120px; border-radius:12px; background:var(--panel2); position:relative; cursor:pointer; user-select:none; overflow:hidden}
  .tile.locked{filter:grayscale(100%); opacity:.9; cursor:default}
  .lvl{position:absolute; left:6px; top:6px; font-size:12px; padding:2px 6px; background:#10122a; border:1px solid #2b2f63; border-radius:8px; z-index:2}
  /* Rep progress band (green) */
  .repband{position:absolute; left:6px; right:6px; bottom:6px; height:18px; border-radius:9px; background:#0e132e; border:1px solid #2a2e5e; overflow:hidden; z-index:1}
  .repfill{height:100%; width:0%; background:linear-gradient(90deg,#17b34c,#27c93f)}
  .reptext{position:absolute; inset:0; display:grid; place-items:center; font-size:12px; color:#cfead6; text-shadow:0 1px 2px #000}

  .cooldown{margin-top:6px; height:22px; background:#141739; border:1px solid var(--border); border-radius:8px; position:relative; overflow:hidden}
  .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,#2f6df3,#41b0ff)}
  body.female .bar{background:linear-gradient(90deg,var(--f-accent),#ffb3d5)}
  .t{position:relative; z-index:1; padding-left:8px; font-size:13px; color:#a6b0d8}
  .title{font-weight:800}
  .meta{display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:10px; flex-wrap:wrap}
  .muted{color:var(--muted)}
  .btn{appearance:none; border:1px solid var(--border); background:#1b1f44; color:#e9edff; padding:10px 14px; border-radius:12px; cursor:pointer; min-width:180px}
  .btn.glow{box-shadow:0 0 0 2px rgba(255,192,120,.22) inset, 0 0 10px rgba(255,122,26,.25)}

  /* Menu (slides up) */
  .menu{position:fixed; inset:0; display:none; z-index:40}
  .menu.show{display:block}
  .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
  .sheet{position:absolute; left:0; right:0; bottom:0; background:#14163a; border-top:1px solid var(--border); transform:translateY(6%); opacity:0; transition:transform .14s ease, opacity .14s ease; max-height:82vh; display:flex; flex-direction:column}
  .menu.show .sheet{transform:translateY(0%); opacity:1}
  .sheet-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border)}
  .tabs{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid var(--border); overflow:auto}
  .tab{appearance:none; border:1px solid var(--border); background:#1b1f44; color:#e9edff; padding:8px 12px; border-radius:10px; cursor:pointer; white-space:nowrap}
  .tab.active{background:#202767; outline:2px solid var(--accent)}
  .sheet-body{flex:1; overflow:auto; padding:14px}
  .coach-row{display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; background:#171a3a; border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px}
  .coach-ava{width:44px; height:44px; border-radius:50%; background:#2b2f63; display:grid; place-items:center; font-weight:800}
  .coach-title{font-weight:800}
  .coach-sub{font-size:12px; color:#a6adcf}
  .hired{color:var(--good); font-weight:800}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#1b1f44; border:1px solid var(--border); font-size:12px}

  @media (max-width:480px){
    .card{grid-template-columns:100px 1fr}
    .tile{height:100px}
    .btn{min-width:140px; padding:8px 12px}
  }
</style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="wrap">
      <change-me>
      <div class="row">
        <div class="row" style="gap:12px">
          <button id="avatar" class="avatar" title="Menu">FF<span class="dot" id="avatar-dot"></span></button>
          <div class="brand">Fitness Frenzy</div>
        </div>
        <div class="bulk" id="bulk">
          <button data-q="1" class="active">×1</button>
          <button data-q="10">×10</button>
          <button data-q="100">×100</button>
        </div>
      </div>
      <!-- Two-pill row -->
      <div class="top-pills">
        <div class="hp-pill"><span>HP</span><span id="hp-readout">0</span></div>
        <div class="fit-pill"><span>Fitcoins</span><span id="fc-readout">0</span></div>
      </div>
      </change-me>
    </div>
  </div>

  <div class="wrap"><div id="cards" class="cards"></div></div>

  <!-- Menu (bottom sheet) -->
  <div id="menu" class="menu" role="dialog" aria-modal="true" aria-labelledby="menu-title">
    <div class="backdrop" data-close="1"></div>
    <div class="sheet">
      <div class="sheet-head">
        <div id="menu-title" style="font-weight:900">Menu</div>
        <button class="btn" data-close="1">Close</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="coaches">Coaches</button>
        <button class="tab" data-tab="achievements">Achievements</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>
      <div id="menu-body" class="sheet-body"></div>
    </div>
  </div>

<script>
/* ====================== Core (quiet) + Fitcoins + Rep bars ====================== */
(function(){
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

  // --- Data & math
  const Exercises = [
    { id:'walk',   name:'Walking',            base:   1000 },
    { id:'jog',    name:'Jogging',            base:   3000 },
    { id:'sit',    name:'Sit-ups',            base:   6000 },
    { id:'push',   name:'Push-ups',           base:  12000 },
    { id:'jacks',  name:'Jumping Jacks',      base:  24000 },
    { id:'pull',   name:'Pull-ups',           base:  48000 },
    { id:'rope',   name:'Jump Rope',          base:  96000 },
    { id:'plank',  name:'Plank',              base: 192000 },
    { id:'mtclimb',name:'Mountain Climbers',  base: 384000 },
    { id:'kb',     name:'Kettlebell',         base: 768000 },
    { id:'burpee', name:'Burpees',            base:1536000 },
    { id:'bench',  name:'Bench Press',        base:3072000 },
    { id:'backsq', name:'Back Squat',         base:6144000 },
    { id:'dead',   name:'Deadlift',           base:12288000 },
    { id:'hand',   name:'Handstands',         base:24576000 },
    { id:'hspu',   name:'Handstand Push-ups', base:49152000 },
    { id:'muscle', name:'Muscle-ups',         base:98304000 },
    { id:'lever',  name:'Front Lever',        base:196608000 },
    { id:'icross', name:'Iron Cross',         base:393216000 },
    { id:'vcross', name:'Victorian Cross',    base:786432000 },
  ];
  const KEY='ff-core-v2'; // bump since we added Fitcoins

  const coachPrice = i => i===0 ? 1500 : Math.round(1500*Math.pow(1.8,i));
  const baseHP     = (idx,ms)=> idx===0 ? 1 : Math.round(20*Math.pow(ms/1000,1.10));
  const perTapHP   = (b,rep)=> b + rep;
  const repBaseCost= b => Math.max(4,Math.round(b*.05));
  const repGrowth  = lvl=> Math.max(1.07,Math.min(1.15,1.07+.01*Math.log2(Math.max(1,lvl))));
  const repCost1   = (rb,g,rep)=> rb*Math.pow(g,rep);
  const repCostN   = (rb,g,rep,n)=> rb*Math.pow(g,rep)*((Math.pow(g,n)-1)/(g-1));
  const nextCd     = ms=> Math.max(100, Math.floor(ms/2));
  const unlockCost = (b,ms)=> Math.round(b*Math.pow(ms/1000,.60)*1.15);
  const fmt        = n=>{ if(!isFinite(n)) return '0'; const a=Math.abs(n);
    if(a>=1e12) return (n/1e12).toFixed(2)+'T';
    if(a>=1e9)  return (n/1e9).toFixed(2)+'B';
    if(a>=1e6)  return (n/1e6).toFixed(2)+'M';
    if(a>=1e3)  return (n/1e3).toFixed(2)+'K';
    return String(Math.floor(n)); };

  // --- State
  function defaultExercises(){ return Exercises.map((ex,i)=>({id:ex.id, unlocked:i===0, repHP:0, repTarget:10, level:1, cooldown:ex.base, lastTapAt:0})); }
  function defaults(){
    return { schema:2, avatar:'male', qty:1, hp:0, fc:0, started:true,
      exercises:defaultExercises(), coaches:{}, stats:{manual:0,auto:0,totalEarned:0} };
  }
  function ensure(s){
    if(!s || typeof s!=='object') return defaults();
    s.avatar = (s.avatar==='female') ? 'female' : 'male';
    s.qty    = s.qty|0 || 1;
    s.hp     = s.hp|0;
    s.fc     = s.fc|0 || 0;
    // repair exercises
    const byId = new Map((s.exercises||[]).map(e=>[e.id,e]));
    s.exercises = Exercises.map((ex,i)=>{
      const e = byId.get(ex.id) || {};
      return {
        id: ex.id, unlocked: !!(i===0 || e.unlocked), repHP: e.repHP|0 || 0,
        repTarget: e.repTarget|0 || 10, level: e.level|0 || 1,
        cooldown: e.cooldown|0 || ex.base, lastTapAt: e.lastTapAt|0 || 0
      };
    });
    s.coaches = s.coaches || {};
    s.stats   = s.stats   || {manual:0,auto:0,totalEarned:0};
    return s;
  }
  function load(){ try{ const raw=localStorage.getItem(KEY); return ensure(raw?JSON.parse(raw):null); }catch(_){ return ensure(null); } }
  function save(x){ try{ localStorage.setItem(KEY, JSON.stringify(ensure(x))); }catch(_){ } }

  let S = load();
  function patch(mut){ S = ensure(mut(ensure(S))); save(S); markDirty(); }

  // --- DOM refs
  const hpEl = $('#hp-readout');
  const fcEl = $('#fc-readout');
  const bulk = $('#bulk');
  const cardsRoot = $('#cards');
  const avatarBtn = $('#avatar');
  const avatarDot = $('#avatar-dot');
  const menu = $('#menu');
  const menuBody = $('#menu-body');

  // --- UI (cards)
  const cardRefs = new Map();
  function updateCard(id){
    const r = cardRefs.get(id); if(!r) return;
    const meta = Exercises[r.idx]; const ex = S.exercises[r.idx];

    r.title.textContent = meta.name;
    r.lvl.textContent   = 'Lvl ' + ex.level;

    if(!ex.unlocked){
      const b=baseHP(r.idx, meta.base), price=unlockCost(b, meta.base);
      r.tile.classList.add('locked');
      r.left.textContent = '—';
      r.btn.textContent  = 'Unlock • ' + fmt(price) + ' HP';
      r.btn.classList.toggle('glow', S.hp>=price);
      r.reptext.textContent='—';
      r.repfill.style.width='0%';
    }else{
      r.tile.classList.remove('locked');
      const b=baseHP(r.idx, meta.base), hpTap=perTapHP(b, ex.repHP);
      r.left.textContent = hpTap + ' HP / tap';
      const rb=repBaseCost(b), g=repGrowth(ex.level), qty=S.qty;
      const cost = Math.ceil(qty===1 ? repCost1(rb,g,ex.repHP) : repCostN(rb,g,ex.repHP,qty));
      r.btn.textContent  = 'Reps • ' + fmt(cost) + ' HP';
      r.btn.classList.toggle('glow', S.hp>=cost);
      // rep band
      const target = ex.repTarget||10, cur = ex.repHP||0;
      r.reptext.textContent = cur + ' / ' + target;
      r.repfill.style.width = Math.max(0, Math.min(100, 100 * (cur/target))) + '%';
    }
  }
  function createCard(i){
    const meta = Exercises[i], ex = S.exercises[i];
    const card = document.createElement('div'); card.className='card';
    const tile = document.createElement('div'); tile.className='tile';
    if(!ex.unlocked) tile.classList.add('locked');
    const lvl = document.createElement('div'); lvl.className='lvl'; lvl.textContent='Lvl '+ex.level;
    // rep band
    const repband=document.createElement('div'); repband.className='repband';
    const repfill=document.createElement('div'); repfill.className='repfill';
    const reptext=document.createElement('div'); reptext.className='reptext'; reptext.textContent='0 / 10';
    repband.append(repfill,reptext);
    tile.append(lvl, repband);

    const right = document.createElement('div');
    const title = document.createElement('div'); title.className='title'; title.textContent=meta.name;
    const cd    = document.createElement('div'); cd.className='cooldown';
    const bar   = document.createElement('div'); bar.className='bar';
    const t     = document.createElement('div'); t.className='t'; t.textContent='Ready'; cd.append(bar,t);
    const metaL = document.createElement('div'); metaL.className='meta';
    const left  = document.createElement('div'); left.className='muted';
    const btn   = document.createElement('button'); btn.className='btn';
    metaL.append(left, btn); right.append(title, cd, metaL);
    card.append(tile, right);

    // tap tile
    tile.addEventListener('click', ()=>{
      const ex = S.exercises[i]; if(!ex.unlocked) return;
      const now = performance.now();
      if(ex.lastTapAt>0 && now < ex.lastTapAt + ex.cooldown) return;
      const gain = perTapHP(baseHP(i,meta.base), ex.repHP);
      patch(st=>{ st.hp += gain; st.stats.manual++; st.stats.totalEarned += gain; st.exercises[i].lastTapAt = now; return st; });
    });

    // button (unlock or reps)
    btn.addEventListener('click', ()=>{
      const st = S; const ex = st.exercises[i];
      if(!ex.unlocked){
        const price = unlockCost(baseHP(i,meta.base), meta.base);
        if(st.hp < price) return;
        patch(s=>{ s.hp -= price; s.exercises[i].unlocked = true; return s; });
      }else{
        const b = baseHP(i,meta.base), rb=repBaseCost(b), g=repGrowth(ex.level), qty=st.qty;
        const price = Math.ceil(qty===1 ? repCost1(rb,g,ex.repHP) : repCostN(rb,g,ex.repHP,qty));
        if(st.hp < price) return;
        patch(s=>{
          s.hp -= price;
          s.exercises[i].repHP += qty;
          while(s.exercises[i].repHP >= s.exercises[i].repTarget){
            s.exercises[i].repHP    -= s.exercises[i].repTarget;
            s.exercises[i].repTarget*= 2;
            s.exercises[i].level    += 1;
            s.exercises[i].cooldown  = nextCd(s.exercises[i].cooldown);
          }
          return s;
        });
      }
    });

    cardsRoot.append(card);
    cardRefs.set(meta.id, { idx:i, card, tile, lvl, left, btn, bar, t, title, repband, repfill, reptext });
    updateCard(meta.id);
  }
  function buildCards(){ cardsRoot.innerHTML=''; cardRefs.clear(); for(let i=0;i<Exercises.length;i++) createCard(i); }

  // bulk selector
  bulk.addEventListener('click', e=>{
    const b = e.target.closest('button'); if(!b) return;
    $$('.bulk button').forEach(x=>x.classList.toggle('active', x===b));
    patch(s=>{ s.qty = parseInt(b.dataset.q,10)||1; return s; });
  });

  // tick loop (cooldowns + hired auto taps)
  function tick(){
    const now = performance.now();
    for(let i=0;i<Exercises.length;i++){
      const ex = S.exercises[i]; const r = cardRefs.get(Exercises[i].id); if(!r) continue;
      if(!ex.unlocked){ r.bar.style.width='0%'; r.t.textContent='—'; continue; }
      const last = ex.lastTapAt||0, cd = ex.cooldown||1;
      const ready = last===0 || now >= last+cd;
      if(ready){ r.bar.style.width='100%'; r.t.textContent='Ready'; }
      else{
        const dt = now-last; const pct = Math.max(0, Math.min(100, 100*dt/cd));
        r.bar.style.width = pct+'%';
        const remain = Math.max(0, (last+cd)-now);
        r.t.textContent = (remain/1000).toFixed(2)+'s';
      }
      // auto tap if coach hired
      const cId='c'+(i+1);
      if(S.coaches[cId] && ready){
        const gain = perTapHP(baseHP(i,Exercises[i].base), ex.repHP);
        patch(s=>{ s.hp += gain; s.stats.auto++; s.stats.totalEarned += gain; s.exercises[i].lastTapAt = now; return s; });
      }
    }
    requestAnimationFrame(tick);
  }

  // menu
  let activeTab='coaches';
  function openMenu(tab='coaches'){ activeTab=tab; renderMenu(); menu.classList.add('show'); }
  function closeMenu(){ menu.classList.remove('show'); }
  $('#avatar').addEventListener('click', ()=> openMenu('coaches'));
  $('#menu').addEventListener('click', e=>{
    const x = e.target.closest('[data-close]'); if(x) return closeMenu();
    const t = e.target.closest('.tab'); if(t){ $$('.tab', menu).forEach(b=>b.classList.toggle('active', b===t)); activeTab=t.dataset.tab; renderMenu(); }
  });

  function anyCoachAffordable(){
    for(let i=0;i<Exercises.length;i++){
      const ex=S.exercises[i]; if(!ex||!ex.unlocked) continue;
      const cId='c'+(i+1); if(S.coaches[cId]) continue;
      if(S.hp >= coachPrice(i)) return true;
    }
    return false;
  }

  function renderMenu(){
    avatarDot.style.display = anyCoachAffordable() ? 'block' : 'none';

    if(activeTab==='coaches'){
      const frag=document.createDocumentFragment();
      let any=false;
      for(let i=0;i<Exercises.length;i++){
        const ex=S.exercises[i]; if(!ex||!ex.unlocked) continue; any=true;
        const row=document.createElement('div'); row.className='coach-row';
        const ava=document.createElement('div'); ava.className='coach-ava'; ava.textContent=String(i+1);
        const mid=document.createElement('div');
        const title=document.createElement('div'); title.className='coach-title'; title.textContent='Coach '+(i+1);
        const sub=document.createElement('div'); sub.className='coach-sub'; sub.textContent='Works on: '+Exercises[i].name;
        mid.append(title, sub);
        const right=document.createElement('div');
        const cId='c'+(i+1); const hired=!!S.coaches[cId]; const price=coachPrice(i);
        if(hired){
          const tag=document.createElement('span'); tag.className='hired'; tag.textContent='Hired'; right.append(tag);
        }else{
          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Hire • '+fmt(price)+' HP';
          btn.classList.toggle('glow', S.hp>=price);
          btn.disabled = S.hp<price;
          btn.addEventListener('click', ()=>{
            if(S.hp<price) return;
            patch(s=>{ s.hp-=price; s.coaches[cId]=true; return s; });
            renderMenu();
          });
          right.append(btn);
        }
        row.append(ava,mid,right);
        frag.append(row);
      }
      menuBody.innerHTML = any ? '' : '<div class="muted">Unlock an exercise to hire its coach.</div>';
      menuBody.append(frag);
      return;
    }

    if(activeTab==='achievements'){
      const div=document.createElement('div');
      div.innerHTML = `
        <div class="coach-row">
          <div class="coach-ava">★</div>
          <div>
            <div class="coach-title">First Steps</div>
            <div class="coach-sub">Walking reaches Lvl 2</div>
          </div>
          <div><span class="pill">Coming soon</span></div>
        </div>`;
      menuBody.innerHTML=''; menuBody.append(div);
      return;
    }

    if(activeTab==='settings'){
      const s=S;
      const div=document.createElement('div');
      div.innerHTML = `
        <div class="coach-row">
          <div class="coach-ava">👤</div>
          <div>
            <div class="coach-title">Avatar</div>
            <div class="coach-sub">Tint cooldown bars by gender</div>
          </div>
          <div>
            <label><input type="radio" name="av" value="male" ${s.avatar==='male'?'checked':''}> Male</label>
            &nbsp;&nbsp;
            <label><input type="radio" name="av" value="female" ${s.avatar==='female'?'checked':''}> Female</label>
          </div>
        </div>
        <div class="coach-row">
          <div class="coach-ava">🧪</div>
          <div>
            <div class="coach-title">Reset Save</div>
            <div class="coach-sub">Start fresh (no confirmation dialog)</div>
          </div>
          <div><button class="btn" id="reset">Reset</button></div>
        </div>
      `;
      menuBody.innerHTML=''; menuBody.append(div);
      // wire
      div.querySelectorAll('input[name="av"]').forEach(r=>{
        r.addEventListener('change', e=>{
          const val = e.target.value==='female' ? 'female' : 'male';
          patch(st=>{ st.avatar = val; return st; });
          document.body.classList.toggle('female', val==='female');
        });
      });
      div.querySelector('#reset').addEventListener('click', ()=>{
        try{ localStorage.removeItem(KEY); }catch(_){}
        S = load(); document.body.classList.toggle('female', S.avatar==='female');
        buildCards(); renderMenu(); markDirty();
      });
      return;
    }
  }

  // --- render loop
  let dirty=true;
  function markDirty(){ dirty=true; }
  function flush(){
    if(dirty){
      dirty=false;
      hpEl.textContent = fmt(S.hp);
      fcEl.textContent = fmt(S.fc);
      document.body.classList.toggle('female', S.avatar==='female');
      for(const id of cardRefs.keys()) updateCard(id);
      avatarDot.style.display = anyCoachAffordable() ? 'block' : 'none';
    }
    requestAnimationFrame(flush);
  }

  // boot
  buildCards();
  requestAnimationFrame(flush);
  requestAnimationFrame(tick);

})();
</script>







  <style data-ff-patch>
  .ff-save-tools{margin-top:16px;padding:12px;border:1px solid #2a2e5e;border-radius:12px;background:#171a3a}
  .ff-save-tools .h{font-weight:900;margin-bottom:10px}
  .ff-save-tools .row{display:flex;gap:10px;flex-wrap:wrap}
  .ff-save-tools .btn{appearance:none;border:1px solid #2a2e5e;background:#1b1f44;color:#e9edff;
    padding:10px 14px;border-radius:10px;cursor:pointer}
</style>

<script type="application/ff-patch">
/* === Settings → General: Export / Import Save (plus Shift+E / Shift+I hotkeys) === */
(function(){
  try{
    const CANDIDATES = ['ff-core-v2','ff-v1']; // try new-first, then legacy
    const menu      = document.getElementById('menu');
    const menuBody  = document.getElementById('menu-body');

    function hasSave(){
      return CANDIDATES.some(k => localStorage.getItem(k) != null);
    }
    function readSave(){
      for(const k of CANDIDATES){
        const v = localStorage.getItem(k);
        if(v != null) return {key:k, json:v};
      }
      return null;
    }
    function writeSave(json){
      // If one of the keys exists already, use that; else first candidate.
      for(const k of CANDIDATES){
        if(localStorage.getItem(k) != null){
          localStorage.setItem(k, json);
          return k;
        }
      }
      localStorage.setItem(CANDIDATES[0], json);
      return CANDIDATES[0];
    }

    function exportSave(){
      const s = readSave();
      if(!s){ alert('No save found. Start a game first.'); return; }
      const blob = new Blob([s.json], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ff-save.json';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 0);
    }

    function importSave(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json,.json';
      input.onchange = () => {
        const f = input.files && input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try{
            JSON.parse(r.result);                  // sanity check
            writeSave(r.result);
            alert('Save imported. Reloading…');
            location.reload();
          }catch(e){
            alert('Invalid save file.');
          }
        };
        r.readAsText(f);
      };
      input.click();
    }

    // Keyboard fallback: Shift+E export, Shift+I import
    window.addEventListener('keydown', (e)=>{
      if(!e.shiftKey) return;
      if(e.key === 'E'){ e.preventDefault(); exportSave(); }
      if(e.key === 'I'){ e.preventDefault(); importSave(); }
    }, true);

    // Helper: are we on Settings → General?
    function settingsGeneralActive(){
      if(!menu || !menuBody) return false;
      const menuOpen = menu.classList.contains('show');
      if(!menuOpen) return false;
      const tab = menu.querySelector('.menu-tabs .tab.active');
      if(!tab) return false;
      const isSettingsTab = (tab.dataset.tab || '').toLowerCase() === 'settings' ||
                            /settings/i.test(tab.textContent||'');
      if(!isSettingsTab) return false;

      // Try to detect your “General” subtab when present; if no subtabs, assume General.
      const subActive = menuBody.querySelector('.subtabs .tab.active');
      if(!subActive) return true;
      const subIsGeneral = /general/i.test(subActive.textContent||'');
      return !!subIsGeneral;
    }

    // Inject the Export/Import UI into Settings → General
    function inject(){
      if(!settingsGeneralActive()) return;
      if(menuBody.querySelector('.ff-save-tools')) return; // already there

      const box = document.createElement('div');
      box.className = 'ff-save-tools';
      box.innerHTML = `
        <div class="h">Save transfer</div>
        <div class="row">
          <button class="btn" id="ff-save-export">Export save</button>
          <button class="btn" id="ff-save-import">Import save</button>
        </div>
        <div class="muted" style="margin-top:8px;font-size:13px">
          Tip: Shift+E to export, Shift+I to import.
        </div>
      `;

      // Append near the end of General settings body
      menuBody.appendChild(box);

      const bEx = box.querySelector('#ff-save-export');
      const bIm = box.querySelector('#ff-save-import');
      bEx.addEventListener('click', exportSave);
      bIm.addEventListener('click', importSave);

      // If no save yet, dim the export button
      if(!hasSave()){
        bEx.disabled = true;
        bEx.title = 'No save found yet';
        bEx.style.opacity = .6;
      }
    }

    // Re-inject on menu open / tab switches / settings refreshes
    const mo = new MutationObserver(()=> setTimeout(inject, 0));
    if(menu) mo.observe(menu, {attributes:true, attributeFilter:['class']});
    if(menuBody) mo.observe(menuBody, {childList:true, subtree:true});

    // Also try once on load (in case Settings is already open)
    setTimeout(inject, 0);
  }catch(e){
    console.warn('Save transfer (settings) patch error:', e);
  }
})();
</script>


</body>
</html>
