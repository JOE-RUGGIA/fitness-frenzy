<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy – V4.9c (Compat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
/* (styles unchanged from last version; trimmed for brevity) */
/* ---------------- THEME ---------------- */
:root{--bg:#0a1320;--card:#0f1b2b;--ink:#e9eef3;--muted:#a7b7cc;--border:#213149;--accent:#cc6b2c;--accent-hi:#ffb357;--rep:#22c55e;--warn:#39d98a;--space:clamp(10px,2.2vw,18px);--r:16px;--fs-2:clamp(18px,3.2vw,22px);--repband:16%;--panel:#13233b;--panel-border:#2b3d5a}
*{box-sizing:border-box}html,body{height:100%;overflow-x:hidden;touch-action:manipulation}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0}
.topbar{position:sticky;top:0;z-index:1000;background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.title{display:flex;align-items:center;gap:10px}.title .icon{font-size:clamp(22px,5vw,28px)}h1{margin:0;font-size:clamp(22px,5vw,28px)}
.hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04)}
.hpPill .label{font-weight:900;letter-spacing:.3px;color:var(--accent)}
.hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);width:11ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}
.spacer{flex:1}.seg{display:inline-flex;border:1px solid var(--panel-border);border-radius:10px;overflow:hidden}
.segBtn{background:var(--panel);color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}.segBtn.active{background:var(--accent);color:#fff}
.btn{position:relative;overflow:hidden;padding:12px 18px;border:none;border-radius:14px;font-weight:800;cursor:pointer;transform:translateZ(0)}
.btn.primary{background:var(--accent);color:#fff}.btn.secondary{background:#1a2a40;color:#d7e3f5}.btn.ghost{background:#13233b;color:#cfe0ff;border:1px solid var(--panel-border)}
#menuBtn{position:relative}.notifDot{position:absolute;right:-12px;top:-12px;width:16px;height:16px;border-radius:50%;display:none;background:var(--warn);box-shadow:0 0 0 2px rgba(10,19,32,.95);pointer-events:none;z-index:200}
.notifDot.show{display:block}
/* volume panel */
#volWrap{position:relative}#volBtn{min-width:44px}
.volPanel{position:absolute;right:0;top:calc(100% + 8px);background:#0f1b2b;border:1px solid var(--panel-border);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.4);padding:10px 12px;display:none;z-index:1200;width:220px}
.volPanel.open{display:block}.volRow{display:flex;align-items:center;gap:8px}#volSlider{flex:1}#volSlider::-webkit-slider-thumb{cursor:pointer}.volPct{min-width:3ch;text-align:right;font-weight:800}

/* cards (unchanged visuals) */
.wrap{max-width:980px;margin:0 auto;padding:var(--space)}.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:var(--space);display:flex;gap:14px;align-items:stretch;transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.90)}
.card.unlock-ready{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 14px 30px rgba(204,107,44,.28),0 0 24px rgba(204,107,44,.25)}
.card.unlock-bounce{animation:bob 1.1s ease-in-out infinite}@keyframes bob{0%{transform:translateY(0) scale(.90)}50%{transform:translateY(-2px) scale(.905)}100%{transform:translateY(0) scale(.90)}}
.tapPad{position:relative;width:clamp(72px,16vw,120px);aspect-ratio:1;border-radius:var(--r);background:#12243b;border:1px solid #1a2f4a;display:flex;align-items:center;justify-content:center;font-size:clamp(44px,12vw,72px);cursor:pointer;overflow:visible}
.lvl{position:absolute;left:6px;top:6px;font-size:12px;font-weight:900;color:#fff;background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;border-radius:8px;padding:2px 6px}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#15341f;border-top:1px solid #204e2b;border-bottom-left-radius:var(--r);border-bottom-right-radius:var(--r);overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}.repLabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cfead6}
.float{position:fixed;color:#ffe6c7;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.6);transform:translate(-50%,-10px);animation:rise .9s ease-out forwards;pointer-events:none;z-index:1000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}
.right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}.ex-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ex-title{font-size:var(--fs-2);margin:0}.muted{color:#a7b7cc}
.coachSlotTop{display:flex;align-items:center;gap:8px;margin-left:auto;flex-wrap:wrap}
.coolwrap{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolbar{height:16px;background:#101a2a;position:relative}
.coolfill{height:100%;width:0%;position:relative;background:linear-gradient(90deg,var(--accent) 0%, var(--accent-hi) 92%)}
.coolfill:after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,.16) 0 6px, transparent 6px 12px);mix-blend-mode:overlay;opacity:.65;animation:stripeMove 1.2s linear infinite}
@keyframes stripeMove{from{background-position:0 0}to{background-position:60px 0}}
.metaRow{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.kv{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:6px 10px;border-radius:10px;font-size:14px}
.costLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.costPill{display:inline-flex;align-items:center;gap:8px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#ffd6a8;background:#142743;border:1px solid #27456d;padding:8px 14px;border-radius:999px;cursor:not-allowed}
.costPill.ready{color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-hi));border-color:#e89d6b;box-shadow:0 12px 26px rgba(204,107,44,.35)}
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);color:#fff;border-top:1px solid #2a4a78;padding:12px 16px calc(12px + env(safe-area-inset-bottom));opacity:0;z-index:3000;display:flex;gap:8px;align-items:center;justify-content:center;text-align:center;animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.6s}
@keyframes bannerIn{to{opacity:1; transform:translateY(0)}}
@keyframes bannerOut{to{opacity:0; transform:translateY(8px)}}

/* menu + start + tutorial + splash (unchanged visuals) */
.menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:5000;display:none;align-items:flex-end;justify-content:center}
.menuOverlay.open{display:flex}
.menuPanel{width:min(980px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden}
.menuHeader{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.menuTitle{font-weight:900;font-size:20px}.menuTabs{display:flex;gap:8px;padding:8px var(--space);border-bottom:1px solid var(--border);flex-wrap:wrap}
.menuTab{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.menuTab.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.menuBody{padding:14px var(--space);overflow:auto}
.coachIntro{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:14px}
.coachList{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:700px){.coachList{grid-template-columns:1fr 1fr}}
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.headshot{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:40px;border-radius:12px;background:#12243b;border:1px solid #1a2f4a}
.coachMid{flex:1;min-width:0}.coachName{font-weight:900}.coachInfo{color:#a7b7cc;font-size:14px;margin-top:2px}
.coachRight{display:flex;align-items:center}.hireBtn{padding:12px 18px;font-size:16px;border-radius:12px}.hireBtn.secondary{background:#1a2a40;color:#d7e3f5}.hireBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
.offOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:7000;display:none;align-items:center;justify-content:center}
.offOverlay.open{display:flex}
.offCard{width:min(520px,94vw);background:#0f1b2b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
.offTitle{font-weight:900;font-size:20px;margin:0 0 6px}.offSub{color:#cfe0ff;margin:0 0 12px}.offGain{font-size:26px;font-weight:900;color:#fff;margin:12px 0}.offNote{color:#a7b7cc;font-size:13px;margin-top:8px}
.tutOv{position:fixed;inset:0;z-index:8000;display:none;pointer-events:none}.tutOv.show{display:block}.tutOv.modal{pointer-events:auto}
.tutDim{position:absolute;inset:0;background:rgba(0,0,0,.22);pointer-events:none}.tutOv.modal .tutDim{pointer-events:auto}
.tutBubble{position:absolute;left:50%;bottom:12vh;transform:translateX(-50%);max-width:min(980px,96vw);background:#0f1b2b;border:2px solid #2a4a78;border-radius:18px;padding:22px 24px;color:#fff;display:flex;gap:16px;align-items:flex-start;pointer-events:auto;box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tutAvatar{font-size:72px;line-height:1}.tutText{flex:1;font-size:clamp(18px,3.8vw,24px);line-height:1.35}.tutWho{font-weight:900;color:#ffd6a8;margin-bottom:4px;font-size:clamp(16px,3.4vw,20px)}
.tutMore{font-size:12px;color:#a7b7cc;margin-top:6px}.tutChevron{margin-left:8px;font-size:14px;color:#ffb357}.hl{color:var(--accent);font-weight:900}
.tutSpot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 42px rgba(255,179,87,.45);animation:spotPulse 1.2s ease-in-out infinite;pointer-events:none}
@keyframes spotPulse{0%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 16px rgba(255,179,87,.35)}50%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 18px rgba(255,179,87,.28),0 0 32px rgba(255,179,87,.55)}100%{box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 16px rgba(255,179,87,.35)}}
.tutPop{animation:tutPop .32s cubic-bezier(.2,1.2,.3,1)}@keyframes tutPop{0%{transform:translateX(-50%) scale(.92);opacity:.0}70%{transform:translateX(-50%) scale(1.04);opacity:1}100%{transform:translateX(-50%) scale(1)}}
.tutIdle{animation:tutIdle 2.6s ease-in-out infinite}@keyframes tutIdle{0%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-3px)}100%{transform:translateX(-50%) translateY(0)}}
.startOv{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;pointer-events:auto}.startOv.open{display:flex}
.startPlate{position:absolute;inset:0;background:url('https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png') center/cover no-repeat;filter:blur(14px) brightness(.75);opacity:.9}
.startBackdrop{position:absolute;inset:0;background:radial-gradient(ellipse at center, rgba(0,0,0,.25), rgba(0,0,0,.55) 70%)}
.startFrame{position:relative;z-index:1;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(10,19,32,.50);backdrop-filter: blur(6px);box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startImgWrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
.startImgWrap img{width:100%;height:100%;object-fit:contain;pointer-events:none}
.coverBounce{animation:coverIn .65s cubic-bezier(.2,1.2,.3,1)}@keyframes coverIn{0%{transform:scale(.92) translateY(8px);opacity:.0}60%{transform:scale(1.04) translateY(-2px);opacity:1}100%{transform:scale(1) translateY(0)}}
.startUI{position:absolute;left:50%;bottom:5.5vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:12px;width:min(92%,680px)}
.startBtns{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;width:100%}.btn.lg{font-size:clamp(18px,4.5vw,22px);padding:14px 24px;border-radius:16px;width:100%}
.startAvatar{display:flex;gap:10px;align-items:center;justify-content:center}.startAvatar .seg{box-shadow:0 6px 18px rgba(0,0,0,.25)}.startAvatar .segBtn{font-size:24px;padding:10px 14px}
.popIn{animation:popIn .45s cubic-bezier(.2,1.2,.3,1)}@keyframes popIn{0%{transform:translate(-50%,10px) scale(.92);opacity:0}70%{transform:translate(-50%,-2px) scale(1.04);opacity:1}100%{transform:translate(-50%,0) scale(1)}
.btnBounce:hover{animation:btnHover .7s ease-out}@keyframes btnHover{0%{transform:translateY(0)}50%{transform:translateY(-3px)}100%{transform:translateY(0)}
}
.splash{position:fixed;inset:0;background:#000;z-index:10000;display:flex;align-items:center;justify-content:center}
.splash.hidden{display:none}
.splashInner{position:relative;width:min(75vw,520px);aspect-ratio:1.5/1;display:flex;align-items:center;justify-content:center}
.splashImg{width:100%;height:100%;object-fit:contain;opacity:0;transform:scale(.92);filter:drop-shadow(0 12px 32px rgba(0,0,0,.6))}
.splashImg.show{animation:logoIn .6s cubic-bezier(.2,1.2,.3,1) forwards}
@keyframes logoIn{to{opacity:1;transform:scale(1)}}
.splashSpark{position:absolute;font-size:28px;opacity:0;animation:spark .9s ease-out forwards}
@keyframes spark{0%{opacity:0;transform:translateY(6px) scale(.8)}40%{opacity:1}100%{opacity:0;transform:translateY(-18px) scale(1)}}
</style>
</head>
<body>
  <!-- top bar -->
  <div class="topbar">
    <div class="topwrap">
      <div class="title"><span class="icon">💪</span><h1>Fitness Frenzy</h1></div>
      <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0.00</span></div>
      <div class="spacer"></div>

      <div id="volWrap">
        <button id="volBtn" class="btn ghost" title="Volume">🔊</button>
        <div id="volPanel" class="volPanel">
          <div class="volRow"><span style="opacity:.9">Music</span><div class="spacer"></div><span id="volPct" class="volPct">20%</span></div>
          <div class="volRow" style="margin-top:6px"><input id="volSlider" type="range" min="0" max="100" value="20" /></div>
        </div>
      </div>

      <button id="menuBtn" class="btn ghost">Menu<span id="menuDot" class="notifDot"></span></button>
      <div class="seg" id="qtyTop"><button class="segBtn active" data-q="1">×1</button><button class="segBtn" data-q="10">×10</button></div>
      <button id="saveBtn" class="btn secondary">Save</button>
      <button id="resetBtn" class="btn secondary">Reset</button>
    </div>
  </div>

  <!-- music -->
  <audio id="introMusic" preload="auto" loop playsinline></audio>
  <audio id="gameMusic"  preload="auto" loop playsinline></audio>

  <!-- start screen -->
  <div id="startOv" class="startOv" aria-hidden="true">
    <div class="startPlate"></div><div class="startBackdrop"></div>
    <div class="startFrame">
      <div class="startImgWrap"><img id="startCoverImg" alt="Fitness Frenzy Cover" src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png"></div>
      <div id="startUI" class="startUI popIn">
        <div class="startBtns">
          <button id="btnStart" class="btn primary lg btnBounce">Start</button>
          <button id="btnContinue" class="btn secondary lg btnBounce">Continue</button>
        </div>
        <div class="startAvatar">
          <div class="seg" id="segAvatar" aria-label="Choose avatar">
            <button class="segBtn" data-avatar="male" title="Male"><span class="sym">♂</span></button>
            <button class="segBtn" data-avatar="female" title="Female"><span class="sym">♀</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- splash -->
  <div id="splash" class="splash">
    <div class="splashInner">
      <img id="splashImg" class="splashImg" alt="GameBros" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
      <div id="sparkHost"></div>
    </div>
  </div>

  <!-- game -->
  <div class="wrap"><div id="stack" class="stack"></div></div>
  <div id="bannerHost"></div>

  <!-- offline -->
  <div id="offOv" class="offOverlay" aria-hidden="true">
    <div class="offCard" role="dialog" aria-modal="true">
      <h3 class="offTitle">Welcome back! 👋</h3>
      <p class="offSub">Your coaches trained while you were away (<span id="offDur">0s</span>).</p>
      <div class="offGain">+<span id="offAmt">0.00</span> HP</div>
      <button id="offClaim" class="btn primary">Claim</button>
      <div id="offCapNote" class="offNote" style="display:none">Note: Offline gains capped for long absences.</div>
    </div>
  </div>

  <!-- menu -->
  <div id="menuOverlay" class="menuOverlay" aria-hidden="true">
    <div class="menuPanel" role="dialog" aria-modal="true">
      <div class="menuHeader">
        <div class="menuTitle">Menu</div><div class="spacer"></div>
        <div class="hpPill small"><span class="label">HP:</span><span id="hpMenu" class="val">0.00</span></div>
        <button id="menuClose" class="btn secondary">Close</button>
      </div>
      <div class="menuTabs">
        <button class="menuTab active" data-tab="coaches">Coaches</button>
        <button class="menuTab" data-tab="upgrades">Upgrades</button>
        <button class="menuTab" data-tab="achievements">Achievements</button>
        <button class="menuTab" data-tab="quests">Side Quests</button>
        <button class="menuTab" data-tab="shop">Shop</button>
        <button class="menuTab" data-tab="stats">Stats</button>
        <button class="menuTab" data-tab="settings">Settings</button>
      </div>
      <div class="menuBody">
        <div id="tab-coaches"></div>
        <div id="tab-upgrades" style="display:none"><p>Upgrades coming soon.</p></div>
        <div id="tab-achievements" style="display:none"></div>
        <div id="tab-quests" style="display:none"><p>Side Quests coming later.</p></div>
        <div id="tab-shop" style="display:none"><p>Shop coming soon.</p></div>
        <div id="tab-stats" style="display:none"></div>
        <div id="tab-settings" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- tutorial -->
  <div id="tutOv" class="tutOv" aria-hidden="true">
    <div class="tutDim"></div>
    <div id="tutSpot" class="tutSpot" style="display:none"></div>
    <div id="tutBubble" class="tutBubble" role="dialog" aria-live="polite" aria-modal="true">
      <div id="tutAvatar" class="tutAvatar">🏋️‍♂️</div>
      <div class="tutText">
        <div id="tutWho" class="tutWho">JAX</div>
        <div id="tutLine">…</div>
        <div class="tutMore"><span>Tap to continue</span> <span class="tutChevron">▾</span></div>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers (no modern syntax) ---------- */
function coalesce(v, d){ return (v===undefined || v===null) ? d : v; }
function byId(id){ return document.getElementById(id); }

/* ---------- bus ---------- */
var App = {};
App.Flags={tutorial:true,coaches:true,achievements:true,shop:false,settings:true,debug:/[?&]debug=1/.test(location.search)};
App.Config={SAVE_KEY:'ff-v400-foundation',SCHEMA_VERSION:5,DEC:2,EPS:1e-6,SOLID_CD_MS:300,REP_GROWTH:1.12,SAVE_MS:20000,UI_REFRESH_MS:100,NOTIFY_REFRESH_MS:200,OFFLINE_MAX_MS:43200000};
App.Bus=(function(){var m={};return{on:function(ev,fn){(m[ev]||(m[ev]=[])).push(fn);return fn;},off:function(ev,fn){var a=m[ev];if(!a)return;var i=a.indexOf(fn);if(i>=0)a.splice(i,1);},emit:function(ev,p){var a=m[ev]||[];for(var i=0;i<a.length;i++){try{a[i](p);}catch(e){console.warn(e);}}}}})();

/* ---------- settings ---------- */
App.Settings=(function(){var KEY=App.Config.SAVE_KEY+':prefs',d={sfx:true,floats:true,musicVol:0.20},p={};try{var raw=localStorage.getItem(KEY);p=raw?Object.assign({},d,JSON.parse(raw)):d;}catch(e){p=d;}function save(){try{localStorage.setItem(KEY,JSON.stringify(p));}catch(e){}}
return{get:function(k){return p[k];},set:function(k,v){p[k]=v;save();App.Bus.emit('settings:change',{key:k,val:v});},all:function(){return Object.assign({},p);}}})();

/* ---------- util ---------- */
App.Util=(function(){function fmtTop(n){var a=Math.abs(n);var d=App.Config.DEC;if(a>=1e9)return (n/1e9).toFixed(d)+'B'; if(a>=1e6)return (n/1e6).toFixed(d)+'M'; if(a>=1e3)return (n/1e3).toFixed(d)+'K'; return n.toFixed(d);}
function fmtCost(n){var d=App.Config.DEC;return n<1e3? n.toFixed(d):(n<1e6?(n/1e3).toFixed(d)+'K':(n<1e9?(n/1e6).toFixed(d)+'M':(n/1e9).toFixed(d)+'B'));} return{fmtTop:fmtTop,fmtCost:fmtCost};})();

/* ---------- audio (compat) ---------- */
App.Audio=(function(){
  var audioCtx=null, needsUnlock=true;
  function ensure(){ if(!audioCtx||audioCtx.state==='closed'){ try{audioCtx=new (window.AudioContext||window.webkitAudioContext)();}catch(e){} } if(audioCtx&&audioCtx.state!=='running'){ audioCtx.resume().catch(function(){});} }
  function unlock(){ ensure(); if(!audioCtx) return; try{ var b=audioCtx.createBuffer(1,1,22050); var s=audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0);}catch(e){} if(audioCtx.state!=='running'){ audioCtx.resume().catch(function(){});} needsUnlock=false; }
  function env(attack,decay,peak){ var t=audioCtx.currentTime, g=audioCtx.createGain(); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(peak||.08,t+attack); g.gain.exponentialRampToValueAtTime(.0001,t+attack+decay); return g; }
  function osc(type,f){ var o=audioCtx.createOscillator(); o.type=type;o.frequency.value=f; return o; }
  function tone(f,dur,gain,type){ try{ ensure(); if(!audioCtx) return; var t=audioCtx.currentTime; var o=osc(type||'sine',f); var g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(gain||.07,t); g.gain.exponentialRampToValueAtTime(.0001,t+(dur||.18)); o.start(); o.stop(t+(dur||.18)); }catch(e){} }
  function chime(){ try{ ensure(); if(!audioCtx) return; var root=880; var partials=[0,3,7,10,14]; var delay=0; for(var i=0;i<partials.length;i++){ var p=partials[i]; var o=osc('triangle', root*Math.pow(2,p/12)); var g=env(.02,.8,.06); o.connect(g); g.connect(audioCtx.destination); var t=audioCtx.currentTime+delay; o.start(t); o.stop(t+1.2); delay+=(i===0?0:0.06+Math.random()*0.04);} }catch(e){} }
  function tick(){ tone(1200,.035,.04,'square'); }
  function sfx(type){ if(!App.Settings.get('sfx')) return; if(!audioCtx||audioCtx.state!=='running'){ needsUnlock=true; return; }
    if(type==='tap') tone(660,.12,.06,'sine'); if(type==='buy') tone(440,.18,.08,'sine'); if(type==='popup'){ tone(520,.10,.06,'triangle'); setTimeout(function(){tone(780,.08,.05,'triangle');},90);} if(type==='reveal'){ tone(420,.12,.06,'sine'); setTimeout(function(){tone(640,.12,.06,'sine');},110); setTimeout(function(){tone(900,.16,.05,'sine');},220);} if(type==='chime') chime(); if(type==='achv'){ tone(600,.10,.07,'square'); setTimeout(function(){tone(800,.10,.06,'square');},110); setTimeout(function(){tone(1000,.12,.06,'square');},220);} if(type==='tick') tick(); }
  ['visibilitychange','pagehide','freeze'].forEach(function(){ if(document.visibilityState!=='visible') needsUnlock=true; });
  ['pointerdown','touchstart','mousedown','click','keydown'].forEach(function(ev){ window.addEventListener(ev,function(){ if(needsUnlock || (audioCtx&&audioCtx.state!=='running')) unlock(); },{capture:true,passive:true}); });

  var elIntro=byId('introMusic'), elGame=byId('gameMusic');
  elIntro.src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-IntroMusic.mp3?raw=true";
  elGame.src ="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/Velvet%20Haze%20-%20Take%20a%20Seat%20-%20Instrumental%20version.mp3?raw=true";

  var baseVol = (function(){ var mv=App.Settings.get('musicVol'); return (mv!=null)?mv:0.20; })();
  var tutFactor=1;
  function _targetVol(){ var v=baseVol*tutFactor; if(v<0)v=0; if(v>1)v=1; return v; }
  function safePlay(el){ try{ var p=el.play(); if(p && p.catch) p.catch(function(){}); }catch(e){} }
  function fadeTo(el,toVol,ms){ var start=el.volume, t0=performance.now(); function step(){ var t=(performance.now()-t0)/ms; var v=(t>=1)?toVol:(start+(toVol-start)*t); if(v<0)v=0; if(v>1)v=1; el.volume=v; if(t<1) requestAnimationFrame(step);} requestAnimationFrame(step);}
  function tryAutoplayIntro(){ elIntro.muted=true; elIntro.loop=true; safePlay(elIntro); setTimeout(function(){ elIntro.muted=false; fadeTo(elIntro,0.5,300); },200); }

  var music = {
    playIntro:function(vol){ elIntro.volume=0; elIntro.loop=true; tryAutoplayIntro(); fadeTo(elIntro, coalesce(vol,0.5), 400); },
    stopIntro:function(ms){ var d=coalesce(ms,400); fadeTo(elIntro,0,d); setTimeout(function(){ try{elIntro.pause(); elIntro.currentTime=0;}catch(e){} }, d+40); },
    playGame:function(){ elGame.loop=true; elGame.volume=_targetVol(); safePlay(elGame); },
    setBaseVolume:function(v){ baseVol=Math.max(0,Math.min(1,v)); App.Settings.set('musicVol',baseVol); fadeTo(elGame,_targetVol(),80); },
    setTutorialMode:function(on){ tutFactor=on?0.4:1; fadeTo(elGame,_targetVol(),120); }
  };
  return { sfx:sfx, unlock:unlock, music:music };
})();

/* ---------- state / content ---------- */
App.State=(function(){
  var KEY=App.Config.SAVE_KEY;
  var s={schemaVersion:App.Config.SCHEMA_VERSION,hp:0,buyQty:1,exercises:[],coachesOwned:{},stats:{manualTaps:0,autoTaps:0,totalEarned:0},tutorial:{done:false,stepId:null,avatar:'male',progress:{walkTaps:0},shown:{unlock:{},coach:{},upgrade:{}}},achievements:{}};
  function setExercises(list){ s.exercises=list.map(function(e){return {id:e.id,name:e.name,icon:e.icon,baseHP:e.baseHP,baseCooldown:e.baseCooldown,repBaseCost:e.repBaseCost,unlockCost:e.unlockCost,unlocked:!!e.unlocked,repHP:0,repProgress:0,repTarget:10,level:1,cooldown:e.baseCooldown,lastTapAt:0,_autoElapsed:0,els:{}};}); }
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify({schemaVersion:s.schemaVersion,hp:s.hp,buyQty:s.buyQty,coachesOwned:s.coachesOwned,stats:s.stats,tutorial:s.tutorial,achievements:s.achievements,exercises:s.exercises.map(function(e){return{id:e.id,repHP:e.repHP,repProgress:e.repProgress,repTarget:e.repTarget,unlocked:e.unlocked,cooldown:e.cooldown,level:e.level,lastTapAt:e.lastTapAt};})})); }catch(e){} }
  function migrateIfNeeded(obj){ var v=obj.schemaVersion||1; while(v<App.Config.SCHEMA_VERSION){ if(App.Migrations[v]){ obj=App.Migrations[v](obj)||obj; v=(obj.schemaVersion||v+1);} else { v++; obj.schemaVersion=v; } } return obj; }
  function load(){ var raw=localStorage.getItem(KEY); if(!raw) return; try{ var j=JSON.parse(raw); j=migrateIfNeeded(j); s.schemaVersion=j.schemaVersion||App.Config.SCHEMA_VERSION; s.hp=coalesce(j.hp,0); s.buyQty=coalesce(j.buyQty,1); s.coachesOwned=j.coachesOwned||{}; s.stats=j.stats||s.stats; s.tutorial=j.tutorial||s.tutorial; if(!s.tutorial.shown) s.tutorial.shown={unlock:{},coach:{},upgrade:{}}; s.achievements=j.achievements||{}; s.__loaded=j.exercises||[]; }catch(e){} }
  function merge(){ if(!s.__loaded) return; for(var i=0;i<s.__loaded.length;i++){ var se=s.__loaded[i]; var e=s.exercises.find(function(x){return x.id===se.id;}); if(!e) continue; e.repHP=coalesce(se.repHP,0); e.repProgress=coalesce(se.repProgress,0); e.repTarget=coalesce(se.repTarget,10); e.unlocked=coalesce(se.unlocked,e.unlocked); e.cooldown=coalesce(se.cooldown,e.baseCooldown); e.level=coalesce(se.level,1); e.lastTapAt=coalesce(se.lastTapAt,0); if(!e.unlocked) e.lastTapAt=-1; } delete s.__loaded; }
  return { s:s, setExercises:setExercises, save:save, load:load, merge:merge };
})();
App.Migrations={1:function(o){o.stats=o.stats||{manualTaps:0,autoTaps:0};o.schemaVersion=2;return o;},2:function(o){o.tutorial=o.tutorial||{done:false,stepId:null,avatar:'male',progress:{}};o.tutorial.progress={walkTaps:0,unlockJogDone:false,coachC1Done:false};o.schemaVersion=3;return o;},3:function(o){o.stats=o.stats||{};o.stats.totalEarned=o.stats.totalEarned||0;o.achievements=o.achievements||{};o.schemaVersion=4;return o;},4:function(o){o.tutorial=o.tutorial||{};o.tutorial.shown=o.tutorial.shown||{unlock:{},coach:{},upgrade:{}};o.schemaVersion=5;return o;}};
App.Content=(function(){return{exercises:[
{id:'walk',name:'Walking',icon:'🚶',baseHP:1,baseCooldown:600,repBaseCost:4,unlockCost:0,unlocked:true},
{id:'jog',name:'Jogging',icon:'🏃',baseHP:60,baseCooldown:3000,repBaseCost:30,unlockCost:60,unlocked:false},
{id:'sit',name:'Sit-ups',icon:'🧘',baseHP:180,baseCooldown:6000,repBaseCost:90,unlockCost:300,unlocked:false},
{id:'push',name:'Push-ups',icon:'💪',baseHP:400,baseCooldown:12000,repBaseCost:200,unlockCost:1200,unlocked:false},
{id:'jacks',name:'Jumping Jacks',icon:'🤸',baseHP:900,baseCooldown:24000,repBaseCost:450,unlockCost:1800,unlocked:false},
{id:'squat',name:'Bodyweight Squats',icon:'🦵',baseHP:1800,baseCooldown:48000,repBaseCost:900,unlockCost:3600,unlocked:false},
{id:'lunge',name:'Lunges',icon:'🦵',baseHP:3200,baseCooldown:96000,repBaseCost:1600,unlockCost:6400,unlocked:false},
{id:'plank',name:'Plank',icon:'🧘‍♂️',baseHP:5000,baseCooldown:192000,repBaseCost:2500,unlockCost:10000,unlocked:false},
{id:'climb',name:'Mountain Climbers',icon:'🧗',baseHP:8000,baseCooldown:384000,repBaseCost:4000,unlockCost:16000,unlocked:false},
{id:'burpee',name:'Burpees',icon:'🤾',baseHP:12000,baseCooldown:768000,repBaseCost:6000,unlockCost:24000,unlocked:false},
{id:'pullup',name:'Pull-ups',icon:'🧗‍♂️',baseHP:18000,baseCooldown:1536000,repBaseCost:9000,unlockCost:36000,unlocked:false},
{id:'kb',name:'Kettlebell Swings',icon:'🏋️',baseHP:26000,baseCooldown:3072000,repBaseCost:13000,unlockCost:52000,unlocked:false},
{id:'bench',name:'Bench Press',icon:'🏋️‍♂️',baseHP:36000,baseCooldown:6144000,repBaseCost:18000,unlockCost:72000,unlocked:false},
{id:'backsq',name:'Back Squat',icon:'🏋️‍♀️',baseHP:48000,baseCooldown:12288000,repBaseCost:24000,unlockCost:96000,unlocked:false},
{id:'dead',name:'Deadlift',icon:'🏋️‍♂️',baseHP:65000,baseCooldown:24576000,repBaseCost:32500,unlockCost:130000,unlocked:false},
{id:'clean',name:'Clean & Jerk',icon:'🏋️‍♂️',baseHP:85000,baseCooldown:49152000,repBaseCost:42500,unlockCost:170000,unlocked:false},
{id:'snatch',name:'Snatch',icon:'🏋️‍♀️',baseHP:110000,baseCooldown:98304000,repBaseCost:55000,unlockCost:220000,unlocked:false},
{id:'halfmar',name:'Half Marathon',icon:'🎽',baseHP:150000,baseCooldown:196608000,repBaseCost:75000,unlockCost:300000,unlocked:false},
{id:'marathon',name:'Marathon',icon:'🏁',baseHP:200000,baseCooldown:393216000,repBaseCost:100000,unlockCost:400000,unlocked:false},
{id:'ironcross',name:'Iron Cross',icon:'🤸‍♂️',baseHP:260000,baseCooldown:786432000,repBaseCost:130000,unlockCost:520000,unlocked:false}
]};})();

/* ---------- game ---------- */
App.Game=(function(){var S=App.State.s, EPS=App.Config.EPS, RG=App.Config.REP_GROWTH;
  function perTap(e){return e.baseHP+e.repHP;}
  function bulkRepCost(e,q){ var base=e.repBaseCost*Math.pow(RG,e.repHP); var d=App.Config.DEC; var sum= base*(Math.pow(RG,q)-1)/(RG-1); return +sum.toFixed(d); }
  function addHP(d){ S.hp+=d; if(d>0){ S.stats.totalEarned=(S.stats.totalEarned||0)+d; } App.Bus.emit('hp:change',S.hp); }
  function addReps(e,q){ var cost=bulkRepCost(e,q); if(S.hp+EPS<cost) return false; addHP(-cost); e.repHP+=q; e.repProgress+=q; App.Bus.emit('reps:buy',{exId:e.id,qty:q});
    while(e.repProgress>=e.repTarget){ e.repProgress-=e.repTarget; e.repTarget*=2; e.cooldown=Math.max(100,Math.floor(e.cooldown/2)); e.level+=1; App.Bus.emit('exercise:levelup',{exId:e.id,level:e.level}); App.UI.Banners.upgrade(e.name+' upgraded to Lvl '+e.level+'! Speed ×2'); }
    return true; }
  function tap(e,now){ now=now||performance.now(); if(!e.unlocked) return 0; var cd=e.cooldown; if(e.lastTapAt>0 && now-e.lastTapAt<cd-1) return 0; e.lastTapAt=now; var g=perTap(e); addHP(g); S.stats.manualTaps++; App.Bus.emit('tap:manual',{exId:e.id,gain:g}); return g; }
  return { perTap:perTap, bulkRepCost:bulkRepCost, addReps:addReps, tap:tap, addHP:addHP };
})();

/* ---------- engine ---------- */
App.Engine=(function(){var C=App.Config, last=performance.now();
  function start(){ function tick(){ var now=performance.now(), dt=Math.min(0.25,(now-last)/1000); last=now; autoTap(now,dt); App.UI.Renderer.tickTop(dt);
      var ex=App.State.s.exercises; for(var i=0;i<ex.length;i++) updateCooldown(ex[i]); if(!tick._u || now-tick._u>C.UI_REFRESH_MS){ App.UI.Renderer.refreshAll(); App.Tutorial.repositionSpot(); tick._u=now; }
      if(!tick._n || now-tick._n>C.NOTIFY_REFRESH_MS){ App.Notify.update(); tick._n=now; } requestAnimationFrame(tick);} requestAnimationFrame(tick); }
  function autoTap(now,dt){ var s=App.State.s; for(var i=0;i<s.exercises.length;i++){ var e=s.exercises[i]; if(!App.Coaches.isAuto(e.id)) continue; e._autoElapsed+=dt*1000; var cd=Math.max(100,e.cooldown); while(e._autoElapsed>=cd){ e._autoElapsed-=cd; e.lastTapAt=now; var g=App.Game.perTap(e); App.Game.addHP(g); s.stats.autoTaps++; if(App.Settings.get('floats') && !App.UI.Overlay.suppressFloats && e.els.tapPad){ App.UI.Overlay.floatFrom(e.els.tapPad,'+'+g.toFixed(App.Config.DEC)); } } } }
  function updateCooldown(e){ if(!e.unlocked) return; var cd=Math.max(100,e.cooldown);
    if(cd<=C.SOLID_CD_MS){ if(e.els.coolFill) e.els.coolFill.style.width='100%'; if(e.els.headRight) e.els.headRight.textContent=(cd/1000).toFixed(C.DEC)+'s'; return; }
    var ready=(e.lastTapAt<=0); var since=ready?cd:(performance.now()-e.lastTapAt); var pct=Math.max(0,Math.min(1,since/cd)); if(e.els.coolFill) e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';
    var elapsed=Math.max(0,Math.min(since,cd)); if(e.els.headRight) e.els.headRight.textContent=(elapsed/1000).toFixed(C.DEC)+'s'; }
  function scheduleSave(){ setInterval(function(){App.State.save();}, C.SAVE_MS); }
  function bindPress(el,fn){ el.addEventListener('pointerdown',function(e){e.preventDefault();fn(e);},{passive:false}); el.addEventListener('keydown',function(e){if(e.key===' '||e.key==='Enter'){e.preventDefault();fn(e);}});}
  return { start:start, scheduleSave:scheduleSave, bindPress:bindPress, updateCooldown:updateCooldown };
})();

/* ---------- UI helpers (unchanged from last, compat-safe) ---------- */
App.UI={};
App.UI.Banners=(function(){ function upgrade(text){ var host=byId('bannerHost'); var el=document.createElement('div'); el.className='banner'; el.innerHTML='🎉 <strong>'+text+'</strong>'; host.appendChild(el); setTimeout(function(){el.remove();},3600);} return{upgrade:upgrade};})();
App.UI.Overlay=(function(){ var sup=false; function floatFrom(fromEl,text){ if(!App.Settings.get('floats')) return; var r=fromEl.getBoundingClientRect(); var span=document.createElement('div'); span.className='float'; span.textContent=text; span.style.left=(r.left+r.width/2)+'px'; span.style.top=(r.top+r.height*0.1)+'px'; document.body.appendChild(span); setTimeout(function(){span.remove();},950);}
  return { floatFrom:floatFrom, get suppressFloats(){return sup;}, set suppressFloats(v){sup=!!v;} };})();
App.UI.Effects=(function(){ var colors=['#ffb357','#ffd166','#7bd88f','#6bd3ff','#d4bfff','#ff8fab']; function confetti(x,y,count){count=count||28; var host=document.createElement('div'); host.style.position='fixed'; host.style.left='0'; host.style.top='0'; host.style.pointerEvents='none'; host.style.zIndex='4000'; document.body.appendChild(host); var ww=window.innerWidth, wh=window.innerHeight;
  for(var i=0;i<count;i++){ var d=document.createElement('div'); var size=6+Math.random()*6; d.style.position='absolute'; d.style.left=(x+(Math.random()*120-60))+'px'; d.style.top=(y+(Math.random()*40-20))+'px'; d.style.width=size+'px'; d.style.height=size+'px'; d.style.background=colors[i%colors.length]; d.style.transform='rotate('+Math.random()*360+'deg)'; d.style.borderRadius=(Math.random()<.4?'50%':'2px'); d.style.opacity='0.95';
    var dx=(Math.random()*2-1)*(ww*0.12); var dy=(wh*0.25+Math.random()*wh*0.15);
    d.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:'translate('+dx+'px,'+dy+'px) rotate('+(180+Math.random()*180)+'deg)',opacity:0}],{duration:1200+Math.random()*600,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}); host.appendChild(d);}
  setTimeout(function(){host.remove();},2000);} function confettiAtEl(el){ var r=el.getBoundingClientRect(); confetti(r.left+r.width/2,r.top+r.height/2); }
  return { confetti:confetti, confettiAtEl:confettiAtEl };})();

/* ---------- coaches / achievements / notify (same logic) ---------- */
App.Coaches=(function(){ var list=[{id:'c1',name:'Rookie Coach',icon:'🧑‍🏫',price:1500,target:'walk'},{id:'c2',name:'Track Buddy',icon:'👟',price:6000,target:'jog'},{id:'c3',name:'Core Captain',icon:'🧘‍♂️',price:25000,target:'sit'},{id:'c4',name:'Push-up Pro',icon:'💪',price:100000,target:'push'},{id:'c5',name:'Cardio Coach',icon:'🤸',price:400000,target:'jacks'},{id:'c6',name:'Squat Sensei',icon:'🦵',price:1500000,target:'squat'},{id:'c7',name:'Kettlebell Guru',icon:'🏋️',price:6000000,target:'kb'},{id:'c8',name:'Bench Boss',icon:'🏋️‍♂️',price:20000000,target:'bench'},{id:'c9',name:'Marathon Mentor',icon:'🎽',price:80000000,target:'marathon'},{id:'c10',name:'Ring Master',icon:'🤸‍♂️',price:300000000,target:'ironcross'}];
  function isAuto(exId){ var owned=App.State.s.coachesOwned; for(var i=0;i<list.length;i++){ var c=list[i]; if(owned[c.id] && c.target===exId) return true; } return false; }
  function getOwnedForExercise(exId){ var owned=App.State.s.coachesOwned, arr=[]; for(var i=0;i<list.length;i++){ var c=list[i]; if(owned[c.id] && c.target===exId) arr.push(c);} return arr; }
  function renderList(){ var host=byId('tab-coaches'); host.innerHTML='<div class="coachIntro">Coaches automatically tap a specific exercise for you. They respect the cooldown and don’t play sounds.</div>'; var listEl=document.createElement('div'); listEl.className='coachList'; host.appendChild(listEl);
    var exById={}; for(var i=0;i<App.State.s.exercises.length;i++){ var e=App.State.s.exercises[i]; exById[e.id]=e; }
    for(var j=0;j<list.length;j++){ var c=list[j]; var owned=!!App.State.s.coachesOwned[c.id]; var unlockedTarget=!!(exById[c.target] && exById[c.target].unlocked); var locked=!unlockedTarget;
      var card=document.createElement('div'); card.className='coachCard'+(locked?' locked':''); var head=document.createElement('div'); head.className='headshot'; head.textContent=c.icon;
      var mid=document.createElement('div'); mid.className='coachMid'; mid.innerHTML='<div class="coachName">'+c.name+'</div><div class="coachInfo">Works on: '+(exById[c.target]?exById[c.target].name:c.target)+'</div>';
      var right=document.createElement('div'); right.className='coachRight'; var btn=document.createElement('button'); btn.className='hireBtn secondary'; btn.setAttribute('data-coach-id',c.id); btn.textContent=owned?'Owned':'Hire • '+App.Util.fmtCost(c.price)+' HP'; if(owned){btn.disabled=true;}
      right.appendChild(btn); card.appendChild(head); card.appendChild(mid); card.appendChild(right); listEl.appendChild(card);
      var canAfford=(App.State.s.hp+App.Config.EPS)>=c.price; if(!locked && !owned){ btn.disabled=!canAfford; if(canAfford){btn.classList.add('ready');btn.classList.remove('secondary');} else {btn.classList.remove('ready');btn.classList.add('secondary');}} else { btn.disabled=true; btn.classList.add('secondary'); btn.classList.remove('ready'); }
      (function(btn,c,locked,owned){ btn.addEventListener('click',function(){ if(locked||owned) return; var S=App.State.s; if(S.hp+App.Config.EPS<c.price) return; App.Game.addHP(-c.price); S.coachesOwned[c.id]=true; App.Audio.sfx('buy'); App.Bus.emit('coach:owned',c.id); App.UI.Renderer.forceTop(); renderList(); }); })(btn,c,locked,owned);
    }}
  return { isAuto:isAuto, getOwnedForExercise:getOwnedForExercise, renderList:renderList, list:function(){return list.slice();} };
})();

App.Achievements=(function(){ var defs=[{id:'first_steps',icon:'👣',title:'First Steps',desc:'Upgrade Walking to Lvl 2 (10/10).',reward:50,done:function(){return lvl('walk')>=2;}},{id:'jog_unlocked',icon:'🏃',title:'Add to Routine',desc:'Unlock Jogging.',reward:100,done:function(){return unlocked('jog');}},{id:'first_coach',icon:'🧑‍🏫',title:'Coach On Duty',desc:'Hire Rookie Coach.',reward:200,done:function(){return ownedCoach('c1');}},{id:'speed_demon',icon:'⚡',title:'Speed Demon',desc:'Any exercise reaches ≤0.30s cooldown.',reward:150,done:function(){return App.State.s.exercises.some(function(e){return e.unlocked && Math.max(100,e.cooldown)<=300;});}},{id:'routine_builder',icon:'📋',title:'Routine Builder',desc:'Unlock 4 exercises.',reward:120,done:function(){return App.State.s.exercises.filter(function(e){return e.unlocked;}).length>=4;}},{id:'tapmaster',icon:'👉',title:'Tap Master',desc:'1,000 manual taps.',reward:180,done:function(){return (App.State.s.stats.manualTaps||0)>=1000;}},{id:'hp_hoarder',icon:'💎',title:'HP Hoarder',desc:'Earn 100K lifetime HP.',reward:300,done:function(){return (App.State.s.stats.totalEarned||0)>=100000;}}];
  function unlocked(id){ var e=App.State.s.exercises.find(function(x){return x.id===id;}); return e&&e.unlocked; }
  function lvl(id){ var e=App.State.s.exercises.find(function(x){return x.id===id;}); return e?e.level:0; }
  function ownedCoach(id){ return !!App.State.s.coachesOwned[id]; }
  function grant(a){ if(App.State.s.achievements[a.id]) return; App.State.s.achievements[a.id]=true; App.Game.addHP(a.reward); App.UI.Banners.upgrade('Achievement: '+a.title+' • +'+App.Util.fmtTop(a.reward)+' HP'); App.Audio.sfx('achv'); App.UI.Effects.confetti(window.innerWidth/2,50,36); App.UI.Renderer.forceTop(); App.State.save(); }
  function checkAll(){ for(var i=0;i<defs.length;i++){ var a=defs[i]; if(!App.State.s.achievements[a.id] && a.done()){ grant(a); } } }
  function render(){ var host=byId('tab-achievements'); if(!host) return; var grid=document.createElement('div'); for(var i=0;i<defs.length;i++){ var a=defs[i]; var done=!!App.State.s.achievements[a.id]; var card=document.createElement('div'); card.className='ach'; card.innerHTML='<div class="achIcon">'+a.icon+'</div><div class="achMid"><div class="achTitle">'+a.title+'</div><div class="achDesc">'+a.desc+'</div></div><div class="achRight"><div class="badgeRew">+'+App.Util.fmtTop(a.reward)+' HP</div>'+(done?'<div class="badgeDone">Completed</div>':'')+'</div>'; grid.appendChild(card);} host.innerHTML=''; host.appendChild(grid); }
  App.Bus.on('hp:change',checkAll); App.Bus.on('reps:buy',checkAll); App.Bus.on('exercise:levelup',checkAll); App.Bus.on('exercise:unlock',checkAll); App.Bus.on('coach:owned',checkAll);
  return { checkAll:checkAll, render:render };
})();

App.Notify=(function(){ var dot=byId('menuDot'); function coachAvailable(){ var s=App.State.s; var exById={}; for(var i=0;i<s.exercises.length;i++){ exById[s.exercises[i].id]=s.exercises[i]; }
  var L=App.Coaches.list(); for(var j=0;j<L.length;j++){ var c=L[j]; if(s.coachesOwned[c.id]) continue; var ex=exById[c.target]; if(!ex||!ex.unlocked) continue; if(s.hp+App.Config.EPS>=c.price) return true; } return false; }
  function update(){ if(!dot) return; if(coachAvailable()) dot.classList.add('show'); else dot.classList.remove('show'); }
  App.Bus.on('hp:change',update); App.Bus.on('coach:owned',update); App.Bus.on('exercise:unlock',update); return { update:update };
})();

/* ---------- UI: cards / renderer ---------- */
App.UI.Cards=(function(){ var bind=App.Engine.bindPress, perTap=App.Game.perTap, tap=App.Game.tap, addReps=App.Game.addReps;
  function makeExerciseCard(e){
    var card=document.createElement('div'); card.className='card'+(e.unlocked?'':' locked'); card.setAttribute('data-id',e.id);
    var tapPad=document.createElement('div'); tapPad.className='tapPad'; tapPad.textContent=e.icon;
    var lvl=document.createElement('div'); lvl.className='lvl'; lvl.textContent='Lvl '+e.level; tapPad.appendChild(lvl);
    var repBand=document.createElement('div'); repBand.className='repBand'; repBand.innerHTML='<div class="repFill"></div><div class="repLabel">0/10</div>'; tapPad.appendChild(repBand);
    var right=document.createElement('div'); right.className='right';
    var head=document.createElement('div'); head.className='ex-head'; head.innerHTML='<div class="ex-title">'+e.name+'</div><div class="muted headRight"></div>';
    var coachSlotTop=document.createElement('div'); coachSlotTop.className='coachSlotTop';
    var coolWrap=document.createElement('div'); coolWrap.className='coolwrap'; coolWrap.innerHTML='<div class="coolbar"><div class="coolfill"></div></div>';
    var metaRow=document.createElement('div'); metaRow.className='metaRow';
    var kvs=document.createElement('div'); kvs.innerHTML='<span class="kv"><strong class="kvTap">'+perTap(e).toFixed(App.Config.DEC)+'</strong> HP</span>';
    var buyBtn=document.createElement('button'); buyBtn.className='btn secondary'; buyBtn.textContent='Reps'; buyBtn.setAttribute('data-role','reps');
    metaRow.appendChild(kvs); metaRow.appendChild(buyBtn);
    var costLine=document.createElement('div'); costLine.className='costLine'; costLine.innerHTML='<button class="costPill" type="button">Unlock for <span class="costAmt"></span> HP</button>';
    var costPill=costLine.querySelector('.costPill'), costAmt=costLine.querySelector('.costAmt');

    right.appendChild(head); right.appendChild(coolWrap); right.appendChild(metaRow); right.appendChild(costLine);
    card.appendChild(tapPad); card.appendChild(right);

    e.els={card:card,tapPad:tapPad,lvl:lvl,repFill:repBand.querySelector('.repFill'),repLabel:repBand.querySelector('.repLabel'),headRight:head.querySelector('.headRight'),coolFill:coolWrap.querySelector('.coolfill'),kvTap:kvs.querySelector('.kvTap'),buyBtn:buyBtn,coachSlotTop:coachSlotTop,costLine:costLine,costPill:costPill,costAmt:costAmt};

    if(e.unlocked){ costLine.style.display='none'; } else { coolWrap.style.display='none'; metaRow.style.display='none'; coachSlotTop.style.display='none'; }

    bind(tapPad,function(){ App.Audio.unlock(); var g=tap(e); if(g>0){ App.Audio.sfx('tap'); if(App.Settings.get('floats')) App.UI.Overlay.floatFrom(tapPad,'+'+g.toFixed(App.Config.DEC)); App.UI.Renderer.forceTop(); }});
    bind(buyBtn,function(){ var ok=addReps(e, App.State.s.buyQty||1); if(ok){ App.Audio.sfx('buy'); App.UI.Renderer.refreshExerciseUI(e); App.UI.Renderer.forceTop(); }});
    costPill.addEventListener('click',function(){ var s=App.State.s; if(!e.unlocked && s.hp+App.Config.EPS>=e.unlockCost){ App.Game.addHP(-e.unlockCost); e.unlocked=true; e.lastTapAt=0; App.Audio.sfx('buy'); App.Bus.emit('exercise:unlock',{exId:e.id});
      e.els.card.classList.remove('locked','unlock-ready','unlock-bounce'); coolWrap.style.display='block'; metaRow.style.display='flex'; coachSlotTop.style.display='flex'; costLine.style.display='none'; App.UI.Renderer.forceTop(); }});
    return card;
  }
  return { makeExerciseCard:makeExerciseCard };
})();

App.UI.Renderer=(function(){
  var refs={stack:byId('stack'),hp:byId('hp'),hpMenu:byId('hpMenu'),qtyTop:byId('qtyTop'),saveBtn:byId('saveBtn'),resetBtn:byId('resetBtn'),menuBtn:byId('menuBtn'),menuOverlay:byId('menuOverlay'),menuClose:byId('menuClose'),tabsWrap:document.querySelector('.menuTabs'),menuBody:document.querySelector('.menuBody'),volBtn:byId('volBtn'),volPanel:byId('volPanel'),volSlider:byId('volSlider'),volPct:byId('volPct')};
  var fmtTop=App.Util.fmtTop, fmtCost=App.Util.fmtCost, perTap=App.Game.perTap, bulkRepCost=App.Game.bulkRepCost, s=App.State.s, shownHP=0;

  function renderStack(){ App.State.merge(); refs.stack.innerHTML=''; for(var i=0;i<s.exercises.length;i++){ var e=s.exercises[i]; var card=App.UI.Cards.makeExerciseCard(e); refs.stack.appendChild(card); refreshExerciseUI(e); } }
  function forceTop(){ shownHP=s.hp; renderTopNow(); }
  function renderTopNow(){ var txt=fmtTop(shownHP); refs.hp.textContent=txt; if(refs.hpMenu) refs.hpMenu.textContent=txt; }
  function tickTop(dt){ shownHP += (s.hp - shownHP) * Math.min(1, dt*8); renderTopNow(); }

  function refreshExerciseUI(e){
    var cd=Math.max(100,e.cooldown);
    if(e.unlocked){
      if(cd<=App.Config.SOLID_CD_MS){ if(e.els.coolFill) e.els.coolFill.style.width='100%'; if(e.els.headRight) e.els.headRight.textContent=(cd/1000).toFixed(App.Config.DEC)+'s'; }
      else { var ready=(e.lastTapAt<=0); var since=ready?cd:(performance.now()-e.lastTapAt); var pct=Math.max(0,Math.min(1,since/cd)); if(e.els.coolFill) e.els.coolFill.style.width=(pct*100).toFixed(1)+'%'; var elapsed=Math.max(0,Math.min(since,cd)); if(e.els.headRight) e.els.headRight.textContent=(elapsed/1000).toFixed(App.Config.DEC)+'s'; }
    }
    if(e.els.repLabel) e.els.repLabel.textContent=e.repProgress+'/'+e.repTarget;
    if(e.els.repFill) e.els.repFill.style.width=(Math.min(e.repProgress/e.repTarget,1)*100).toFixed(1)+'%';
    if(e.els.lvl) e.els.lvl.textContent='Lvl '+e.level;
    if(e.els.kvTap) e.els.kvTap.textContent=perTap(e).toFixed(App.Config.DEC);
    if(e.els.coachSlotTop){ var cs=App.Coaches.getOwnedForExercise(e.id); e.els.coachSlotTop.innerHTML=''; if(cs.length){ for(var i=0;i<cs.length;i++){ var c=cs[i]; var chip=document.createElement('div'); chip.className='coachChip'; chip.textContent=c.icon+' '+c.name; e.els.coachSlotTop.appendChild(chip); } } }
    if(e.unlocked && e.els.buyBtn){ var qty=s.buyQty||1, cost=bulkRepCost(e,qty), canBuy=s.hp+App.Config.EPS>=cost;
      e.els.buyBtn.textContent=(qty===1?('Reps ('+fmtCost(cost)+' HP)'):('×'+qty+' Reps ('+fmtCost(cost)+' HP)')); e.els.buyBtn.disabled=!canBuy; if(canBuy){e.els.buyBtn.classList.add('primary','ready'); e.els.buyBtn.classList.remove('secondary');} else {e.els.buyBtn.classList.add('secondary'); e.els.buyBtn.classList.remove('primary','ready');} }
    if(!e.unlocked && e.els.costPill){ var canUn=s.hp+App.Config.EPS>=e.unlockCost; e.els.costAmt.textContent=App.Util.fmtCost(e.unlockCost);
      e.els.card.classList.toggle('unlock-ready',canUn); e.els.card.classList.toggle('unlock-bounce',canUn); if(canUn){e.els.costPill.classList.add('ready');}else{e.els.costPill.classList.remove('ready');}}
  }
  function refreshAll(){ renderTopNow(); for(var i=0;i<App.State.s.exercises.length;i++) refreshExerciseUI(App.State.s.exercises[i]); }

  function buildStats(){ var host=byId('tab-stats'); var owned=Object.keys(App.State.s.coachesOwned).length; var unlocked=App.State.s.exercises.filter(function(e){return e.unlocked;}).length;
    host.innerHTML='<div class="coachIntro"><strong>Lifetime Stats</strong>'
      +'<div>Total HP (current): '+App.Util.fmtTop(App.State.s.hp)+'</div>'
      +'<div>Lifetime HP earned: '+App.Util.fmtTop(App.State.s.stats.totalEarned||0)+'</div>'
      +'<div>Manual taps: '+App.State.s.stats.manualTaps+'</div>'
      +'<div>Auto taps: '+App.State.s.stats.autoTaps+'</div>'
      +'<div>Exercises unlocked: '+unlocked+' / '+App.State.s.exercises.length+'</div>'
      +'<div>Coaches hired: '+owned+' / '+App.Coaches.list().length+'</div></div>'; }

  function buildSettings(){
    var host=byId('tab-settings'); var prefs=App.Settings.all();
    host.innerHTML='<div class="coachIntro"><strong>Preferences</strong></div>'
      +'<div style="display:flex;flex-direction:column;gap:10px">'
      +'<label><input id="set-sfx" type="checkbox" '+(prefs.sfx?'checked':'')+'/> Sound effects (manual taps & FX)</label>'
      +'<label><input id="set-floats" type="checkbox" '+(prefs.floats?'checked':'')+'/> Show +HP float text</label></div>'
      +'<hr style="border:0;border-top:1px solid #223556;margin:12px 0">'
      +'<div class="coachIntro"><strong>Save Management</strong></div>'
      +'<div style="display:flex;gap:8px;flex-wrap:wrap">'
      +'<button id="btn-export" class="btn primary">Export Save</button>'
      +'<button id="btn-import" class="btn secondary">Import Save</button>'
      +'<button id="btn-clear" class="btn secondary">Clear Save</button></div>'
      +'<div id="ioArea" style="margin-top:10px;display:none"><textarea id="ioText" style="width:100%;height:160px;background:#0c1525;color:#cfe0ff;border:1px solid #223556;border-radius:8px;padding:8px"></textarea><div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap"><button id="ioCopy" class="btn secondary">Copy</button><button id="ioDownload" class="btn secondary">Download JSON</button><button id="ioClose" class="btn secondary">Close</button></div></div>';
    byId('set-sfx').onchange=function(e){App.Settings.set('sfx',!!e.target.checked);};
    byId('set-floats').onchange=function(e){App.Settings.set('floats',!!e.target.checked);};
    var io=byId('ioArea'), txt=byId('ioText');
    byId('btn-export').onclick=function(){ var payload=localStorage.getItem(App.Config.SAVE_KEY)||'{}'; txt.value=payload; io.style.display='block'; txt.focus(); txt.select(); };
    byId('btn-import').onclick=function(){ io.style.display='block'; txt.value=''; txt.placeholder='Paste JSON then press "Import Save" again.'; byId('btn-import').onclick=function(){ try{ var obj=JSON.parse(txt.value||'{}'); if(!obj||typeof obj!=='object') throw new Error('Invalid JSON'); localStorage.setItem(App.Config.SAVE_KEY, JSON.stringify(obj)); alert('Save imported. Reloading…'); location.reload(); }catch(e){ alert('Import failed: '+e.message); } }; };
    byId('btn-clear').onclick=function(){ if(confirm('This clears your game save (not preferences). Proceed?')){ localStorage.clear(); location.reload(); } };
    byId('ioCopy').onclick=function(){ txt.select(); document.execCommand('copy'); };
    byId('ioDownload').onclick=function(){ var blob=new Blob([txt.value||'{}'],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fitness-frenzy-save.json'; a.click(); setTimeout(function(){URL.revokeObjectURL(a.href);},500); };
    byId('ioClose').onclick=function(){ io.style.display='none'; };
  }

  function wireMenu(){
    refs.menuBtn.addEventListener('click', function(){ App.Audio.sfx('popup'); refs.menuOverlay.classList.add('open'); refs.menuOverlay.setAttribute('aria-hidden','false'); App.UI.Overlay.suppressFloats=true; switchTab('coaches'); App.Notify.update(); document.dispatchEvent(new Event('menu:open')); });
    refs.menuClose.addEventListener('click', function(){ App.Audio.sfx('popup'); refs.menuOverlay.classList.remove('open'); refs.menuOverlay.setAttribute('aria-hidden','true'); App.UI.Overlay.suppressFloats=false; });
    refs.menuOverlay.addEventListener('click', function(e){ if(e.target===refs.menuOverlay){ App.Audio.sfx('popup'); refs.menuClose.click(); }});
    document.addEventListener('keydown',function(e){ if(e.key==='Escape'){ App.Audio.sfx('popup'); refs.menuClose.click(); }});
    var tabs=refs.tabsWrap.querySelectorAll('.menuTab'); for(var i=0;i<tabs.length;i++){ (function(btn){ btn.addEventListener('click', function(){ App.Audio.sfx('popup'); switchTab(btn.getAttribute('data-tab')); }); })(tabs[i]); }
    byId('saveBtn').addEventListener('click', function(){App.Audio.sfx('tap');});
    byId('resetBtn').addEventListener('click', function(){App.Audio.sfx('tap');});

    function switchTab(tab){ var ids=['coaches','upgrades','achievements','quests','shop','stats','settings']; for(var i=0;i<ids.length;i++){ var id=ids[i]; document.getElementById('tab-'+id).style.display=(id===tab?'block':'none'); }
      var t=refs.tabsWrap.querySelectorAll('.menuTab'); for(var j=0;j<t.length;j++){ t[j].classList.toggle('active', t[j].getAttribute('data-tab')===tab); }
      if(tab==='coaches') App.Coaches.renderList(); if(tab==='stats') buildStats(); if(tab==='settings') buildSettings(); if(tab==='achievements') App.Achievements.render();
    }

    // volume UI
    refs.volBtn.addEventListener('click', function(){ refs.volPanel.classList.toggle('open'); App.Audio.sfx('popup'); });
    document.addEventListener('click', function(e){ var vw=byId('volWrap'); if(vw && !vw.contains(e.target)) refs.volPanel.classList.remove('open'); }, true);

    function applyVolUI(v){ var pct=Math.round(v*100); refs.volPct.textContent=pct+'%'; App.Audio.music.setBaseVolume(v); }
    var prefs=App.Settings.all(); var mv=(prefs.musicVol!=null?prefs.musicVol:0.20); refs.volSlider.value=Math.round(mv*100); applyVolUI(mv);
    var lastTick=0; refs.volSlider.addEventListener('input', function(){ var v=Number(refs.volSlider.value)/100; applyVolUI(v); var now=performance.now(); if(now-lastTick>80){ App.Audio.sfx('tick'); lastTick=now; }});
  }
  return { refs:refs, renderStack:renderStack, refreshAll:refreshAll, tickTop:tickTop, forceTop:forceTop, wireMenu:wireMenu, buildStats:buildStats, buildSettings:buildSettings, refreshExerciseUI:refreshExerciseUI };
})();

/* ---------- fixes / offline ---------- */
App.Fix=(function(){ return { normalizeCooldownStamps:function(){ for(var i=0;i<App.State.s.exercises.length;i++){ var e=App.State.s.exercises[i]; e._autoElapsed=0; e.lastTapAt = e.unlocked ? 0 : -1; } } };})();
App.Offline=(function(){ var KEY_TS='ff-last-active'; function saveNow(){ try{localStorage.setItem(KEY_TS, Date.now().toString());}catch(e){} }
  function summarize(ms){ var earned=0; var s=App.State.s; for(var i=0;i<s.exercises.length;i++){ var e=s.exercises[i]; if(!e.unlocked) continue; if(!App.Coaches.isAuto(e.id)) continue; var cd=Math.max(100,e.cooldown); var taps=Math.floor(ms/cd); if(taps<=0) continue; earned += taps*App.Game.perTap(e); } return earned; }
  function fmtDuration(ms){ var sec=Math.floor(ms/1000); var h=Math.floor(sec/3600); sec%=3600; var m=Math.floor(sec/60); sec%=60; var parts=[]; if(h)parts.push(h+'h'); if(m)parts.push(m+'m'); if(sec||!parts.length)parts.push(sec+'s'); return parts.join(' '); }
  function checkAndShow(){ var last=parseInt(localStorage.getItem(KEY_TS)||'0',10); var now=Date.now(); if(last>0){ var delta=now-last; var capped=Math.min(delta, App.Config.OFFLINE_MAX_MS); var gained=summarize(capped);
      if(gained>0){ byId('offAmt').textContent=App.Util.fmtTop(gained); byId('offDur').textContent=fmtDuration(capped); byId('offCapNote').style.display=(delta>capped)?'block':'none'; byId('offOv').classList.add('open'); byId('offClaim').onclick=function(){ App.Game.addHP(gained); App.Fix.normalizeCooldownStamps(); App.UI.Renderer.refreshAll(); byId('offOv').classList.remove('open'); }; } }
    saveNow(); }
  window.addEventListener('visibilitychange', function(){ if(document.visibilityState==='hidden'){ saveNow(); } });
  window.addEventListener('pagehide', saveNow); window.addEventListener('beforeunload', saveNow);
  return { checkAndShow:checkAndShow, saveNow:saveNow };
})();

/* ---------- tutorial (unchanged logic, compat calls) ---------- */
App.Tutorial=(function(){ if(!App.Flags.tutorial){ return { init:function(){}, start:function(){}, end:function(){}, repositionSpot:function(){} }; }
  var S=App.State.s, ov=byId('tutOv'), bubble=byId('tutBubble'), who=byId('tutWho'), line=byId('tutLine'), avatar=byId('tutAvatar'), spot=byId('tutSpot');
  var active=false,gating=false,curStep=null,lineIdx=0,allowed=[],lastSpotSel=null;
  function setModal(on){ if(on) ov.classList.add('modal'); else ov.classList.remove('modal'); }
  function show(modal){ ov.classList.add('show'); ov.setAttribute('aria-hidden','false'); active=true; setModal(!!modal); App.UI.Overlay.suppressFloats=true; App.Audio.music.setTutorialMode(true); }
  function hide(){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); active=false; setModal(false); App.UI.Overlay.suppressFloats=false; App.Audio.music.setTutorialMode(false); hideSpot(); gateStop(); bubble.classList.remove('tutPop'); bubble.classList.remove('tutIdle'); }
  function setSpeaker(name,icon){ who.textContent=name; avatar.textContent=icon; }
  function setTextHTML(html){ line.innerHTML=html; }
  function showSpotFor(selector){ lastSpotSel=selector; var el=document.querySelector(selector); if(!el){ hideSpot(); return;} var r=el.getBoundingClientRect(), pad=6; spot.style.display='block'; spot.style.left=(r.left-pad)+'px'; spot.style.top=(r.top-pad)+'px'; spot.style.width=(r.width+pad*2)+'px'; spot.style.height=(r.height+pad*2)+'px'; try{ el.scrollIntoView({behavior:'smooth', block:'center'});}catch(e){} }
  function hideSpot(){ spot.style.display='none'; lastSpotSel=null; }
  function repositionSpot(){ if(active && lastSpotSel) showSpotFor(lastSpotSel); }
  function gateStart(allow){ allowed=allow||[]; gating=true; setModal(false); document.addEventListener('pointerdown',gateHandler,true); document.addEventListener('click',gateHandler,true); }
  function gateStop(){ gating=false; allowed=[]; document.removeEventListener('pointerdown',gateHandler,true); document.removeEventListener('click',gateHandler,true); }
  function gateHandler(e){ if(!active||!gating) return; var okay=false; for(var i=0;i<allowed.length;i++){ if(e.target.closest(allowed[i])){ okay=true; break; } } if(!okay){ e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation(); } }
  function popInFX(){ bubble.classList.remove('tutPop'); void bubble.offsetWidth; bubble.classList.add('tutPop'); bubble.classList.add('tutIdle'); App.Audio.sfx('popup'); var r=bubble.getBoundingClientRect(); App.UI.Effects.confetti(r.left+r.width*0.5,r.top+10,16); }
  function setStep(step,modal){ curStep=step; S.tutorial.stepId=step.id||null; App.State.save(); lineIdx=0; bubble.style.display=''; var L=step.lines[0]; setSpeaker(L.who,L.icon); setTextHTML(L.html); show(modal!==false); setTimeout(popInFX,10); }
  bubble.addEventListener('click', function(){ if(!curStep) return; if(lineIdx<curStep.lines.length-1){ lineIdx++; var L=curStep.lines[lineIdx]; setSpeaker(L.who,L.icon); setTextHTML(L.html); App.Audio.sfx('popup'); } else if(curStep.onLinesDone){ var done=curStep.onLinesDone; curStep=null; done(); } });
  ov.querySelector('.tutDim').addEventListener('click', function(){ if(curStep){ bubble.click(); }});

  function startIntro(){ setStep({id:'intro-walk',lines:[{who:'JAX',icon:'🏋️‍♂️',html:'Hey—energy looks low. Let’s fix that 💪'},{who:'You',icon:(S.tutorial.avatar==='female'?'👩':'👨'),html:'Where do I start?'},{who:'JAX',icon:'🏋️‍♂️',html:'Tap <span class="hl">Walking</span> to earn <span class="hl">1 HP</span> each time.'}],onLinesDone:function(){
      showSpotFor('.card[data-id="walk"] .tapPad'); gateStart(['.card[data-id="walk"] .tapPad','#tutBubble']); bubble.style.display='none';
      var offTap=App.Bus.on('tap:manual',function(d){ if(d.exId!=='walk') return; S.tutorial.progress.walkTaps=(S.tutorial.progress.walkTaps||0)+1; if(S.tutorial.progress.walkTaps>=4){ App.Bus.off('tap:manual',offTap); bubble.style.display='';
          setStep({id:'reps-walk',lines:[{who:'JAX',icon:'🏋️‍♂️',html:'Use <span class="hl">Reps</span> to add <span class="hl">+1 HP</span> per tap.'},{who:'JAX',icon:'🏋️‍♂️',html:'When the <span class="hl">Reps</span> button turns orange, tap it to buy.'},{who:'JAX',icon:'🏋️‍♂️',html:'Watch the green <span class="hl">Rep bar</span>. At <span class="hl">10/10</span> you <span class="hl">upgrade</span> and cooldown halves.'}],onLinesDone:function(){
            App.State.s.buyQty=1; try{ var b1=document.querySelector('#qtyTop .segBtn[data-q="1"]'); var b10=document.querySelector('#qtyTop .segBtn[data-q="10"]'); if(b1&&b10){ b1.classList.add('active'); b10.classList.remove('active'); }}catch(e){}
            App.UI.Renderer.refreshAll(); showSpotFor('.card[data-id="walk"] .btn[data-role="reps"]'); gateStart(['.card[data-id="walk"] .btn[data-role="reps"]','#tutBubble']); bubble.style.display='none';
            var offBuy=App.Bus.on('reps:buy',function(ev){ if(ev.exId!=='walk') return; App.Bus.off('reps:buy',offBuy); hideSpot(); gateStop(); S.tutorial.done=true; S.tutorial.stepId=null; App.State.save(); hide(); }); }}); }}); }
  function promptUnlockJog(jog){ if(S.tutorial.shown.unlock[jog.id]) return; setStep({lines:[{who:'JAX',icon:'🏋️‍♂️',html:'Time to add to your routine. Unlock <span class="hl">'+jog.name+'</span> for <span class="hl">'+App.Util.fmtTop(jog.unlockCost)+' HP</span>.'},{who:'JAX',icon:'🏋️‍♂️',html:'Tap the <span class="hl">Unlock</span> pill when ready.'}],onLinesDone:function(){ S.tutorial.shown.unlock[jog.id]=true; App.State.save(); hide(); }},true); showSpotFor('.card[data-id="'+jog.id+'"] .costPill'); }
  function promptUpgrade(ex){ if(S.tutorial.shown.upgrade[ex.id]) return; setStep({lines:[{who:'JAX',icon:'🏋️‍♂️',html:'<span class="hl">'+ex.name+' upgraded!</span> Cooldown halved. Keep stacking Reps to upgrade again.'}],onLinesDone:function(){ S.tutorial.shown.upgrade[ex.id]=true; App.State.save(); hide(); }},true); showSpotFor('.card[data-id="'+ex.id+'"] .coolwrap'); }
  function promptCoach(){ var exById={}; for(var i=0;i<S.exercises.length;i++){ exById[S.exercises[i].id]=S.exercises[i]; } var L=App.Coaches.list();
    for(var j=0;j<L.length;j++){ var c=L[j]; if(S.coachesOwned[c.id]) continue; if(S.tutorial.shown.coach[c.id]) continue; var ex=exById[c.target]; if(!ex||!ex.unlocked) continue; if(S.hp+App.Config.EPS<c.price) continue;
      setStep({lines:[{who:'JAX',icon:'🏋️‍♂️',html:'Want to maximize gains? Hire <span class="hl">'+c.name+'</span> to auto-tap <span class="hl">'+ex.name+'</span>.'},{who:'JAX',icon:'🏋️‍♂️',html:'Open the <span class="hl">Menu</span> and hit <span class="hl">Hire</span>.'}],onLinesDone:function(){ S.tutorial.shown.coach[c.id]=true; App.State.save(); hide(); }},true); showSpotFor('#menuBtn'); break; } }
  function checkTriggers(){ for(var i=0;i<S.exercises.length;i++){ var e=S.exercises[i]; if(e.unlocked && !S.tutorial.shown.upgrade[e.id] && e.level>=2){ promptUpgrade(e); return; } }
    var jog=S.exercises.find(function(x){return x.id==='jog';}); if(jog && !jog.unlocked && !S.tutorial.shown.unlock[jog.id] && (S.hp+App.Config.EPS>=jog.unlockCost)){ promptUnlockJog(jog); return; } promptCoach(); }
  App.Bus.on('hp:change',checkTriggers); App.Bus.on('exercise:unlock',checkTriggers); App.Bus.on('coach:owned',checkTriggers); App.Bus.on('exercise:levelup', function(d){ var ex=S.exercises.find(function(x){return x.id===d.exId;}); if(ex) promptUpgrade(ex); });

  return { init:function(){}, start:function(){ if(!S.tutorial.done){ startIntro(); } }, end:function(){}, repositionSpot:repositionSpot };
})();

/* ---------- start screen & splash ---------- */
App.UI.Start=(function(){ var ov=byId('startOv'), btnStart=byId('btnStart'), btnCont=byId('btnContinue'), seg=byId('segAvatar'), ui=byId('startUI'), cover=byId('startCoverImg');
  function setAvatar(av){ App.State.s.tutorial.avatar=av; var bs=seg.querySelectorAll('.segBtn'); for(var i=0;i<bs.length;i++){ bs[i].classList.toggle('active', bs[i].getAttribute('data-avatar')===av); } App.State.save(); }
  function emojiBurstAround(el){ var r=el.getBoundingClientRect(), x=r.left+r.width/2, y=r.top+r.height/2; var emojis=['💪','🏃','🔥','⭐','🎉']; for(var i=0;i<14;i++){ var span=document.createElement('div'); span.textContent=emojis[i%emojis.length]; span.style.position='fixed'; span.style.left=(x+(Math.random()*120-60))+'px'; span.style.top=(y+(Math.random()*30-15))+'px'; span.style.fontSize=(18+Math.random()*12)+'px'; span.style.pointerEvents='none'; span.style.zIndex='9100'; document.body.appendChild(span);
      span.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:'translate(' + ((Math.random()*2-1)*160) + 'px, -' + (60+Math.random()*80) + 'px) scale(' + (.9+Math.random()*.4) + ')',opacity:0}],{duration:900+Math.random()*400,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}); (function(s){ setTimeout(function(){s.remove();},1500); })(span);} }
  function init(){
    var cur=App.State.s.tutorial.avatar||'male'; setAvatar(cur);
    var bs=seg.querySelectorAll('.segBtn'); for(var i=0;i<bs.length;i++){ (function(b){ b.addEventListener('click', function(){ App.Audio.sfx('tap'); setAvatar(b.getAttribute('data-avatar')); }); })(bs[i]); }
    function beginGame(startTutorial){ App.Audio.sfx('popup'); App.Audio.music.stopIntro(400); App.Audio.music.playGame(); hide(); if(startTutorial){ App.Tutorial.start(); } setTimeout(function(){App.Offline.checkAndShow();},50); }
    btnStart.addEventListener('click', function(){ beginGame(true); });
    btnCont.addEventListener('click', function(){ beginGame(false); });
  }
  function show(){ ov.classList.add('open'); ov.setAttribute('aria-hidden','false'); try{ cover.classList.remove('coverBounce'); void cover.offsetWidth; cover.classList.add('coverBounce'); ui.classList.remove('popIn'); void ui.offsetWidth; ui.classList.add('popIn'); App.Audio.sfx('popup'); emojiBurstAround(ui);}catch(e){} }
  function hide(){ ov.classList.remove('open'); ov.setAttribute('aria-hidden','true'); }
  return { init:init, show:show, hide:hide };
})();

App.UI.Splash=(function(){ var el=byId('splash'), img=byId('splashImg'), sparkHost=byId('sparkHost');
  function spark(){ var s=document.createElement('div'); s.className='splashSpark'; s.textContent='✨'; s.style.left=(50+(Math.random()*20-10))+'%'; s.style.top=(70+(Math.random()*6-3))+'%'; sparkHost.appendChild(s); setTimeout(function(){s.remove();},1000); }
  function show(){ el.classList.remove('hidden'); img.classList.remove('show'); void img.offsetWidth; img.classList.add('show'); }
  function hide(){ el.classList.add('hidden'); }
  function startSequence(){ show(); App.Audio.music.playIntro(0.5); App.Audio.sfx('reveal'); setTimeout(function(){App.Audio.sfx('chime');},220); setTimeout(function(){spark();},240); setTimeout(function(){spark();},420); setTimeout(function(){spark();},620); setTimeout(function(){ hide(); App.UI.Start.show(); },2200); }
  return { startSequence:startSequence };
})();

/* ---------- boot ---------- */
(function boot(){
  var lastTouchEnd=0; document.addEventListener('touchend',function(e){var n=Date.now(); if(n-lastTouchEnd<=300){e.preventDefault();} lastTouchEnd=n;},{passive:false});
  document.addEventListener('dblclick',function(e){e.preventDefault();},{passive:false}); document.addEventListener('gesturestart',function(e){e.preventDefault();},{passive:false});

  App.State.load(); App.State.setExercises(App.Content.exercises);
  App.UI.Renderer.renderStack(); App.UI.Renderer.forceTop(); App.UI.Renderer.refreshAll();
  App.UI.Renderer.wireMenu();

  var refs=App.UI.Renderer.refs;
  var qs=refs.qtyTop.querySelectorAll('.segBtn'); for(var i=0;i<qs.length;i++){ (function(b){ b.addEventListener('pointerdown',function(ev){ ev.preventDefault(); for(var j=0;j<qs.length;j++){ qs[j].classList.remove('active'); } b.classList.add('active'); App.State.s.buyQty=parseInt(b.getAttribute('data-q'),10); App.UI.Renderer.refreshAll(); App.Notify.update(); App.Audio.sfx('tap'); }, {passive:false}); })(qs[i]); }

  App.Bus.on('hp:change', function(){ App.UI.Renderer.forceTop(); });

  App.Tutorial.init();
  App.Engine.start();
  App.Engine.scheduleSave();
  App.Notify.update();

  App.UI.Start.init();
  App.UI.Splash.startSequence();
})();
</script>
</body>
</html>