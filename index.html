<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Fitness Frenzy</title>
<style>
:root{
  --bg:#0f1421; --bg2:#0b1220;
  --ink:#eaf1fb; --muted:#9fb0c6;
  --card:#152136; --edge:rgba(255,255,255,.06);
  --accent:#ff7a1a; --accent2:#ffc38f;
  --good:#2dd36f;
}
*{box-sizing:border-box}
html,body{height:100%}
html{-webkit-text-size-adjust:100%}
body{
  margin:0;color:var(--ink);
  font:16px/1.45 system-ui, Segoe UI, Arial;
  background:
    radial-gradient(900px 600px at -10% -20%,rgba(58,160,255,.15),transparent),
    radial-gradient(1000px 700px at 110% 10%,rgba(255,122,26,.10),transparent),
    linear-gradient(180deg,var(--bg),var(--bg2));
  -webkit-tap-highlight-color: transparent;
  padding-bottom: env(safe-area-inset-bottom);
}
button{font:inherit}

/* Sticky header */
header{
  position:sticky; top:0; z-index:1000;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 14px;
  background:rgba(15,21,33,.85); border-bottom:1px solid var(--edge);
  backdrop-filter:saturate(1.1) blur(8px);
}
.hp{
  flex:1 1 auto;
  font:900 clamp(22px,4.2vw,36px)/1 system-ui;
  min-width: clamp(180px,30vw,260px);
  text-overflow:ellipsis;white-space:nowrap;overflow:hidden;
  text-shadow:0 6px 22px rgba(0,0,0,.35)
}
.hp small{font-weight:800;opacity:.9;background:rgba(255,255,255,.08);padding:.16em .45em;border-radius:.35em;margin-left:.45rem}
.head-actions{display:flex;gap:8px;align-items:center}
.btn{
  border:1px solid var(--edge);border-radius:12px;padding:8px 12px;font-weight:800;background:#0f1926;color:#fff;cursor:pointer;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:84px
}

/* Mission / progress */
.mission{
  display:flex;align-items:center;gap:10px;margin:12px 14px 8px;
  background:#111a2b;border:1px solid var(--edge);border-radius:12px;padding:10px;
}
.mission h2{margin:0;font:900 16px/1.1 system-ui}
.msub{color:#cfe0ff;font-size:12px}
.mbar{flex:1;height:12px;background:#0b1219;border-radius:8px;overflow:hidden;position:relative}
.mbar i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--good),#9cffbd)}
.mgoal{font-weight:900;color:#bfe0ff}

/* Content wrapper */
.wrap{max-width:1140px;margin:0 auto 110px;padding:0 14px}

/* Cards */
.card{
  position:relative;background:var(--card);border-radius:14px;padding:10px;margin:10px 14px;
  box-shadow:0 10px 22px rgba(0,0,0,.36), inset 0 0 0 1px var(--edge);
  display:grid;grid-template-columns:160px 1fr 340px;gap:10px;align-items:center;min-height:140px;
}
@media (max-width:900px){
  .card{grid-template-columns:140px 1fr;min-height:150px}
  .actions{grid-column:1/-1}
}
@media (max-width:680px){
  .card{grid-template-columns:1fr;gap:8px;padding:12px}
}

/* Avatar */
.avatarbtn{
  position:relative;display:grid;place-items:center;width:100%;height: clamp(92px,22vw,110px);
  border-radius:14px;border:2px dashed #7ff2b0;background:linear-gradient(180deg,#0c1e16,#0f271a);color:#cffff1;
  cursor:pointer;user-select:none;overflow:hidden;z-index:5;transition:box-shadow .15s ease, transform .06s ease;
  touch-action: manipulation;
}
.avatarbtn.ready{box-shadow:0 0 0 3px rgba(39,210,103,.25) inset}
.avatarbtn.needGlow{animation:needBlink 1.1s ease-in-out infinite}
@keyframes needBlink{
  0%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
  50%{box-shadow:0 0 14px 2px rgba(58,160,255,.35),0 0 0 4px rgba(255,122,26,.18) inset}
  100%{box-shadow:0 0 0 0 rgba(58,160,255,.0),0 0 0 0 rgba(255,122,26,.0) inset}
}
.emoji{font-size: clamp(48px,10vw,64px);display:block;filter:drop-shadow(0 4px 7px rgba(0,0,0,.35))}
.avatarbtn.animate .emoji{animation:bop .22s ease}
@keyframes bop{0%{transform:scale(.94) rotate(-2deg)}50%{transform:scale(1.12) rotate(2deg)}100%{transform:scale(1)}}

/* Locks */
.badge{position:absolute;top:8px;left:8px;background:#20314f;color:#bfe0ff;border:1px solid var(--edge);font-weight:900;padding:.2em .5em;border-radius:999px}
.locked .emoji{filter:blur(8px) grayscale(.25) drop-shadow(0 4px 7px rgba(0,0,0,.35))}
.lockOverlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.22);font-weight:900;color:#ffddb5;letter-spacing:.4px}
.lockOverlay span{background:rgba(0,0,0,.22);padding:.2em .6em;border-radius:999px;border:1px solid var(--edge)}

/* Meta + orange cooldown bar */
.meta h3{margin:0 0 2px;font:800 clamp(16px,3.8vw,18px)/1.1 system-ui;max-height:22px;overflow:hidden}
.meta .sub{color:var(--muted);font-size: clamp(11px,3.2vw,12px);max-height:18px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.bar{height: clamp(12px,3.4vw,14px);background:#0b1219;border-radius:8px;overflow:hidden;margin-top:8px;position:relative}
.bar i{
  display:block;height:100%;width:0;
  background:
    repeating-linear-gradient(45deg, rgba(0,0,0,.06) 0 10px, rgba(0,0,0,.14) 10px 20px),
    linear-gradient(90deg,var(--accent),var(--accent2));
  background-size:24px 100%, auto; animation:stripe 1.2s linear infinite;
}
@keyframes stripe{from{background-position:0 0,0 0}to{background-position:24px 0,0 0}}
.bar.ready{box-shadow:0 0 0 2px rgba(45,211,111,.3) inset}

/* Actions */
.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-self:stretch}
@media (max-width:680px){ .actions{grid-template-columns:1fr} }
.actions .btn{height:44px;display:flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.action{background:linear-gradient(180deg,#ff8b3a,#ff7a1a);color:#1b0e03;border-color:transparent;position:relative}
.secondary{background:#0e1724;color:#fff;border:1px solid var(--edge);position:relative}
.action[disabled],.secondary[disabled]{opacity:.5;cursor:not-allowed}

/* Glitter only when affordable */
.glitter.available::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.18) 25%, rgba(255,255,255,.35) 33%, transparent 45%);
  transform:translateX(-120%); filter:blur(.6px);
  animation:shine 1.15s ease-in-out infinite;
}
@keyframes shine{0%{transform:translateX(-120%)}60%{transform:translateX(0%)}100%{transform:translateX(120%)}}

/* Mobile footer: mute only */
.footer{
  position:fixed;left:0;right:0;bottom:0;z-index:1000;
  display:none;gap:10px;align-items:center;justify-content:flex-end;
  padding:10px max(10px, env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
  background:rgba(15,21,33,.85); backdrop-filter: blur(10px);
  border-top:1px solid var(--edge);
}
.footer .btn{min-width:64px}
@media (max-width:820px){ .footer{display:flex} .wrap{margin-bottom:160px} }

/* Intro modal */
body.intro-open{overflow:hidden}
#intro{
  position:fixed;inset:0;z-index:999;display:grid;place-items:center;background:rgba(8,12,20,.65);
  opacity:1;visibility:visible;transition:opacity .25s ease,visibility .25s ease
}
#intro.off{opacity:0;visibility:hidden;pointer-events:none}
.introCard{width:min(720px,92vw);background:#141f34;border:1px solid var(--edge);border-radius:16px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.introCard h1{margin:0 0 6px;font:900 clamp(22px,6vw,28px)/1.1 system-ui}
.introRow{display:flex;gap:12px;flex-wrap:wrap}
.introStep{background:#0f1928;border:1px solid var(--edge);border-radius:12px;padding:10px;flex:1;min-width:200px}
.startBtn{margin-top:12px;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#ff8b3a,#ff7a1a);border:0;border-radius:12px;color:#1b0e03;font-weight:900;padding:10px 14px;cursor:pointer}

/* Tutorial overlay (no blur, forces action) */
.tutor{
  position:fixed;inset:0;display:none;z-index:1500;
  background:rgba(0,0,0,.35);
}
.tutor.on{display:block}
.tcard{
  position:absolute;max-width:92vw;background:#13203a;border:1px solid var(--edge);border-radius:12px;padding:12px;
  box-shadow:0 16px 44px rgba(0,0,0,.6); font-weight:700;
}
.tfinger{
  position:absolute;width:64px;height:64px;transform:translate(-50%,-50%);pointer-events:none;
  filter:drop-shadow(0 8px 20px rgba(0,0,0,.5))
}
</style>
</head>
<body class="intro-open">
<canvas id="confetti"></canvas>

<!-- INTRO -->
<div id="intro">
  <div class="introCard">
    <h1>Fitness Frenzy</h1>
    <p class="hint">Earn <b>HP (Health Points)</b> by tapping exercises. Upgrade them, hire coaches (auto-tap), and unlock stronger moves. The orange striped bar shows cooldown in seconds.</p>
    <div class="introRow">
      <div class="introStep">üëü <b>Tap</b> when a card glows.</div>
      <div class="introStep">üßë‚Äçüè´ <b>Coach</b> auto-taps; reach <b>Coach Lv.2</b> to complete Week 1.</div>
      <div class="introStep">üîì <b>Unlock</b> new exercises with HP.</div>
    </div>
    <button class="startBtn" onclick="startGame()">Start Workout ‚ñ∂</button>
  </div>
</div>

<header>
  <div class="hp" id="hp">0.00 <small>HP</small></div>
  <div class="head-actions">
    <button class="btn" id="share">Share</button>
    <button class="btn" id="muteTop">Mute</button>
    <button class="btn" id="new">New Game</button>
  </div>
</header>

<div class="mission" id="mission">
  <div>
    <h2 id="mTitle">Week 1: Foundation</h2>
    <div class="msub" id="mSub">Goal: Unlock <b>Weight Lifting</b> & any Coach to <b>Lv.2</b></div>
  </div>
  <div class="mbar"><i id="mProg"></i></div>
  <div class="mgoal" id="mGoal">0/2</div>
</div>

<div class="wrap" aria-live="polite">
  <div id="list"></div>
</div>

<!-- Mobile footer (mute only) -->
<div class="footer">
  <button class="btn" id="muteBottom">Mute</button>
</div>

<!-- Tutorial overlay -->
<div class="tutor" id="tutor">
  <img class="tfinger" id="tfinger" alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text x='8' y='48' font-size='40'>üëâ</text></svg>">
  <div class="tcard" id="tcard">Tip</div>
</div>

<div class="ribbon" id="ribbon">üéâ Unlocked!</div>
<audio id="bgm" preload="auto" loop crossorigin="anonymous"></audio>

<script>
/* ====== STATIC PATHS ====== */
const RAW_BASE = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/";
const MUSIC_URL = RAW_BASE + "Velvet%20Haze%20-%20Take%20a%20Seat%20-%20Instrumental%20version.mp3";

/* ====== EXERCISES (seconds shown) ====== */
const EX=[ // id,name,emoji,setLabel(sec),gain,interval,baseCost,mult,coachCost,unlock,week
  ["walk","Walking","üëü","0.25s",1,0.25,6,1.18,  300,    0, 1],
  ["jog","Jogging","üèÉ‚Äç‚ôÇÔ∏è","0.5s",  7,0.50,40,1.19, 1200,   40, 1],
  ["yoga","Yoga","üßò‚Äç‚ôÇÔ∏è","1.0s",   30,1.00,220,1.20, 6000,  120,1],
  ["cycle","Cycling","üö¥‚Äç‚ôÇÔ∏è","2.0s",120,2.00,1200,1.21,20000,  600,1],
  ["lift","Weight Lifting","üèãÔ∏è‚Äç‚ôÇÔ∏è","3.0s",520,3.00,6800,1.22,80000, 2200,1], // Week 1 final
];

/* Big teaser (future) */
const BIG_GOAL = { id:"ult", name:"Ultimate Trainer", emoji:"üèÜ", tease:"All exercises x10 ‚Ä¢ Global auto-click", unlockHp: 5_000_000 };

/* ====== STATE ====== */
const STORAGE="ff_polish_v1";
let state={
  hp:0, items:{}, level:1,
  firstSteps:{taps:0, done:false},
  lastSeen: Date.now(),
  streak:{lastDay:null,count:0},
  tut:{step:null, done:{tap:false,unlock:false,up:false,coach:false,coach2:false}}
};
const tmp={}; // per-exercise timers

/* ====== Helpers ====== */
const $=s=>document.querySelector(s), id=s=>document.getElementById(s);
const now=()=>performance.now()/1000;
function fmtHP(n){
  const a=Math.abs(n);
  const d=v=>v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  if(a>=1e9) return d(n/1e9)+"B";
  if(a>=1e6) return d(n/1e6)+"M";
  if(a>=1e3) return d(n/1e3)+"K";
  return d(n);
}
function fmtCost(n){
  n=Math.floor(n); const a=Math.abs(n);
  const f=v=>Number.isInteger(v)?v.toString():v.toFixed(1).replace(/\.0$/,'');
  if(a>=1e9) return f(n/1e9)+"B";
  if(a>=1e6) return f(n/1e6)+"M";
  if(a>=1e3) return f(n/1e3)+"K";
  return String(n);
}

/* ====== Confetti + Ribbon ====== */
const cf=id("confetti"); const cfx=cf.getContext("2d"); let confetti=[],confTimer=null;
function fireConfetti(n=160){cancelAnimationFrame(confTimer);const W=cf.width=innerWidth,H=cf.height=innerHeight;confetti=Array.from({length:n},()=>({x:Math.random()*W,y:-10,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,s:2+Math.random()*4,c:`hsl(${Math.random()*360},90%,60%)`,r:Math.random()*Math.PI}));(function loop(){cfx.clearRect(0,0,W,H);confetti.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.r+=.1;cfx.save();cfx.translate(p.x,p.y);cfx.rotate(p.r);cfx.fillStyle=p.c;cfx.fillRect(-p.s/2,-p.s/2,p.s,p.s);cfx.restore();});confTimer=requestAnimationFrame(loop); if(confetti.every(p=>p.y>H+20)) cancelAnimationFrame(confTimer);})();}

function showRibbon(text){const rb=$("#ribbon");rb.textContent=text;rb.classList.remove("show");void rb.offsetWidth;rb.classList.add("show");fireConfetti(180); s_cheer();}

/* ====== Audio ====== */
const bgm=id("bgm"); bgm.src=MUSIC_URL; bgm.volume=0.22; let isPlaying=false;
function syncMute(){ const t=bgm.muted?"Unmute":"Mute"; id("muteTop").textContent=t; id("muteBottom").textContent=t; }
id("muteTop").addEventListener("click",()=>{ bgm.muted=!bgm.muted; syncMute(); });
id("muteBottom").addEventListener("click",()=>{ bgm.muted=!bgm.muted; syncMute(); });

let AC=null, master=null, noiseBuf=null;
function ensureAC(){ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; AC=new C(); master=AC.createGain(); master.gain.value=.95; master.connect(AC.destination); noiseBuf=mkNoise(.18); }
function mkNoise(sec){const n=AC.sampleRate*sec,b=AC.createBuffer(1,n,AC.sampleRate),a=b.getChannelData(0);for(let i=0;i<n;i++)a[i]=Math.random()*2-1;return b;}
/* SFX: click, upgrade, cheer */
function s_click(){ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="triangle";o.frequency.value=420;o.connect(g);g.connect(master);g.gain.setValueAtTime(.18,t);g.gain.exponentialRampToValueAtTime(.0001,t+.14);o.start(t);o.stop(t+.16);}
function s_upgrade(){ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="square";o.frequency.value=980;o.connect(g);g.connect(master);g.gain.setValueAtTime(.24,t);g.gain.exponentialRampToValueAtTime(.0001,t+.22);o.start(t);o.stop(t+.24);}
function s_coin(){ ensureAC(); const t=AC.currentTime; const o=AC.createOscillator(),g=AC.createGain();o.type="square";o.frequency.value=760;o.connect(g);g.connect(master);g.gain.setValueAtTime(.22,t);g.gain.exponentialRampToValueAtTime(.0001,t+.18);o.start(t);o.stop(t+.2);}
function s_cheer(){ ensureAC(); const t=AC.currentTime; const ns=AC.createBufferSource(); ns.buffer=noiseBuf; const hp=AC.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=420; const g1=AC.createGain(); g1.gain.value=.35; ns.connect(hp); hp.connect(g1); g1.connect(master); g1.gain.setValueAtTime(0,t); g1.gain.linearRampToValueAtTime(.35,t+.02); g1.gain.exponentialRampToValueAtTime(.0001,t+.6); ns.start(t); ns.stop(t+.62); const blip=(f,dt,amp=.22)=>{const o=AC.createOscillator(),g=AC.createGain();o.type="triangle";o.frequency.value=f;o.connect(g);g.connect(master);g.gain.setValueAtTime(amp,t+dt);g.gain.exponentialRampToValueAtTime(.0001,t+dt+.3);o.start(t+dt);o.stop(t+dt+.32);}; blip(660,0.02); blip(990,0.02,.20); blip(1320,0.03,.18); }

/* ====== Save/Load ====== */
function load(){
  try{const raw=localStorage.getItem(STORAGE); if(raw){ const parsed=JSON.parse(raw); state=Object.assign(state,parsed);} }catch{}
  EX.forEach(([eid],i)=>{
    if(!state.items[eid]) state.items[eid]={lvl:i?0:1,unlocked:!i,coach:false,coachLevel:0,taps:0};
    tmp[eid]={next:0,timer:null};
  });
}
function save(){ state.lastSeen = Date.now(); localStorage.setItem(STORAGE,JSON.stringify(state)); }
function newGame(){ localStorage.removeItem(STORAGE); state={hp:0, items:{}, level:1, firstSteps:{taps:0,done:false}, lastSeen:Date.now(), streak:{lastDay:null,count:0}, tut:{step:null, done:{tap:false,unlock:false,up:false,coach:false,coach2:false}}}; load(); build(); renderAll(); }

/* ====== Offline Gains ====== */
function coachSpeed(baseInterval, level){ // cap at Lv.2 (+25%)
  if(!level || level<1) level=1;
  const capped = Math.min(level,2);
  return baseInterval / (1 + (capped-1)*0.25);
}
function grantOffline(){
  const then = state.lastSeen || Date.now();
  const ms = Math.max(0, Date.now()-then);
  const sec = Math.floor(ms/1000);
  if(sec<5) return;
  let perSec = 0;
  EX.forEach(([eid,, , , gain, interval])=>{
    const it=state.items[eid]; if(it?.coach){
      const perTap = Math.floor(gain*Math.max(1,it.lvl));
      const speed = coachSpeed(interval,it.coachLevel||1);
      perSec += (perTap/speed);
    }
  });
  const gain = Math.floor(perSec * sec);
  if(gain>0){ state.hp += gain; showRibbon(`üí§ Offline gains: +${fmtCost(gain)} HP`); }
}

/* ====== Daily Streak ====== */
function dailyStreak(){
  const today = new Date(); today.setHours(0,0,0,0);
  const todayKey = today.getTime();
  if(state.streak.lastDay===todayKey) return;
  const last = state.streak.lastDay;
  if(last && todayKey - last === 86400000){ state.streak.count = Math.min(state.streak.count+1,7); }
  else { state.streak.count = 1; }
  state.streak.lastDay = todayKey;
  const reward = 100 * state.streak.count;
  state.hp += reward;
  showRibbon(`üìÜ Daily streak ${state.streak.count}/7: +${fmtCost(reward)} HP`);
}

/* ====== Build UI ====== */
function build(){
  const host=$("#list"); host.innerHTML="";

  EX.filter(r=>r[10] <= state.level).forEach(([eid,name,emoji,setLabel,gain,interval,base,mult,coachCost,unlock])=>{
    const it=state.items[eid], unlocked=it.unlocked, ready=now()>=tmp[eid].next;
    const affordable = state.hp>=unlock;

    const card=document.createElement("div"); card.className="card"; card.dataset.id=eid;
    card.innerHTML=`
      ${!unlocked && affordable? `<div class="badge">UNLOCK AVAILABLE</div>` : ``}
      <button type="button" class="avatarbtn ${unlocked?'':'locked'} ${ready?'ready':''}" 
              id="tap-${eid}" ${unlocked?``:`disabled`} aria-label="${unlocked?'Perform '+name:'Locked'}">
        <div class="emoji">${emoji}</div>
        ${unlocked?'':`<div class="lockOverlay"><span>üîì Unlock | ${fmtCost(unlock)} HP</span></div>`}
      </button>
      <div class="meta">
        <h3>${name} <span class="sub">‚Ä¢ ${setLabel}</span></h3>
        <div class="sub">HP Gain: <b id="gain-${eid}">${fmtCost(Math.max(1,gain*Math.max(1,it.lvl)))}</b> ‚Ä¢ Unlock: ${fmtCost(unlock)} HP</div>
        <div class="bar ${ready?'ready':''}"><i id="bar-${eid}"></i></div>
      </div>
      <div class="actions">
        ${unlocked
          ? `<button class="btn action" id="up-${eid}">Upgrade</button>
             <button class="btn secondary" id="coach-${eid}">
                <span class="coachFace" id="coachFace-${eid}">üßë‚Äçüè´</span>
                <span id="coachTxt-${eid}"></span>
                <span class="dot ${it.coach?'pulse':'hide'}" id="coachDot-${eid}" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2dd36f;margin-left:6px;box-shadow:0 0 10px #2dd36f"></span>
              </button>`
          : `<button class="btn action" id="unlock-${eid}">Unlock | ${fmtCost(unlock)} HP</button>
             <button class="btn secondary" disabled>Coach</button>`}
      </div>`;
    host.appendChild(card);

    // Tap
    const tap=id("tap-"+eid);
    if(unlocked){
      const handler=e=>{
        e.preventDefault(); firstUserInteract();
        perform(eid);
        s_click();
      };
      tap.addEventListener("pointerdown",handler,{passive:false});
      tap.addEventListener("click",handler);
      tap.addEventListener("touchstart",handler,{passive:false});

      // Upgrade
      id("up-"+eid).addEventListener("click",()=>{
        const cost=pack(base,mult,it.lvl,1);
        if(state.hp>=cost){
          state.hp-=cost; it.lvl+=1; s_upgrade(); renderAll(); save();
          if(!state.tut.done.coach){ setTimeout(()=>startTutor("coach", id("coach-"+eid), "Hire a Coach to auto-tap."),200); }
        }
      });

      // Coach / Lv.2 cap
      const coachBtn=id("coach-"+eid);
      coachBtn.addEventListener("click",()=>{
        // Hire
        if(!it.coach){
          if(state.hp<coachCost) return;
          state.hp-=coachCost; it.coach=true; it.coachLevel=1; s_coin();
          startCoach(eid);
          showRibbon(`üßë‚Äçüè´ Coach hired for ${name}!`);
          if(!state.tut.done.coach2){ setTimeout(()=>startTutor("coach2", coachBtn, "Upgrade Coach to Lv.2 to progress."),200); }
          renderAll(); save();
        }else{
          // Upgrade to Lv.2 only
          if((it.coachLevel||1)>=2) return;
          const nextLevel=2;
          const cost=Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
          if(state.hp<cost) return;
          state.hp-=cost; it.coachLevel=2; s_upgrade(); renderAll(); save();
          showRibbon(`‚¨ÜÔ∏è Coach Lv.2 for ${name}`);
        }
      });
    }else{
      id("unlock-"+eid).addEventListener("click",()=>{
        if(state.hp<unlock) return;
        state.hp-=unlock; it.unlocked=true; it.lvl=Math.max(1,it.lvl);
        s_coin(); renderAll(); build(); showRibbon(`‚ú® Unlocked ${name}!`);
      });
      if(affordable){ card.querySelector(".avatarbtn").classList.add("unlockPulse"); }
    }
  });

  /* Big goal teaser */
  const goal = document.createElement("div"); goal.className="card";
  goal.innerHTML = `
    <button type="button" class="avatarbtn locked" disabled>
      <div class="emoji">üèÜ</div>
      <div class="lockOverlay"><span>üîí ${fmtCost(BIG_GOAL.unlockHp)} HP</span></div>
    </button>
    <div class="meta">
      <h3>${BIG_GOAL.name} <span class="sub">‚Ä¢ ${BIG_GOAL.tease}</span></h3>
      <div class="sub">Unlock: <b>${fmtCost(BIG_GOAL.unlockHp)} HP</b></div>
      <div class="bar"><i style="width:${Math.min(100, Math.floor((state.hp/BIG_GOAL.unlockHp)*100))}%"></i></div>
    </div>
    <div class="actions">
      <button class="btn secondary" disabled>Coming Soon</button>
      <button class="btn secondary" id="share2">Tell a friend</button>
    </div>`;
  $("#list").appendChild(goal);
  goal.querySelector("#share2").addEventListener("click",shareProgress);

  updateMissionUI();
}

/* ====== Core loop ====== */
function firstUserInteract(){ if(!isPlaying){ bgm.play().catch(()=>{}); isPlaying=true; ensureAC(); syncMute(); } }

function perform(eid){
  const row=EX.find(r=>r[0]===eid), it=state.items[eid]; if(!row) return;
  const [, , , , gain, interval] = row;
  const t=now(); if(t<tmp[eid].next) return;

  const dur = coachSpeed(interval, it.coachLevel|| (it.coach?1:0));
  tmp[eid].next = t + dur;

  let amt = Math.floor(gain * Math.max(1,it.lvl));
  if(Math.random()<0.05){ const bonus = Math.ceil(amt*0.5); amt += bonus; floatText(id("tap-"+eid), `‚ú® +${fmtCost(bonus)} bonus!`); }

  state.hp += amt; it.taps++;

  // First steps bonus (on walk)
  if(!state.firstSteps.done && eid==="walk"){
    state.firstSteps.taps++;
    if(state.firstSteps.taps===10){
      const gift = 120; state.hp += gift; state.firstSteps.done=true;
      showRibbon(`üëü First Steps bonus: +${fmtCost(gift)} HP`);
    }
  }

  // Bounce emoji
  const tap = id("tap-"+eid);
  tap.classList.remove("animate"); void tap.offsetWidth; tap.classList.add("animate");

  floatText(tap, `+${fmtCost(amt)}`);

  renderAll(); save();
}

/* Coaches loop (Lv.2 cap) */
function startCoach(eid){
  const it=state.items[eid]; if(!it.coach) return;
  stopCoach(eid);
  const tick=()=>{
    const interval = coachSpeed(EX.find(r=>r[0]===eid)[5], it.coachLevel||1);
    perform(eid);
    tmp[eid].timer = setTimeout(tick, interval*1000);
  };
  tmp[eid].timer = setTimeout(tick, 0);
}
function stopCoach(eid){ if(tmp[eid].timer){ clearTimeout(tmp[eid].timer); tmp[eid].timer=null; }}

/* ====== Math & render ====== */
function pack(base,mult,start,count){const a=base*Math.pow(mult,start);return count===1?a:a*(Math.pow(mult,count)-1)/(mult-1)}

function floatText(anchor,text){
  const n=document.createElement("div"); n.textContent=text;
  n.style.position="absolute"; n.style.left="0"; n.style.top="0"; n.style.pointerEvents="none"; n.style.zIndex=1300; n.style.fontWeight="900";
  document.body.appendChild(n);
  const r=anchor.getBoundingClientRect();
  n.style.left=(r.left+r.width/2)+"px"; n.style.top=(r.top-6+window.scrollY)+"px"; n.style.transform="translate(-50%,0)";
  n.animate([{transform:"translate(-50%,0)",opacity:1,color:"#fff"},
             {transform:"translate(-50%,-46px)",opacity:0,color:"#ffdea8"}],
            {duration:820,easing:"ease-out"});
  setTimeout(()=>n.remove(),840)
}

function renderHP(){ id("hp").innerHTML=`${fmtHP(state.hp)} <small>HP</small>`; }

function renderBars(){
  const t=now();
  EX.forEach(([eid,, , , , interval, base, mult, coachCost, unlock])=>{
    const it=state.items[eid];
    const dur = coachSpeed(interval, it.coachLevel || (it.coach?1:0));
    const left=Math.max(0,tmp[eid].next - t);
    const pct = 1 - Math.min(1, left / dur);
    const bar=id("bar-"+eid), tap=id("tap-"+eid);
    if(bar){ bar.style.width = Math.round(pct*100)+"%"; bar.parentElement.classList.toggle('ready', left<=0); }
    if(tap){
      tap.classList.toggle("ready", left<=0);
      tap.classList.toggle("needGlow", left<=0 && !it.coach);
      const card = tap.closest(".card");
      if(card){
        const upBtn=card.querySelector("#up-"+eid);
        const unlockBtn=card.querySelector("#unlock-"+eid);
        const coachBtn=card.querySelector("#coach-"+eid);

        if(unlockBtn){
          const allow = (state.hp>=unlock && !it.unlocked);
          unlockBtn.classList.toggle("glitter", allow);
          unlockBtn.classList.toggle("available", allow);
          if(allow && !state.tut.done.unlock) startTutor("unlock", unlockBtn, "Unlock your next exercise here.");
        }
        if(upBtn){
          const c1 = pack(base, mult, it.lvl, 1);
          const allow = state.hp>=c1;
          upBtn.classList.toggle("glitter", allow);
          upBtn.classList.toggle("available", allow);
          if(allow && !state.tut.done.up) startTutor("up", upBtn, "Upgrade to increase HP per tap.");
        }
        if(coachBtn){
          if(!it.coach){
            const allow = state.hp>=coachCost;
            coachBtn.classList.toggle("glitter", allow);
            coachBtn.classList.toggle("available", allow);
          }else{
            const nextLevel=2;
            const c = Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
            const allow = (it.coachLevel<2) && state.hp>=c;
            coachBtn.classList.toggle("glitter", allow);
            coachBtn.classList.toggle("available", allow);
            if(allow && !state.tut.done.coach2) startTutor("coach2", coachBtn, "Upgrade Coach to Lv.2 to progress.");
          }
          const txt=id("coachTxt-"+eid);
          if(!it.coach){
            txt.textContent = `Hire Coach ‚Ä¢ ${fmtCost(coachCost)} HP`;
            coachBtn.disabled = state.hp<coachCost;
            if(!state.tut.done.coach && state.tut.done.up) startTutor("coach", coachBtn, "Hire a Coach to auto-tap.");
          }else{
            if((it.coachLevel||1)>=2){
              txt.textContent = `Coach Lv.2 (Max)`;
              coachBtn.disabled = true;
            }else{
              const nextLevel=2;
              const c = Math.floor(coachCost*Math.pow(1.7,nextLevel-1));
              txt.textContent = `Coach Lv.${it.coachLevel||1} ‚Ä¢ Upgrade ${fmtCost(c)} HP`;
              coachBtn.disabled = state.hp<c;
            }
          }
        }
      }
    }
  });
  updateMissionUI();
}

function renderButtons(){
  EX.forEach(([eid,, , , gain, , base, mult, coachCost, unlock])=>{
    const it=state.items[eid]; if(!it) return;
    const gEl=id("gain-"+eid); if(gEl) gEl.textContent = fmtCost(gain*Math.max(1,it.lvl));
    const upBtn=id("up-"+eid);
    if(upBtn){
      const cost=pack(base,mult,it.lvl,1);
      upBtn.textContent = `Upgrade | ${fmtCost(cost)} HP`;
      upBtn.disabled = state.hp<cost;
    }
    const unlockBtn=id("unlock-"+eid);
    if(unlockBtn){ unlockBtn.textContent = `Unlock | ${fmtCost(unlock)} HP`; unlockBtn.disabled = state.hp<unlock; }
  });
}
function renderAll(){ renderHP(); renderBars(); renderButtons(); }

/* ====== Mission / Leveling ====== */
function updateMissionUI(){
  const goals = [
    () => state.items["lift"]?.unlocked ? 1 : 0,
    () => Object.values(state.items).some(v=>v.coach && (v.coachLevel||1)>=2) ? 1 : 0
  ];
  const done = goals.reduce((a,f)=>a+f(),0);
  id("mGoal").textContent = `${done}/2`;
  id("mProg").style.width = `${(done/2)*100}%`;
  id("mTitle").textContent = state.level===1 ? "Week 1: Foundation" : `Week ${state.level}`;
  id("mSub").innerHTML = state.level===1
    ? `Goal: Unlock <b>Weight Lifting</b> & any Coach to <b>Lv.2</b>`
    : `New week unlocked! More intense training ahead.`;

  if(done===2 && state.level===1){
    state.level=2; save();
    showRibbon("‚úÖ Week 1 complete ‚Äî Week 2 unlocked!");
  }
}

/* ====== Tutorial (forced) ====== */
function startTutor(which, targetEl, msg){
  if(!targetEl || state.tut.done[which]) return;
  if(state.tut.step && state.tut.step!==which) return; // don't stack
  state.tut.step = which;
  showTutor(msg, targetEl);
}
function completeTutor(which){
  if(state.tut.step!==which) return;
  state.tut.done[which]=true; state.tut.step=null; save();
  id("tutor").classList.remove("on");
}
function showTutor(msg, targetEl){
  const overlay=id("tutor"), card=id("tcard"), finger=id("tfinger");
  targetEl.scrollIntoView({behavior:"smooth", block:"center"});
  setTimeout(()=>{
    const r=targetEl.getBoundingClientRect();
    const x = r.left + r.width/2;
    const y = r.top + window.scrollY + r.height + 24;

    card.textContent = msg;
    const cardTop = (r.top+window.scrollY) - 70;
    card.style.left = Math.max(12, x-140) + "px";
    card.style.top = (cardTop<80? (y+12) : cardTop) + "px";

    finger.style.left = x + "px";
    finger.style.top  = y + "px";

    overlay.classList.add("on");
  }, 180);
}

/* ====== Share ====== */
function shareProgress(){
  const text=`I just hit ${fmtHP(state.hp)} HP in Fitness Frenzy! üí™`;
  const url=location.href;
  if(navigator.share){ navigator.share({title:"Fitness Frenzy", text, url}).catch(()=>{}); }
  else { navigator.clipboard?.writeText(`${text} ${url}`); showRibbon("üîó Link copied ‚Äî go flex!"); }
}
id("share").addEventListener("click",shareProgress);

/* ====== Start / Boot ====== */
function startGame(){
  id('intro')?.classList.add('off');
  document.body.classList.remove('intro-open');
  try{ bgm.play().catch(()=>{}); }catch(e){}
  isPlaying=true; try{ ensureAC(); }catch(e){}
  syncMute();
  if(!state.tut.done.tap) startTutor("tap", id("tap-walk"), "Tap to walk and earn HP!");
}
id("new").onclick=()=>{ if(confirm("Start a new game? This wipes progress.")) { newGame(); } };

function loop(){
  renderBars();
  // If walk ready & tutorial says tap, completing on click happens in perform()
  requestAnimationFrame(loop);
}
function loadAll(){
  load();
  grantOffline();
  dailyStreak();
  build();
  renderAll();
  loop();
}

/* Close tutorials ONLY on the required action */
document.addEventListener("click",(e)=>{
  const step = state.tut.step;
  if(!step) return;

  const targetUnlock = step==="unlock";
  const targetUp = step==="up";
  const targetCoach = step==="coach";
  const targetCoach2 = step==="coach2";
  const targetTap = step==="tap";

  if(targetTap && e.target.closest("#tap-walk")) { completeTutor("tap"); return; }
  if(targetUnlock && e.target.closest("#unlock-jog")) { completeTutor("unlock"); return; }
  if(targetUp && e.target.closest("#up-walk")) { completeTutor("up"); return; }
  if(targetCoach && e.target.closest("#coach-walk")) { completeTutor("coach"); return; }
  if(targetCoach2 && e.target.closest("#coach-walk")) {
    // Only complete when Lv.2 achieved
    const it = state.items["walk"];
    if(it?.coach && (it.coachLevel||1)>=2) completeTutor("coach2");
    return;
  }
}, true);

/* Hook perform to complete 'tap' step */
const _perform = perform;
perform = function(eid){
  _perform(eid);
  if(state.tut.step==="tap" && eid==="walk") completeTutor("tap");
};

/* Music + AudioContext on first pointer (mobile) */
window.addEventListener("pointerdown",()=>{ ensureAC(); if(!isPlaying){ bgm.play().catch(()=>{}); isPlaying=true; syncMute(); } }, {once:true});

loadAll();
</script>
</body>
</html>
