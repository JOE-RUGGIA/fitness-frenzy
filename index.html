<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy – V2.4 (Long Cooldowns + Bulletproof SFX Resume)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
  :root{
    --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#a7b7cc; --border:#213149;
    --accent:#cc6b2c; --accent-hi:#ffb357; --rep:#22c55e;
    --space:clamp(10px,2.2vw,18px); --r:16px;
    --fs-1:clamp(16px,2.4vw,18px); --fs-2:clamp(18px,3.2vw,22px); --fs-3:clamp(22px,5vw,28px);
    --repband:16%;
  }
  *{box-sizing:border-box}
  html,body{height:100%; touch-action:manipulation;}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);
       padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0;}
  button,.tapPad{-webkit-user-select:none;user-select:none;touch-action:manipulation;}

  .topbar{position:sticky;top:0;z-index:10;background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .title{display:flex;align-items:center;gap:10px}
  .title .icon{font-size:clamp(22px,5vw,28px)}
  h1{margin:0;font-size:var(--fs-3)}

  .hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;
          background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;
          box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04)}
  .hpPill .label{font-weight:900;letter-spacing:.3px;color:var(--accent)}
  .hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);
               width:10ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}

  .spacer{flex:1 1 auto}
  .seg{display:inline-flex;border:1px solid #2b3d5a;border-radius:10px;overflow:hidden}
  .segBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}
  .segBtn.active{background:var(--accent);color:#fff}
  .segBtn:active{transform:translateY(1px)}

  .btn{position:relative;overflow:hidden;padding:10px 14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;
       transition:transform .04s ease,box-shadow .2s ease,filter .2s ease}
  .btn.secondary{background:#1a2a40;color:#d7e3f5}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{background:#2a3a51;color:#9ab;cursor:not-allowed}
  .btn.ready{box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 8px 20px rgba(204,107,44,.35);filter:saturate(1.15) brightness(1.08)}
  .btn.ready::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.18) 45%,transparent 90%);
                    transform:translateX(-110%);animation:shine 1.25s linear infinite;pointer-events:none}
  @keyframes shine{to{transform:translateX(110%)}}

  .wrap{max-width:980px;margin:0 auto;padding:var(--space)}
  .stack{display:flex;flex-direction:column;gap:var(--space)}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:var(--space);
        display:flex;gap:14px;align-items:stretch;transition:transform .18s ease,filter .18s ease,opacity .18s ease, box-shadow .18s ease}
  .card.locked{opacity:.58;filter:grayscale(1);transform:scale(.90)}
  .card.unlock-ready{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 14px 30px rgba(204,107,44,.28),0 0 24px rgba(204,107,44,.25)}
  .card.unlock-bounce{animation:bob 1.1s ease-in-out infinite}
  @keyframes bob{0%{transform:translateY(0) scale(.90)}50%{transform:translateY(-2px) scale(.905)}100%{transform:translateY(0) scale(.90)}}

  .tapPad{position:relative;width:clamp(72px,14vw,110px);aspect-ratio:1/1;border-radius:16px;
          background:#12243b;border:1px solid #1a2f4a;display:flex;align-items:center;justify-content:center;
          font-size:clamp(38px,11vw,64px);cursor:pointer;overflow:visible}
  .tapPad:active{transform:translateY(1px) scale(.98);filter:brightness(1.08)}

  .lvl{position:absolute;left:6px;top:6px;font-size:12px;font-weight:900;color:#fff;
       background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;border-radius:8px;
       padding:2px 6px;box-shadow:0 4px 12px rgba(0,0,0,.25)}

  .repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#15341f;border-top:1px solid #204e2b;
           border-bottom-left-radius:16px;border-bottom-right-radius:16px;overflow:hidden}
  .repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep));
           border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  .repLabel{position:absolute;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cfead6;text-shadow:0 1px 0 rgba(0,0,0,.5)}

  .float{position:fixed;left:50%;top:10%;transform:translateX(-50%);color:#ffe6c7;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.6);
         animation:rise .9s ease-out forwards;pointer-events:none;z-index:1000}
  @keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}

  .right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
  .ex-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ex-title{font-size:var(--fs-2);margin:0}
  .muted{color:#a7b7cc}

  .coolwrap{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
  .coolbar{height:16px;background:#101a2a;position:relative}
  .coolfill{height:100%;width:0%;position:relative;background:linear-gradient(90deg,var(--accent) 0%, var(--accent-hi) 92%)}
  .coolfill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,.16) 0 6px, transparent 6px 12px);
                   mix-blend-mode:overlay;opacity:.65;animation:stripeMove 1.2s linear infinite}
  @keyframes stripeMove{from{background-position:0 0}to{background-position:60px 0}}

  .kv{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:6px 10px;border-radius:10px;font-size:14px}
  .metaRow{display:flex;align-items:center;gap:10px;justify-content:space-between}

  .costLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .costPill{display:inline-flex;align-items:center;gap:8px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#ffd6a8;
            background:#142743;border:1px solid #27456d;padding:8px 14px;border-radius:999px;transition:transform .06s ease,filter .2s ease,box-shadow .2s ease,background .2s ease;cursor:not-allowed}
  .costPill.ready{color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-hi));border-color:#e89d6b;
                  box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 12px 26px rgba(204,107,44,.35);animation:bob 1.1s ease-in-out infinite}
  .costPill:active{transform:translateY(1px) scale(.985)}

  .banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);
          color:#fff;border-top:1px solid #2a4a78;padding:12px 16px calc(12px + env(safe-area-inset-bottom));border-radius:0;
          box-shadow:0 -10px 24px rgba(0,0,0,.35);opacity:0;z-index:30;pointer-events:none;display:flex;gap:8px;align-items:center;justify-content:center;text-align:center;
          animation:bannerIn .22s ease-out forwards, bannerOut .9s ease-in forwards 2.6s}
  @keyframes bannerIn{to{opacity:1; transform:translateY(0)}}
  @keyframes bannerOut{to{opacity:0; transform:translateY(8px)}}
</style>
</head>
<body>
<div class="topbar">
  <div class="topwrap">
    <div class="title"><span class="icon">💪</span><h1>Fitness Frenzy</h1></div>
    <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0</span></div>
    <div class="spacer"></div>
    <div class="seg" id="qtyTop"><button class="segBtn active" data-q="1">×1</button><button class="segBtn" data-q="10">×10</button></div>
    <button id="saveBtn" class="btn secondary">Save</button>
    <button id="resetBtn" class="btn secondary">Reset</button>
  </div>
</div>

<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<script>
/* ===== Data / Config ===== */
const VERSION='ff-v2-4';
const SAVE_KEY='fitness_frenzy_ff-v2-2'; // keep persistence
const REP_GROWTH = 1.07;
const BANNER_STAY_MS = 3800;
let BUY_QTY = 1;

/* Model with new cooldowns (ms) */
const exercises = [
  { id:'walk', name:'Walking', icon:'🚶', baseHP:1,   baseCooldown:   600,  // 0.60s
    repHP:0, repProgress:0, repTarget:10, repBaseCost:4,   level:1, unlocked:true,  unlockCost:0,
    cooldown:   600, lastTapAt:-Infinity, _repReady:false, _unlockReady:false, els:{} },

  { id:'jog',  name:'Jogging', icon:'🏃', baseHP:60,  baseCooldown:180000,  // 3 minutes
    repHP:0, repProgress:0, repTarget:10, repBaseCost:30,  level:1, unlocked:false, unlockCost:60,
    cooldown:180000, lastTapAt:-Infinity, _repReady:false, _unlockReady:false, els:{} },

  { id:'sit',  name:'Sit-ups', icon:'🧘', baseHP:180, baseCooldown:360000,  // 6 minutes
    repHP:0, repProgress:0, repTarget:10, repBaseCost:90,  level:1, unlocked:false, unlockCost:300,
    cooldown:360000, lastTapAt:-Infinity, _repReady:false, _unlockReady:false, els:{} },

  { id:'push', name:'Push-ups', icon:'💪', baseHP:400, baseCooldown:720000,  // 12 minutes
    repHP:0, repProgress:0, repTarget:10, repBaseCost:200, level:1, unlocked:false, unlockCost:1200,
    cooldown:720000, lastTapAt:-Infinity, _repReady:false, _unlockReady:false, els:{} },
];

const state = { hp:0 };

/* ===== Utils ===== */
const fmtTop = n => n>=1e9?(n/1e9).toFixed(2)+'B' : n>=1e6?(n/1e6).toFixed(2)+'M' : n>=1e3?(n/1e3).toFixed(2)+'K' : Math.floor(n).toString();
const fmtCost = n => n<1e3 ? n.toFixed(2) : (n<1e6 ? (n/1e3).toFixed(2)+'K' : (n<1e9 ? (n/1e6).toFixed(2)+'M' : (n/1e9).toFixed(2)+'B'));
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const perTap = e => e.baseHP + e.repHP;
const cooldownMs = e => e.cooldown;
const canTap = (e, now)=> (now - e.lastTapAt) >= cooldownMs(e) - 1;

/* ===== Audio with bulletproof resume ===== */
let audioCtx=null, audioNeedsUnlock=true;
function ensureAudioCtx(){
  if(!audioCtx || audioCtx.state==='closed'){
    try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    catch{ audioCtx = null; }
  }
  if(audioCtx && audioCtx.state==='suspended'){
    audioCtx.resume().catch(()=>{});
  }
}
function unlockAudio(){
  ensureAudioCtx();
  if(!audioCtx) return;
  // Play a 1-frame silent buffer to fully unlock audio on iOS/Android
  try{
    const buf = audioCtx.createBuffer(1, 1, 22050);
    const src = audioCtx.createBufferSource();
    src.buffer = buf; src.connect(audioCtx.destination); src.start(0);
  }catch{}
  if(audioCtx.state!=='running'){
    audioCtx.resume().catch(()=>{});
  }
  audioNeedsUnlock=false;
}
function sfx(type){
  try{
    ensureAudioCtx(); if(!audioCtx) return;
    if(audioCtx.state!=='running'){ audioNeedsUnlock=true; return; } // will unlock on next gesture
    const t=audioCtx.currentTime;
    const beep=(f,type='sine',dur=.22,vol=.07)=>{
      const o=audioCtx.createOscillator(); o.type=type; o.frequency.setValueAtTime(f,t);
      const g=audioCtx.createGain(); g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
      o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+dur);
    };
    if(type==='tap')      beep(660,'sine',.12,.06);
    if(type==='buy')      beep(440,'sine',.18,.08);
    if(type==='upgrade'){ beep(520,'sine',.2,.08); const o=audioCtx.createOscillator(), g=audioCtx.createGain();
                          o.type='sine'; g.gain.setValueAtTime(.06,t); g.gain.exponentialRampToValueAtTime(.0001,t+.22);
                          o.frequency.setValueAtTime(520,t); o.frequency.exponentialRampToValueAtTime(880,t+.18);
                          o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+.24);}
    if(type==='ready'){   beep(760,'triangle',.16,.06); setTimeout(()=>beep(980,'triangle',.14,.05), 60); }
  }catch{}
}
/* Set/clear unlock flag around lifecycle transitions */
['visibilitychange','pagehide','freeze'].forEach(ev=>document.addEventListener(ev, ()=>{
  if(document.visibilityState==='hidden' || ev!=='visibilitychange'){ audioNeedsUnlock=true; }
}));
['pageshow','focus'].forEach(ev=>window.addEventListener(ev, ()=>{ audioNeedsUnlock=true; ensureAudioCtx(); }));
/* Unlock on any user gesture (capture to always see it) */
['pointerdown','touchstart','mousedown','click','keydown'].forEach(ev=>{
  window.addEventListener(ev, ()=>{
    if(audioNeedsUnlock || (audioCtx && audioCtx.state!=='running')) unlockAudio();
  }, {capture:true, passive:true});
});

/* ===== Persistence ===== */
function save(){
  localStorage.setItem(SAVE_KEY, JSON.stringify({
    hp: state.hp,
    exercises: exercises.map(e=>({
      id:e.id, repHP:e.repHP, repProgress:e.repProgress, repTarget:e.repTarget,
      unlocked:e.unlocked, cooldown:e.cooldown, level:e.level
    }))
  }));
}
function load(){
  const raw=localStorage.getItem(SAVE_KEY); if(!raw) return;
  try{
    const s=JSON.parse(raw); state.hp = s.hp ?? 0;
    if(Array.isArray(s.exercises)){
      for(const se of s.exercises){
        const e = exercises.find(x=>x.id===se.id); if(!e) continue;
        if(se.repPower!==undefined && e.repHP===0){ e.repHP = se.repPower; }
        e.repHP       = se.repHP ?? e.repHP;
        e.repProgress = se.repProgress ?? e.repProgress;
        e.repTarget   = se.repTarget ?? e.repTarget;
        e.unlocked    = se.unlocked ?? e.unlocked;
        e.cooldown    = se.cooldown ?? e.baseCooldown;
        e.level       = se.level ?? e.level ?? 1;
      }
    }
  }catch{}
}

/* ===== UI Build ===== */
const ui = {
  hp: document.getElementById('hp'),
  saveBtn: document.getElementById('saveBtn'),
  resetBtn: document.getElementById('resetBtn'),
  qtyTop: document.getElementById('qtyTop'),
  stack: document.getElementById('stack'),
  bannerHost: document.getElementById('bannerHost')
};

function makeExerciseCard(e){
  const card = document.createElement('div'); card.className='card'+(e.unlocked?'':' locked');

  const tapPad = document.createElement('div'); tapPad.className='tapPad'; tapPad.textContent = e.icon;
  const lvl = document.createElement('div'); lvl.className='lvl'; lvl.textContent = `Lvl ${e.level}`; tapPad.appendChild(lvl);

  const repBand = document.createElement('div'); repBand.className='repBand';
  repBand.innerHTML = `<div class="repFill"></div><div class="repLabel">0/10</div>`; tapPad.appendChild(repBand);

  const right = document.createElement('div'); right.className='right';

  const head = document.createElement('div'); head.className='ex-head';
  head.innerHTML = `<div class="ex-title">${e.name}</div><div class="muted headRight"></div>`;

  const coolWrap = document.createElement('div'); coolWrap.className='coolwrap';
  coolWrap.innerHTML = `<div class="coolbar"><div class="coolfill"></div></div>`;

  const metaRow = document.createElement('div'); metaRow.className='metaRow';
  const kvs = document.createElement('div'); kvs.innerHTML = `<span class="kv">Per Tap: <strong class="kvTap">${perTap(e).toFixed(0)}</strong> HP</span>`;
  const buyRepBtn = document.createElement('button'); buyRepBtn.className='btn'; buyRepBtn.textContent='Add Reps';
  metaRow.appendChild(kvs); metaRow.appendChild(buyRepBtn);

  const costLine = document.createElement('div'); costLine.className='costLine';
  costLine.innerHTML = `<button class="costPill" type="button">Unlock for <span class="costAmt">${fmtCost(e.unlockCost)}</span> HP</button>`;
  const costPill = costLine.querySelector('.costPill');

  right.appendChild(head); right.appendChild(coolWrap); right.appendChild(metaRow); right.appendChild(costLine);
  card.appendChild(tapPad); card.appendChild(right);

  e.els = { card, tapPad, lvl,
    repFill: repBand.querySelector('.repFill'), repLabel: repBand.querySelector('.repLabel'),
    headRight: head.querySelector('.headRight'), coolFill: coolWrap.querySelector('.coolfill'),
    kvTap: kvs.querySelector('.kvTap'), buyRepBtn, costLine, costPill, costAmt: costLine.querySelector('.costAmt'),
    coolWrap, metaRow, kvs
  };

  if(e.unlocked){ costLine.style.display='none'; } else { coolWrap.style.display='none'; metaRow.style.display='none'; }

  bindPress(tapPad, ()=>{ unlockAudio(); tap(e); });
  bindPress(buyRepBtn, ()=> addReps(e, BUY_QTY));
  costPill.addEventListener('click', ()=>{
    if(!e.unlocked && state.hp >= e.unlockCost){
      state.hp -= e.unlockCost; e.unlocked = true; sfx('buy');
      e.els.card.classList.remove('locked','unlock-ready','unlock-bounce');
      e.els.coolWrap.style.display='block'; e.els.metaRow.style.display='flex'; e.els.costLine.style.display='none';
      burstConfetti(e.els.card);
      refreshExerciseUI(e); renderTop();
    }
  });

  return card;
}

function renderStack(){ ui.stack.innerHTML=''; exercises.forEach(e=>{ ui.stack.appendChild(makeExerciseCard(e)); refreshExerciseUI(e); }); }

/* Global qty toggle */
[...ui.qtyTop.querySelectorAll('.segBtn')].forEach(btn=>{
  btn.addEventListener('pointerdown', ev=>{
    ev.preventDefault();
    [...ui.qtyTop.querySelectorAll('.segBtn')].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); BUY_QTY = parseInt(btn.dataset.q,10); exercises.forEach(refreshExerciseUI);
  }, {passive:false});
});

/* ===== UI Updates ===== */
function refreshExerciseUI(e){
  // Cooldown label: show full when ready; after tap count 0 -> full
  if(e.unlocked){
    const cd = cooldownMs(e), now = performance.now(), since = now - e.lastTapAt, ready = since >= cd;
    const shown = ready ? cd : since;
    e.els.headRight.textContent = (Math.max(0, Math.min(cd, shown))/1000).toFixed(2)+'s';
  } else { e.els.headRight.textContent = ''; }

  e.els.repLabel.textContent = `${e.repProgress}/${e.repTarget}`;
  e.els.repFill.style.width = (Math.min(e.repProgress / e.repTarget, 1)*100).toFixed(1)+'%';
  e.els.lvl.textContent = `Lvl ${e.level}`;

  if(e.unlocked){
    e.els.coolWrap.style.display='block'; e.els.metaRow.style.display='flex'; e.els.costLine.style.display='none';
    e.els.kvTap.textContent = perTap(e).toFixed(0);
    const cost = bulkRepCost(e, BUY_QTY), canBuy = state.hp >= cost;
    e.els.buyRepBtn.textContent = (BUY_QTY===1 ? `Add Reps (${fmtCost(cost)} HP)` : `Add ${BUY_QTY} Reps (${fmtCost(cost)} HP)`);
    e.els.buyRepBtn.disabled = !canBuy;
    if(canBuy && !e._repReady){ e._repReady=true; e.els.buyRepBtn.classList.add('ready'); sfx('ready'); }
    if(!canBuy && e._repReady){ e._repReady=false; e.els.buyRepBtn.classList.remove('ready'); }
  }else{
    e.els.coolWrap.style.display='none'; e.els.metaRow.style.display='none'; e.els.costLine.style.display='flex';
    e.els.costAmt.textContent = fmtCost(e.unlockCost);
    const canUn = state.hp >= e.unlockCost;
    if(canUn && !e._unlockReady){ e._unlockReady=true; e.els.card.classList.add('unlock-ready','unlock-bounce'); e.els.costPill.classList.add('ready'); sfx('ready'); }
    if(!canUn && e._unlockReady){ e._unlockReady=false; e.els.card.classList.remove('unlock-ready','unlock-bounce'); e.els.costPill.classList.remove('ready'); }
  }
}

function renderTop(){ ui.hp.textContent = fmtTop(state.hp); }
function refreshAll(){ renderTop(); exercises.forEach(refreshExerciseUI); }

/* ===== Economy ===== */
function bulkRepCost(e, qty){
  const base = e.repBaseCost * Math.pow(REP_GROWTH, e.repHP);
  const cost = base * (Math.pow(REP_GROWTH, qty) - 1) / (REP_GROWTH - 1);
  return +cost.toFixed(2);
}
function addReps(e, qty=1){
  if(!e.unlocked) return;
  const cost = bulkRepCost(e, qty); if(state.hp + 1e-9 < cost) return;
  state.hp -= cost; e.repHP += qty; e.repProgress += qty; sfx('buy'); handleUpgrades(e); refreshAll();
}
function handleUpgrades(e){
  let upgraded=false;
  while(e.repProgress >= e.repTarget){
    e.repProgress -= e.repTarget; e.repTarget *= 2; e.cooldown = Math.max(100, Math.floor(e.cooldown/2));
    e.level += 1; upgraded = true;
  }
  if(upgraded){ showBanner(`${e.name} upgraded to Lvl ${e.level}! Speed ×2 (cooldown halved)`); sfx('upgrade'); }
}

/* ===== Tapping, Floats & Cooldown ===== */
function tap(e){
  const now=performance.now(); if(!e.unlocked || !canTap(e, now)) return;
  e.lastTapAt = now; const gain = perTap(e); state.hp += gain; sfx('tap'); spawnFloat(e, `+${gain.toFixed(0)}`); refreshAll();
}
function spawnFloat(e, text){
  const rect = e.els.tapPad.getBoundingClientRect(); const span=document.createElement('div');
  span.className='float'; span.textContent=text;
  const jitter = (Math.random()*16 - 8)|0;
  span.style.left = (rect.left + rect.width/2 + jitter) + 'px';
  span.style.top  = (rect.top + rect.height*0.1) + 'px';
  document.body.appendChild(span); setTimeout(()=>span.remove(), 950);
}
function updateCooldownUI(e){
  if(!e.unlocked) return;
  const cd = cooldownMs(e), now = performance.now(), since = now - e.lastTapAt, pct = clamp(since/cd,0,1);
  e.els.coolFill.style.width = (pct*100).toFixed(1)+'%'; // 0 → 100% during cooldown
}

/* ===== Confetti & Banner ===== */
function burstConfetti(card){
  const rect = card.getBoundingClientRect();
  const container = document.createElement('div');
  container.style.position='fixed'; container.style.left=rect.left+'px'; container.style.top=rect.top+'px';
  container.style.width=rect.width+'px'; container.style.height=rect.height+'px'; container.style.pointerEvents='none'; container.style.zIndex=9999;
  document.body.appendChild(container);
  const colors=['#ffb357','#cc6b2c','#22c55e','#8ab4ff','#ffd166'], N = 36;
  for(let i=0;i<N;i++){
    const p=document.createElement('div'); p.style.position='absolute'; p.style.width='6px'; p.style.height='10px';
    p.style.left='50%'; p.style.top='50%'; p.style.transform='translate(-50%,-50%)';
    p.style.background=colors[i%colors.length]; p.style.borderRadius='2px';
    const angle = Math.random()*2*Math.PI, dist = 40 + Math.random()*80, dx = Math.cos(angle)*dist, dy = Math.sin(angle)*dist, rot=(Math.random()*360)|0;
    p.animate([{ transform:`translate(-50%,-50%) translate(0,0) rotate(0deg)`, opacity:1 },
               { transform:`translate(-50%,-50%) translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0 }],
               { duration: 700 + Math.random()*400, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' });
    container.appendChild(p);
  }
  setTimeout(()=>container.remove(), 1200);
}
function showBanner(text){
  const host = document.getElementById('bannerHost'); const el = document.createElement('div');
  el.className='banner'; el.innerHTML = `🎉 <strong>${text}</strong>`; host.appendChild(el);
  setTimeout(()=> el.remove(), BANNER_STAY_MS);
}

/* ===== Loop, Bind, Boot ===== */
function tick(){
  exercises.forEach(updateCooldownUI);
  if(!tick._t || performance.now()-tick._t>100){ exercises.forEach(refreshExerciseUI); tick._t=performance.now(); }
  requestAnimationFrame(tick);
}
function bindPress(el, fn){
  el.addEventListener('pointerdown', e=>{ e.preventDefault(); fn(e); }, {passive:false});
  el.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); fn(e);} });
}
document.getElementById('saveBtn').addEventListener('click', save);
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(!confirm('Reset your progress?')) return; localStorage.removeItem(SAVE_KEY); location.reload(); });

/* Double-tap zoom prevention */
let lastTouchEnd=0;
document.addEventListener('touchend', (e)=>{ const now = Date.now(); if(now - lastTouchEnd <= 300){ e.preventDefault(); } lastTouchEnd = now; }, {passive:false});
document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {passive:false});
document.addEventListener('gesturestart', (e)=>{ e.preventDefault(); }, {passive:false});

function boot(){ load(); renderTop(); renderStack(); tick(); setInterval(save, 20000); }
boot();
</script>
</body>
</html>