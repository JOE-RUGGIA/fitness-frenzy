<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy â€“ V3.6-clean</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{
  --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#a7b7cc; --border:#213149;
  --accent:#cc6b2c; --accent-hi:#ffb357; --rep:#22c55e; --warn:#39d98a;
  --space:clamp(10px,2.2vw,18px); --r:16px; --fs-2:clamp(18px,3.2vw,22px); --repband:16%;
}
*{box-sizing:border-box}
html,body{height:100%; touch-action:manipulation;}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);
     padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0;}
button,.tapPad{-webkit-user-select:none;user-select:none;touch-action:manipulation}

/* Sticky Top Bar */
.topbar{position:sticky;top:0;z-index:60;background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap;overflow:visible}
.title{display:flex;align-items:center;gap:10px}
.title .icon{font-size:clamp(22px,5vw,28px)}
h1{margin:0;font-size:clamp(22px,5vw,28px)}

/* HP pill */
.hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;
        background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;
        box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04)}
.hpPill .label{font-weight:900;letter-spacing:.3px;color:var(--accent)}
.hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);
             width:11ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}
.hpPill.small{transform:scale(.9); transform-origin:right center}

/* Buttons */
.spacer{flex:1}
.seg{display:inline-flex;border:1px solid #2b3d5a;border-radius:10px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}
.segBtn.active{background:var(--accent);color:#fff}
.btn{position:relative;overflow:hidden;padding:10px 14px;border:none;border-radius:12px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.btn.secondary{background:#1a2a40;color:#d7e3f5}
.btn.ghost{background:#13233b;color:#cfe0ff;border:1px solid #2b3d5a}
.btn.ready{box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 8px 20px rgba(204,107,44,.35)}
.btn.ready::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.18) 45%,transparent 90%);
                  transform:translateX(-110%);animation:shine 1.25s linear infinite;pointer-events:none}
.btn[disabled]{filter:saturate(.65) brightness(.85)}
@keyframes shine{to{transform:translateX(110%)}}

/* Menu dot (outside corner) */
#menuBtn{position:relative}
.notifDot{position:absolute;right:-10px;top:-10px;width:14px;height:14px;border-radius:50%;
          display:none;background:var(--warn);box-shadow:0 0 0 2px rgba(10,19,32,.95);pointer-events:none;z-index:10}
.notifDot.show{display:block}

/* Layout */
.wrap{max-width:980px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:var(--space);
      display:flex;gap:14px;align-items:stretch;transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.90)}
.card.unlock-ready{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 14px 30px rgba(204,107,44,.28),0 0 24px rgba(204,107,44,.25)}
.card.unlock-bounce{animation:bob 1.1s ease-in-out infinite}
@keyframes bob{0%{transform:translateY(0) scale(.90)}50%{transform:translateY(-2px) scale(.905)}100%{transform:translateY(0) scale(.90)}}

/* Tap pad */
.tapPad{position:relative;width:clamp(72px,14vw,110px);aspect-ratio:1/1;border-radius:var(--r);
        background:#12243b;border:1px solid #1a2f4a;display:flex;align-items:center;justify-content:center;
        font-size:clamp(38px,11vw,64px);cursor:pointer;overflow:visible}
.lvl{position:absolute;left:6px;top:6px;font-size:12px;font-weight:900;color:#fff;
     background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;border-radius:8px;padding:2px 6px}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#15341f;border-top:1px solid #204e2b;
         border-bottom-left-radius:var(--r);border-bottom-right-radius:var(--r);overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repLabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cfead6}

/* +HP float */
.float{position:fixed;color:#ffe6c7;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.6);
       transform:translate(-50%,-10px);animation:rise .9s ease-out forwards;pointer-events:none;z-index:1000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}

/* Right column */
.right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
.ex-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ex-title{font-size:var(--fs-2);margin:0}
.muted{color:#a7b7cc}
.coachSlotTop{display:flex;flex-wrap:wrap;gap:8px}
.coachChip{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-size:12px}

/* Cooldown */
.coolwrap{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolbar{height:16px;background:#101a2a;position:relative}
.coolfill{height:100%;width:0%;position:relative;background:linear-gradient(90deg,var(--accent) 0%, var(--accent-hi) 92%)}
.coolfill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,.16) 0 6px, transparent 6px 12px);
                 mix-blend-mode:overlay;opacity:.65;animation:stripeMove 1.2s linear infinite}
@keyframes stripeMove{from{background-position:0 0}to{background-position:60px 0}}

/* One-row meta under cooldown */
.metaRow{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.kv{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:6px 10px;border-radius:10px;font-size:14px}

/* Unlock pill */
.costLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.costPill{display:inline-flex;align-items:center;gap:8px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#ffd6a8;
          background:#142743;border:1px solid #27456d;padding:8px 14px;border-radius:999px;cursor:not-allowed}
.costPill.ready{color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-hi));border-color:#e89d6b;
                box-shadow:0 12px 26px rgba(204,107,44,.35)}

/* Banner (upgrade) */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);
        color:#fff;border-top:1px solid #2a4a78;padding:12px 16px calc(12px + env(safe-area-inset-bottom));opacity:0;z-index:3000;
        display:flex;gap:8px;align-items:center;justify-content:center;text-align:center;
        animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.6s}
@keyframes bannerIn{to{opacity:1; transform:translateY(0)}}
@keyframes bannerOut{to{opacity:0; transform:translateY(8px)}}

/* ===== MENU ===== */
.menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:5000;display:none;align-items:flex-end;justify-content:center}
.menuOverlay.open{display:flex}
.menuPanel{width:min(980px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:16px 16px 0 0;
           box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden}
.menuHeader{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.menuTitle{font-weight:900;font-size:20px}
.menuTabs{display:flex;gap:8px;padding:8px var(--space);border-bottom:1px solid var(--border);flex-wrap:wrap}
.menuTab{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.menuTab.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.menuBody{padding:14px var(--space);overflow:auto}

/* Coaches */
.coachIntro{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:14px}
.coachList{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:700px){ .coachList{grid-template-columns:1fr 1fr;} }
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.headshot{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:40px;border-radius:12px;background:#12243b;border:1px solid #1a2f4a}
.coachMid{flex:1;min-width:0}
.coachName{font-weight:900}
.coachInfo{color:#a7b7cc;font-size:14px;margin-top:2px}
.coachRight{display:flex;align-items:center}
.hireBtn{padding:12px 18px;font-size:16px;border-radius:12px}
.hireBtn.secondary{background:#1a2a40;color:#d7e3f5}
.hireBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
</style>
</head>
<body>
  <!-- Sticky Top Bar -->
  <div class="topbar">
    <div class="topwrap">
      <div class="title"><span class="icon">ðŸ’ª</span><h1>Fitness Frenzy</h1></div>
      <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0.0</span></div>
      <div class="spacer"></div>
      <button id="menuBtn" class="btn ghost">Menu<span id="menuDot" class="notifDot"></span></button>
      <div class="seg" id="qtyTop"><button class="segBtn active" data-q="1">Ã—1</button><button class="segBtn" data-q="10">Ã—10</button></div>
      <button id="saveBtn" class="btn secondary">Save</button>
      <button id="resetBtn" class="btn secondary">Reset</button>
    </div>
  </div>

  <div class="wrap"><div id="stack" class="stack"></div></div>
  <div id="bannerHost"></div>

  <!-- Menu -->
  <div id="menuOverlay" class="menuOverlay" aria-hidden="true">
    <div class="menuPanel" role="dialog" aria-modal="true">
      <div class="menuHeader">
        <div class="menuTitle">Menu</div>
        <div class="spacer"></div>
        <div class="hpPill small"><span class="label">HP:</span><span id="hpMenu" class="val">0.0</span></div>
        <button id="menuClose" class="btn secondary">Close</button>
      </div>
      <div class="menuTabs">
        <button class="menuTab active" data-tab="coaches">Coaches</button>
        <button class="menuTab" data-tab="upgrades">Upgrades</button>
        <button class="menuTab" data-tab="achievements">Achievements</button>
        <button class="menuTab" data-tab="quests">Side Quests</button>
        <button class="menuTab" data-tab="shop">Shop</button>
        <button class="menuTab" data-tab="stats">Stats</button>
      </div>
      <div class="menuBody">
        <div id="tab-coaches"></div>
        <div id="tab-upgrades" style="display:none"><p>Upgrades coming soon.</p></div>
        <div id="tab-achievements" style="display:none"><p>Achievements coming soon.</p></div>
        <div id="tab-quests" style="display:none"><p>Side Quests coming later.</p></div>
        <div id="tab-shop" style="display:none"><p>Shop coming soon.</p></div>
        <div id="tab-stats" style="display:none"><p>Stats placeholder.</p></div>
      </div>
    </div>
  </div>

<script>
/* ================= Core App ================= */
const App = {};

/* Util */
App.Util = (()=> {
  const fmtTop = (n)=>{
    const abs = Math.abs(n);
    if (abs >= 1e9) return (n/1e9).toFixed(1)+'B';
    if (abs >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (abs >= 1e3) return (n/1e3).toFixed(1)+'K';
    return n.toFixed(1);
  };
  const fmtCost = (n)=> n<1e3 ? n.toFixed(2) : (n<1e6 ? (n/1e3).toFixed(2)+'K' : (n<1e9 ? (n/1e6).toFixed(2)+'M' : (n/1e9).toFixed(2)+'B'));
  return { fmtTop, fmtCost };
})();

/* Audio (manual taps only) */
App.Audio = (()=> {
  let audioCtx=null, audioNeedsUnlock=true;
  function ensure(){ if(!audioCtx || audioCtx.state==='closed'){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(audioCtx&&audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{});} }
  function unlock(){ ensure(); if(!audioCtx) return; try{ const b=audioCtx.createBuffer(1,1,22050); const s=audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0);}catch{} if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{});} audioNeedsUnlock=false; }
  function sfx(type){
    try{
      ensure(); if(!audioCtx) return; if(audioCtx.state!=='running'){ audioNeedsUnlock=true; return; }
      const t=audioCtx.currentTime;
      const blip=(f,w='sine',dur=.18,vol=.07)=>{ const o=audioCtx.createOscillator(); o.type=w; o.frequency.setValueAtTime(f,t);
        const g=audioCtx.createGain(); g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+dur); };
      if(type==='tap') blip(660,'sine',.12,.06);
      if(type==='buy') blip(440,'sine',.18,.08);
      if(type==='ready'){ blip(760,'triangle',.16,.06); setTimeout(()=>blip(980,'triangle',.14,.05),60); }
    }catch{}
  }
  ['visibilitychange','pagehide','freeze'].forEach(()=>{ if(document.visibilityState!=='visible') audioNeedsUnlock=true; });
  ['pageshow','focus'].forEach(()=>{ audioNeedsUnlock=true; ensure(); });
  ['pointerdown','touchstart','mousedown','click','keydown'].forEach(ev=>{ window.addEventListener(ev, ()=>{ if(audioNeedsUnlock || (audioCtx && audioCtx.state!=='running')) unlock(); }, {capture:true, passive:true}); });
  return { sfx, unlock };
})();

/* Notif dot */
App.Notif = (()=> {
  const dot = document.getElementById('menuDot');
  const state = { coaches:false };
  function set(section,on=true){ if(section==='coaches'){ state.coaches=!!on; apply(); } }
  function clear(section){ if(section==='coaches'){ state.coaches=false; apply(); } }
  function apply(){ dot.className = 'notifDot' + (state.coaches?' show':''); }
  return { set, clear };
})();

/* State */
App.State = (()=> {
  const KEY='ff-v36-clean-1';
  const s = { hp:0, buyQty:1, exercises:[], coachesOwned:{}, stats:{manualTaps:0, autoTaps:0} };
  function setExercises(list){
    s.exercises = list.map(e=>({ ...e,
      repHP:0, repProgress:0, repTarget:10,
      level:1, cooldown:e.baseCooldown, lastTapAt:0, // 0 means "not tapped yet"
      _autoElapsed:0, _repReady:false, _unlockReady:false, els:{}
    }));
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify({
    hp:s.hp,buyQty:s.buyQty,coachesOwned:s.coachesOwned,stats:s.stats,
    exercises:s.exercises.map(e=>({id:e.id,repHP:e.repHP,repProgress:e.repProgress,repTarget:e.repTarget,unlocked:e.unlocked,cooldown:e.cooldown,level:e.level,lastTapAt:e.lastTapAt}))
  }));}
  function load(){ const raw=localStorage.getItem(KEY); if(!raw) return; try{ const j=JSON.parse(raw);
    s.hp=j.hp??0; s.buyQty=j.buyQty??1; s.coachesOwned=j.coachesOwned||{}; s.stats=j.stats||s.stats; s.__loaded=j.exercises||[];
  }catch{}}
  function merge(){ if(!s.__loaded) return; for(const se of s.__loaded){ const e=s.exercises.find(x=>x.id===se.id); if(!e) continue;
    e.repHP=se.repHP??0; e.repProgress=se.repProgress??0; e.repTarget=se.repTarget??10; e.unlocked=se.unlocked??e.unlocked;
    e.cooldown=se.cooldown??e.baseCooldown; e.level=se.level??1; e.lastTapAt=se.lastTapAt??0; } delete s.__loaded; }
  return { s, setExercises, save, load, merge };
})();

/* Economy */
App.Economy = (()=> {
  const G=1.12; // 12% growth (your â€œharder after coachâ€ balance)
  const perTap = e => e.baseHP + e.repHP;  // +1 HP per rep (no doubling)
  const bulkRepCost=(e,q)=>{ const base=e.repBaseCost*Math.pow(G,e.repHP); return +(base*(Math.pow(G,q)-1)/(G-1)).toFixed(2); };
  function addReps(e,q){
    const s=App.State.s; const cost=bulkRepCost(e,q);
    if(s.hp+1e-9<cost) return false;
    s.hp-=cost; e.repHP+=q; e.repProgress+=q;
    while(e.repProgress>=e.repTarget){
      e.repProgress-=e.repTarget; e.repTarget*=2;
      e.cooldown=Math.max(100, Math.floor(e.cooldown/2)); // halves each upgrade
      e.level+=1;
      App.UI.Overlay.showBanner(`${e.name} upgraded to Lvl ${e.level}! Speed Ã—2`);
    }
    return true;
  }
  function tap(e,now=performance.now()){
    if(!e.unlocked) return 0;
    const cd=e.cooldown; if(e.lastTapAt>0 && now-e.lastTapAt < cd-1) return 0;
    e.lastTapAt=now; const g=perTap(e); const S=App.State.s; S.hp+=g; S.stats.manualTaps++; return g;
  }
  return { perTap, bulkRepCost, addReps, tap };
})();

/* Engine (tick + auto taps with cooldown) */
App.Engine = (()=> {
  let last=performance.now();
  function start(updateCooldown, refreshUI){
    function tick(){
      const now=performance.now(), dt=Math.min(0.25,(now-last)/1000); last=now;
      autoTap(now, dt);              // coaches trigger real taps
      App.UI.Renderer.tickTop(dt);   // smooth HP display (top + menu)
      for(const e of App.State.s.exercises) updateCooldown(e);
      if(!tick._u || now-tick._u>100){ for(const e of App.State.s.exercises) refreshUI(e); tick._u=now; }
      requestAnimationFrame(tick);
    } requestAnimationFrame(tick);
  }
  function autoTap(now, dt){
    const s=App.State.s;
    for(const e of s.exercises){
      if(!App.Coaches.isAuto(e.id)) continue;
      e._autoElapsed += dt*1000;
      const cd = Math.max(100, e.cooldown);
      while(e._autoElapsed >= cd){
        e._autoElapsed -= cd;
        e.lastTapAt = now;
        const g = App.Economy.perTap(e);
        s.hp += g; s.stats.autoTaps++;
        if(!App.UI.Overlay.suppressFloats && e.els.tapPad){ App.UI.Overlay.floatFrom(e.els.tapPad, `+${g.toFixed(0)}`); }
      }
    }
  }
  function bindPress(el,fn){ el.addEventListener('pointerdown',e=>{e.preventDefault();fn(e);},{passive:false});
                             el.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();fn(e);}}); }
  function updateCooldown(e){
    if(!e.unlocked) return;
    const cd=Math.max(100,e.cooldown);
    if(cd<=100){ e.els.coolFill.style.width='100%'; return; }
    const since = (e.lastTapAt<=0) ? cd : (performance.now()-e.lastTapAt);
    const pct=Math.max(0,Math.min(1, since/cd));
    e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';
  }
  function scheduleSave(){ setInterval(()=>App.State.save(),20000); }
  return { start, bindPress, updateCooldown, scheduleSave };
})();

/* Overlay + Banners */
App.UI = {};
App.UI.Overlay = (()=> {
  let suppressFloats = false;
  function showBanner(text){ const host=document.getElementById('bannerHost'); const el=document.createElement('div'); el.className='banner'; el.innerHTML=`ðŸŽ‰ <strong>${text}</strong>`; host.appendChild(el); setTimeout(()=>el.remove(),3600); }
  function floatFrom(fromEl,text){
    const r=fromEl.getBoundingClientRect(); const span=document.createElement('div'); span.className='float'; span.textContent=text;
    span.style.left=(r.left+r.width/2)+'px'; span.style.top=(r.top+r.height*0.1)+'px'; document.body.appendChild(span); setTimeout(()=>span.remove(),950);
  }
  return { showBanner, floatFrom, get suppressFloats(){return suppressFloats;}, set suppressFloats(v){suppressFloats=v;} };
})();

/* Cards + Renderer */
App.UI.Cards = (()=> {
  const { bindPress } = App.Engine; const { perTap, tap, addReps, bulkRepCost } = App.Economy; const { sfx, unlock } = App.Audio;
  function makeExerciseCard(e){
    const card=document.createElement('div'); card.className='card'+(e.unlocked?'':' locked');

    const tapPad=document.createElement('div'); tapPad.className='tapPad'; tapPad.textContent=e.icon;
    const lvl=document.createElement('div'); lvl.className='lvl'; lvl.textContent=`Lvl ${e.level}`; tapPad.appendChild(lvl);
    const repBand=document.createElement('div'); repBand.className='repBand'; repBand.innerHTML=`<div class="repFill"></div><div class="repLabel">0/10</div>`; tapPad.appendChild(repBand);

    const right=document.createElement('div'); right.className='right';
    const head=document.createElement('div'); head.className='ex-head'; head.innerHTML=`<div class="ex-title">${e.name}</div><div class="muted headRight"></div>`;

    /* Coach chip ABOVE cooldown to keep one-row meta */
    const coachSlotTop=document.createElement('div'); coachSlotTop.className='coachSlotTop';

    const coolWrap=document.createElement('div'); coolWrap.className='coolwrap'; coolWrap.innerHTML=`<div class="coolbar"><div class="coolfill"></div></div>`;

    /* One row under cooldown */
    const metaRow=document.createElement('div'); metaRow.className='metaRow';
    const kvs=document.createElement('div'); kvs.innerHTML=`<span class="kv">Per Tap: <strong class="kvTap">${perTap(e).toFixed(0)}</strong> HP</span>`;
    const buyBtn=document.createElement('button'); buyBtn.className='btn secondary'; buyBtn.textContent='Add Reps';
    metaRow.appendChild(kvs); metaRow.appendChild(buyBtn);

    const costLine=document.createElement('div'); costLine.className='costLine';
    costLine.innerHTML=`<button class="costPill" type="button">Unlock for <span class="costAmt">${e.unlockCost}</span> HP</button>`;
    const costPill=costLine.querySelector('.costPill'), costAmt=costLine.querySelector('.costAmt');

    right.appendChild(head); right.appendChild(coachSlotTop); right.appendChild(coolWrap); right.appendChild(metaRow); right.appendChild(costLine);
    card.appendChild(tapPad); card.appendChild(right);

    e.els={ card,tapPad,lvl,
      repFill:repBand.querySelector('.repFill'), repLabel:repBand.querySelector('.repLabel'),
      headRight:head.querySelector('.headRight'), coolFill:coolWrap.querySelector('.coolfill'),
      kvTap:kvs.querySelector('.kvTap'), buyBtn, coachSlotTop, costLine,costPill,costAmt
    };

    if(e.unlocked){ costLine.style.display='none'; } else { coolWrap.style.display='none'; metaRow.style.display='none'; coachSlotTop.style.display='none'; }

    // Manual tap
    bindPress(tapPad, ()=>{ unlock(); const g=tap(e); if(g>0){ sfx('tap'); App.UI.Overlay.floatFrom(tapPad, `+${g.toFixed(0)}`); App.UI.Renderer.forceTop(); } });

    // Buy reps
    bindPress(buyBtn, ()=>{ const ok=addReps(e, App.State.s.buyQty||1); if(ok){ sfx('buy'); App.UI.Renderer.refreshExerciseUI(e); App.UI.Renderer.forceTop(); } });

    // Unlock
    costPill.addEventListener('click', ()=>{ const s=App.State.s; if(!e.unlocked && s.hp>=e.unlockCost){
      s.hp-=e.unlockCost; e.unlocked=true; sfx('buy');
      e.els.card.classList.remove('locked','unlock-ready','unlock-bounce');
      coolWrap.style.display='block'; metaRow.style.display='flex'; coachSlotTop.style.display='flex'; costLine.style.display='none';
      App.UI.Renderer.forceTop();
    }});

    return card;
  }
  return { makeExerciseCard };
})();

App.UI.Renderer = (()=> {
  const refs={ stack:document.getElementById('stack'), hp:document.getElementById('hp'), hpMenu:document.getElementById('hpMenu'),
               qtyTop:document.getElementById('qtyTop'), saveBtn:document.getElementById('saveBtn'), resetBtn:document.getElementById('resetBtn'),
               menuBtn:document.getElementById('menuBtn') };
  const { fmtTop, fmtCost } = App.Util; const { perTap, bulkRepCost } = App.Economy; const { s } = App.State;

  let shownHP = 0; // smooth display

  function renderStack(){ App.State.merge(); refs.stack.innerHTML=''; for(const e of s.exercises){ const card=App.UI.Cards.makeExerciseCard(e); refs.stack.appendChild(card); refreshExerciseUI(e); } }
  function forceTop(){ shownHP=s.hp; renderTopNow(); }
  function renderTopNow(){ const txt = fmtTop(shownHP); refs.hp.textContent=txt; if(refs.hpMenu) refs.hpMenu.textContent=txt; }
  function tickTop(dt){ const speed = 8; shownHP += (s.hp - shownHP) * Math.min(1, dt*speed); renderTopNow(); }

  function refreshExerciseUI(e){
    // Cooldown label (0 -> cd)
    if(e.unlocked){
      const cd=Math.max(100,e.cooldown), now=performance.now(), since=(e.lastTapAt<=0?cd:Math.max(0,Math.min(cd, now-e.lastTapAt)));
      if(e.els.headRight) e.els.headRight.textContent=(since/1000).toFixed(2)+'s';
    }else if(e.els.headRight){ e.els.headRight.textContent=''; }

    // Rep band
    if(e.els.repLabel) e.els.repLabel.textContent=`${e.repProgress}/${e.repTarget}`;
    if(e.els.repFill) e.els.repFill.style.width=(Math.min(e.repProgress/e.repTarget,1)*100).toFixed(1)+'%';

    // Level & per tap
    if(e.els.lvl) e.els.lvl.textContent=`Lvl ${e.level}`;
    if(e.els.kvTap) e.els.kvTap.textContent=perTap(e).toFixed(0);

    // Coach chips
    if(e.els.coachSlotTop){
      const cs = App.Coaches.getOwnedForExercise(e.id);
      e.els.coachSlotTop.innerHTML = '';
      if(cs.length){
        for(const c of cs){ const chip=document.createElement('div'); chip.className='coachChip'; chip.textContent=`${c.icon} ${c.name}`; e.els.coachSlotTop.appendChild(chip); }
      }
    }

    // Reps button state
    if(e.unlocked && e.els.buyBtn){
      const qty = s.buyQty||1, cost = bulkRepCost(e, qty), canBuy = s.hp >= cost;
      e.els.buyBtn.textContent = (qty===1?`Add Reps (${fmtCost(cost)} HP)`: `Add ${qty} Reps (${fmtCost(cost)} HP)`);
      e.els.buyBtn.disabled = !canBuy;
      e.els.buyBtn.classList.toggle('primary', canBuy);
      e.els.buyBtn.classList.toggle('secondary', !canBuy);
      e.els.buyBtn.classList.toggle('ready', canBuy);
    }

    // Unlock pill
    if(!e.unlocked && e.els.costPill){
      const canUn = s.hp >= e.unlockCost;
      e.els.costAmt.textContent=fmtCost(e.unlockCost);
      e.els.card.classList.toggle('unlock-ready', canUn);
      e.els.card.classList.toggle('unlock-bounce', canUn);
      e.els.costPill.classList.toggle('ready', canUn);
    }
  }
  function refreshAll(){ renderTopNow(); for(const e of App.State.s.exercises) refreshExerciseUI(e); }
  return { refs, renderStack, refreshAll, tickTop, forceTop };
})();

/* Menu */
App.Menu = (()=> {
  const overlay=document.getElementById('menuOverlay'), closeBtn=document.getElementById('menuClose');
  const tabs=[...document.querySelectorAll('.menuTab')];
  function open(tab='coaches'){ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); App.UI.Overlay.suppressFloats=true; App.Notif.clear('coaches'); switchTab(tab); }
  function close(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); App.UI.Overlay.suppressFloats=false; }
  function switchTab(name){
    tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
    ['coaches','upgrades','achievements','quests','shop','stats'].forEach(id=>{ const el=document.getElementById('tab-'+id); if(el) el.style.display=(id===name?'block':'none'); });
    if(name==='coaches') App.Coaches.renderList();
  }
  overlay.addEventListener('click',e=>{ if(e.target===overlay) close(); });
  closeBtn.addEventListener('click',close);
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') close(); });
  tabs.forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
  return { open, close, switchTab };
})();

/* Coaches */
App.Coaches = (()=> {
  const coaches = [
    { id:'c1',  name:'Rookie Coach',     icon:'ðŸ§‘â€ðŸ«', price:   1500,      target:'walk' },
    { id:'c2',  name:'Track Buddy',      icon:'ðŸ‘Ÿ',   price:   6000,      target:'jog' },
    { id:'c3',  name:'Core Captain',     icon:'ðŸ§˜â€â™‚ï¸', price:  25000,      target:'sit' },
    { id:'c4',  name:'Push-up Pro',      icon:'ðŸ’ª',   price: 100000,      target:'push' },
    { id:'c5',  name:'Cardio Coach',     icon:'ðŸ¤¸',   price: 400000,      target:'jacks' },
    { id:'c6',  name:'Squat Sensei',     icon:'ðŸ¦µ',   price:1500000,      target:'squat' },
    { id:'c7',  name:'Kettlebell Guru',  icon:'ðŸ‹ï¸',  price:6000000,      target:'kb' },
    { id:'c8',  name:'Bench Boss',       icon:'ðŸ‹ï¸â€â™‚ï¸',price:20000000,     target:'bench' },
    { id:'c9',  name:'Marathon Mentor',  icon:'ðŸŽ½',   price:80000000,     target:'marathon' },
    { id:'c10', name:'Ring Master',      icon:'ðŸ¤¸â€â™‚ï¸', price:300000000,    target:'ironcross' }
  ];
  function isAuto(exId){ const owned=App.State.s.coachesOwned; return coaches.some(c=>owned[c.id] && c.target===exId); }
  function getOwnedForExercise(exId){ const owned=App.State.s.coachesOwned; return coaches.filter(c=>owned[c.id] && c.target===exId); }

  function renderList(){
    const host=document.getElementById('tab-coaches');
    host.innerHTML = `<div class="coachIntro">Coaches automatically work out for you on a specific exercise. Hire one when you can afford it to keep progress rolling.</div>`;
    const list=document.createElement('div'); list.className='coachList'; host.appendChild(list);

    const exById=Object.fromEntries(App.State.s.exercises.map(e=>[e.id,e]));
    for(const c of coaches){
      const owned=!!App.State.s.coachesOwned[c.id];
      const unlockedTarget=!!(exById[c.target] && exById[c.target].unlocked);
      const locked=!unlockedTarget;

      const card=document.createElement('div'); card.className='coachCard'+(locked?' locked':'');
      const head=document.createElement('div'); head.className='headshot'; head.textContent=c.icon;
      const mid=document.createElement('div'); mid.className='coachMid';
      const name=document.createElement('div'); name.className='coachName'; name.textContent=c.name;
      const info=document.createElement('div'); info.className='coachInfo'; info.textContent=`Works on: ${exById[c.target]?.name || c.target}`;
      mid.appendChild(name); mid.appendChild(info);

      const right=document.createElement('div'); right.className='coachRight';
      const btn=document.createElement('button'); btn.className='hireBtn secondary'; btn.textContent = owned ? 'Owned' : `Hire â€¢ ${App.Util.fmtCost(c.price)} HP`;
      if(owned){ btn.disabled=true; }
      right.appendChild(btn);

      card.appendChild(head); card.appendChild(mid); card.appendChild(right);
      list.appendChild(card);

      const canAfford = App.State.s.hp >= c.price;
      if(!locked && !owned){
        btn.disabled = !canAfford;
        btn.classList.toggle('ready', canAfford);
        btn.classList.toggle('secondary', !canAfford);
      }else{
        btn.disabled = true;
        btn.classList.add('secondary');
        btn.classList.remove('ready');
      }

      btn.addEventListener('click', ()=>{
        if(locked || owned) return;
        const S=App.State.s; if(S.hp+1e-9<c.price) return;
        S.hp-=c.price; S.coachesOwned[c.id]=true; App.Audio.sfx('buy');
        App.UI.Renderer.forceTop(); App.Menu.open('coaches'); // re-render list
      });
    }
  }

  return { isAuto, getOwnedForExercise, renderList };
})();

/* Content (20 exercises) */
App.Content = (()=> {
  const ex = [
    { id:'walk', name:'Walking',         icon:'ðŸš¶',   baseHP:1,      baseCooldown:   600,   repBaseCost:  4,   unlockCost:    0,   unlocked:true  },
    { id:'jog',  name:'Jogging',         icon:'ðŸƒ',   baseHP:60,     baseCooldown:  3000,   repBaseCost: 30,   unlockCost:   60,   unlocked:false },
    { id:'sit',  name:'Sit-ups',         icon:'ðŸ§˜',   baseHP:180,    baseCooldown:  6000,   repBaseCost: 90,   unlockCost:  300,   unlocked:false },
    { id:'push', name:'Push-ups',        icon:'ðŸ’ª',   baseHP:400,    baseCooldown: 12000,   repBaseCost:200,   unlockCost: 1200,   unlocked:false },
    { id:'jacks', name:'Jumping Jacks',  icon:'ðŸ¤¸',   baseHP:900,    baseCooldown: 24000,   repBaseCost:450,   unlockCost: 1800,   unlocked:false },
    { id:'squat', name:'Bodyweight Squats',icon:'ðŸ¦µ', baseHP:1800,   baseCooldown: 48000,   repBaseCost:900,   unlockCost: 3600,   unlocked:false },
    { id:'lunge', name:'Lunges',         icon:'ðŸ¦µ',   baseHP:3200,   baseCooldown: 96000,   repBaseCost:1600,  unlockCost: 6400,   unlocked:false },
    { id:'plank', name:'Plank',          icon:'ðŸ§˜â€â™‚ï¸', baseHP:5000,   baseCooldown:192000,   repBaseCost:2500,  unlockCost:10000,   unlocked:false },
    { id:'climb', name:'Mountain Climbers',icon:'ðŸ§—', baseHP:8000,   baseCooldown:384000,   repBaseCost:4000,  unlockCost:16000,   unlocked:false },
    { id:'burpee',name:'Burpees',        icon:'ðŸ¤¾',   baseHP:12000,  baseCooldown:768000,   repBaseCost:6000,  unlockCost:24000,   unlocked:false },
    { id:'pullup',name:'Pull-ups',       icon:'ðŸ§—â€â™‚ï¸', baseHP:18000,  baseCooldown:1536000,  repBaseCost:9000,  unlockCost:36000,   unlocked:false },
    { id:'kb',    name:'Kettlebell Swings',icon:'ðŸ‹ï¸', baseHP:26000,  baseCooldown:3072000,  repBaseCost:13000, unlockCost:52000,   unlocked:false },
    { id:'bench', name:'Bench Press',    icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:36000,  baseCooldown:6144000,  repBaseCost:18000, unlockCost:72000,   unlocked:false },
    { id:'backsq',name:'Back Squat',     icon:'ðŸ‹ï¸â€â™€ï¸',baseHP:48000,  baseCooldown:12288000, repBaseCost:24000, unlockCost:96000,   unlocked:false },
    { id:'dead',  name:'Deadlift',       icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:65000,  baseCooldown:24576000, repBaseCost:32500, unlockCost:130000,  unlocked:false },
    { id:'clean', name:'Clean & Jerk',   icon:'ðŸ‹ï¸â€â™‚ï¸',baseHP:85000,  baseCooldown:49152000, repBaseCost:42500, unlockCost:170000,  unlocked:false },
    { id:'snatch',name:'Snatch',         icon:'ðŸ‹ï¸â€â™€ï¸',baseHP:110000, baseCooldown:98304000, repBaseCost:55000, unlockCost:220000,  unlocked:false },
    { id:'halfmar',name:'Half Marathon', icon:'ðŸŽ½',   baseHP:150000, baseCooldown:196608000,repBaseCost:75000, unlockCost:300000,  unlocked:false },
    { id:'marathon',name:'Marathon',     icon:'ðŸ',   baseHP:200000, baseCooldown:393216000,repBaseCost:100000,unlockCost:400000,  unlocked:false },
    { id:'ironcross',name:'Iron Cross',  icon:'ðŸ¤¸â€â™‚ï¸', baseHP:260000, baseCooldown:786432000,repBaseCost:130000,unlockCost:520000,  unlocked:false }
  ];
  return { exercises:ex };
})();

/* Boot */
(function boot(){
  // Prevent double-tap zoom
  let lastTouchEnd=0; document.addEventListener('touchend',e=>{const n=Date.now(); if(n-lastTouchEnd<=300){e.preventDefault();} lastTouchEnd=n;},{passive:false});
  document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false}); document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});

  App.State.load(); App.State.setExercises(App.Content.exercises);
  App.UI.Renderer.renderStack(); App.UI.Renderer.forceTop(); App.UI.Renderer.refreshAll();

  const { refs } = App.UI.Renderer;
  refs.saveBtn.addEventListener('click', App.State.save);
  refs.resetBtn.addEventListener('click', ()=>{ if(!confirm('Reset your progress?')) return; localStorage.clear(); location.reload(); });
  [...refs.qtyTop.querySelectorAll('.segBtn')].forEach(b=>b.addEventListener('pointerdown',ev=>{
    ev.preventDefault(); [...refs.qtyTop.querySelectorAll('.segBtn')].forEach(x=>x.classList.remove('active')); b.classList.add('active');
    App.State.s.buyQty=parseInt(b.dataset.q,10); App.UI.Renderer.refreshAll();
  },{passive:false}));

  // Menu
  refs.menuBtn.addEventListener('click', ()=>App.Menu.open('coaches'));

  App.Engine.start(App.Engine.updateCooldown, App.UI.Renderer.refreshExerciseUI);
  App.Engine.scheduleSave();
})();
</script>
</body>
</html>