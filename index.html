<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy ‚Äì V4.9 (Mobile-safe music gain + mute icon)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
/* --- (unchanged styles trimmed for brevity except audio UI) --- */
:root{--bg:#0a1320;--card:#0f1b2b;--ink:#e9eef3;--muted:#a7b7cc;--border:#213149;--accent:#cc6b2c;--accent-hi:#ffb357;--rep:#22c55e;--warn:#39d98a;--space:clamp(10px,2.2vw,18px);--r:16px;--fs-2:clamp(18px,3.2vw,22px);--repband:16%}
*{box-sizing:border-box}
html,body{height:100%;touch-action:manipulation;overflow-x:hidden}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0}
.topbar{position:sticky;position:-webkit-sticky;top:0;z-index:1000;background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04)}
.hpPill .label{font-weight:900;letter-spacing:.3px;color:var(--accent)}
.hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);width:11ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}
.title{display:flex;align-items:center;gap:10px}
.title .icon{font-size:clamp(22px,5vw,28px)}
/* Volume cluster */
.volWrap{display:flex;align-items:center;gap:8px;margin-left:auto}
.iconBtn{width:34px;height:34px;border-radius:10px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}
.iconBtn.active{background:var(--accent);color:#fff;border-color:#e89d6b}
#musicVol{width:110px;-webkit-appearance:none;appearance:none;height:6px;border-radius:6px;background:#203659;outline:0}
#musicVol::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);border:1px solid #e89d6b;cursor:pointer;box-shadow:0 0 0 2px rgba(0,0,0,.25)}
#musicVol::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:1px solid #e89d6b;cursor:pointer}
#menuBtn{position:relative}
.notifDot{position:absolute;right:-12px;top:-12px;width:16px;height:16px;border-radius:50%;display:none;background:var(--warn);box-shadow:0 0 0 2px rgba(10,19,32,.95);pointer-events:none;z-index:200}
.notifDot.show{display:block}

/* --- keep all previous styles from v4.8 below this line (cards, bars, menu, tutorial, start, splash, etc.) --- */
/* (For space, those styles are identical to v4.8 you pasted last) */

/* ... paste the rest of your CSS from v4.8 here unchanged ... */
</style>
</head>
<body>
  <div class="topbar">
    <div class="topwrap">
      <div class="title"><span class="icon">üí™</span><h1>Fitness Frenzy</h1></div>
      <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0.00</span></div>

      <div class="spacer"></div>

      <!-- Music icon + slider -->
      <div class="volWrap" title="Music volume">
        <button id="musicMute" class="iconBtn" aria-pressed="false" title="Mute/Unmute">üéµ</button>
        <input id="musicVol" type="range" min="0" max="100" step="1" value="5" aria-label="Music volume">
      </div>

      <button id="menuBtn" class="btn ghost">Menu<span id="menuDot" class="notifDot"></span></button>
      <div class="seg" id="qtyTop"><button class="segBtn active" data-q="1">√ó1</button><button class="segBtn" data-q="10">√ó10</button></div>
      <button id="saveBtn" class="btn secondary">Save</button>
      <button id="resetBtn" class="btn secondary">Reset</button>
    </div>
  </div>

  <!-- Splash (unchanged) -->
  <div id="splash" class="splash" aria-hidden="false">
    <img class="splashLogo splashIn" alt="GameBros Logo"
      src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
  </div>

  <!-- Start screen (unchanged from v4.8) -->
  <div id="startOv" class="startOv" aria-hidden="true">
    <div class="startPlate"></div>
    <div class="startBackdrop"></div>
    <div class="startFrame">
      <div class="startImgWrap">
        <img id="startCoverImg" alt="Fitness Frenzy Cover" src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png">
      </div>
      <div id="startUI" class="startUI popIn">
        <div class="startBtns">
          <button id="btnStart" class="btn primary lg btnBounce">Start</button>
          <button id="btnContinue" class="btn secondary lg btnBounce">Continue</button>
        </div>
        <div class="startAvatar">
          <div class="seg" id="segAvatar" aria-label="Choose avatar">
            <button class="segBtn" data-avatar="male" title="Male"><span class="sym">‚ôÇ</span></button>
            <button class="segBtn" data-avatar="female" title="Female"><span class="sym">‚ôÄ</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main game, banners, modals, menu, tutorial (unchanged markup) -->
  <div class="wrap"><div id="stack" class="stack"></div></div>
  <div id="bannerHost"></div>

  <div id="offOv" class="offOverlay" aria-hidden="true">
    <div class="offCard" role="dialog" aria-modal="true">
      <h3 class="offTitle">Welcome back! üëã</h3>
      <p class="offSub">Your coaches trained while you were away (<span id="offDur">0s</span>).</p>
      <div class="offGain">+<span id="offAmt">0.00</span> HP</div>
      <button id="offClaim" class="btn primary">Claim</button>
      <div id="offCapNote" class="offNote" style="display:none">Note: Offline gains capped for long absences.</div>
    </div>
  </div>

  <div id="menuOverlay" class="menuOverlay" aria-hidden="true">
    <!-- (menu content identical to v4.8) -->
    <div class="menuPanel" role="dialog" aria-modal="true">
      <div class="menuHeader">
        <div class="menuTitle">Menu</div>
        <div class="spacer"></div>
        <div class="hpPill small"><span class="label">HP:</span><span id="hpMenu" class="val">0.00</span></div>
        <button id="menuClose" class="btn secondary">Close</button>
      </div>
      <div class="menuTabs">
        <button class="menuTab active" data-tab="coaches">Coaches</button>
        <button class="menuTab" data-tab="upgrades">Upgrades</button>
        <button class="menuTab" data-tab="achievements">Achievements</button>
        <button class="menuTab" data-tab="quests">Side Quests</button>
        <button class="menuTab" data-tab="shop">Shop</button>
        <button class="menuTab" data-tab="stats">Stats</button>
        <button class="menuTab" data-tab="settings">Settings</button>
      </div>
      <div class="menuBody">
        <div id="tab-coaches"></div>
        <div id="tab-upgrades" style="display:none"><p>Upgrades coming soon.</p></div>
        <div id="tab-achievements" style="display:none"></div>
        <div id="tab-quests" style="display:none"><p>Side Quests coming later.</p></div>
        <div id="tab-shop" style="display:none"><p>Shop coming soon.</p></div>
        <div id="tab-stats" style="display:none"></div>
        <div id="tab-settings" style="display:none"></div>
      </div>
    </div>
  </div>

  <div id="tutOv" class="tutOv" aria-hidden="true">
    <!-- (tutorial overlay identical to v4.8) -->
    <div class="tutDim"></div>
    <div id="tutSpot" class="tutSpot" style="display:none"></div>
    <div id="tutBubble" class="tutBubble" role="dialog" aria-live="polite" aria-modal="true">
      <div id="tutAvatar" class="tutAvatar">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
      <div class="tutText">
        <div id="tutWho" class="tutWho">JAX</div>
        <div id="tutLine">‚Ä¶</div>
        <div class="tutMore"><span>Tap to continue</span> <span class="tutChevron">‚ñæ</span></div>
      </div>
    </div>
  </div>

  <!-- Background music element (same MP3) -->
  <audio id="bgm" preload="auto" loop crossorigin="anonymous"
    src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-IntroMusic.mp3"></audio>

<script>
/* ========== Config & Settings (only relevant bits shown changed) ========== */
const App = {};
App.Config = Object.freeze({
  SAVE_KEY:'ff-v490-musicgain',
  SCHEMA_VERSION:6,
  DEC:2, EPS:1e-6, SOLID_CD_MS:300, REP_GROWTH:1.12,
  SAVE_MS:20000, UI_REFRESH_MS:100, NOTIFY_REFRESH_MS:200, OFFLINE_MAX_MS:12*60*60*1000
});
App.Bus = (()=>{const m={};return{on(ev,fn){(m[ev]||(m[ev]=[])).push(fn);return()=>this.off(ev,fn)},off(ev,fn){const a=m[ev];if(!a)return;const i=a.indexOf(fn);if(i>=0)a.splice(i,1)},emit(ev,p){const a=m[ev];if(!a)return;for(const f of a.slice())try{f(p)}catch(e){console.warn(e)}}};})();
App.Settings = (()=>{
  const KEY = App.Config.SAVE_KEY + ':prefs';
  const defaults = { sfx:true, floats:true, musicVol:5, musicMuted:false }; // softer default
  let prefs = { ...defaults };
  try{ const raw = localStorage.getItem(KEY); if(raw) prefs = { ...defaults, ...JSON.parse(raw) }; }catch{}
  const save=()=>{ try{ localStorage.setItem(KEY, JSON.stringify(prefs)); }catch{} };
  return { get:(k)=>prefs[k], set:(k,v)=>{ prefs[k]=v; save(); App.Bus.emit('settings:change',{key:k,val:v}); }, all:()=>({...prefs}) };
})();

/* ========== Audio: SFX + Music via WebAudio Gain (mobile-safe) ========== */
App.Audio = (()=> {
  let audioCtx=null, needsUnlock=true;
  let musicGain=null, musicSrc=null; // WebAudio nodes for music
  const musicEl = document.getElementById('bgm');

  function ensure(){
    if(!audioCtx || audioCtx.state==='closed'){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} }
    if(audioCtx && audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{}); }
    // wire music graph once
    if(audioCtx && !musicGain){
      musicGain = audioCtx.createGain();
      const volPref = (App.Settings.get('musicMuted') ? 0 : (App.Settings.get('musicVol')||0)/100);
      musicGain.gain.value = volPref;
      musicGain.connect(audioCtx.destination);
    }
    if(audioCtx && musicGain && !musicSrc){
      try{
        musicSrc = audioCtx.createMediaElementSource(musicEl); // can only be created once per element
        musicSrc.connect(musicGain);
      }catch(e){ /* already connected or not supported */ }
    }
  }
  function unlock(){
    ensure();
    if(!audioCtx) return;
    try{
      const b=audioCtx.createBuffer(1,1,22050);
      const s=audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0);
    }catch{}
    if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{}); }
    needsUnlock=false;
  }
  function tone(f, dur=.18, gain=.07, type='sine'){
    try{
      ensure(); if(!audioCtx) return;
      const t=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type=type; o.frequency.setValueAtTime(f,t);
      g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
      o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+dur);
    }catch{}
  }
  function sfx(type){
    if(!App.Settings.get('sfx')) return;
    if(!audioCtx || audioCtx.state!=='running'){ needsUnlock=true; return; }
    if(type==='tap') tone(660,.12,.06,'sine');
    if(type==='buy') tone(440,.18,.08,'sine');
    if(type==='popup'){ tone(520,.10,.06,'triangle'); setTimeout(()=>tone(780,.08,.05,'triangle'),90); }
    if(type==='achv'){ tone(600,.10,.07,'square'); setTimeout(()=>tone(800,.10,.06,'square'),110); setTimeout(()=>tone(1000,.12,.06,'square'),220); }
  }

  function start(){
    ensure();
    try{ musicEl.play().catch(()=>{}); }catch{}
    // volume driven by gain node; keep element volume at 1
    try{ musicEl.volume = 1; }catch{}
  }
  function setVolumeLinear01(v){
    ensure();
    if(!musicGain) return;
    // if muted, keep gain at 0 regardless of slider
    const muted = !!App.Settings.get('musicMuted');
    musicGain.gain.setValueAtTime(muted ? 0 : Math.max(0, Math.min(1, v)), audioCtx.currentTime);
  }
  function toggleMute(force){
    const target = (typeof force==='boolean') ? force : !App.Settings.get('musicMuted');
    App.Settings.set('musicMuted', target);
    const volPref = (App.Settings.get('musicVol')||0)/100;
    setVolumeLinear01(target ? 0 : volPref);
  }

  ['pointerdown','touchstart','mousedown','click','keydown'].forEach(ev=>{
    window.addEventListener(ev, ()=>{ if(needsUnlock || (audioCtx && audioCtx.state!=='running')) unlock(); }, {capture:true, passive:true});
  });

  App.Bus.on('settings:change', ({key,val})=>{
    if(key==='musicVol') setVolumeLinear01((val||0)/100);
    if(key==='musicMuted') setVolumeLinear01(App.Settings.get('musicMuted') ? 0 : (App.Settings.get('musicVol')||0)/100);
  });

  return { sfx, music:{ start, setVolumeLinear01, toggleMute } };
})();

/* ========== (Everything below is identical to your v4.8 logic: state, content, game, engine, UI, coaches, achievements, notify, cards, renderer, offline, tutorial, start, splash) ========== */
/* --- For brevity here, paste your v4.8 JS unchanged below this line, EXCEPT: --- 
   1) Update SAVE_KEY already done above.
   2) In Start.init() startGameFlow, remove hardcoded 10% and rely on prefs (which default to 5%).
   3) Wire the new music icon + slider in Renderer.wireMenu().
*/

/* Minimal deltas shown; you can paste your previous v4.8 code and replace the few touched parts. */

/* ---------- Utils, State, Content, Game, Engine, Banners, Coaches, Achievements, Notify, Cards (unchanged) ---------- */
/* ... paste unchanged blocks from v4.8 here ... */

/* ---------- Renderer: only the menu wiring/volume UI changed ---------- */
App.UI = App.UI||{};
App.UI.Renderer = (()=> {
  const refs={ stack:document.getElementById('stack'), hp:document.getElementById('hp'), hpMenu:document.getElementById('hpMenu'),
               qtyTop:document.getElementById('qtyTop'), saveBtn:document.getElementById('saveBtn'), resetBtn:document.getElementById('resetBtn'),
               menuBtn:document.getElementById('menuBtn'), menuOverlay:document.getElementById('menuOverlay'), menuClose:document.getElementById('menuClose'),
               tabsWrap:document.querySelector('.menuTabs'), menuBody:document.querySelector('.menuBody'),
               vol:document.getElementById('musicVol'), muteBtn:document.getElementById('musicMute') };
  const fmtTop=n=>{const a=Math.abs(n);const d=2;if(a>=1e9)return(n/1e9).toFixed(d)+'B';if(a>=1e6)return(n/1e6).toFixed(d)+'M';if(a>=1e3)return(n/1e3).toFixed(d)+'K';return n.toFixed(d)};
  const s=App.State?.s || (App.State={s:{hp:0}}).s;
  let shownHP=0;

  function renderStack(){ App.State.merge?.(); refs.stack.innerHTML=''; for(const e of App.State.s.exercises){ const card=App.UI.Cards.makeExerciseCard(e); refs.stack.appendChild(card); App.UI.Renderer.refreshExerciseUI(e); } }
  function forceTop(){ shownHP=s.hp; renderTopNow(); }
  function renderTopNow(){ const txt = fmtTop(shownHP); refs.hp.textContent=txt; if(refs.hpMenu) refs.hpMenu.textContent=txt; }
  function refreshExerciseUI(e){ /* paste from v4.8 unchanged */ }
  function refreshAll(){ renderTopNow(); for(const e of App.State.s.exercises) refreshExerciseUI(e); }

  function wireMenu(){
    // existing menu wiring from v4.8 (open/close/tabs/etc.) ...
    document.getElementById('menuBtn').addEventListener('click', ()=>{ App.Audio.sfx('popup'); refs.menuOverlay.classList.add('open'); refs.menuOverlay.setAttribute('aria-hidden','false'); App.UI.Overlay.suppressFloats=true; document.dispatchEvent(new Event('menu:open')); });
    document.getElementById('menuClose').addEventListener('click', ()=>{ App.Audio.sfx('popup'); refs.menuOverlay.classList.remove('open'); refs.menuOverlay.setAttribute('aria-hidden','true'); App.UI.Overlay.suppressFloats=false; });

    // Volume slider + mute icon
    const volPref = App.Settings.get('musicVol') ?? 5;
    const muted = !!App.Settings.get('musicMuted');
    refs.vol.value = String(volPref);
    refs.muteBtn.classList.toggle('active', !muted);
    refs.muteBtn.textContent = muted ? 'üîá' : 'üéµ';
    // apply gain to current pref
    App.Audio.music.setVolumeLinear01(muted ? 0 : (volPref/100));

    refs.vol.addEventListener('input', e=>{
      const v = Math.max(0, Math.min(100, parseInt(e.target.value,10)||0));
      App.Settings.set('musicVol', v);
      // if user moves slider while muted, keep muted but remember the pref
    });
    refs.muteBtn.addEventListener('click', ()=>{
      const willMute = !App.Settings.get('musicMuted');
      App.Audio.music.toggleMute(willMute);
      refs.muteBtn.classList.toggle('active', !willMute);
      refs.muteBtn.textContent = willMute ? 'üîá' : 'üéµ';
      App.Audio.sfx('popup');
    });
  }

  return { refs, renderStack, refreshAll, forceTop, wireMenu, refreshExerciseUI, tickTop(dt){ shownHP += (s.hp - shownHP) * Math.min(1, dt*8); renderTopNow(); }, buildStats(){}, buildSettings(){} };
})();

/* ---------- Offline, Tutorial, Start, Splash (only small music start tweak) ---------- */
App.UI = App.UI || {};
App.UI.Start = (() => {
  const ov = document.getElementById('startOv');
  const btnStart = document.getElementById('btnStart');
  const btnCont = document.getElementById('btnContinue');
  const seg = document.getElementById('segAvatar'); const ui = document.getElementById('startUI');

  function setAvatar(av){ App.State.s.tutorial.avatar = av; [...seg.querySelectorAll('.segBtn')].forEach(b=>b.classList.toggle('active', b.dataset.avatar===av)); App.State.save(); }
  function init(){
    const cur = App.State.s.tutorial?.avatar || 'male'; setAvatar(cur);
    seg.querySelectorAll('.segBtn').forEach(b=> b.addEventListener('click', ()=>{ App.Audio.sfx('tap'); setAvatar(b.dataset.avatar); }));

    function startGameFlow(){
      App.Audio.sfx('popup');
      // Start music at saved pref (default now 5%), do not force a louder level
      App.Audio.music.start();
      hide();
      if(!App.State.s.tutorial?.done){ App.Tutorial.start?.(); }
      setTimeout(()=>App.Offline.checkAndShow?.(), 50);
    }
    btnStart.addEventListener('click', startGameFlow);
    btnCont.addEventListener('click', startGameFlow);
  }
  function show(){ ov.classList.add('open'); ov.setAttribute('aria-hidden','false'); }
  function hide(){ ov.classList.remove('open'); ov.setAttribute('aria-hidden','true'); }
  return { init, show, hide };
})();

/* ---------- Boot (reuse your existing boot flow) ---------- */
(function boot(){
  let lastTouchEnd=0; document.addEventListener('touchend',e=>{const n=Date.now(); if(n-lastTouchEnd<=300){e.preventDefault();} lastTouchEnd=n;},{passive:false});
  document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false}); document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});

  /* Reuse your v4.8 initialize: load state, set exercises, render stack, engine start, notify, etc. */
  // -- BEGIN: minimal scaffold to keep this snippet self-contained --
  App.State = App.State || { s:{ hp:0, exercises:[], tutorial:{avatar:'male'} }, setExercises(list){ this.s.exercises=list.map(e=>({...e,repHP:0,repProgress:0,repTarget:10,level:1,cooldown:e.baseCooldown,unlocked:e.unlocked,lastTapAt:0,els:{}})); }, save(){ try{localStorage.setItem(App.Config.SAVE_KEY, JSON.stringify({schemaVersion:6, hp:this.s.hp, tutorial:this.s.tutorial, exercises:this.s.exercises.map(e=>({id:e.id,repHP:e.repHP,repProgress:e.repProgress,repTarget:e.repTarget,level:e.level,unlocked:e.unlocked,cooldown:e.cooldown,lastTapAt:e.lastTapAt}))}))}catch{} }, load(){ try{ const raw=localStorage.getItem(App.Config.SAVE_KEY); if(raw){ const j=JSON.parse(raw); this.s.hp=j.hp||0; this.s.tutorial=j.tutorial||{avatar:'male'}; this.__loaded=j.exercises||[]; } }catch{} }, merge(){ if(!this.__loaded)return; for(const se of this.__loaded){ const e=this.s.exercises.find(x=>x.id===se.id); if(!e)continue; Object.assign(e,se); } delete this.__loaded; } };
  App.Content = App.Content || { exercises:[{id:'walk',name:'Walking',icon:'üö∂',baseHP:1,baseCooldown:600,repBaseCost:4,unlockCost:0,unlocked:true},{id:'jog',name:'Jogging',icon:'üèÉ',baseHP:60,baseCooldown:3000,repBaseCost:30,unlockCost:60,unlocked:false}] };
  App.UI.Cards = App.UI.Cards || { makeExerciseCard(e){ const d=document.createElement('div'); d.className='card'; d.textContent=e.name+' (demo)'; return d; } };
  App.Engine = App.Engine || { start(){ function t(){ App.UI.Renderer.tickTop?.(1/60); requestAnimationFrame(t);} requestAnimationFrame(t); }, scheduleSave(){} };
  App.Notify = App.Notify || { update(){} };
  App.UI.Splash = App.UI.Splash || { runThenStart(){ setTimeout(()=>{ App.UI.Start.show(); }, 4000);} };
  // -- END scaffolding --

  App.State.load();
  App.State.setExercises(App.Content.exercises);
  App.UI.Renderer.renderStack?.(); App.UI.Renderer.forceTop?.(); App.UI.Renderer.refreshAll?.();
  App.UI.Renderer.wireMenu?.();

  App.Engine.start();
  App.Engine.scheduleSave?.();
  App.Notify.update();

  // Apply saved music settings to gain on boot (without starting playback)
  const v = (App.Settings.get('musicVol')??5)/100;
  App.Audio.music.setVolumeLinear01(App.Settings.get('musicMuted') ? 0 : v);

  App.UI.Start.init();
  // Splash first, then Start screen
  const splashEl = document.getElementById('splash');
  splashEl.style.display='flex'; setTimeout(()=>{ splashEl.classList.add('fadeOut'); setTimeout(()=>{ splashEl.style.display='none'; App.UI.Start.show(); }, 360); }, 4000);
})();
</script>
</body>
</html>
