<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness Frenzy — Minimal Single (VS1)</title>
  <style>
    :root{
      --bg:#0f1020; --panel:#1a1c35; --panel-2:#23264a; --accent:#ff7a1a; --accent-2:#3aa6ff;
      --text:#f5f7ff; --muted:#aab1d6; --good:#27c93f; --danger:#ff3860;
      --rep:#27c93f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .topbar{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, #151734, #10122a); border-bottom:1px solid #22254b; padding:10px 12px}
    .wrap{max-width:860px; margin:0 auto; padding:12px}
    .row{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .logo{font-weight:900; letter-spacing:0.8px}
    .bulk{display:inline-flex; background:#20244a; border:1px solid #2a2e5e; border-radius:8px; overflow:hidden}
    .bulk button{background:transparent; color:#fff; border:0; padding:6px 10px; cursor:pointer; min-width:44px}
    .bulk button.active{background:var(--accent-2); color:#061222; font-weight:700}
    .hp-pill{margin-top:8px; background:#182047; border:1px solid #2a2e5e; padding:8px 10px; border-radius:10px; font-variant-numeric: tabular-nums; display:flex; align-items:center; justify-content:space-between}
    .cards{display:grid; gap:12px}
    .card{display:grid; grid-template-columns:110px 1fr; gap:12px; padding:10px; background:var(--panel); border:1px solid #262a58; border-radius:12px}
    .tile{background:var(--panel-2); border-radius:10px; position:relative; height:110px; display:grid; place-items:center; user-select:none}
    .lvl{position:absolute; top:6px; left:6px; background:#171a38; border:1px solid #2b2f63; padding:2px 6px; border-radius:6px; font-size:12px}
    .tap-btn{appearance:none; border:0; background:var(--accent); color:#1b0d00; font-weight:800; padding:8px 10px; border-radius:8px; cursor:pointer}
    .tile.cooling .tap-btn{opacity:.5; cursor:not-allowed}
    .title{font-weight:700; margin-top:2px}
    .cooldown{margin-top:6px; height:20px; background:#141739; border:1px solid #2a2e5e; border-radius:6px; overflow:hidden; position:relative}
    .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #2f6df3, #41b0ff)}
    .t{position:relative; z-index:1; padding-left:8px; font-variant-numeric: tabular-nums; color:var(--muted)}
    .meta{display:flex; align-items:center; justify-content:space-between; margin-top:8px}
    .muted{color:var(--muted)}
    .btn{appearance:none; border:1px solid #2a2e5e; background:#1b1f44; color:#e9edff; padding:8px 10px; border-radius:10px; min-width:160px; cursor:pointer; font-variant-numeric: tabular-nums}
    .btn.glow{box-shadow:0 0 0 2px rgba(255, 192, 120, .25) inset, 0 0 12px rgba(255, 122, 26, .35)}
    .repband{position:absolute; left:6px; right:6px; bottom:6px; height:16px; border-radius:8px; background:#0e132e; border:1px solid #2a2e5e; overflow:hidden}
    .repfill{height:100%; width:0%; background:linear-gradient(90deg, #17b34c, #27c93f)}
    .reptext{position:absolute; inset:0; display:grid; place-items:center; font-size:12px; color:#cfead6; text-shadow:0 1px 2px #000}
    .menu{position:fixed; right:12px; bottom:12px; background:#14163a; border:1px solid #2a2e5e; border-radius:10px; padding:10px}
    .menu h4{margin:0 0 8px 0}
    .danger{color:#ff9aa5}
    .footer{margin-top:10px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="logo">Fitness Frenzy — VS1</div>
        <div class="bulk" id="bulk">
          <button data-q="1" class="active">×1</button>
          <button data-q="10">×10</button>
          <button data-q="100">×100</button>
        </div>
      </div>
      <div class="hp-pill"><span>HP</span><span id="hp-readout">0</span></div>
    </div>
  </div>

  <div class="wrap">
    <div id="cards" class="cards"></div>
    <div class="footer">VS1 scope: Single exercise (Walking), Reps button, Rep progress band, Level-ups halve cooldown (min 100ms). Coach purchase below.</div>
  </div>

  <!-- Minimal “menu” pinned bottom-right for coach + reset -->
  <div class="menu">
    <h4>Coaches</h4>
    <div style="display:flex; gap:8px; align-items:center;">
      <div style="background:#2b2f63; width:28px; height:28px; border-radius:50%; display:grid; place-items:center;">F</div>
      <div style="flex:1;">
        <div style="font-weight:700">Coach 1</div>
        <div class="muted">Works on: Walking</div>
      </div>
      <button id="hire" class="btn">Hire • <span id="hire-price">1,500</span> HP</button>
    </div>
    <div style="height:8px"></div>
    <button id="reset" class="btn danger">Reset Save</button>
  </div>

  <script>
    // ----- One-time guard
    if (!window.__FF_VS1__) {
      window.__FF_VS1__ = true;

      // ----- Event bus
      const Bus = (()=>{ const m=new Map(); return { on:(e,cb)=>{ if(!m.has(e)) m.set(e,new Set()); m.get(e).add(cb); return ()=>m.get(e).delete(cb); }, emit:(e,p)=>{ const s=m.get(e); if(!s) return; s.forEach(cb=>{ try{cb(p)}catch(err){console.error(err)} }); } }; })();

      // ----- Content & Math
      const Exercise = { id:'walk', name:'Walking', baseCooldownMs:1000 };
      const coachPrice = 1500;
      const log2 = x => Math.log(x)/Math.log(2);
      const baseHP = 1; // Walking special case
      const perTapHP = repHP => baseHP + repHP;
      const repBaseCost = () => Math.max(4, Math.round(baseHP * 0.05)); // =4
      const repGrowth = level => Math.max(1.07, Math.min(1.15, 1.07 + 0.01 * log2(Math.max(1, level))));
      const repCostSingle = (rb,g,rep) => rb * Math.pow(g, rep);
      const repCostBulk   = (rb,g,rep,n) => rb * Math.pow(g, rep) * ((Math.pow(g,n)-1)/(g-1));
      const nextCooldown = ms => Math.max(100, Math.floor(ms/2));
      const fmt = n => { if(!isFinite(n)) return '0'; const a=Math.abs(n); if(a>=1e12) return (n/1e12).toFixed(2)+'T'; if(a>=1e9) return (n/1e9).toFixed(2)+'B'; if(a>=1e6) return (n/1e6).toFixed(2)+'M'; if(a>=1e3) return (n/1e3).toFixed(2)+'K'; return String(Math.floor(n)); };

      // ----- Storage / State
      const KEY='ff-vs1';
      function defaults(){ return {
        hp:0, qty:1,
        ex:{ id:'walk', unlocked:true, repHP:0, repTarget:10, level:1, cooldown:Exercise.baseCooldownMs, lastTapAt:0 },
        coaches:{ c1:false }
      };}
      function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return defaults(); const d=JSON.parse(raw)||{}; return { ...defaults(), ...d }; }catch{ return defaults(); } }
      function save(s){ try{ localStorage.setItem(KEY, JSON.stringify(s)); }catch{} }
      let S = load();
      const get = () => S;
      function patch(mut){ S = mut(structuredClone(S)); save(S); Bus.emit('state:changed', S); }

      // ----- Topbar
      const hpEl = document.getElementById('hp-readout');
      const bulk = document.getElementById('bulk');
      bulk.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if(!b) return;
        [...bulk.children].forEach(btn => btn.classList.toggle('active', btn === b));
        const qty = parseInt(b.dataset.q,10);
        patch(s => { s.qty = qty; return s; });
      });
      Bus.on('state:changed', () => { hpEl.textContent = fmt(get().hp); });
      hpEl.textContent = fmt(get().hp);

      // ----- Cards
      const root = document.getElementById('cards');
      let refs = null;
      function mount(){
        root.innerHTML='';
        const s = get();
        const ex = s.ex;
        const card = document.createElement('div'); card.className='card';
        const tile = document.createElement('div'); tile.className='tile';
        const lvl  = document.createElement('div'); lvl.className='lvl'; lvl.textContent = 'Lvl ' + ex.level;
        const tap  = document.createElement('button'); tap.className='tap-btn'; tap.textContent = '+ Tap';
        const repband = document.createElement('div'); repband.className='repband';
        const repfill = document.createElement('div'); repfill.className='repfill';
        const reptext = document.createElement('div'); reptext.className='reptext'; reptext.textContent = ex.repHP + ' / ' + ex.repTarget;
        repband.append(repfill, reptext);
        tile.append(lvl, tap, repband);

        const right = document.createElement('div');
        const title = document.createElement('div'); title.className='title'; title.textContent = Exercise.name;
        const cd = document.createElement('div'); cd.className='cooldown';
        const bar = document.createElement('div'); bar.className='bar';
        const t = document.createElement('div'); t.className='t'; t.textContent='Ready';
        cd.append(bar, t);
        const meta = document.createElement('div'); meta.className='meta';
        const left = document.createElement('div'); left.className='muted';
        const repBtn = document.createElement('button'); repBtn.className='btn';
        meta.append(left, repBtn);
        right.append(title, cd, meta);
        card.append(tile, right);
        root.append(card);

        function updateMeta(){
          const s = get(); const ex = s.ex;
          left.textContent = perTapHP(ex.repHP) + ' HP / tap';
          const rb = repBaseCost(); const g = repGrowth(ex.level); const qty = s.qty||1;
          const price = Math.ceil(qty===1 ? repCostSingle(rb,g,ex.repHP) : repCostBulk(rb,g,ex.repHP,qty));
          repBtn.textContent = 'Reps • ' + fmt(price) + ' HP';
          repBtn.classList.toggle('glow', s.hp >= price);
          reptext.textContent = ex.repHP + ' / ' + ex.repTarget;
          const pct = Math.max(0, Math.min(100, 100 * (ex.repHP / ex.repTarget)));
          repfill.style.width = pct + '%';
        }
        updateMeta();

        repBtn.addEventListener('click', () => {
          const s = get(); const ex = s.ex;
          const rb = repBaseCost(); const g = repGrowth(ex.level); const qty = s.qty||1;
          const price = Math.ceil(qty===1 ? repCostSingle(rb,g,ex.repHP) : repCostBulk(rb,g,ex.repHP,qty));
          if (s.hp < price) return;
          patch(st => {
            st.hp -= price;
            st.ex.repHP += qty;
            while(st.ex.repHP >= st.ex.repTarget){
              st.ex.level += 1;
              st.ex.cooldown = nextCooldown(st.ex.cooldown);
              st.ex.repTarget *= 2;
            }
            return st;
          });
        });

        tap.addEventListener('click', () => {
          const s = get(); const ex = s.ex; const now = performance.now();
          if (now < ex.lastTapAt + ex.cooldown) return;
          const gain = perTapHP(ex.repHP);
          patch(st => { st.hp += gain; st.ex.lastTapAt = now; return st; });
        });

        refs = { bar, t, tile, updateMeta };
      }
      mount();
      // Re-render on state change
      Bus.on('state:changed', () => { mount(); });

      // ----- Cooldown ticker
      function tick(){
        const s = get(); const ex = s.ex; const now = performance.now();
        const dt = now - ex.lastTapAt; const r = Math.max(0, ex.cooldown - dt);
        if (refs){
          if (r<=0){ refs.bar.style.width='100%'; refs.t.textContent='Ready'; refs.tile.classList.remove('cooling'); }
          else { const pct = 100 * (dt / ex.cooldown); refs.bar.style.width = Math.max(0,Math.min(100,pct))+'%'; refs.t.textContent=(r/1000).toFixed(2)+'s'; refs.tile.classList.add('cooling'); }
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      // ----- Coach + Reset
      const hireBtn = document.getElementById('hire');
      const hirePrice = document.getElementById('hire-price');
      hirePrice.textContent = fmt(coachPrice);
      function updateHire(){
        const s=get(); const hired=s.coaches.c1; const able=s.hp>=coachPrice;
        hireBtn.textContent = hired ? 'Hired' : ('Hire • ' + fmt(coachPrice) + ' HP');
        hireBtn.disabled = hired;
        hireBtn.classList.toggle('glow', !hired && able);
      }
      hireBtn.addEventListener('click', ()=>{
        const s=get(); if(s.coaches.c1 || s.hp<coachPrice) return;
        patch(st => { st.hp -= coachPrice; st.coaches.c1 = true; return st; });
      });
      Bus.on('state:changed', updateHire);
      updateHire();

      document.getElementById('reset').addEventListener('click', ()=>{
        if(confirm('Reset your save?')){ localStorage.removeItem(KEY); S = defaults(); save(S); Bus.emit('state:changed', S); }
      });
    }
  </script>
</body>
</html>
