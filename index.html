<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy — Coaches V2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{
  --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#9fb1c8; --border:#223556;
  --accent:#cc6b2c; --accent-hi:#ffb357; --brandBlue:#2b6cb0; --rep:#22c55e;
  --pillBg:#132647; --pillBr:#2a4a78; --r:16px; --barH:16px; --repband:16%;
  --space:clamp(10px,2.2vw,18px);
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
img,video{max-width:100%;display:block}

/* topbar */
.topbar{position:sticky;top:0;z-index:1000;background:rgba(10,19,32,.96);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:1024px;margin:0 auto;padding:10px var(--space) 8px;display:grid;grid-template-columns:auto 1fr auto;grid-template-rows:auto auto;gap:8px 14px;align-items:center}
.leftRow{display:flex;align-items:center;gap:12px}
.avatarBtn{position:relative;width:56px;height:56px;border-radius:50%;overflow:visible;border:2px solid #2a446c;background:#0b1626;cursor:pointer}
.avatarBtn img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.notifDot{position:absolute;right:-6px;top:-6px;width:18px;height:18px;border-radius:50%;background:#39d98a;box-shadow:0 0 0 2px rgba(10,19,32,.96);display:none;z-index:2}
.notifDot.show{display:block}
.logoImg{height:36px;width:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
.qtyGroup{justify-self:end;display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.qtyBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 10px;font-weight:800;cursor:pointer;font-size:14px}
.qtyBtn.active{background:var(--accent);color:#fff}
.hpRow{grid-column:1/-1;display:flex;align-items:center;gap:12px}
.hpPill{display:flex;align-items:baseline;gap:8px;padding:10px 16px;border-radius:999px;background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid var(--pillBr);flex:1}
.hpLabel{font-weight:900;color:var(--accent)}
.hpVal{font-weight:900;font-variant-numeric:tabular-nums;min-width:10ch;text-align:left}

/* content */
.wrap{max-width:1024px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}

/* cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;transition:transform .18s ease, filter .18s ease}
.card .left{position:relative;width:92px;aspect-ratio:1;border-radius:14px;background:#102036;border:1px solid #223b60;display:flex;align-items:center;justify-content:center;overflow:hidden}
.left .vid, .left .poster{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;object-position:center}
.lvlBadge{position:absolute;left:6px;top:6px;background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;color:#fff;font-weight:900;border-radius:8px;padding:2px 6px;font-size:12px}
.coachDot{position:absolute;right:6px;top:6px;width:22px;height:22px;border-radius:6px;border:1px solid #2b3d5a;background:#13233b;display:none;align-items:center;justify-content:center;overflow:hidden}
.coachDot img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#14361f;border-top:1px solid #204e2b;display:flex;align-items:center;justify-content:center;overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repText{position:relative;font-size:12px;color:#cfead6;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.4)}

.right{display:flex;flex-direction:column;gap:8px;min-width:0}
.title{margin:0 0 2px 0;font-size:16px;font-weight:900}
.coolRow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.cool{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolBar{height:var(--barH);background:#101a2a;position:relative}
.coolFill{height:100%;width:100%;background:linear-gradient(90deg,var(--accent),var(--accent-hi));position:relative}
.coolFill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.22) 0 6px,transparent 6px 12px);opacity:.55;mix-blend-mode:overlay;animation:stripe 1.2s linear infinite}
@keyframes stripe{to{background-position:60px 0}}
.coolTime{min-width:54px;text-align:right;font-variant-numeric:tabular-nums;color:#cfe0ff;font-size:12px}
.metaRow{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
.kv{background:#13223a;border:1px solid #203659;border-radius:10px;padding:6px 10px;color:#cfe0ff;font-size:13px;white-space:nowrap}
.chips{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.repsBtn{padding:8px 12px;border:0;border-radius:10px;font-weight:800;cursor:pointer;font-size:13px;white-space:nowrap}
.repsBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}
.repsBtn:not(.ready){background:#1a2a40;color:#d7e3f5}

/* locked */
.card.locked{opacity:.6;filter:grayscale(1);transform:scale(.97)}
.lockRow{grid-column:1/-1;display:flex;align-items:center;gap:10px}
.lockName{font-weight:900}
.unlockPill{margin-left:auto;padding:8px 14px;border-radius:999px;background:#142743;border:1px solid #27456d;color:#ffd6a8;font-weight:900;cursor:not-allowed;font-size:13px}
.unlockPill.ready{background:linear-gradient(135deg,var(--accent),var(--accent-hi));color:#fff;border-color:#e89d6b;cursor:pointer;box-shadow:0 12px 26px rgba(204,107,44,.35)}
.card.unlockPulse{animation:unlockPulse .9s ease-in-out infinite}
@keyframes unlockPulse{0%{transform:scale(.97)}50%{transform:scale(.985)}100%{transform:scale(.97)}}

/* floaters & banners */
.float{position:fixed;left:0;top:0;transform:translate(-50%,-10px);color:#ffe6c7;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.6);animation:rise .9s ease-out forwards;pointer-events:none;z-index:2000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);border-top:1px solid var(--pillBr);color:#fff;padding:12px 16px calc(12px + env(safe-area-inset-bottom));text-align:center;z-index:2500;animation:bannerIn .25s ease-out forwards,bannerOut .9s ease-in forwards 2.8s}
@keyframes bannerIn{to{transform:translateY(0)}}
@keyframes bannerOut{to{transform:translateY(10px);opacity:0}}

/* menu overlay */
.menuOv{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3000}
.menuOv.open{display:flex}
.panel{width:min(1024px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:18px 18px 0 0;overflow:hidden;box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column}
.panelHead{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.panelTitle{font-weight:900}
.hpMini{margin-left:auto;background:#132647;border:1px solid var(--pillBr);border-radius:999px;padding:4px 10px}
.menuTabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px var(--space);border-bottom:1px solid var(--border)}
.tabBtn{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.tabBtn.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.panelBody{padding:14px var(--space);overflow:auto}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}

/* coach cards */
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1)}
.headshot{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid #1a2f4a;background:#12243b;display:flex;align-items:center;justify-content:center}
.headshot img{width:100%;height:100%;object-fit:cover}
.cName{font-weight:900}
.cInfo{color:var(--muted);font-size:14px;margin-top:4px}
.hire{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer;background:#1a2a40;color:#d7e3f5}
.hire.ready{background:var(--accent);color:#fff}
.hire.owned{background:#198754;color:#fff}

/* splash / start */
.splash{position:fixed;inset:0;background:#fff;z-index:5000;display:none;align-items:center;justify-content:center}
.splash.open{display:flex}
.splashInner{width:min(90vw,900px);height:min(80vh,600px);display:flex;align-items:center;justify-content:center}
.splashLogo{max-width:100%;max-height:100%;animation:splashPop 1100ms cubic-bezier(.2,1.2,.3,1)}
@keyframes splashPop{0%{transform:scale(.82);opacity:0}45%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}

.start{position:fixed;inset:0;z-index:4500;display:none;align-items:center;justify-content:center;background:#000}
.start.open{display:flex}
.startFrame{position:relative;width:min(96vw,1100px);height:min(92vh,1200px);border-radius:18px;border:1px solid rgba(255,255,255,.08);background:#000;box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;display:flex;align-items:center;justify-content:center}
.startUI{position:absolute;left:50%;bottom:7vh;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:14px;width:min(92%,680px)}
.rowBtns{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%}
.btn{padding:14px 22px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.orange{background:var(--accent);color:#fff}
.btn.blue{background:var(--brandBlue);color:#fff}
.segment{display:inline-flex;border:1px solid #2b3d5a;border-radius:12px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:10px 14px;font-weight:900;cursor:pointer}
.segBtn.active{background:var(--accent);color:#fff}

/* tutorial */
.tut{position:fixed;inset:0;z-index:4000;display:none}
.tut.show{display:block}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.18)}
.bubble{position:absolute;left:50%;bottom:8vh;transform:translateX(-50%);display:flex;gap:14px;align-items:flex-start;background:#0f1b2b;border:2px solid var(--pillBr);border-radius:18px;padding:22px;max-width:min(1024px,96vw);box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tFace{width:92px;height:92px;border-radius:12px;overflow:hidden;border:1px solid #26406c;background:#0b1423}
.tFace img{width:100%;height:100%;object-fit:cover}
.bubble .content{display:flex;flex-direction:column;gap:8px}
.tWho{font-weight:900;color:#ffd6a8;margin-bottom:0}
.tText{font-size:clamp(18px,4vw,22px);line-height:1.35}
.hl{color:var(--accent);font-weight:900}
.tNext{margin-top:6px;font-size:14px;color:#cfe0ff;display:flex;align-items:center;gap:10px}
.chev{color:var(--accent-hi);font-size:24px}
.spot{position:absolute;border-radius:16px;box-shadow:0 0 0 4px rgba(255,179,87,.95),0 0 0 14px rgba(255,179,87,.20),0 0 42px rgba(255,179,87,.45);pointer-events:none}

/* larger bubbles on mobile */
@media(max-width:520px){
  .bubble{bottom:6vh;padding:24px}
  .tFace{width:112px;height:112px;margin:0 auto}
  .bubble{flex-direction:column;align-items:center}
}

/* offline modal */
.off{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:3500}
.off.open{display:flex}
.offCard{width:min(520px,94vw);background:#0f1b2b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center}
.offTitle{margin:0 0 6px;font-weight:900}
.offAmt{font-weight:900;font-size:24px}

/* motion reduce */
@media (prefers-reduced-motion: reduce){
  .coolFill::after{animation:none}
  .banner{animation:none}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topwrap">
    <div class="leftRow">
      <button id="avatarBtn" class="avatarBtn" title="Menu">
        <img id="avatarImg" alt="Avatar" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Player%20Male%20GIFF.gif?raw=true">
        <span id="menuDot" class="notifDot"></span>
      </button>
      <img class="logoImg" alt="Fitness Frenzy Logo" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Logo%20(2).png?raw=true" />
    </div>
    <div class="qtyGroup" id="qtyGroup">
      <button class="qtyBtn active" data-q="1">×1</button>
      <button class="qtyBtn" data-q="10">×10</button>
      <button class="qtyBtn" data-q="100">×100</button>
    </div>
    <div></div>
    <div class="hpRow">
      <div class="hpPill"><span class="hpLabel">HP:</span> <span id="hpTop" class="hpVal">0.00</span></div>
    </div>
  </div>
</div>

<!-- CONTENT -->
<div class="wrap"><div id="stack" class="stack"></div></div>
<div id="bannerHost"></div>

<!-- MENU -->
<div id="menuOv" class="menuOv" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHead">
      <div class="panelTitle">Menu</div>
      <div class="hpMini">HP: <span id="hpMini">0.00</span></div>
      <button id="menuClose" class="btn" style="margin-left:auto;background:#1a2a40;color:#d7e3f5">Close</button>
    </div>
    <div class="menuTabs">
      <button class="tabBtn active" data-tab="coaches">Coaches</button>
      <button class="tabBtn" data-tab="achievements">Achievements</button>
      <button class="tabBtn" data-tab="upgrades">Upgrades</button>
      <button class="tabBtn" data-tab="quests">Side Quests</button>
      <button class="tabBtn" data-tab="stats">Stats</button>
      <button class="tabBtn" data-tab="settings">Settings</button>
    </div>
    <div class="panelBody">
      <div id="tab-coaches"></div>
      <div id="tab-achievements" style="display:none"></div>
      <div id="tab-upgrades" style="display:none">
        <div class="coachCard"><div class="cInfo">Future boosts (energy drinks, pre-workout, coffee, weighted vests…)</div></div>
      </div>
      <div id="tab-quests" style="display:none">
        <div class="coachCard"><div class="cInfo">Side Quests: 5K, marathon, sunrise hike, fasting streak, buddy workout…</div></div>
      </div>
      <div id="tab-stats" style="display:none"></div>
      <div id="tab-settings" style="display:none"></div>
    </div>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tut" class="tut" aria-hidden="true">
  <div class="dim"></div>
  <div id="spot" class="spot" style="display:none"></div>
  <div class="bubble" id="bubble">
    <div class="tFace"><img id="tFace" alt="Trainer" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Trainer%20GIF.gif?raw=true"></div>
    <div class="content">
      <div class="tWho" id="tWho">JAX</div>
      <div class="tText" id="tText">…</div>
      <div class="tNext"><span>Next</span><span class="chev">›</span></div>
    </div>
  </div>
</div>

<!-- OFFLINE -->
<div id="off" class="off" aria-hidden="true">
  <div class="offCard">
    <h3 class="offTitle">Welcome back! 👋</h3>
    <div>You were away for <strong id="offDur">0s</strong>.</div>
    <div class="offAmt">You earned <strong id="offAmt">0.00</strong> HP while away.</div>
    <button id="offClaim" class="btn orange" style="margin-top:10px">Claim</button>
    <div id="offCapNote" style="color:#9fb1c8;margin-top:8px;display:none">Offline gains were capped for long absences.</div>
  </div>
</div>

<!-- SPLASH / START -->
<div id="splash" class="splash" aria-hidden="false">
  <div class="splashInner">
    <img class="splashLogo" alt="GameBros" src="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/GameBros%20Logo.png?raw=true">
  </div>
</div>

<div id="start" class="start" aria-hidden="true">
  <div class="startFrame">
    <div class="startUI">
      <div class="rowBtns" id="rowStart">
        <button id="btnStart" class="btn orange">New Game</button>
        <button id="btnContinue" class="btn blue" style="display:none">Continue</button>
      </div>
      <div class="segment" id="avatarSeg">
        <button class="segBtn active" data-avatar="male" title="Male">👨</button>
        <button class="segBtn" data-avatar="female" title="Female">👩</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================= CONFIG / UTIL ======================= */
const App = {};
App.Config = Object.freeze({
  SAVE_KEY:'ff-v1', SCHEMA:1, DEC:2, MIN_CD_MS:100, NOTIFY_MS:160, UI_MS:80, SAVE_MS:15000,
  OFFLINE_CAP_MS:24*60*60*1000, PULSE_MIN_MS:10000, PULSE_MAX_MS:11000,
  SPLASH_MS:5000
});

const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const el=(tag,attrs={})=>{ const n=document.createElement(tag); for(const k in attrs){ if(k==='text')n.textContent=attrs[k]; else if(k==='html')n.innerHTML=attrs[k]; else n.setAttribute(k,attrs[k]); } return n; };
const Bus=(()=>{ const m={}; return{on(e,f){(m[e]||(m[e]=[])).push(f)},emit(e,p){(m[e]||[]).slice().forEach(fn=>{try{fn(p)}catch{}})}}})();

const Util={
  clamp:(v,a,b)=>Math.max(a,Math.min(b,v)),
  fmtHP(n){ const a=Math.abs(n),d=App.Config.DEC; if(a>=1e9)return(n/1e9).toFixed(d)+'B'; if(a>=1e6)return(n/1e6).toFixed(d)+'M'; if(a>=1e3)return(n/1e3).toFixed(d)+'K'; return n.toFixed(d); },
  fmtCost(n){ const d=App.Config.DEC; if(n<1e3)return n.toFixed(d); if(n<1e6)return(n/1e3).toFixed(d)+'K'; if(n<1e9)return(n/1e6).toFixed(d)+'M'; return(n/1e9).toFixed(d)+'B'; },
  now:()=>performance.now(),
  randInt:(a,b)=>Math.floor(a+Math.random()*(b-a+1)),
  mobile:()=>/Mobi|Android/i.test(navigator.userAgent)
};

/* ======================= AUDIO ======================= */
const MusicURL_DESKTOP="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music.mp3?raw=true";
const MusicURL_MOBILE ="https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-fighting%20music%20(soft).mp3?raw=true";
const AudioSys=(()=>{ let music, musicVol=Util.mobile()?0.08:0.15, musicOn=false; const sfxEnabled={on:true};
  const synth=(type='sine',f=660,d=0.12,g=0.06)=>{ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(),q=ctx.createGain(); o.type=type;o.frequency.value=f;q.gain.value=g;o.connect(q);q.connect(ctx.destination);o.start();q.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);o.stop(ctx.currentTime+d+0.02);}catch{}};
  function playSFX(h){ if(!sfxEnabled.on)return;
    if(h==='tap.ok') synth('sine',700,0.07,0.07);
    else if(h==='reps.buy') synth('square',420,0.12,0.08);
    else if(h==='unlock.do') synth('triangle',300,0.2,0.1);
    else if(h==='upgrade.apply'){ synth('square',650,0.09,0.08); setTimeout(()=>synth('square',900,0.09,0.07),90);}
    else if(h==='achievement.unlock'){ synth('square',600,0.10,0.08); setTimeout(()=>synth('square',800,0.10,0.07),110); setTimeout(()=>synth('square',1000,0.12,0.07),220);}
    else if(h.startsWith('ui.')) synth('sine',500,0.06,0.05);
    else if(h.startsWith('tutorial.')) synth('triangle',520,0.09,0.06);
    else if(h.startsWith('offline.')) synth('sawtooth',400,0.12,0.06);
  }
  function startMusic(){ if(musicOn) return; musicOn=true; music=new Audio(Util.mobile()?MusicURL_MOBILE:MusicURL_DESKTOP); music.loop=true; music.volume=musicVol; music.play().catch(()=>{musicOn=false;}); }
  function setMusicVol(v){ musicVol=v; if(music) music.volume=v; }
  return {play:playSFX, music:{start:startMusic,setVol:setMusicVol}, sfxEnabled}; })();

/* ======================= STATE / SAVE ======================= */
const State={hp:0,qty:1,avatar:'male',stats:{manual:0,auto:0,totalEarned:0},coaches:{},achievements:{},exercises:[],tutorial:{done:false, shown:{rep:false, jog:false, coach:false}}};
function save(){ try{ localStorage.setItem(App.Config.SAVE_KEY,JSON.stringify({schema:App.Config.SCHEMA,...State})); }catch{} }
function load(){ try{ const raw=localStorage.getItem(App.Config.SAVE_KEY); if(!raw) return false; const j=JSON.parse(raw); if(j.schema===App.Config.SCHEMA){ Object.assign(State,j); return true; } }catch{} return false; }
const HAS_SAVE=load();

/* ======================= ASSETS ======================= */
const Assets={
  avatarMale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Player%20Male%20GIFF.gif?raw=true",
  avatarFemale:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-PlayerFemaleGIFF.gif?raw=true",
  trainer:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF-Trainer%20GIF.gif?raw=true"
};

/* videos/posters for first 4 exercises (male/female) */
const VID = {
  male:{
    walk:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20walking.mp4?raw=true",
    jog:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20running.mp4?raw=true",
    sit:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20situps.mp4?raw=true",
    push:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20pushups.mp4?raw=true"
  },
  female:{
    walk:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20walking.mp4?raw=true",
    jog:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20running.mp4?raw=true",
    sit:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20situps.mp4?raw=true",
    push:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercixe%20female%20pushups.mp4?raw=true"
  }
};
const POSTER = {
  male:{
    walk:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20walking.jpg?raw=true",
    jog:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20running.jpg?raw=true",
    sit:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20situp%20still.jpg?raw=true",
    push:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20male%20pushup%20still.jpg?raw=true"
  },
  female:{
    walk:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20walking.jpg?raw=true",
    jog:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20running.jpg?raw=true",
    sit:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20situp.jpg?raw=true",
    push:"https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/FF%20exercise%20female%20pushup.jpg?raw=true"
  }
};

/* Coach images & names (F/M alternating starting with F) */
const COACH_URL = [
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c1.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c2.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c3.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c4.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c5.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c6.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c7.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c8.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c9.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c10.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c11.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c12.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c13.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c14.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c15.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c16.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c17.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c18.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c19.png?raw=true",
  "https://github.com/JOE-RUGGIA/fitness-frenzy/blob/main/c20.png?raw=true"
];
const COACH_NAME = [
  "Aria Stride","Miles Pace","Cora Crunch","Max Push","Jenna Jacks",
  "Drew Pullman","Roxy Rope","Kai Plankston","Mina Summit","Kade Kettlebell",
  "Bella Burpee","Bennett Bench","Becca Backley","Dylan Deadlift","Hana Handstand",
  "Holden Press","Mara Muscle","Levi Lever","Iris Cross","Victor Victorian"
];

/* ======================= EXERCISES ======================= */
function buildExercises(){
  const L=[
    ['walk','Walking',1000],['jog','Jogging',3000],['sit','Sit-ups',6000],['push','Push-ups',12000],
    ['jacks','Jumping Jacks',24000],['pull','Pull-ups',48000],['rope','Jump Rope',96000],['plank','Plank',192000],
    ['mtclimb','Mountain Climbers',384000],['kb','Kettlebell',768000],['burpee','Burpees',1536000],
    ['bench','Bench Press',3072000],['backsq','Back Squat',6144000],['dead','Deadlift',12288000],
    ['hand','Handstands',24576000],['hspu','Handstand Push-ups',49152000],['muscle','Muscle-ups',98304000],
    ['lever','Front Lever',196608000],['icross','Iron Cross',393216000],['vcross','Victorian Cross',786432000]
  ];
  const arr=[];
  for(let i=0;i<L.length;i++){
    const [id,name,cd]=L[i];
    const sec=cd/1000;
    let baseHP=i===0?1:Math.round(20*Math.pow(sec,1.10));
    const repBaseCost=Math.max(4,Math.round(baseHP*0.05));
    const unlockCost=(i===0)?0:Math.round(baseHP*Math.pow(sec,0.60)*1.15);
    const prev=State.exercises.find(e=>e.id===id)||{};
    arr.push({
      id,name,baseHP,baseCooldown:cd,unlockCost,repBaseCost,
      unlocked: prev.unlocked ?? (i===0), repHP: prev.repHP ?? 0, repProgress: prev.repProgress ?? 0,
      repTarget: prev.repTarget ?? 10, level: prev.level ?? 1, cooldown: prev.cooldown ?? cd,
      lastTapAt: prev.lastTapAt ?? 0, _autoElapsed:0, els:{} });
  }
  State.exercises=arr;
}
buildExercises();

/* ======================= GAME ======================= */
const Game={
  perTap:(ex)=>ex.baseHP+ex.repHP,
  repGrowth:(ex)=>Util.clamp(1.07+0.01*Math.log2(Math.max(1,ex.level)),1.07,1.15),
  repCost(ex,n=1){ const g=Game.repGrowth(ex); const b=ex.repBaseCost*Math.pow(g,ex.repHP); if(n===1)return +(b.toFixed(App.Config.DEC)); return +((b*(Math.pow(g,n)-1)/(g-1)).toFixed(App.Config.DEC)); },
  addHP(v){ State.hp+=v; if(v>0) State.stats.totalEarned+=v; Bus.emit('hp',State.hp); },
  tap(ex,now=Util.now()){
    if(!ex.unlocked) return 0; const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);
    if(ex.lastTapAt>0 && now-ex.lastTapAt<cd-1){ AudioSys.play('tap.blocked'); return 0;}
    ex.lastTapAt=now; const g=Game.perTap(ex); Game.addHP(g); State.stats.manual++; AudioSys.play('tap.ok');
    UI.floatFrom(ex.els.left,`+${g.toFixed(App.Config.DEC)}`); UI.popTap(ex);
    return g;
  },
  buyReps(ex,n){
    const cost=Game.repCost(ex,n); if(State.hp+1e-6<cost) return false;
    Game.addHP(-cost); ex.repHP+=n; ex.repProgress+=n;
    while(ex.repProgress>=ex.repTarget){
      ex.repProgress-=ex.repTarget; ex.repTarget*=2; ex.level+=1;
      ex.cooldown=Math.max(App.Config.MIN_CD_MS,Math.floor(ex.cooldown/2));
      Banners.push(`${ex.name} upgraded to <strong>Lvl ${ex.level}</strong> — cooldown halved!`);
      AudioSys.play('upgrade.apply'); FX.confettiAt(ex.els.card); Bus.emit('upgrade',{id:ex.id,level:ex.level});
    }
    AudioSys.play('reps.buy'); Bus.emit('reps',{id:ex.id,qty:n}); return true;
  },
  unlock(ex){
    if(ex.unlocked) return false; if(State.hp+1e-6<ex.unlockCost) return false;
    Game.addHP(-ex.unlockCost); ex.unlocked=true; ex.lastTapAt=0; AudioSys.play('unlock.do'); FX.confettiAt(ex.els.card); Bus.emit('unlock',ex.id); return true;
  }
};

/* ======================= ENGINE ======================= */
const Engine=(()=>{ let last=Util.now();
  function loop(){ const now=Util.now(); const dt=Math.min(0.25,(now-last)/1000); last=now;
    // auto
    for(const ex of State.exercises){
      if(!Coaches.isAuto(ex.id)) continue;
      const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown); ex._autoElapsed+=dt*1000;
      while(ex._autoElapsed>=cd){ ex._autoElapsed-=cd; ex.lastTapAt=now; const g=Game.perTap(ex); Game.addHP(g); State.stats.auto++; if(Settings.get('floats')) UI.floatFrom(ex.els.left,`+${g.toFixed(App.Config.DEC)}`); }
    }
    // cooldown visuals
    for(const ex of State.exercises) UI.drawCooldown(ex);
    UI.tickTop(dt); UI.refreshThrottled(); Notify.updateThrottled();
    requestAnimationFrame(loop);
  }
  return {start:()=>requestAnimationFrame(loop)};
})();

/* ======================= UI ======================= */
const UI={
  _hpShown:0,
  build(){
    const host=$('#stack'); host.innerHTML='';
    State.exercises.forEach((ex,i)=>{
      const card=el('div',{class:'card','data-id':ex.id}); ex.els.card=card;
      const left=el('div',{class:'left'}); ex.els.left=left;

      // video/poster only for first 4
      if(['walk','jog','sit','push'].includes(ex.id)){
        const sex=State.avatar==='female'?'female':'male';
        const src=VID[sex][ex.id==='walk'?'walk':ex.id==='jog'?'jog':ex.id==='sit'?'sit':'push'];
        const poster=POSTER[sex][ex.id==='walk'?'walk':ex.id==='jog'?'jog':ex.id==='sit'?'sit':'push'];
        const vid=el('video',{class:'vid',muted:'',playsinline:'',preload:'none',poster});
        const img=el('img',{class:'poster',src:poster,alt:ex.name});
        left.append(img,vid); ex.els.vid=vid; ex.els.poster=img;

        // pulse play every 10-11s
        const schedule=()=>setTimeout(()=>{ if(!ex.unlocked) return schedule(); try{vid.currentTime=0; vid.play().catch(()=>{}); setTimeout(()=>{try{vid.pause()}catch{}},2000);}catch{} schedule(); }, Util.randInt(App.Config.PULSE_MIN_MS,App.Config.PULSE_MAX_MS));
        schedule();

        vid.addEventListener('error',()=>{ vid.remove(); img.style.display='block'; });
      }else{
        // emoji fallback for others (placeholder)
        const span=el('div',{text:UI.emojiFor(ex.id)}); span.style.fontSize='48px'; span.style.lineHeight='1'; left.append(span);
      }

      const lvl=el('div',{class:'lvlBadge',text:`Lvl ${ex.level}`}); ex.els.lvl=lvl; left.append(lvl);
      const coachDot=el('div',{class:'coachDot'}); ex.els.coachDot=coachDot; coachDot.append(el('img',{alt:'Coach'})); left.append(coachDot);

      const repBand=el('div',{class:'repBand'}); const repFill=el('div',{class:'repFill'}); const repText=el('div',{class:'repText',text:`${ex.repProgress}/${ex.repTarget}`});
      ex.els.repFill=repFill; ex.els.repText=repText; repBand.append(repFill,repText); left.append(repBand);

      const right=el('div',{class:'right'});
      const title=el('div',{class:'title',text:ex.name}); const coolRow=el('div',{class:'coolRow'}); const cool=el('div',{class:'cool'}); const bar=el('div',{class:'coolBar'}); const fill=el('div',{class:'coolFill'}); ex.els.fill=fill; bar.append(fill); cool.append(bar);
      const time=el('div',{class:'coolTime',text:(Math.max(App.Config.MIN_CD_MS,ex.cooldown)/1000).toFixed(App.Config.DEC)+'s'}); ex.els.time=time; coolRow.append(cool,time);
      const meta=el('div',{class:'metaRow'}); const kv=el('div',{class:'kv',text:`${Game.perTap(ex).toFixed(0)} HP`}); ex.els.kv=kv; const chips=el('div',{class:'chips'}); ex.els.chips=chips;
      const reps=el('button',{class:'repsBtn',text:'Reps'}); ex.els.reps=reps; meta.append(kv,chips,reps);

      right.append(title,coolRow,meta);

      if(ex.unlocked){
        card.append(left,right);
      }else{
        card.classList.add('locked');
        const lockRow=el('div',{class:'lockRow'});
        const lockName=el('div',{class:'lockName',text:ex.name});
        const pill=el('button',{class:'unlockPill',text:`Unlock for ${Util.fmtCost(ex.unlockCost)} HP`}); ex.els.pill=pill;
        lockRow.append(lockName,pill); card.append(left,lockRow);
      }
      host.appendChild(card);

      /* interactions */
      left.addEventListener('pointerdown',e=>{ e.preventDefault(); if(!ex.unlocked) return; Game.tap(ex); save(); });
      if(ex.els.reps) ex.els.reps.addEventListener('click',()=>{ if(Game.buyReps(ex,State.qty)) save(); });
      if(ex.els.pill) ex.els.pill.addEventListener('click',()=>{ if(Game.unlock(ex)){ card.classList.remove('locked','unlockPulse'); card.innerHTML=''; card.append(left,right); save(); } });

      // keep each card compact and stable
      card.style.minHeight='auto';
    });
  },
  emojiFor(id){
    const map={jacks:'🤸',pull:'🧗',rope:'🪢',plank:'🧘',mtclimb:'🏔️',kb:'🏋️',burpee:'⚡',bench:'🏋️‍♂️',backsq:'🏋️‍♀️',dead:'🦾',hand:'🤸‍♂️',hspu:'📈',muscle:'💪',lever:'🧲',icross:'➕',vcross:'✚'};
    if(id==='walk') return '🚶'; if(id==='jog') return '🏃'; if(id==='sit') return '🧎'; if(id==='push') return '🙇';
    return map[id]||'🏅';
  },
  drawCooldown(ex){
    if(!ex.unlocked) return;
    const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown);
    if(cd<=App.Config.MIN_CD_MS){ ex.els.fill.style.width='100%'; ex.els.time.textContent=(cd/1000).toFixed(App.Config.DEC)+'s'; return; }
    const ready=ex.lastTapAt<=0; const since=ready?cd:(Util.now()-ex.lastTapAt); const elapsed=Math.max(0,Math.min(since,cd)); const pct=elapsed/cd;
    ex.els.fill.style.width=(pct*100).toFixed(1)+'%'; ex.els.time.textContent=(elapsed/1000).toFixed(App.Config.DEC)+'s';
  },
  tickTop(dt){ UI._hpShown += (State.hp-UI._hpShown)*Math.min(1,dt*8); $('#hpTop').textContent=Util.fmtHP(UI._hpShown); $('#hpMini').textContent=Util.fmtHP(UI._hpShown); },
  refreshThrottled(){ const now=performance.now(); if(!UI._next||now>=UI._next){ UI._next=now+App.Config.UI_MS; for(const ex of State.exercises) UI.refreshExercise(ex); } },
  refreshExercise(ex){
    ex.els.repText.textContent=`${ex.repProgress}/${ex.repTarget}`; ex.els.repFill.style.width=Math.min(1,ex.repProgress/ex.repTarget)*100+'%';
    ex.els.lvl.textContent=`Lvl ${ex.level}`; ex.els.kv.textContent=`${Game.perTap(ex).toFixed(0)} HP`;
    const n=State.qty; const cost=Game.repCost(ex,n); const can=State.hp+1e-6>=cost;
    if(ex.els.reps){ ex.els.reps.textContent=(n===1?`Reps (${Util.fmtCost(cost)} HP)`:`×${n} Reps (${Util.fmtCost(cost)} HP)`); ex.els.reps.classList.toggle('ready',can); ex.els.reps.disabled=!can; }
    if(!ex.unlocked && ex.els.pill){ const canU=State.hp+1e-6>=ex.unlockCost; ex.els.pill.textContent=`Unlock for ${Util.fmtCost(ex.unlockCost)} HP`; ex.els.pill.classList.toggle('ready',canU); ex.els.card.classList.toggle('unlockPulse',canU); }
    // coach chip icon only
    const owned=Coaches.ownedFor(ex.id); if(owned.length){ ex.els.coachDot.style.display='flex'; ex.els.coachDot.querySelector('img').src=owned[0].icon; } else { ex.els.coachDot.style.display='none'; }
  },
  floatFrom(ref,text){ if(!ref||!Settings.get('floats')) return; const r=ref.getBoundingClientRect(); const sp=el('div',{class:'float',text}); sp.style.left=(r.left+r.width/2)+'px'; sp.style.top=(r.top+r.height*0.15)+'px'; document.body.appendChild(sp); setTimeout(()=>sp.remove(),900); },
  popTap(ex){ ex.els.left.animate([{transform:'scale(1)'},{transform:'scale(0.96)'},{transform:'scale(1)'}],{duration:140, easing:'cubic-bezier(.2,1.2,.3,1)'}); ex.els.card.animate([{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 0 0 rgba(0,0,0,0)'}],{duration:100}); }
};
const Banners={push(html){ const host=$('#bannerHost'); const b=el('div',{class:'banner',html:`🎉 ${html}`}); host.appendChild(b); setTimeout(()=>b.remove(),3200);} };
const FX={confettiAt(node){ if(!node) return; const rect=node.getBoundingClientRect(); const x=rect.left+rect.width/2, y=rect.top+rect.height/2; const host=el('div'); host.style.cssText='position:fixed;left:0;top:0;pointer-events:none;z-index:2200'; document.body.appendChild(host); const colors=['#ffb357','#ffd166','#7bd88f','#6bd3ff','#d4bfff','#ff8fab']; for(let i=0;i<24;i++){ const d=el('div'); const size=6+Math.random()*6; d.style.cssText=`position:absolute;width:${size}px;height:${size}px;background:${colors[i%colors.length]};opacity:.95;border-radius:${Math.random()<.4?'50%':'2px'};left:${x+(Math.random()*120-60)}px;top:${y+(Math.random()*40-20)}px`; const dx=(Math.random()*2-1)*(innerWidth*0.12),dy=(innerHeight*0.25+Math.random()*innerHeight*0.15); d.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${180+Math.random()*180}deg)`,opacity:0}],{duration:1100+Math.random()*600,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}); host.appendChild(d);} setTimeout(()=>host.remove(),1800);} };

/* ======================= COACHES / MENU ======================= */
const Coaches={
  list:[],
  build(){ Coaches.list=State.exercises.map((ex,idx)=>({id:'c'+(idx+1),name:COACH_NAME[idx],icon:COACH_URL[idx]||COACH_URL[COACH_URL.length-1],target:ex.id,price:Coaches.priceFor(idx)})); },
  priceFor(idx){ return idx===0?1500:Math.round(1500*Math.pow(1.8,idx)); },
  isAuto(exId){ return Coaches.list.some(c=>State.coaches[c.id] && c.target===exId); },
  ownedFor(exId){ return Coaches.list.filter(c=>State.coaches[c.id] && c.target===exId); },
  renderTab(){
    const host=$('#tab-coaches'); host.innerHTML='';
    const intro=el('div',{class:'coachCard'}); intro.append(el('div',{class:'cInfo',text:'Coaches auto-tap a specific exercise (no sound), respecting cooldowns. Hire when affordable.'})); host.appendChild(intro);
    const grid=el('div',{class:'grid'}); host.appendChild(grid);
    const exBy=Object.fromEntries(State.exercises.map(e=>[e.id,e]));
    for(const c of Coaches.list){
      const ex=exBy[c.target]; const owned=!!State.coaches[c.id]; const can=State.hp+1e-6>=c.price; const unlockedTarget=!!(ex&&ex.unlocked);
      const card=el('div',{class:'coachCard'+(unlockedTarget?'':' locked')}); const head=el('div',{class:'headshot'}); head.append(el('img',{src:c.icon,alt:c.name}));
      const mid=el('div'); mid.append(el('div',{class:'cName',text:c.name}),el('div',{class:'cInfo',text:`Works on: ${ex?.name||c.target}`}));
      const btn=el('button',{class:'hire',text:owned?'Hired':`Hire • ${Util.fmtCost(c.price)} HP`});
      if(owned){ btn.classList.add('owned'); btn.disabled=true; } else if(unlockedTarget){ btn.classList.toggle('ready',can); btn.disabled=!can; }
      card.append(head,mid,btn); grid.appendChild(card);
      btn.addEventListener('click',()=>{ if(owned||!unlockedTarget) return; if(State.hp+1e-6<c.price) return; Game.addHP(-c.price); State.coaches[c.id]=true; AudioSys.play('ui.click'); save(); UI.refreshThrottled(); Coaches.renderTab(); });
    }
  }
};
Coaches.build();

const Notify=(()=>{ let next=0;
  function coachAvailable(){ for(const c of Coaches.list){ const ex=State.exercises.find(e=>e.id===c.target); if(!ex||!ex.unlocked) continue; if(State.coaches[c.id]) continue; if(State.hp+1e-6>=c.price) return true; } return false; }
  function update(){ $('#menuDot').classList.toggle('show',coachAvailable()); }
  function updateThrottled(){ const now=performance.now(); if(now>=next){ next=now+App.Config.NOTIFY_MS; update(); } }
  Bus.on('hp',update); Bus.on('unlock',update); Bus.on('reps',update); Bus.on('upgrade',update);
  return {update,updateThrottled};
})();

const Menu={
  open(){ $('#menuOv').classList.add('open'); $('#menuOv').setAttribute('aria-hidden','false'); AudioSys.play('ui.menu.open'); $('.tabBtn[data-tab="coaches"]').click(); },
  close(){ $('#menuOv').classList.remove('open'); $('#menuOv').setAttribute('aria-hidden','true'); AudioSys.play('ui.menu.close'); },
  wire(){
    $('#avatarBtn').addEventListener('click',()=>Menu.open());
    $('#menuClose').addEventListener('click',()=>Menu.close());
    $('#menuOv').addEventListener('click',e=>{ if(e.target.id==='menuOv') Menu.close(); });
    $$('.tabBtn',$('.menuTabs')).forEach(btn=>btn.addEventListener('click',()=>{ AudioSys.play('ui.tab.switch'); $$('.tabBtn',$('.menuTabs')).forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const tab=btn.dataset.tab; ['coaches','achievements','upgrades','quests','stats','settings'].forEach(t=>$('#tab-'+t).style.display=(t===tab?'block':'none')); if(tab==='coaches') Coaches.renderTab(); if(tab==='stats') Menu.renderStats(); if(tab==='settings') Menu.renderSettings(); if(tab==='achievements') Menu.renderAchievements(); }));
  },
  renderStats(){ const host=$('#tab-stats'); host.innerHTML=`<div class="coachCard"><div><div><strong>Current HP:</strong> ${Util.fmtHP(State.hp)}</div><div><strong>Total Earned:</strong> ${Util.fmtHP(State.stats.totalEarned||0)}</div><div><strong>Manual Taps:</strong> ${State.stats.manual||0}</div><div><strong>Auto Taps:</strong> ${State.stats.auto||0}</div><div><strong>Exercises Unlocked:</strong> ${State.exercises.filter(e=>e.unlocked).length} / ${State.exercises.length}</div><div><strong>Coaches Hired:</strong> ${Object.values(State.coaches).filter(Boolean).length} / ${Coaches.list.length}</div></div></div>`; },
  renderSettings(){ const host=$('#tab-settings'); host.innerHTML=''; const card=el('div',{class:'coachCard'}); const wrap=el('div');
    wrap.innerHTML=`<div style="display:flex;flex-direction:column;gap:10px"><label><input id="set-sfx" type="checkbox" checked/> Sound Effects</label><label>Music Volume <input id="set-music" type="range" min="0" max="1" step="0.01" value="${Util.mobile()?0.08:0.15}" style="width:160px;vertical-align:middle"> (low)</label><label><input id="set-floats" type="checkbox" checked/> Show +HP floaters</label></div><hr style="border:0;border-top:1px solid #223556;margin:10px 0"><div style="display:flex;gap:8px;flex-wrap:wrap"><button id="btn-save" class="btn" style="background:#1a2a40;color:#d7e3f5">Save</button><button id="btn-reset" class="btn" style="background:#1a2a40;color:#d7e3f5">Reset</button></div>`;
    card.appendChild(wrap); host.appendChild(card);
    $('#set-sfx').onchange=e=>AudioSys.sfxEnabled.on=!!e.target.checked;
    $('#set-music').oninput=e=>AudioSys.music.setVol(parseFloat(e.target.value||'0.15'));
    $('#set-floats').onchange=e=>Settings.set('floats',!!e.target.checked);
    $('#btn-save').onclick=()=>{ save(); AudioSys.play('ui.click'); };
    $('#btn-reset').onclick=()=>{ if(confirm('Reset your progress?')){ localStorage.removeItem(App.Config.SAVE_KEY); location.reload(); } };
  },
  renderAchievements(){ const host=$('#tab-achievements'); host.innerHTML=''; const grid=el('div',{class:'grid'}); host.appendChild(grid);
    for(const a of Achievements.defs){ const owned=!!State.achievements[a.id]; const card=el('div',{class:'coachCard'}); const head=el('div',{class:'headshot'}); head.append(el('div',{text:a.icon,style:'font-size:36px;display:flex;align-items:center;justify-content:center;width:100%;height:100%'})); const mid=el('div'); mid.append(el('div',{class:'cName',text:a.title}),el('div',{class:'cInfo',text:a.desc})); const right=el('div',{class:'cInfo',text: owned? 'Completed' : `Reward: +${Util.fmtCost(a.reward)} HP`}); card.append(head,mid,right); grid.appendChild(card);} }
};

/* ======================= ACHIEVEMENTS ======================= */
const Achievements={defs:[
  {id:'first_steps',icon:'👣',title:'First Steps',desc:'Upgrade Walking to Lvl 2 (10/10).',reward:50,test:()=>State.exercises.find(e=>e.id==='walk')?.level>=2},
  {id:'add_routine',icon:'🏃',title:'Add to Routine',desc:'Unlock Jogging.',reward:100,test:()=>State.exercises.find(e=>e.id==='jog')?.unlocked},
  {id:'first_coach',icon:'🧑‍🏫',title:'Coach On Duty',desc:'Hire your first coach.',reward:150,test:()=>Object.values(State.coaches).some(Boolean)},
  {id:'speed_demon',icon:'⚡',title:'Speed Demon',desc:'Any exercise reaches ≤0.30s cooldown.',reward:180,test:()=>State.exercises.some(e=>e.unlocked && Math.max(App.Config.MIN_CD_MS,e.cooldown)<=300)}
],
checkAll(){ for(const a of Achievements.defs){ if(!State.achievements[a.id] && a.test()){ State.achievements[a.id]=true; Game.addHP(a.reward); AudioSys.play('achievement.unlock'); Banners.push(`Achievement: <strong>${a.title}</strong> • +${Util.fmtCost(a.reward)} HP`); save(); } } } };
Bus.on('hp',()=>Achievements.checkAll()); Bus.on('upgrade',()=>Achievements.checkAll()); Bus.on('unlock',()=>Achievements.checkAll()); Bus.on('reps',()=>Achievements.checkAll());

/* ======================= SETTINGS ======================= */
const Settings=(()=>{ const d={floats:true}; try{ const raw=localStorage.getItem(App.Config.SAVE_KEY+':prefs'); if(raw){ Object.assign(d,JSON.parse(raw)); } }catch{} function saveSettings(){ try{ localStorage.setItem(App.Config.SAVE_KEY+':prefs',JSON.stringify(d)); }catch{} } return{get:k=>d[k], set:(k,v)=>{ d[k]=v; saveSettings(); }} })();

/* ======================= OFFLINE ======================= */
const Offline=(()=>{ const KEY='ff-last'; const off=$('#off');
  function saveNow(){ try{ localStorage.setItem(KEY,Date.now().toString()); }catch{} }
  function fmt(ms){ let s=Math.floor(ms/1000),h=Math.floor(s/3600); s%=3600; const m=Math.floor(s/60); s%=60; const L=[]; if(h)L.push(h+'h'); if(m)L.push(m+'m'); if(s||!L.length)L.push(s+'s'); return L.join(' '); }
  function summary(ms){ let sum=0; for(const ex of State.exercises){ if(!ex.unlocked) continue; if(!Coaches.isAuto(ex.id)) continue; const cd=Math.max(App.Config.MIN_CD_MS,ex.cooldown); const taps=Math.floor(ms/cd); if(taps>0) sum+=taps*Game.perTap(ex); } return sum; }
  function check(){ const last=parseInt(localStorage.getItem(KEY)||'0',10); const now=Date.now(); if(last>0){ const delta=now-last; const cap=Math.min(delta,App.Config.OFFLINE_CAP_MS); const gain=summary(cap); if(gain>0){ $('#offDur').textContent=fmt(cap); $('#offAmt').textContent=Util.fmtHP(gain); $('#offCapNote').style.display=(delta>cap)?'block':'none'; off.classList.add('open'); AudioSys.play('offline.show'); $('#offClaim').onclick=()=>{ Game.addHP(gain); off.classList.remove('open'); AudioSys.play('offline.claim'); save(); }; } } saveNow(); }
  window.addEventListener('visibilitychange',()=>{ if(document.hidden) saveNow(); }); window.addEventListener('pagehide',saveNow); window.addEventListener('beforeunload',saveNow);
  return {check};
})();

/* ======================= TUTORIAL ======================= */
const Tutorial=(()=>{ const ov=$('#tut'),bubble=$('#bubble'),tFace=$('#tFace'),tWho=$('#tWho'),tText=$('#tText'),spot=$('#spot'); let step=null,idx=0;
  function show(){ ov.classList.add('show'); ov.setAttribute('aria-hidden','false'); AudioSys.play('tutorial.show'); }
  function hide(){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); hideSpot(); }
  function setSpeaker(who){ tWho.textContent=who; tFace.src=(who==='JAX')?Assets.trainer:(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale); }
  function setLines(lines){ idx=0; setSpeaker(lines[0].who); tText.innerHTML=lines[0].html; show(); }
  function nextLine(lines,onDone){ if(idx<lines.length-1){ idx++; setSpeaker(lines[idx].who); tText.innerHTML=lines[idx].html; AudioSys.play('tutorial.next'); } else { if(onDone) onDone(); } }
  bubble.addEventListener('click',()=>{ if(step) nextLine(step.lines,step.onDone); });
  function showSpot(sel){ const node=document.querySelector(sel); if(!node){hideSpot();return;} const r=node.getBoundingClientRect(), pad=6; spot.style.display='block'; spot.style.left=(r.left-pad)+'px'; spot.style.top=(r.top-pad)+'px'; spot.style.width=(r.width+pad*2)+'px'; spot.style.height=(r.height+pad*2)+'px'; }
  function hideSpot(){ spot.style.display='none'; }

  function startIntro(){
    if(State.tutorial.done) return;
    const lines=[{who:'JAX',html:`You look a bit low on energy. Let's fix that <span class="hl">fast</span> 💪`},{who:'You',html:`Where do I start?`},{who:'JAX',html:`Tap <span class="hl">Walking</span> to earn <span class="hl">1 HP</span>. Then we'll power up.`}];
    setLines(lines); step={lines,onDone(){ hide(); showSpot('.card[data-id="walk"] .left'); }};
  }

  // Rep tip at 4 HP (only once)
  Bus.on('hp',()=>{ if(State.tutorial.shown.rep || State.tutorial.done) return; const w=State.exercises.find(e=>e.id==='walk'); if(!w) return; if(State.hp+1e-6>=4){ State.tutorial.shown.rep=true; save(); const L=[{who:'JAX',html:`Good! Use <span class="hl">Reps</span> to hit harder. Watch the <span class="hl">green bar</span> (10/10 upgrades your cooldown).`}] ; setLines(L); step={lines:L,onDone(){ hide(); }}; showSpot('.card[data-id="walk"] .repsBtn'); } });

  // Jogging unlock tip (first unlock only)
  Bus.on('hp',()=>{ if(State.tutorial.shown.jog || State.tutorial.done) return; const j=State.exercises.find(e=>e.id==='jog'); if(!j || j.unlocked) return; if(State.hp+1e-6>=j.unlockCost){ State.tutorial.shown.jog=true; save(); const L=[{who:'JAX',html:`Add to your routine! Unlock <span class="hl">Jogging</span> when the pill turns orange.`}]; setLines(L); step={lines:L,onDone(){ hide(); }}; showSpot('.card[data-id="jog"] .unlockPill'); } });

  // First coach only
  Bus.on('hp',()=>{ if(State.tutorial.shown.coach || State.tutorial.done) return; const c=Coaches.list[0]; if(!c) return; const ex=State.exercises.find(e=>e.id===c.target); if(!ex||!ex.unlocked) return; if(State.hp+1e-6>=c.price){ State.tutorial.shown.coach=true; save(); const L=[{who:'JAX',html:`Want to maximize gains? Open the <span class="hl">Menu</span> (your avatar) and <span class="hl">Hire</span> a coach.`}]; setLines(L); step={lines:L,onDone(){ hide(); }}; showSpot('#avatarBtn'); } });

  return {startIntro};
})();

/* ======================= START / SPLASH ======================= */
function showSplashThenStart(){ const s=$('#splash'); s.classList.add('open'); setTimeout(()=>{ s.classList.remove('open'); $('#start').classList.add('open'); }, App.Config.SPLASH_MS); }
function wireStart(){
  // Continue visible only if save exists
  if(HAS_SAVE){ $('#btnContinue').style.display='inline-block'; }
  $('#btnStart').addEventListener('click',()=>{ AudioSys.play('ui.click'); localStorage.removeItem(App.Config.SAVE_KEY); Object.assign(State,{hp:0,qty:1,avatar:State.avatar,stats:{manual:0,auto:0,totalEarned:0},coaches:{},achievements:{},exercises:[],tutorial:{done:false,shown:{rep:false,jog:false,coach:false}}}); buildExercises(); UI.build(); Coaches.build(); $('#start').classList.remove('open'); AudioSys.music.start(); Tutorial.startIntro(); Offline.check(); save(); });
  $('#btnContinue').addEventListener('click',()=>{ AudioSys.play('ui.click'); $('#start').classList.remove('open'); AudioSys.music.start(); Offline.check(); });
  $$('.segBtn',$('#avatarSeg')).forEach(b=>b.addEventListener('click',()=>{ $$('.segBtn',$('#avatarSeg')).forEach(x=>x.classList.remove('active')); b.classList.add('active'); State.avatar=b.dataset.avatar; $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale); save(); // rebuild first 4 to swap videos/posters
    UI.build();
  }));
}

/* ======================= INPUT GUARDS ======================= */
(function mobileGuards(){ let lastTouch=0; document.addEventListener('touchend',e=>{ const n=Date.now(); if(n-lastTouch<300){ e.preventDefault(); } lastTouch=n; },{passive:false}); document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false}); document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false}); })();

/* ======================= TOPBAR WIRING ======================= */
function wireTopbar(){ const g=$('#qtyGroup'); $$('.qtyBtn',g).forEach(btn=>btn.addEventListener('click',()=>{ $$('.qtyBtn',g).forEach(x=>x.classList.remove('active')); btn.classList.add('active'); State.qty=parseInt(btn.dataset.q,10)||1; save(); AudioSys.play('ui.click'); UI.refreshThrottled(); })); }

/* ======================= BOOT ======================= */
function boot(){
  $('#avatarImg').src=(State.avatar==='female'?Assets.avatarFemale:Assets.avatarMale);
  UI._hpShown=State.hp;
  UI.build();
  Menu.wire();
  wireTopbar();
  wireStart();
  showSplashThenStart();
  // keep mini HP fresh in menu
  setInterval(()=>{ $('#hpMini').textContent=Util.fmtHP(State.hp); }, 400);
  State.qty=State.qty||1;
  Engine.start();
  setInterval(save,App.Config.SAVE_MS);
  // start music only after user interaction (start/continue)
}

document.addEventListener('DOMContentLoaded', boot);

/* ======================= BUS HOOKS ======================= */
Bus.on('unlock',()=>save());
Bus.on('reps',()=>save());
Bus.on('upgrade',()=>save());
</script>
</body>
</html>
