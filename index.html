<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fitness Frenzy ‚Äì v5.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{
  --bg:#0a1320; --card:#0f1b2b; --ink:#e9eef3; --muted:#a7b7cc; --border:#213149;
  --accent:#cc6b2c; --accent-hi:#ffb357; --rep:#22c55e; --warn:#39d98a;
  --space:clamp(10px,2.2vw,18px); --r:16px; --fs-2:clamp(18px,3.2vw,22px); --repband:16%;
}
*{box-sizing:border-box}
html,body{height:100%; touch-action:manipulation; overflow-x:hidden;}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);
     padding:env(safe-area-inset-top)0 env(safe-area-inset-bottom)0;}
button,.tapPad{-webkit-user-select:none;user-select:none;touch-action:manipulation}

/* Topbar */
.topbar{position:sticky; top:0; z-index:1000; background:rgba(10,19,32,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topwrap{max-width:980px;margin:0 auto;padding:8px var(--space);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.title{display:flex;align-items:center;gap:10px}
.titleAvatar{width:clamp(48px,7.5vw,64px); height:clamp(48px,7.5vw,64px); border-radius:50%; overflow:hidden;
             background:#0b1423;border:2px solid #2e4e7e; box-shadow:0 6px 18px rgba(0,0,0,.28)}
.titleAvatar img{width:100%; height:100%; object-fit:cover; image-rendering:auto}
h1{margin:0;font-size:clamp(22px,5vw,28px)}
.topPlayer{display:flex;align-items:center;gap:8px;margin-left:6px}
.pAvatar{width:44px;height:44px;border-radius:50%;overflow:hidden;background:#0b1423;border:1px solid #27456d;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.pAvatar img{width:100%;height:100%;object-fit:cover;image-rendering:auto}
.hpPill{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;
        background:linear-gradient(135deg,#132647,#1d3a61);border:1px solid #2a4a78;
        box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04)}
.hpPill .label{font-weight:900;letter-spacing:.3px;color:var(--accent)}
.hpPill .val{font-variant-numeric:tabular-nums;font-weight:900;color:#fff;font-size:clamp(20px,4.5vw,28px);
             width:11ch;text-align:left;padding-right:1ch;white-space:nowrap;overflow:hidden}
.hpPill.small{transform:scale(.9); transform-origin:right center}
.spacer{flex:1}
.seg{display:inline-flex;border:1px solid #2b3d5a;border-radius:10px;overflow:hidden}
.segBtn{background:#13233b;color:#cfe0ff;border:0;padding:8px 12px;font-weight:800;cursor:pointer}
.segBtn.active{background:var(--accent);color:#fff}
.btn{position:relative;overflow:hidden;padding:12px 18px;border:none;border-radius:14px;font-weight:800;cursor:pointer;transform:translateZ(0)}
.btn.primary{background:var(--accent);color:#fff}
.btn.secondary{background:#1a2a40;color:#d7e3f5}
.btn.ghost{background:#13233b;color:#cfe0ff;border:1px solid #2b3d5a}
.btn.ready{box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 8px 20px rgba(204,107,44,.35)}
.btn.ready::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.18) 45%,transparent 90%);
                  transform:translateX(-110%);animation:shine 1.25s linear infinite;pointer-events:none}
.btn[disabled]{filter:saturate(.65) brightness(.85)}
@keyframes shine{to{transform:translateX(110%)}}
#menuBtn{position:relative; overflow:visible; z-index:1;}
.notifDot{position:absolute; right:-12px; top:-12px; width:16px; height:16px; border-radius:50%;
  display:none; background:var(--warn); box-shadow:0 0 0 2px rgba(10,19,32,.95); pointer-events:none; z-index:200;}
.notifDot.show{display:block}

/* Layout / cards */
.wrap{max-width:980px;margin:0 auto;padding:var(--space)}
.stack{display:flex;flex-direction:column;gap:var(--space)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:var(--space);
      display:flex;gap:14px;align-items:stretch;transition:transform .18s ease,filter .18s ease,opacity .18s ease}
.card.locked{opacity:.58;filter:grayscale(1);transform:scale(.90)}
.card.unlock-ready{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 14px 30px rgba(204,107,44,.28),0 0 24px rgba(204,107,44,.25)}
.card.unlock-bounce{animation:bob 1.1s ease-in-out infinite}
@keyframes bob{0%{transform:translateY(0) scale(.90)}50%{transform:translateY(-2px) scale(.905)}100%{transform:translateY(0) scale(.90)}}

.tapPad{position:relative;width:clamp(72px,16vw,120px);aspect-ratio:1;border-radius:var(--r);
        background:#12243b;border:1px solid #1a2f4a;display:flex;align-items:center;justify-content:center;
        font-size:clamp(44px,12vw,72px);cursor:pointer;overflow:visible; will-change:transform}
/* New bounce on tap */
.tapPad.tap-bounce{animation:tapBounce 220ms cubic-bezier(.2,1.2,.3,1)}
@keyframes tapBounce{0%{transform:scale(1)}45%{transform:scale(.92)}100%{transform:scale(1)}}

/* wrapper so we can swap emoji ‚áÑ image */
.iconWrap{position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center;}
.tapGif{width:78%; height:78%; object-fit:contain; border-radius:8px}

.lvl{position:absolute;left:6px;top:6px;font-size:12px;font-weight:900;color:#fff;
     background:linear-gradient(135deg,#203a63,#32578e);border:1px solid #4776b8;border-radius:8px;padding:2px 6px}
.repBand{position:absolute;left:0;right:0;bottom:0;height:var(--repband);background:#15341f;border-top:1px solid #204e2b;
         border-bottom-left-radius:var(--r);border-bottom-right-radius:var(--r);overflow:hidden}
.repFill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#1fa24e,var(--rep))}
.repLabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#cfead6}
.float{position:fixed;color:#ffe6c7;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.6);
       transform:translate(-50%,-10px);animation:rise .9s ease-out forwards;pointer-events:none;z-index:1000}
@keyframes rise{0%{opacity:0;transform:translate(-50%,10px) scale(.9)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-40px) scale(1.05)}}

.right{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
.ex-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ex-title{font-size:var(--fs-2);margin:0}
.muted{color:#a7b7cc}
.coachSlotTop{display:flex;align-items:center;gap:8px;margin-left:auto;flex-wrap:wrap}
@media (max-width:480px){ .coachSlotTop{gap:6px} }

.coachChip{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-size:12px}

/* Cooldown */
.coolwrap{background:#0c1525;border:1px solid #223556;border-radius:10px;overflow:hidden}
.coolbar{height:16px;background:#101a2a;position:relative}
.coolfill{height:100%;width:0%;position:relative;background:linear-gradient(90deg,var(--accent) 0%, var(--accent-hi) 92%)}
.coolfill::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,.16) 0 6px, transparent 6px 12px);
                 mix-blend-mode:overlay;opacity:.65;animation:stripeMove 1.2s linear infinite}
@keyframes stripeMove{from{background-position:0 0}to{background-position:60px 0}}
.metaRow{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.kv{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:6px 10px;border-radius:10px;font-size:14px}
.costLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.costPill{display:inline-flex;align-items:center;gap:8px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#ffd6a8;
          background:#142743;border:1px solid #27456d;padding:8px 14px;border-radius:999px;cursor:not-allowed}
.costPill.ready{color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-hi));border-color:#e89d6b;
                box-shadow:0 12px 26px rgba(204,107,44,.35)}

/* Banners */
.banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:linear-gradient(135deg,#132647,#1d3a61);
        color:#fff;border-top:1px solid #2a4a78;padding:12px 16px calc(12px + env(safe-area-inset-bottom));opacity:0;z-index:3000;
        display:flex;gap:8px;align-items:center;justify-content:center;text-align:center;
        animation:bannerIn .25s ease-out forwards, bannerOut .9s ease-in forwards 2.6s}
@keyframes bannerIn{to{opacity:1; transform:translateY(0)}}
@keyframes bannerOut{to{opacity:0; transform:translateY(8px)}}

/* Menu / overlays / achievements / start screen ‚Äî styles omitted for brevity, same as previous build */
.menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:5000;display:none;align-items:flex-end;justify-content:center}
.menuOverlay.open{display:flex}
.menuPanel{width:min(980px,96vw);max-height:88vh;background:#0f1b2b;border:1px solid var(--border);border-radius:16px 16px 0 0;
           box-shadow:0 -12px 30px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden}
.menuHeader{display:flex;align-items:center;gap:10px;padding:10px var(--space);border-bottom:1px solid var(--border)}
.menuTitle{font-weight:900;font-size:20px}
.menuTabs{display:flex;gap:8px;padding:8px var(--space);border-bottom:1px solid var(--border);flex-wrap:wrap}
.menuTab{padding:8px 12px;border-radius:999px;border:1px solid #2b3d5a;background:#13233b;color:#cfe0ff;font-weight:800;cursor:pointer}
.menuTab.active{background:var(--accent);color:#fff;border-color:#e89d6b}
.menuBody{padding:14px var(--space);overflow:auto}
.coachIntro{color:#cfe0ff;background:#13223a;border:1px solid #203659;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:14px}
.coachList{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:700px){ .coachList{grid-template-columns:1fr 1fr;} }
.coachCard{display:flex;gap:12px;align-items:center;background:#0c1525;border:1px solid #223556;border-radius:12px;padding:12px}
.coachCard.locked{opacity:.58;filter:grayscale(1);transform:scale(.96)}
.headshot{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:40px;border-radius:12px;background:#12243b;border:1px solid #1a2f4a}
.coachMid{flex:1;min-width:0}
.coachName{font-weight:900}
.coachInfo{color:#a7b7cc;font-size:14px;margin-top:2px}
.coachRight{display:flex;align-items:center}
.hireBtn{padding:12px 18px;font-size:16px;border-radius:12px}
.hireBtn.secondary{background:#1a2a40;color:#d7e3f5}
.hireBtn.ready{background:var(--accent);color:#fff;box-shadow:0 8px 22px rgba(204,107,44,.35)}

.startOv{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;pointer-events:auto}
.startOv.open{display:flex}
/* (‚Ä¶ keep your existing start overlay styles here ‚Ä¶) */

/* Tutorial overlay (typewriter) */
.tutOv{position:fixed;inset:0;z-index:8000;display:none;pointer-events:none}
.tutOv.show{display:block}
.tutOv.modal{pointer-events:auto}
.tutDim{position:absolute;inset:0;background:rgba(0,0,0,.22);pointer-events:none}
.tutOv.modal .tutDim{pointer-events:auto}
.tutBubble{position:absolute;left:50%;bottom:12vh;transform:translateX(-50%);max-width:min(980px,96vw);
  background:#0f1b2b;border:2px solid #2a4a78;border-radius:18px;padding:22px 24px;color:#fff;display:flex;gap:16px;align-items:flex-start;pointer-events:auto;
  box-shadow:0 18px 36px rgba(0,0,0,.35)}
.tutAvatar{width:92px; height:92px; border-radius:12px; overflow:hidden; flex:0 0 auto; display:flex; align-items:center; justify-content:center;
           background:#0b1423; border:1px solid #26406c; box-shadow:0 6px 18px rgba(0,0,0,.25)}
.tutAvatar img{width:100%; height:100%; object-fit:cover}
.tutText{flex:1;font-size:clamp(18px,3.8vw,24px);line-height:1.35}
.tutWho{font-weight:900;color:#ffd6a8;margin-bottom:4px;font-size:clamp(16px,3.4vw,20px)}
.hl{color:var(--accent); font-weight:900}
.tutMore{font-size:14px;color:#a7b7cc;margin-top:10px; display:flex; align-items:center; gap:10px}
.tutChevron{font-size:24px;color:var(--accent-hi)}
.tutPop{animation:tutPop .32s cubic-bezier(.2,1.2,.3,1)}
@keyframes tutPop{0%{transform:translateX(-50%) scale(.92); opacity:.0}70%{transform:translateX(-50%) scale(1.04); opacity:1}100%{transform:translateX(-50%) scale(1)}}
</style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar" id="topbar">
    <div class="topwrap">
      <div class="title">
        <div class="titleAvatar"><img id="titleAvatarImg" alt="Avatar"></div>
        <h1>Fitness Frenzy</h1>
      </div>
      <div class="topPlayer" id="topPlayer">
        <div class="pAvatar" id="topPlayerAvatar">
          <img id="topPlayerImg" alt="Player Avatar">
        </div>
      </div>
      <div class="hpPill"><span class="label">HP:</span><span id="hp" class="val">0.00</span></div>
      <div class="spacer"></div>
      <button id="menuBtn" class="btn ghost">Menu<span id="menuDot" class="notifDot"></span></button>
      <div class="seg" id="qtyTop"><button class="segBtn active" data-q="1">√ó1</button><button class="segBtn" data-q="10">√ó10</button></div>
      <button id="saveBtn" class="btn secondary">Save</button>
      <button id="resetBtn" class="btn secondary">Reset</button>
    </div>
  </div>

  <!-- Start Screen (unchanged structure; using your cover image) -->
  <div id="startOv" class="startOv" aria-hidden="true">
    <div class="startPlate" style="position:absolute;inset:0;background:url('https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png') center/cover no-repeat;filter:blur(14px) brightness(.75);opacity:.9"></div>
    <div class="startBackdrop" style="position:absolute;inset:0;background:radial-gradient(ellipse at center, rgba(0,0,0,.25), rgba(0,0,0,.55) 70%)"></div>
    <div class="startFrame" style="position:relative; z-index:1; width:min(96vw,1100px); height:min(92vh,1200px); border-radius:18px; border:1px solid rgba(255,255,255,.08);
      background:rgba(10,19,32,.50); backdrop-filter: blur(6px); box-shadow:0 12px 28px rgba(0,0,0,.45); overflow:hidden; display:flex; align-items:center; justify-content:center;">
      <div class="startImgWrap" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#000;">
        <img id="startCoverImg" alt="Fitness Frenzy Cover" src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Cover-Art.png" style="width:100%;height:100%;object-fit:contain;">
      </div>
      <div id="startUI" class="startUI popIn" style="position:absolute; left:50%; bottom:5.5vh; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center; gap:12px; width:min(92%,680px);">
        <div class="startBtns" style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; width:100%">
          <button id="btnStart" class="btn primary lg" style="font-size:clamp(18px,4.5vw,22px); padding:14px 24px; border-radius:16px;">Start</button>
          <button id="btnContinue" class="btn secondary lg" style="font-size:clamp(18px,4.5vw,22px); padding:14px 24px; border-radius:16px;">Continue</button>
        </div>
        <div class="startAvatar" style="display:flex; gap:10px; align-items:center; justify-content:center">
          <div class="seg" id="segAvatar" aria-label="Choose avatar">
            <button class="segBtn" data-avatar="male" title="Male"><span class="sym" style="display:inline-block;line-height:1;color:#59a8ff">‚ôÇ</span></button>
            <button class="segBtn" data-avatar="female" title="Female"><span class="sym" style="display:inline-block;line-height:1;color:#ff7db8">‚ôÄ</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game content -->
  <div class="wrap"><div id="stack" class="stack"></div></div>
  <div id="bannerHost"></div>

  <!-- Menu (same sections as before) -->
  <div id="menuOverlay" class="menuOverlay" aria-hidden="true">
    <div class="menuPanel" role="dialog" aria-modal="true">
      <div class="menuHeader">
        <div class="menuTitle">Menu</div>
        <div class="spacer"></div>
        <div class="hpPill small"><span class="label">HP:</span><span id="hpMenu" class="val">0.00</span></div>
        <button id="menuClose" class="btn secondary">Close</button>
      </div>
      <div class="menuTabs">
        <button class="menuTab active" data-tab="coaches">Coaches</button>
        <button class="menuTab" data-tab="upgrades">Upgrades</button>
        <button class="menuTab" data-tab="achievements">Achievements</button>
        <button class="menuTab" data-tab="quests">Side Quests</button>
        <button class="menuTab" data-tab="shop">Shop</button>
        <button class="menuTab" data-tab="stats">Stats</button>
        <button class="menuTab" data-tab="settings">Settings</button>
      </div>
      <div class="menuBody">
        <div id="tab-coaches"></div>
        <div id="tab-upgrades" style="display:none"><p>Upgrades coming soon.</p></div>
        <div id="tab-achievements" style="display:none"></div>
        <div id="tab-quests" style="display:none"><p>Side Quests coming later.</p></div>
        <div id="tab-shop" style="display:none"><p>Shop coming soon.</p></div>
        <div id="tab-stats" style="display:none"></div>
        <div id="tab-settings" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutOv" class="tutOv" aria-hidden="true">
    <div class="tutDim"></div>
    <div id="tutSpot" class="tutSpot" style="display:none"></div>
    <div id="tutBubble" class="tutBubble tutPop" role="dialog" aria-live="polite" aria-modal="true">
      <div id="tutAvatar" class="tutAvatar">
        <img id="tutAvatarImg" alt="Trainer" decoding="async" loading="eager"
             src="https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Trainer%20GIF.gif">
      </div>
      <div class="tutText">
        <div id="tutWho" class="tutWho">JAX</div>
        <div id="tutLine">‚Ä¶</div>
        <div class="tutMore"><span>Next</span> <span class="tutChevron">‚Ä∫</span></div>
      </div>
    </div>
  </div>

<script>
/* === External assets === */
const TRAINER_GIF = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Trainer%20GIF.gif";
const PLAYER_GIF_MALE = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Player%20Male%20GIFF.gif";
const PLAYER_GIF_FEMALE = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-PlayerFemaleGIFF.gif";
const PUSH_GIF = "https://raw.githubusercontent.com/JOE-RUGGIA/fitness-frenzy/main/FF-Clips.gif";

/* === Core App bootstrap (state, settings, utils) ‚Äî same foundations as last build === */
const App = {};
App.Flags = { tutorial:true, coaches:true, achievements:true, settings:true, debug:/[?&]debug=1/.test(location.search) };
App.Config = Object.freeze({ SAVE_KEY:'ff-v530', SCHEMA_VERSION:6, DEC:2, EPS:1e-6, SOLID_CD_MS:300,
  REP_GROWTH:1.12, SAVE_MS:20000, UI_REFRESH_MS:100, NOTIFY_REFRESH_MS:200, OFFLINE_MAX_MS:12*60*60*1000 });

App.Bus = (()=>{const m={};return{on(ev,fn){(m[ev]||(m[ev]=[])).push(fn);return()=>this.off(ev,fn)},off(ev,fn){const a=m[ev];if(!a)return;const i=a.indexOf(fn);if(i>=0)a.splice(i,1)},emit(ev,p){const a=m[ev];if(!a)return;for(const f of a.slice())try{f(p)}catch(e){console.warn(e)}}};})();

App.Settings = (()=>{const KEY=App.Config.SAVE_KEY+':prefs',d={sfx:true,floats:true};let p={...d};try{const r=localStorage.getItem(KEY);if(r)p={...d,...JSON.parse(r)}}catch{} function save(){try{localStorage.setItem(KEY,JSON.stringify(p))}catch{}} return{get:k=>p[k],set:(k,v)=>{p[k]=v;save();App.Bus.emit('settings:change',{key:k,val:v})},all:()=>({...p})};})();

App.Util = (()=>{const DEC=()=>App.Config.DEC; const fmtTop=n=>{const a=Math.abs(n); if(a>=1e9)return(n/1e9).toFixed(DEC())+'B'; if(a>=1e6)return(n/1e6).toFixed(DEC())+'M'; if(a>=1e3)return(n/1e3).toFixed(DEC())+'K'; return n.toFixed(DEC());};
const fmtCost=n=> n<1e3? n.toFixed(DEC()):(n<1e6?(n/1e3).toFixed(DEC())+'K':(n<1e9?(n/1e6).toFixed(DEC())+'M':(n/1e9).toFixed(DEC())+'B')); return { fmtTop, fmtCost };})();

/* === Audio with new 'type' tick === */
App.Audio = (()=> {
  let audioCtx=null, needsUnlock=true;
  function ensure(){ if(!audioCtx||audioCtx.state==='closed'){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(audioCtx&&audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{});} }
  function unlock(){ ensure(); if(!audioCtx) return; try{ const b=audioCtx.createBuffer(1,1,22050); const s=audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0);}catch{} if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{});} needsUnlock=false; }
  function tone(f,d=.12,g=.06,type='sine'){ try{ ensure(); if(!audioCtx) return; const t=audioCtx.currentTime; const o=audioCtx.createOscillator(); const q=audioCtx.createGain(); o.type=type;o.frequency.setValueAtTime(f,t); q.gain.setValueAtTime(g,t); q.gain.exponentialRampToValueAtTime(.0001,t+d); o.connect(q); q.connect(audioCtx.destination); o.start(); o.stop(t+d);}catch{} }
  function sfx(type){ if(!App.Settings.get('sfx')) return; if(!audioCtx||audioCtx.state!=='running'){ needsUnlock=true; return; }
    if(type==='tap') tone(660,.12,.055,'sine');
    if(type==='buy') tone(440,.18,.08,'sine');
    if(type==='popup'){ tone(520,.10,.06,'triangle'); setTimeout(()=>tone(780,.08,.05,'triangle'),90); }
    if(type==='achv'){ tone(600,.10,.07,'square'); setTimeout(()=>tone(800,.10,.06,'square'),110); setTimeout(()=>tone(1000,.12,.06,'square'),220); }
    if(type==='type'){ tone(950,.03,.025,'square'); } }
  ['visibilitychange','pagehide','freeze'].forEach(()=>{ if(document.visibilityState!=='visible') needsUnlock=true; });
  ['pointerdown','touchstart','mousedown','click','keydown'].forEach(ev=>{ window.addEventListener(ev, ()=>{ if(needsUnlock || (audioCtx && audioCtx.state!=='running')) unlock(); }, {capture:true, passive:true}); });
  return { sfx, unlock };
})();

/* === UI Effects: confetti (already present) === */
App.UI = {};
App.UI.Effects = (()=>{ const colors=['#ffb357','#ffd166','#7bd88f','#6bd3ff','#d4bfff','#ff8fab'];
  function confetti(x,y,count=14){ const host=document.createElement('div'); host.style.position='fixed'; host.style.left='0'; host.style.top='0'; host.style.pointerEvents='none'; host.style.zIndex='4000'; document.body.appendChild(host);
    const ww=window.innerWidth, wh=window.innerHeight; for(let i=0;i<count;i++){ const d=document.createElement('div'); const size=6+Math.random()*6; d.style.position='absolute';
      d.style.left=(x+(Math.random()*80-40))+'px'; d.style.top=(y+(Math.random()*30-15))+'px'; d.style.width=size+'px'; d.style.height=size+'px';
      d.style.background=colors[i%colors.length]; d.style.transform=`rotate(${Math.random()*360}deg)`; d.style.borderRadius=Math.random()<.4?'50%':'2px'; d.style.opacity='0.95';
      const dx=(Math.random()*2-1)*(ww*0.08); const dy=(wh*0.18+Math.random()*wh*0.12);
      d.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:`translate(${dx}px, ${dy}px) rotate(${180+Math.random()*180}deg)`,opacity:0}],{duration:900+Math.random()*500,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}); host.appendChild(d);}
    setTimeout(()=>host.remove(),1600);}
  return { confetti, confettiAtEl:(el,cnt)=>{ const r=el.getBoundingClientRect(); confetti(r.left+r.width/2, r.top+r.height*0.2, cnt||12); } };})();

/* === Overlay floats === */
App.UI.Overlay = (()=>{const floatFrom=(fromEl,text)=>{ const r=fromEl.getBoundingClientRect(); const span=document.createElement('div'); span.className='float'; span.textContent=text;
  span.style.left=(r.left+r.width/2)+'px'; span.style.top=(r.top+r.height*0.1)+'px'; document.body.appendChild(span); setTimeout(()=>span.remove(),950);}; return { floatFrom, suppressFloats:false };})();

/* === State / content === */
App.State = (()=> {
  const KEY=App.Config.SAVE_KEY;
  const s={ schemaVersion:App.Config.SCHEMA_VERSION, hp:0, buyQty:1, exercises:[], coachesOwned:{}, stats:{manualTaps:0, autoTaps:0, totalEarned:0},
    tutorial:{ done:false, stepId:null, avatar:'male', progress:{walkTaps:0}, shown:{ unlock:{}, coach:{}, upgrade:{} } }, achievements:{} };
  function setExercises(list){ s.exercises = list.map(e=>({ ...e, repHP:0, repProgress:0, repTarget:10, level:1, cooldown:e.baseCooldown, lastTapAt:0, _autoElapsed:0, _pushMode:null, els:{} })); }
  function save(){ localStorage.setItem(KEY, JSON.stringify({ schemaVersion:s.schemaVersion, hp:s.hp,buyQty:s.buyQty,coachesOwned:s.coachesOwned,stats:s.stats,tutorial:s.tutorial,achievements:s.achievements,
    exercises:s.exercises.map(e=>({id:e.id,repHP:e.repHP,repProgress:e.repProgress,repTarget:e.repTarget,unlocked:e.unlocked,cooldown:e.cooldown,level:e.level,lastTapAt:e.lastTapAt})) })); }
  function load(){ const raw=localStorage.getItem(KEY); if(!raw) return; try{ let j=JSON.parse(raw); s.hp=j.hp??0; s.buyQty=j.buyQty??1; s.coachesOwned=j.coachesOwned||{}; s.stats=j.stats||s.stats; s.tutorial=j.tutorial||s.tutorial; s.achievements=j.achievements||{}; s.__loaded=j.exercises||[]; }catch{} }
  function merge(){ if(!s.__loaded) return; for(const se of s.__loaded){ const e=s.exercises.find(x=>x.id===se.id); if(!e) continue;
      e.repHP=se.repHP??0; e.repProgress=se.repProgress??0; e.repTarget=se.repTarget??10; e.unlocked=se.unlocked??e.unlocked;
      e.cooldown=se.cooldown??e.baseCooldown; e.level=se.level??1; e.lastTapAt=(se.lastTapAt ?? 0); if(!e.unlocked){ e.lastTapAt=-1; } } delete s.__loaded; }
  return { s, setExercises, save, load, merge };
})();

App.Content = (()=> {
  const ex = [
    { id:'walk', name:'Walking',         icon:'üö∂',   baseHP:1,      baseCooldown:   600,   repBaseCost:  4,   unlockCost:    0,   unlocked:true  },
    { id:'jog',  name:'Jogging',         icon:'üèÉ',   baseHP:60,     baseCooldown:  3000,   repBaseCost: 30,   unlockCost:   60,   unlocked:false },
    { id:'sit',  name:'Sit-ups',         icon:'üßò',   baseHP:180,    baseCooldown:  6000,   repBaseCost: 90,   unlockCost:  300,   unlocked:false },
    /* Push-ups uses GIF only while active; otherwise static emoji 'üèãÔ∏è' */
    { id:'push', name:'Push-ups',        icon:'üèãÔ∏è',  gifUrl:PUSH_GIF, baseHP:400,  baseCooldown: 12000,   repBaseCost:200,   unlockCost: 1200,   unlocked:false },
    { id:'jacks', name:'Jumping Jacks',  icon:'ü§∏',   baseHP:900,    baseCooldown: 24000,   repBaseCost:450,   unlockCost: 1800,   unlocked:false },
    { id:'squat', name:'Bodyweight Squats',icon:'ü¶µ', baseHP:1800,   baseCooldown: 48000,   repBaseCost:900,   unlockCost: 3600,   unlocked:false }
    /* (‚Ä¶ you can keep the rest from the previous build if you want all 20) */
  ];
  return { exercises:ex };
})();

/* === Game logic === */
App.Game = (()=> {
  const { EPS, REP_GROWTH } = App.Config; const S=App.State.s;
  const perTap=e=> e.baseHP + e.repHP;
  const bulkRepCost=(e,q)=>{ const base=e.repBaseCost*Math.pow(REP_GROWTH,e.repHP); return +(base*(Math.pow(REP_GROWTH,q)-1)/(REP_GROWTH-1)).toFixed(App.Config.DEC); };
  function addHP(d){ S.hp+=d; if(d>0){ S.stats.totalEarned=(S.stats.totalEarn||0)+d; } App.Bus.emit('hp:change', S.hp); }
  function addReps(e,q){ const cost=bulkRepCost(e,q); if(S.hp+EPS<cost) return false; addHP(-cost); e.repHP+=q; e.repProgress+=q; App.Bus.emit('reps:buy',{exId:e.id,qty:q});
    while(e.repProgress>=e.repTarget){ e.repProgress-=e.repTarget; e.repTarget*=2; e.cooldown=Math.max(100, Math.floor(e.cooldown/2)); e.level+=1; App.Bus.emit('exercise:levelup',{exId:e.id,level:e.level}); App.UI.Banners.upgrade(`${e.name} upgraded to Lvl ${e.level}! Speed √ó2`); }
    return true; }
  function tap(e,now=performance.now()){ if(!e.unlocked) return 0; const cd=e.cooldown; if(e.lastTapAt>0 && now-e.lastTapAt<cd-1) return 0; e.lastTapAt=now; const g=perTap(e); addHP(g); S.stats.manualTaps++; App.Bus.emit('tap:manual',{exId:e.id,gain:g}); return g; }
  return { perTap, bulkRepCost, addReps, tap, addHP };
})();

/* === Engine & cooldown ‚Äî with push-up GIF active/idle toggling === */
App.Engine = (()=> {
  const { SOLID_CD_MS, SAVE_MS, UI_REFRESH_MS, NOTIFY_REFRESH_MS } = App.Config; let last=performance.now();
  function start(){ function tick(){ const now=performance.now(), dt=Math.min(0.25,(now-last)/1000); last=now; autoTap(now,dt); App.UI.Renderer.tickTop(dt); for(const e of App.State.s.exercises) updateCooldown(e);
      if(!tick._u || now-tick._u>UI_REFRESH_MS){ App.UI.Renderer.refreshAll(); App.Tutorial.repositionSpot&&App.Tutorial.repositionSpot(); tick._u=now; }
      if(!tick._n || now-tick._n>NOTIFY_REFRESH_MS){ App.Notify.update&&App.Notify.update(); tick._n=now; }
      requestAnimationFrame(tick);} requestAnimationFrame(tick); }
  function autoTap(now,dt){ const s=App.State.s; for(const e of s.exercises){ if(!App.Coaches.isAuto(e.id)) continue; e._autoElapsed += dt*1000; const cd=Math.max(100,e.cooldown);
      while(e._autoElapsed>=cd){ e._autoElapsed-=cd; e.lastTapAt=now; const g=App.Game.perTap(e); App.Game.addHP(g); s.stats.autoTaps++; if(App.UI.Overlay && !App.UI.Overlay.suppressFloats && e.els.tapPad){ App.UI.Overlay.floatFrom(e.els.tapPad, `+${g.toFixed(App.Config.DEC)}`); } } } }
  function updateCooldown(e){ if(!e.unlocked) return; const cd=Math.max(100,e.cooldown);
    // push-ups GIF control
    if(e.id==='push'){ const active = (e.lastTapAt>0) && ((performance.now()-e.lastTapAt) < cd-1);
      App.UI.Cards.setPushVisual(e, active?'anim':'idle');
    }
    if(cd<=SOLID_CD_MS){ if(e.els.coolFill) e.els.coolFill.style.width='100%'; if(e.els.headRight) e.els.headRight.textContent=(cd/1000).toFixed(App.Config.DEC)+'s'; return; }
    const ready=(e.lastTapAt<=0); const since=ready?cd:(performance.now()-e.lastTapAt); const pct=Math.max(0,Math.min(1,since/cd)); if(e.els.coolFill) e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';
    const elapsed=Math.max(0,Math.min(since,cd)); if(e.els.headRight) e.els.headRight.textContent=(elapsed/1000).toFixed(App.Config.DEC)+'s'; }
  function scheduleSave(){ setInterval(()=>App.State.save(), SAVE_MS); }
  function bindPress(el,fn){ el.addEventListener('pointerdown',e=>{e.preventDefault();fn(e);},{passive:false}); el.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();fn(e);}}); }
  return { start, scheduleSave, bindPress, updateCooldown };
})();

/* === Banners === */
App.UI.Banners = (()=>{ function upgrade(text){ const host=document.getElementById('bannerHost'); const el=document.createElement('div'); el.className='banner'; el.innerHTML=`üéâ <strong>${text}</strong>`; host.appendChild(el); setTimeout(()=>el.remove(),3600); } return { upgrade };})();

/* === Coaches (trimmed list for brevity) === */
App.Coaches = (()=> {
  const coaches=[ {id:'c1',name:'Rookie Coach',icon:'üßë‚Äçüè´',price:1500,target:'walk'}, {id:'c2',name:'Track Buddy',icon:'üëü',price:6000,target:'jog'},
                 {id:'c3',name:'Core Captain',icon:'üßò‚Äç‚ôÇÔ∏è',price:25000,target:'sit'}, {id:'c4',name:'Push-up Pro',icon:'üí™',price:100000,target:'push'} ];
  function isAuto(exId){ const owned=App.State.s.coachesOwned; return coaches.some(c=>owned[c.id] && c.target===exId); }
  function getOwnedForExercise(exId){ const owned=App.State.s.coachesOwned; return coaches.filter(c=>owned[c.id] && c.target===exId); }
  function list(){ return coaches.slice(); }
  function renderList(){
    const host=document.getElementById('tab-coaches'); host.innerHTML=`<div class="coachIntro">Coaches automatically tap a specific exercise for you. They respect the cooldown and don‚Äôt play sounds.</div>`;
    const listEl=document.createElement('div'); listEl.className='coachList'; host.appendChild(listEl);
    const exById=Object.fromEntries(App.State.s.exercises.map(e=>[e.id,e]));
    for(const c of coaches){
      const owned=!!App.State.s.coachesOwned[c.id]; const unlockedTarget=!!(exById[c.target] && exById[c.target].unlocked); const locked=!unlockedTarget;
      const card=document.createElement('div'); card.className='coachCard'+(locked?' locked':'');
      const head=document.createElement('div'); head.className='headshot'; head.textContent=c.icon;
      const mid=document.createElement('div'); mid.className='coachMid';
      mid.innerHTML=`<div class="coachName">${c.name}</div><div class="coachInfo">Works on: ${exById[c.target]?.name || c.target}</div>`;
      const right=document.createElement('div'); right.className='coachRight'; const btn=document.createElement('button'); btn.className='hireBtn secondary'; btn.dataset.coachId=c.id;
      btn.textContent = owned ? 'Owned' : `Hire ‚Ä¢ ${App.Util.fmtCost(c.price)} HP`; if(owned){ btn.disabled=true; } right.appendChild(btn);
      card.appendChild(head); card.appendChild(mid); card.appendChild(right); listEl.appendChild(card);
      const canAfford=(App.State.s.hp+App.Config.EPS)>=c.price;
      if(!locked && !owned){ btn.disabled=!canAfford; btn.classList.toggle('ready', canAfford); btn.classList.toggle('secondary', !canAfford); } else { btn.disabled=true; btn.classList.add('secondary'); btn.classList.remove('ready'); }
      btn.addEventListener('click', ()=>{ if(locked||owned) return; const S=App.State.s; if(S.hp+App.Config.EPS<c.price) return;
        App.Game.addHP(-c.price); S.coachesOwned[c.id]=true; App.Audio.sfx('buy'); App.Bus.emit('coach:owned', c.id); App.UI.Renderer.forceTop(); renderList(); });
    }
  }
  return { isAuto, getOwnedForExercise, renderList, list };
})();

/* === Achievements (minimal for now) === */
App.Achievements = (()=> {
  const defs = [
    { id:'first_steps', icon:'üë£',  title:'First Steps',   desc:'Upgrade Walking to Lvl 2 (10/10).',   reward:50,  done:()=> lvl('walk')>=2 },
    { id:'jog_unlocked', icon:'üèÉ', title:'Add to Routine',desc:'Unlock Jogging.',                      reward:100, done:()=> unlocked('jog') },
  ];
  function unlocked(id){ const e=App.State.s.exercises.find(x=>x.id===id); return e && e.unlocked; }
  function lvl(id){ const e=App.State.s.exercises.find(x=>x.id===id); return e? e.level:0; }
  function grant(ach){ if(App.State.s.achievements[ach.id]) return; App.State.s.achievements[ach.id]=true; App.Game.addHP(ach.reward);
    App.UI.Banners.upgrade(`Achievement: ${ach.title} ‚Ä¢ +${App.Util.fmtTop(ach.reward)} HP`); App.Audio.sfx('achv'); App.UI.Effects.confetti(window.innerWidth/2, 50, 26); App.State.save(); }
  function checkAll(){ for(const a of defs){ if(!App.State.s.achievements[a.id] && a.done()){ grant(a); } } }
  App.Bus.on('hp:change', checkAll); App.Bus.on('reps:buy', checkAll); App.Bus.on('exercise:levelup', checkAll); App.Bus.on('exercise:unlock', checkAll);
  return { render(){ const host=document.getElementById('tab-achievements'); const grid=document.createElement('div'); grid.className='achGrid';
    for(const a of defs){ const done=!!App.State.s.achievements[a.id]; const card=document.createElement('div'); card.className='ach';
      card.innerHTML=`<div class="achIcon">${a.icon}</div><div class="achMid"><div class="achTitle">${a.title}</div><div class="achDesc">${a.desc}</div></div>
      <div class="achRight"><div class="badgeRew">+${App.Util.fmtTop(a.reward)} HP</div>${done?'<div class="badgeDone">Completed</div>':''}</div>`; grid.appendChild(card); }
    host.innerHTML=''; host.appendChild(grid); } };
})();

/* === Menu notifier === */
App.Notify = (()=> {
  const dot=document.getElementById('menuDot');
  function coachAvailable(){ const s=App.State.s; const exById=Object.fromEntries(s.exercises.map(e=>[e.id,e])); for(const c of App.Coaches.list()){
      if(s.coachesOwned[c.id]) continue; const ex=exById[c.target]; if(!ex||!ex.unlocked) continue; if(s.hp+App.Config.EPS>=c.price) return true; } return false; }
  function update(){ if(!dot) return; dot.classList.toggle('show', coachAvailable()); }
  App.Bus.on('hp:change', update); App.Bus.on('coach:owned', update); App.Bus.on('exercise:unlock', update);
  return { update };
})();

/* === Cards & Renderer (with tap bounce/confetti and push-visual API) === */
App.UI.Cards = (()=> {
  const { bindPress } = App.Engine; const { perTap, tap, addReps, bulkRepCost } = App.Game; const { sfx, unlock } = App.Audio;

  function setPushVisual(e, mode){ // 'idle' | 'anim'
    if(!e.els || !e.els.iconWrap) return;
    if(e._pushMode === mode) return;
    e._pushMode = mode;
    if(mode==='anim' && e.gifUrl){
      // show GIF
      e.els.iconWrap.innerHTML = `<img class="tapGif" alt="${e.name}" src="${e.gifUrl}">`;
    } else {
      // show static emoji placeholder (appears "paused")
      e.els.iconWrap.innerHTML = '';
      e.els.iconWrap.textContent = e.icon || 'üèãÔ∏è';
    }
  }

  function applyIcon(e){
    if(e.id==='push'){
      // Locked: static emoji; Unlocked: default to idle (no gif) until active
      setPushVisual(e, 'idle');
      return;
    }
    // Non-push: emoji as icon
    if(!e.els || !e.els.iconWrap) return;
    e.els.iconWrap.innerHTML = '';
    e.els.iconWrap.textContent = e.icon || 'üí™';
  }

  function makeExerciseCard(e){
    const card=document.createElement('div'); card.className='card'+(e.unlocked?'':' locked'); card.dataset.id=e.id;

    const tapPad=document.createElement('div'); tapPad.className='tapPad';
    const iconWrap=document.createElement('div'); iconWrap.className='iconWrap';
    tapPad.appendChild(iconWrap);

    const lvl=document.createElement('div'); lvl.className='lvl'; lvl.textContent=`Lvl ${e.level}`; tapPad.appendChild(lvl);
    const repBand=document.createElement('div'); repBand.className='repBand'; repBand.innerHTML=`<div class="repFill"></div><div class="repLabel">0/10</div>`; tapPad.appendChild(repBand);

    applyIcon(e);

    const right=document.createElement('div'); right.className='right';
    const head=document.createElement('div'); head.className='ex-head'; head.innerHTML=`<div class="ex-title">${e.name}</div><div class="muted headRight"></div>`;
    const coachSlotTop=document.createElement('div'); coachSlotTop.className='coachSlotTop';
    const coolWrap=document.createElement('div'); coolWrap.className='coolwrap'; coolWrap.innerHTML=`<div class="coolbar"><div class="coolfill"></div></div>`;
    const metaRow=document.createElement('div'); metaRow.className='metaRow';
    const kvs=document.createElement('div'); kvs.innerHTML=`<span class="kv"><strong class="kvTap">${perTap(e).toFixed(App.Config.DEC)}</strong> HP</span>`;
    const buyBtn=document.createElement('button'); buyBtn.className='btn secondary'; buyBtn.textContent='Reps'; buyBtn.dataset.role='reps';
    metaRow.appendChild(kvs); metaRow.appendChild(buyBtn);
    const costLine=document.createElement('div'); costLine.className='costLine';
    costLine.innerHTML=`<button class="costPill" type="button">Unlock for <span class="costAmt"></span> HP</button>`;
    const costPill=costLine.querySelector('.costPill'), costAmt=costLine.querySelector('.costAmt');
    head.appendChild(coachSlotTop);
    right.appendChild(head); right.appendChild(coolWrap); right.appendChild(metaRow); right.appendChild(costLine);
    card.appendChild(tapPad); card.appendChild(right);

    e.els={ card,tapPad,iconWrap,lvl, repFill:repBand.querySelector('.repFill'), repLabel:repBand.querySelector('.repLabel'),
      headRight:head.querySelector('.headRight'), coolFill:coolWrap.querySelector('.coolfill'), kvTap:kvs.querySelector('.kvTap'), buyBtn, coachSlotTop, costLine,costPill,costAmt };

    if(e.unlocked){ costLine.style.display='none'; } else { coolWrap.style.display='none'; metaRow.style.display='none'; coachSlotTop.style.display='none'; }

    bindPress(tapPad, ()=>{ unlock(); const g=tap(e); if(g>0){
        // Bounce + confetti on manual taps only
        e.els.tapPad.classList.add('tap-bounce'); e.els.tapPad.addEventListener('animationend',()=>e.els.tapPad.classList.remove('tap-bounce'),{once:true});
        App.UI.Effects.confettiAtEl(e.els.tapPad, 10);
        sfx('tap');
        if(App.Settings.get('floats')) App.UI.Overlay.floatFrom(tapPad, `+${g.toFixed(App.Config.DEC)}`);
        App.UI.Renderer.forceTop();
      } });
    bindPress(buyBtn, ()=>{ const ok=addReps(e, App.State.s.buyQty||1); if(ok){ App.Audio.sfx('buy'); App.UI.Renderer.refreshExerciseUI(e); App.UI.Renderer.forceTop(); } });
    costPill.addEventListener('click', ()=>{ const s=App.State.s; if(!e.unlocked && s.hp+App.Config.EPS>=e.unlockCost){
      App.Game.addHP(-e.unlockCost); e.unlocked=true; e.lastTapAt=0; App.Audio.sfx('buy'); App.Bus.emit('exercise:unlock', { exId:e.id });
      // For push-ups: stay idle (no gif) until first active cooldown
      applyIcon(e);
      e.els.card.classList.remove('locked','unlock-ready','unlock-bounce'); coolWrap.style.display='block'; metaRow.style.display='flex'; coachSlotTop.style.display='flex'; costLine.style.display='none'; App.UI.Renderer.forceTop(); }});

    return card;
  }

  return { makeExerciseCard, applyIcon, setPushVisual };
})();

/* === Renderer (top numbers, HP, cards, etc.) === */
App.UI.Renderer = (()=> {
  const refs={ stack:document.getElementById('stack'), hp:document.getElementById('hp'), hpMenu:document.getElementById('hpMenu'),
               qtyTop:document.getElementById('qtyTop'), saveBtn:document.getElementById('saveBtn'), resetBtn:document.getElementById('resetBtn'),
               menuBtn:document.getElementById('menuBtn'), menuOverlay:document.getElementById('menuOverlay'), menuClose:document.getElementById('menuClose'),
               tabsWrap:document.querySelector('.menuTabs'), menuBody:document.querySelector('.menuBody'),
               topPlayerImg:document.getElementById('topPlayerImg'), titleAvatarImg:document.getElementById('titleAvatarImg') };
  const { fmtTop, fmtCost } = App.Util; const { perTap, bulkRepCost } = App.Game; const { s } = App.State;
  let shownHP=0;
  function renderStack(){ App.State.merge(); refs.stack.innerHTML=''; for(const e of s.exercises){ const card=App.UI.Cards.makeExerciseCard(e); refs.stack.appendChild(card); refreshExerciseUI(e); } }
  function forceTop(){ shownHP=s.hp; renderTopNow(); }
  function renderTopNow(){ const txt=fmtTop(shownHP); refs.hp.textContent=txt; if(refs.hpMenu) refs.hpMenu.textContent=txt; }
  function tickTop(dt){ shownHP += (s.hp - shownHP) * Math.min(1, dt*8); renderTopNow(); }
  function refreshExerciseUI(e){
    const cd=Math.max(100,e.cooldown);
    // icon states
    if(e.id==='push'){ /* engine will flip to GIF on active */ } else { App.UI.Cards.applyIcon(e); }
    if(e.unlocked){
      if(cd<=App.Config.SOLID_CD_MS){ if(e.els.coolFill) e.els.coolFill.style.width='100%'; if(e.els.headRight) e.els.headRight.textContent=(cd/1000).toFixed(App.Config.DEC)+'s'; }
      else { const ready=(e.lastTapAt<=0); const since=ready?cd:(performance.now()-e.lastTapAt); const pct=Math.max(0,Math.min(1,since/cd)); if(e.els.coolFill) e.els.coolFill.style.width=(pct*100).toFixed(1)+'%';
             const elapsed=Math.max(0,Math.min(since,cd)); if(e.els.headRight) e.els.headRight.textContent=(elapsed/1000).toFixed(App.Config.DEC)+'s'; }
    }
    if(e.els.repLabel) e.els.repLabel.textContent=`${e.repProgress}/${e.repTarget}`;
    if(e.els.repFill) e.els.repFill.style.width=(Math.min(e.repProgress/e.repTarget,1)*100).toFixed(1)+'%';
    if(e.els.lvl) e.els.lvl.textContent=`Lvl ${e.level}`;
    if(e.els.kvTap) e.els.kvTap.textContent=perTap(e).toFixed(App.Config.DEC);
    if(e.els.coachSlotTop){ const cs=App.Coaches.getOwnedForExercise(e.id); e.els.coachSlotTop.innerHTML=''; if(cs.length){ for(const c of cs){ const chip=document.createElement('div'); chip.className='coachChip'; chip.textContent=`${c.icon} ${c.name}`; e.els.coachSlotTop.appendChild(chip); } } }
    if(e.unlocked && e.els.buyBtn){ const qty=s.buyQty||1, cost=bulkRepCost(e,qty), canBuy=s.hp+App.Config.EPS>=cost;
      e.els.buyBtn.textContent=(qty===1?`Reps (${fmtCost(cost)} HP)`: `√ó${qty} Reps (${fmtCost(cost)} HP)`); e.els.buyBtn.disabled=!canBuy; e.els.buyBtn.classList.toggle('primary',canBuy);
      e.els.buyBtn.classList.toggle('secondary',!canBuy); e.els.buyBtn.classList.toggle('ready',canBuy); }
    if(!e.unlocked && e.els.costPill){ const canUn=s.hp+App.Config.EPS>=e.unlockCost; e.els.costAmt.textContent=App.Util.fmtCost(e.unlockCost);
      e.els.card.classList.toggle('unlock-ready',canUn); e.els.card.classList.toggle('unlock-bounce',canUn); e.els.costPill.classList.toggle('ready',canUn); }
  }
  function refreshAll(){ renderTopNow(); for(const e of App.State.s.exercises) refreshExerciseUI(e); }
  function buildStats(){ const host=document.getElementById('tab-stats'); const owned=Object.keys(App.State.s.coachesOwned).length; const unlocked=App.State.s.exercises.filter(e=>e.unlocked).length;
    host.innerHTML=`<div class="coachIntro"><strong>Lifetime Stats</strong>
      <div>Total HP (current): ${App.Util.fmtTop(App.State.s.hp)}</div>
      <div>Lifetime HP earned: ${App.Util.fmtTop(App.State.s.stats.totalEarned||0)}</div>
      <div>Manual taps: ${App.State.s.stats.manualTaps}</div>
      <div>Auto taps: ${App.State.s.stats.autoTaps}</div>
      <div>Exercises unlocked: ${unlocked} / ${App.State.s.exercises.length}</div>
      <div>Coaches hired: ${owned} / ${App.Coaches.list().length}</div></div>`; }
  function buildSettings(){ const host=document.getElementById('tab-settings'); const prefs=App.Settings.all();
    host.innerHTML=`<div class="coachIntro"><strong>Preferences</strong></div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <label><input id="set-sfx" type="checkbox" ${prefs.sfx?'checked':''}/> Sound effects</label>
        <label><input id="set-floats" type="checkbox" ${prefs.floats?'checked':''}/> Show +HP float text</label>
      </div>`;
    document.getElementById('set-sfx').onchange=e=>App.Settings.set('sfx',!!e.target.checked);
    document.getElementById('set-floats').onchange=e=>App.Settings.set('floats',!!e.target.checked);
  }
  function wireMenu(){
    refs.menuBtn.addEventListener('click', ()=>{ App.Audio.sfx('popup'); document.getElementById('menuOverlay').classList.add('open'); document.getElementById('menuOverlay').setAttribute('aria-hidden','false'); App.UI.Overlay.suppressFloats=true; switchTab('coaches'); App.Notify.update(); });
    document.getElementById('menuClose').addEventListener('click', ()=>{ App.Audio.sfx('popup'); document.getElementById('menuOverlay').classList.remove('open'); document.getElementById('menuOverlay').setAttribute('aria-hidden','true'); App.UI.Overlay.suppressFloats=false; });
    document.getElementById('menuOverlay').addEventListener('click', (e)=>{ if(e.target===document.getElementById('menuOverlay')){ App.Audio.sfx('popup'); document.getElementById('menuClose').click(); }});
    function switchTab(tab){ document.querySelectorAll('.menuTab').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
      const ids=['coaches','upgrades','achievements','quests','shop','stats','settings'];
      ids.forEach(id=> document.getElementById('tab-'+id).style.display=(id===tab?'block':'none'));
      if(tab==='coaches') App.Coaches.renderList(); if(tab==='stats') buildStats(); if(tab==='settings') buildSettings(); if(tab==='achievements') App.Achievements.render();
    }
  }
  // expose avatar updater for title & top
  function setAvatarImages(av){
    const src = (av==='female') ? PLAYER_GIF_FEMALE : PLAYER_GIF_MALE;
    refs.topPlayerImg.src = src;
    refs.titleAvatarImg.src = src; // big avatar in the title (replaces üí™)
  }
  return { refs, renderStack, refreshAll, tickTop, forceTop, wireMenu, setAvatarImages };
})();

/* === Offline (unchanged logic ‚Äì omitted here to keep focus) === */

/* === Tutorial with TYPEWRITER effect === */
App.Tutorial = (()=> {
  if(!App.Flags.tutorial){ return { init(){}, start(){}, end(){}, repositionSpot(){} }; }
  const S=App.State.s; const ov=document.getElementById('tutOv'); const bubble=document.getElementById('tutBubble');
  const who=document.getElementById('tutWho'); const line=document.getElementById('tutLine'); const avatarBox=document.getElementById('tutAvatar');
  let active=false, gating=false, curStep=null, lineIdx=0, allowed=[], typing=false, targetHTML='', typedHTML='', typeTimer=null, typePos=0;

  function setModal(on){ ov.classList.toggle('modal',!!on); }
  function show(modal=true){ ov.classList.add('show'); ov.setAttribute('aria-hidden','false'); active=true; setModal(modal); App.UI.Overlay.suppressFloats=true; }
  function hide(){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); active=false; setModal(false); App.UI.Overlay.suppressFloats=false; gateStop(); stopTyping(); }
  function gateStart(allow){ allowed=allow||[]; gating=true; document.addEventListener('pointerdown',gateHandler,true); document.addEventListener('click',gateHandler,true); }
  function gateStop(){ gating=false; allowed=[]; document.removeEventListener('pointerdown',gateHandler,true); document.removeEventListener('click',gateHandler,true); }
  function gateHandler(e){ if(!active||!gating) return; let okay=false; for(const sel of allowed){ if(e.target.closest(sel)){ okay=true; break; } } if(!okay){ e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation(); } }

  function setSpeaker(name){
    who.textContent=name;
    avatarBox.innerHTML = `<img alt="Trainer" src="${TRAINER_GIF}">`;
  }

  function tokenizeHTML(html){
    const tokens=[]; let i=0; while(i<html.length){
      if(html[i]==='<'){ const j=html.indexOf('>',i); if(j===-1){ tokens.push(html.slice(i)); break; } tokens.push(html.slice(i,j+1)); i=j+1; }
      else { const j=html.indexOf('<',i); if(j===-1){ tokens.push(html.slice(i)); break; } tokens.push(html.slice(i,j)); i=j; }
    } return tokens;
  }
  function typeLine(html, onDone){
    stopTyping(); targetHTML=html; typedHTML=''; typePos=0; const tokens=tokenizeHTML(html); typing=true;
    function tick(){
      if(typePos>=tokens.length){ typing=false; if(onDone) onDone(); return; }
      const tk=tokens[typePos++];
      if(tk.startsWith('<')){ typedHTML+=tk; line.innerHTML=typedHTML; tick(); } // insert tags immediately
      else{
        if(tk.length<=1){ typedHTML+=tk; line.innerHTML=typedHTML; App.Audio.sfx('type'); setTimeout(tick, 18); }
        else {
          // reveal text token character by character
          let ci=0;
          function cstep(){
            typedHTML+=tk[ci++]; line.innerHTML=typedHTML; if(ci%2===0) App.Audio.sfx('type');
            if(ci<tk.length){ typeTimer=setTimeout(cstep, 18); }
            else { typeTimer=null; setTimeout(tick, 12); }
          }
          cstep();
        }
      }
    }
    tick();
  }
  function stopTyping(){ typing=false; if(typeTimer){ clearTimeout(typeTimer); typeTimer=null; } }

  bubble.addEventListener('click',()=>{
    if(!curStep) return;
    if(typing){ // fast-forward
      stopTyping(); line.innerHTML=targetHTML; typing=false; return;
    }
    if(lineIdx<curStep.lines.length-1){ lineIdx++; const L=curStep.lines[lineIdx]; setSpeaker(L.who); typeLine(L.html); App.Audio.sfx('popup'); }
    else if(curStep.onLinesDone){ const done=curStep.onLinesDone; curStep=null; done(); }
  });

  function setStep(step,modal=true){ curStep=step; S.tutorial.stepId=step.id||null; lineIdx=0; show(modal); setSpeaker(step.lines[0].who); typeLine(step.lines[0].html); }

  function startIntro(){ setStep({ id:'intro-walk', lines:[
    {who:'JAX',html:'Hey‚Äîenergy looks <span class="hl">low</span>. Let‚Äôs fix that <span class="hl">fast</span> üí™'},
    {who:'JAX',html:'Tap <span class="hl">Walking</span> to earn <span class="hl">1 HP</span> each time. Then we‚Äôll power up.'}
  ], onLinesDone(){ showSpotFor('.card[data-id="walk"] .tapPad'); gateStart(['.card[data-id="walk"] .tapPad','#tutBubble']); bubble.style.display='none';
      const offTap=App.Bus.on('tap:manual',({exId})=>{ if(exId!=='walk') return; App.Bus.off('tap:manual',offTap); bubble.style.display=''; setStep({ id:'reps-walk', lines:[
        {who:'JAX',html:'Use <span class="hl">Reps</span> to add <span class="hl">+1 HP</span> per tap.'},
        {who:'JAX',html:'Watch the green <span class="hl">Rep bar</span>. At <span class="hl">10/10</span> you <span class="hl">upgrade</span> and cooldown halves.'}
      ], onLinesDone(){ hideSpot(); gateStop(); hide(); } }, true);
    } }); }
  function showSpotFor(sel){ const spot=document.getElementById('tutSpot'); const el=document.querySelector(sel); if(!el){ spot.style.display='none'; return; } const r=el.getBoundingClientRect(); const pad=6;
    spot.style.display='block'; spot.style.position='absolute'; spot.style.left=(r.left-pad)+'px'; spot.style.top=(r.top-pad)+'px'; spot.style.width=(r.width+pad*2)+'px'; spot.style.height=(r.height+pad*2)+'px';
    try{ el.scrollIntoView({behavior:'smooth',block:'center'});}catch{} }
  function hideSpot(){ const spot=document.getElementById('tutSpot'); spot.style.display='none'; }
  function repositionSpot(){ /* no-op in this trimmed build */ }
  return { init(){}, start(){ if(!S.tutorial.done){ startIntro(); } }, repositionSpot };
})();

/* === Start UI & avatar wiring === */
App.UI.Start = (() => {
  const ov=document.getElementById('startOv'); const btnStart=document.getElementById('btnStart'); const btnCont=document.getElementById('btnContinue'); const seg=document.getElementById('segAvatar');
  function setAvatar(av){
    App.State.s.tutorial.avatar=av;
    [...seg.querySelectorAll('.segBtn')].forEach(b=>b.classList.toggle('active',b.dataset.avatar===av));
    App.UI.Renderer.setAvatarImages(av);
    App.State.save&&App.State.save();
  }
  function init(){ const cur=App.State.s.tutorial.avatar||'male'; setAvatar(cur); seg.querySelectorAll('.segBtn').forEach(b=> b.addEventListener('click', ()=> { App.Audio.sfx('tap'); setAvatar(b.dataset.avatar); }));
    btnStart.addEventListener('click', ()=>{ App.Audio.sfx('popup'); hide(); App.Tutorial.start(); });
    btnCont.addEventListener('click', ()=>{ App.Audio.sfx('popup'); hide(); });
  }
  function show(){ ov.classList.add('open'); ov.setAttribute('aria-hidden','false'); }
  function hide(){ ov.classList.remove('open'); ov.setAttribute('aria-hidden','true'); }
  return { init, show, hide };
})();

/* === Boot === */
(function boot(){
  // Prevent double-tap zoom
  let lastTouchEnd=0; document.addEventListener('touchend',e=>{const n=Date.now(); if(n-lastTouchEnd<=300){e.preventDefault();} lastTouchEnd=n;},{passive:false});
  document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false}); document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});

  App.State.load(); App.State.setExercises(App.Content.exercises);

  // Avatar defaults up top
  App.UI.Renderer.setAvatarImages(App.State.s.tutorial.avatar||'male');

  App.UI.Renderer.renderStack(); App.UI.Renderer.forceTop(); App.UI.Renderer.refreshAll();
  App.UI.Renderer.wireMenu();

  const { refs } = App.UI.Renderer;
  refs.saveBtn.addEventListener('click', App.State.save);
  refs.resetBtn.addEventListener('click', ()=>{ if(!confirm('Reset your progress?')) return; localStorage.clear(); location.reload(); });
  [...refs.qtyTop.querySelectorAll('.segBtn')].forEach(b=>b.addEventListener('pointerdown',ev=>{
    ev.preventDefault(); [...refs.qtyTop.querySelectorAll('.segBtn')].forEach(x=>x.classList.remove('active')); b.classList.add('active');
    App.State.s.buyQty=parseInt(b.dataset.q,10); App.UI.Renderer.refreshAll(); App.Audio.sfx('tap');
  },{passive:false}));

  App.UI.Start.init(); App.UI.Start.show();

  // Simple loop to keep menu dot fresh
  setInterval(()=>{ App.Notify.update&&App.Notify.update(); }, 250);
})();
</script>
</body>
</html>
